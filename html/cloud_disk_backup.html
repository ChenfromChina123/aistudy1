<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç›˜ç®¡ç† - AIæ™ºèƒ½å­¦ä¹ å¯¼å¸ˆ</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
            --gray-color: #95a5a6;
            --light-gray: #f1f2f3;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* é¡µé¢å¤´éƒ¨ */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .back-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }
        
        .back-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) translateX(-2px);
        }
        
        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .upload-header {
            margin-bottom: 15px;
            color: var(--dark-color);
        }
        
        .upload-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        .file-input-wrapper {
            position: relative;
            flex: 1;
        }
        
        .custom-file-input {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--gray-color);
            border-radius: 6px;
            background-color: var(--light-gray);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .custom-file-input:hover {
            border-color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .custom-file-input.drag-over {
            border-color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .custom-file-input input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .upload-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            height: 50px;
            white-space: nowrap;
        }
        
        .create-file-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            height: 50px;
            white-space: nowrap;
        }
        
        .create-file-btn:hover {
            background-color: #219653;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--dark-color);
        }
        
        .close-modal-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-color);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .close-modal-btn:hover {
            background-color: var(--light-gray);
            color: var(--dark-color);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-color);
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-color);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 150px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .cancel-btn {
            background-color: var(--light-gray);
            color: var(--dark-color);
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .cancel-btn:hover {
            background-color: var(--gray-color);
        }
        
        .create-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .create-btn:hover {
            background-color: var(--secondary-color);
        }
        
        /* é€‰ä¸­æ–‡ä»¶åˆ—è¡¨ */
        .selected-files {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            padding: 10px;
            background-color: var(--light-gray);
        }
        
        .selected-files-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .clear-files-btn {
            background: none;
            border: none;
            color: var(--gray-color);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 2px 8px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .clear-files-btn:hover {
            background-color: var(--gray-color);
            color: white;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            background-color: white;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .file-item-icon {
            margin-right: 8px;
            font-size: 1rem;
        }
        
        .file-item-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-item-size {
            color: var(--gray-color);
            margin-left: 8px;
            font-size: 0.85rem;
        }
        
        .upload-btn:hover:not(:disabled) {
            background-color: var(--secondary-color);
        }
        
        .upload-btn:disabled {
            background-color: var(--gray-color);
            cursor: not-allowed;
        }
        
        .upload-info {
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--gray-color);
        }
        
        /* æ–‡ä»¶åˆ—è¡¨ */
        .files-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: var(--dark-color);
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .refresh-btn {
            background-color: var(--light-gray);
            color: var(--dark-color);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .refresh-btn:hover {
            background-color: var(--gray-color);
            color: white;
        }
        
        /* è¡¨æ ¼æ ·å¼ */
        .files-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .files-table th,
        .files-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .files-table th {
            background-color: var(--light-gray);
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .files-table tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .file-icon {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-icon i {
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        
        .file-name {
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .file-size {
            color: var(--gray-color);
            font-size: 0.9rem;
        }
        
        .file-date {
            color: var(--gray-color);
            font-size: 0.9rem;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .download-btn {
            background-color: var(--success-color);
            color: white;
        }
        
        .download-btn:hover {
            background-color: #219653;
        }
        
        .delete-btn {
            background-color: var(--accent-color);
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-color);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--dark-color);
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-gray);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* é€šçŸ¥æ¶ˆæ¯ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: var(--success-color);
            color: white;
        }
        
        .notification.error {
            background-color: var(--accent-color);
            color: white;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-container {
            display: none;
            margin-top: 15px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: var(--light-gray);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-top: 5px;
            text-align: right;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .upload-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .upload-btn {
                width: 100%;
                height: auto;
            }
            
            .files-table {
                display: block;
                overflow-x: auto;
            }
            
            .file-actions {
                flex-direction: column;
                gap: 5px;
            }
            
            .back-btn {
                position: static;
                transform: none;
                margin-bottom: 15px;
                display: inline-block;
            }
            
            header {
                text-align: center;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <div class="container">
        <header>
            <a href="index.html" class="back-btn">è¿”å›é¦–é¡µ</a>
            <h1>äº‘ç›˜ç®¡ç†</h1>
            <p>å®‰å…¨å­˜å‚¨æ‚¨çš„å­¦ä¹ èµ„æ–™å’Œæ–‡ä»¶</p>
        </header>
        
        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
            <h2 class="upload-header">ä¸Šä¼ æ–‡ä»¶</h2>
            <div class="upload-container">
                <div class="file-input-wrapper">
                    <label class="custom-file-input" id="fileDropArea">
                        <i style="font-size: 2rem;">ğŸ“</i>
                        <div>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                        <input type="file" id="fileInput" multiple>
                    </label>
                </div>
                <button class="upload-btn" id="uploadBtn" disabled>å¼€å§‹ä¸Šä¼ </button>
                <button class="create-file-btn" id="createFileBtn">
                    <i>ğŸ“</i> æ–°å»ºæ–‡ä»¶
                </button>
            </div>
            
            <!-- é€‰ä¸­æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="selected-files" id="selectedFilesContainer" style="display: none;">
                <div class="selected-files-header">
                    <span id="selectedFilesCount">å·²é€‰æ‹© 0 ä¸ªæ–‡ä»¶</span>
                    <button class="clear-files-btn" id="clearFilesBtn">æ¸…é™¤æ‰€æœ‰</button>
                </div>
                <div id="selectedFilesList"></div>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
            
            <div class="upload-info">
                <p>æ”¯æŒæ ¼å¼ï¼šæ–‡æ¡£(.txt, .pdf, .doc, .docxç­‰)ã€å›¾ç‰‡(.jpg, .pngç­‰)ã€è§†é¢‘(.mp4ç­‰)ã€å‹ç¼©åŒ…(.zipç­‰)ã€ä»£ç æ–‡ä»¶ç­‰</p>
                <p>å•ä¸ªæ–‡ä»¶å¤§å°é™åˆ¶ï¼š100MBï¼Œè§†é¢‘æ–‡ä»¶å°†è‡ªåŠ¨å‹ç¼©ä¸ºZIPæ ¼å¼</p>
            </div>
        </div>
        
        <!-- æ–‡ä»¶å¤¹å¯¼èˆªå’Œç®¡ç†å·¥å…·æ  -->
        <div class="folder-toolbar" style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                <span style="font-weight: 600; color: #333;">ğŸ“ æ–‡ä»¶å¤¹å¯¼èˆªï¼š</span>
                <div id="breadcrumb" style="display: flex; align-items: center; gap: 5px; flex-wrap: wrap;">
                    <button class="breadcrumb-btn" data-path="/" style="background: none; border: none; color: #3498db; cursor: pointer; padding: 0; text-decoration: underline;">æ ¹ç›®å½•</button>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="createFolderBtn" class="action-btn" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                    <span>â•</span> æ–°å»ºæ–‡ä»¶å¤¹
                </button>
                <input type="text" id="newFolderName" placeholder="è¾“å…¥æ–°æ–‡ä»¶å¤¹åç§°" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; flex: 0 0 auto; max-width: 200px; display: none;">
                <button id="confirmFolderBtn" class="action-btn" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: none;">
                    âœ“ ç¡®è®¤
                </button>
                <button id="cancelFolderBtn" class="action-btn" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: none;">
                    âœ• å–æ¶ˆ
                </button>
            </div>
        </div>
        
        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <div class="files-section">
            <div class="section-header">
                <h2 class="section-title">æˆ‘çš„æ–‡ä»¶</h2>
                <button class="refresh-btn" id="refreshBtn">
                    <i>ğŸ”„</i> åˆ·æ–°åˆ—è¡¨
                </button>
            </div>
            
            <table class="files-table" id="filesTable">
                <thead>
                    <tr>
                        <th style="width: 35%;">æ–‡ä»¶å</th>
                        <th style="width: 15%;">å¤§å°</th>
                        <th style="width: 25%;">ä¸Šä¼ æ—¶é—´</th>
                        <th style="width: 25%;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="filesList">
                    <!-- æ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    <tr class="empty-state">
                        <td colspan="4">
                            <i>ğŸ“‚</i>
                            <h3>æš‚æ— æ–‡ä»¶</h3>
                            <p>ä¸Šä¼ æ‚¨çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶å¼€å§‹ä½¿ç”¨äº‘ç›˜åŠŸèƒ½</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- æ–°å»ºæ–‡ä»¶æ¨¡æ€æ¡† -->
    <div class="modal" id="createFileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°å»ºæ–‡ä»¶</h3>
                <button class="close-modal-btn" id="closeModalBtn">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="fileName">æ–‡ä»¶å</label>
                    <input type="text" id="fileName" placeholder="è¯·è¾“å…¥æ–‡ä»¶å">
                </div>
                <div class="form-group">
                    <label for="fileType">æ–‡ä»¶ç±»å‹</label>
                    <select id="fileType">
                        <option value="txt">æ–‡æœ¬æ–‡æ¡£ (.txt)</option>
                        <option value="docx">Wordæ–‡æ¡£ (.docx)</option>
                    </select>
                </div>
                <div class="form-group" id="fileContentContainer">
                    <label for="fileContent">æ–‡ä»¶å†…å®¹</label>
                    <textarea id="fileContent" placeholder="è¯·è¾“å…¥æ–‡ä»¶å†…å®¹" rows="10"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" id="cancelCreateFileBtn">å–æ¶ˆ</button>
                <button class="create-btn" id="confirmCreateFileBtn">åˆ›å»º</button>
            </div>
        </div>
    </div>
    
    <script>
        // APIåŸºç¡€åœ°å€å¸¸é‡
        // ä½¿ç”¨å½“å‰é¡µé¢åŸŸåä½œä¸ºAPIåŸºç¡€åœ°å€ï¼Œä¾¿äºéƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
        const API_BASE_URL = `${window.location.origin}`;
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–DOMå…ƒç´ 
            const fileInput = document.getElementById('fileInput');
            const fileDropArea = document.getElementById('fileDropArea');
            const uploadBtn = document.getElementById('uploadBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const filesList = document.getElementById('filesList');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const notification = document.getElementById('notification');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const selectedFilesContainer = document.getElementById('selectedFilesContainer');
            const selectedFilesList = document.getElementById('selectedFilesList');
            const selectedFilesCount = document.getElementById('selectedFilesCount');
            const clearFilesBtn = document.getElementById('clearFilesBtn');
            
            // æ–°å»ºæ–‡ä»¶æ¨¡æ€æ¡†ç›¸å…³å…ƒç´ 
            const createFileModal = document.getElementById('createFileModal');
            const createFileBtn = document.getElementById('createFileBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelCreateFileBtn = document.getElementById('cancelCreateFileBtn');
            const confirmCreateFileBtn = document.getElementById('confirmCreateFileBtn');
            const fileNameInput = document.getElementById('fileName');
            const fileTypeSelect = document.getElementById('fileType');
            const fileContentTextarea = document.getElementById('fileContent');
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶éªŒè¯token
            const token = localStorage.getItem('access_token');
            let currentUser = null;
            
            function validateToken() {
                return new Promise((resolve, reject) => {
                    if (!token) {
                        reject(new Error('æœªæ‰¾åˆ°ç™»å½•ä¿¡æ¯'));
                        return;
                    }
                    
                    // è°ƒç”¨åç«¯éªŒè¯tokençš„æ¥å£
                    fetch(`${API_BASE_URL}/api/auth/verify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ token: token })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('TokenéªŒè¯å¤±è´¥');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.user_id) {
                            currentUser = data;
                            resolve(data);
                        } else {
                            reject(new Error('Tokenæ— æ•ˆ'));
                        }
                    })
                    .catch(error => {
                        reject(error);
                    });
                });
            }
            
            // åˆå§‹åŒ–é¡µé¢æ—¶éªŒè¯token
            validateToken()
                .catch(error => {
                    console.error('TokenéªŒè¯å¤±è´¥:', error);
                    showNotification('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                });
            
            // ç­‰å¾…tokenéªŒè¯åå†åŠ è½½æ–‡ä»¶åˆ—è¡¨
            validateToken().then(() => {
                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                if (currentUser && currentUser.username) {
                    document.querySelector('header h1').textContent = `${currentUser.username}çš„äº‘ç›˜`;
                }
                // åˆå§‹åŒ–æ–‡ä»¶å¤¹åŠŸèƒ½
                initFolderFeature();
                // åˆå§‹åŠ è½½æ–‡ä»¶åˆ—è¡¨
                loadFilesList();
            });
            
            // å…¨å±€æ•°ç»„ï¼Œç”¨äºå­˜å‚¨å·²é€‰æ‹©çš„æ–‡ä»¶
            let selectedFiles = [];
            
            // æ–‡ä»¶å¤¹ç®¡ç†ç›¸å…³å˜é‡
            let currentFolderPath = '/';
            let allFolders = {};
            
            // åˆå§‹åŒ–æ–‡ä»¶å¤¹åŠŸèƒ½
            function initFolderFeature() {
                const createFolderBtn = document.getElementById('createFolderBtn');
                const newFolderName = document.getElementById('newFolderName');
                const confirmFolderBtn = document.getElementById('confirmFolderBtn');
                const cancelFolderBtn = document.getElementById('cancelFolderBtn');
                
                // æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®ç‚¹å‡»
                createFolderBtn.addEventListener('click', function() {
                    createFolderBtn.style.display = 'none';
                    newFolderName.style.display = 'block';
                    confirmFolderBtn.style.display = 'inline-block';
                    cancelFolderBtn.style.display = 'inline-block';
                    newFolderName.focus();
                });
                
                // ç¡®è®¤åˆ›å»ºæ–‡ä»¶å¤¹
                confirmFolderBtn.addEventListener('click', async function() {
                    const folderName = newFolderName.value.trim();
                    if (!folderName) {
                        showNotification('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°', 'error');
                        return;
                    }
                    
                    try {
                        const newPath = currentFolderPath + folderName + '/';
                        const response = await fetch(`${API_BASE_URL}/api/cloud_disk/create-folder`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ folder_path: newPath })
                        });
                        
                        if (response.ok) {
                            showNotification('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ', 'success');
                            newFolderName.value = '';
                            newFolderName.style.display = 'none';
                            createFolderBtn.style.display = 'inline-block';
                            confirmFolderBtn.style.display = 'none';
                            cancelFolderBtn.style.display = 'none';
                            loadFilesList(); // åˆ·æ–°åˆ—è¡¨
                        } else {
                            showNotification('æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥', 'error');
                        }
                    } catch (error) {
                        console.error('åˆ›å»ºæ–‡ä»¶å¤¹é”™è¯¯:', error);
                        showNotification('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    }
                });
                
                // å–æ¶ˆåˆ›å»º
                cancelFolderBtn.addEventListener('click', function() {
                    newFolderName.value = '';
                    newFolderName.style.display = 'none';
                    createFolderBtn.style.display = 'inline-block';
                    confirmFolderBtn.style.display = 'none';
                    cancelFolderBtn.style.display = 'none';
                });
                
                // å›è½¦é”®åˆ›å»º
                newFolderName.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        confirmFolderBtn.click();
                    } else if (e.key === 'Escape') {
                        cancelFolderBtn.click();
                    }
                });
            }
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ–‡ä»¶åˆ—è¡¨
            function displaySelectedFiles() {
                if (selectedFiles.length === 0) {
                    selectedFilesContainer.style.display = 'none';
                    uploadBtn.disabled = true;
                    return;
                }
                
                // æ¸…ç©ºç°æœ‰åˆ—è¡¨
                selectedFilesList.innerHTML = '';
                
                // æ·»åŠ æ–‡ä»¶åˆ°åˆ—è¡¨
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const fileIcon = getFileIcon(file.name);
                    const fileSize = formatFileSize(file.size);
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <span class="file-item-icon">${fileIcon}</span>
                        <span class="file-item-name">${file.name}</span>
                        <span class="file-item-size">${fileSize}</span>
                        <button class="remove-file-btn" data-index="${i}">âœ•</button>
                    `;
                    
                    selectedFilesList.appendChild(fileItem);
                }
                
                // æ·»åŠ å•ä¸ªæ–‡ä»¶åˆ é™¤äº‹ä»¶ç›‘å¬
                document.querySelectorAll('.remove-file-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        selectedFiles.splice(index, 1);
                        displaySelectedFiles();
                    });
                });
                
                // æ›´æ–°æ–‡ä»¶è®¡æ•°
                selectedFilesCount.textContent = `å·²é€‰æ‹© ${selectedFiles.length} ä¸ªæ–‡ä»¶`;
                
                // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨å®¹å™¨
                selectedFilesContainer.style.display = 'block';
                uploadBtn.disabled = false;
            }
            
            // å…è®¸çš„æ–‡ä»¶æ‰©å±•ååˆ—è¡¨
                const ALLOWED_EXTENSIONS = {
                    // å›¾ç‰‡
                    'jpg': true, 'jpeg': true, 'png': true, 'gif': true, 'bmp': true, 'svg': true, 'webp': true,
                    // æ–‡æœ¬æ–‡ä»¶
                    'txt': true, 'md': true, 'csv': true, 'json': true, 'xml': true, 'html': true, 'css': true, 'js': true,
                    // æ–‡æ¡£
                    'doc': true, 'docx': true, 'pdf': true, 'rtf': true,
                    // è¡¨æ ¼
                    'xls': true, 'xlsx': true,
                    // æ¼”ç¤ºæ–‡ç¨¿
                    'ppt': true, 'pptx': true,
                    // è§†é¢‘
                    'mp4': true, 'avi': true, 'mov': true, 'wmv': true, 'flv': true, 'mkv': true,
                    // å‹ç¼©åŒ…
                    'zip': true, 'rar': true, '7z': true, 'tar': true, 'gz': true
                };
                
                // æ–‡ä»¶å¤§å°é™åˆ¶ï¼š100MB
                const MAX_FILE_SIZE = 100 * 1024 * 1024;
                
                // éªŒè¯æ–‡ä»¶æ ¼å¼å’Œå¤§å°
                function validateFile(file) {
                    // è·å–æ–‡ä»¶æ‰©å±•å
                    const fileExt = file.name.split('.').pop().toLowerCase();
                    
                    // æ£€æŸ¥æ–‡ä»¶æ ¼å¼
                    if (!ALLOWED_EXTENSIONS[fileExt]) {
                        return { valid: false, message: `ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: .${fileExt}` };
                    }
                    
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°
                    if (file.size > MAX_FILE_SIZE) {
                        return { valid: false, message: `æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ (æœ€å¤§100MB)` };
                    }
                    
                    return { valid: true };
                }
                
                // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
                fileInput.addEventListener('change', function() {
                    // å¦‚æœç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶ï¼ˆæ²¡æœ‰å–æ¶ˆï¼‰
                    if (this.files.length > 0) {
                        let hasInvalidFiles = false;
                        
                        // å°†æ–°é€‰æ‹©çš„æ–‡ä»¶æ·»åŠ åˆ°æ•°ç»„ä¸­
                        for (let i = 0; i < this.files.length; i++) {
                            const file = this.files[i];
                            
                            // éªŒè¯æ–‡ä»¶
                            const validation = validateFile(file);
                            if (!validation.valid) {
                                showNotification(`æ–‡ä»¶ "${file.name}": ${validation.message}`, 'error');
                                hasInvalidFiles = true;
                                continue;
                            }
                            
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ–‡ä»¶ï¼ˆé€šè¿‡æ–‡ä»¶åå’Œå¤§å°ï¼‰
                            const existingFileIndex = selectedFiles.findIndex(
                                f => f.name === file.name && f.size === file.size
                            );
                            
                            // åªæœ‰å½“æ–‡ä»¶ä¸å­˜åœ¨æ—¶æ‰æ·»åŠ 
                            if (existingFileIndex === -1) {
                                selectedFiles.push(file);
                            }
                        }
                        
                        // å¦‚æœæœ‰æ— æ•ˆæ–‡ä»¶ï¼Œæ˜¾ç¤ºæç¤º
                        if (hasInvalidFiles) {
                            showNotification('éƒ¨åˆ†æ–‡ä»¶ä¸ç¬¦åˆè¦æ±‚ï¼Œæœªæ·»åŠ åˆ°ä¸Šä¼ åˆ—è¡¨', 'warning');
                        }
                        
                        // æ˜¾ç¤ºæ›´æ–°åçš„æ–‡ä»¶åˆ—è¡¨
                        displaySelectedFiles();
                    }
                    
                    // é‡ç½®fileInputçš„å€¼ï¼Œè¿™æ ·ç”¨æˆ·å¯ä»¥å†æ¬¡é€‰æ‹©ç›¸åŒçš„æ–‡ä»¶
                    this.value = '';
                });
            
            // æ‹–æ”¾åŠŸèƒ½
                fileDropArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });
                
                fileDropArea.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                
                fileDropArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    
                    if (e.dataTransfer.files.length > 0) {
                        let hasInvalidFiles = false;
                        
                        // å°†æ‹–æ”¾çš„æ–‡ä»¶æ·»åŠ åˆ°å·²é€‰æ‹©çš„æ–‡ä»¶æ•°ç»„ä¸­
                        for (let i = 0; i < e.dataTransfer.files.length; i++) {
                            const file = e.dataTransfer.files[i];
                            
                            // éªŒè¯æ–‡ä»¶
                            const validation = validateFile(file);
                            if (!validation.valid) {
                                showNotification(`æ–‡ä»¶ "${file.name}": ${validation.message}`, 'error');
                                hasInvalidFiles = true;
                                continue;
                            }
                            
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ–‡ä»¶
                            const existingFileIndex = selectedFiles.findIndex(
                                f => f.name === file.name && f.size === file.size
                            );
                            
                            if (existingFileIndex === -1) {
                                selectedFiles.push(file);
                            }
                        }
                        
                        // å¦‚æœæœ‰æ— æ•ˆæ–‡ä»¶ï¼Œæ˜¾ç¤ºæç¤º
                        if (hasInvalidFiles) {
                            showNotification('éƒ¨åˆ†æ–‡ä»¶ä¸ç¬¦åˆè¦æ±‚ï¼Œæœªæ·»åŠ åˆ°ä¸Šä¼ åˆ—è¡¨', 'warning');
                        }
                        
                        displaySelectedFiles();
                    }
                });
            
            // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            uploadBtn.addEventListener('click', function() {
                if (selectedFiles.length === 0) {
                    showNotification('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                    return;
                }
                
                uploadFiles(selectedFiles);
            });
            
            // åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            refreshBtn.addEventListener('click', loadFilesList);
            
            // æ¸…é™¤é€‰ä¸­æ–‡ä»¶
            clearFilesBtn.addEventListener('click', function() {
                selectedFiles = [];
                fileInput.value = '';
                selectedFilesContainer.style.display = 'none';
                uploadBtn.disabled = true;
            });
            
            // æ‰“å¼€æ–°å»ºæ–‡ä»¶æ¨¡æ€æ¡†
            function openCreateFileModal() {
                createFileModal.style.display = 'flex';
                // æ¸…ç©ºè¡¨å•
                fileNameInput.value = '';
                fileTypeSelect.value = 'txt';
                fileContentTextarea.value = '';
                // èšç„¦åˆ°æ–‡ä»¶åè¾“å…¥æ¡†
                setTimeout(() => fileNameInput.focus(), 100);
            }
            
            // å…³é—­æ–°å»ºæ–‡ä»¶æ¨¡æ€æ¡†
            function closeCreateFileModal() {
                createFileModal.style.display = 'none';
            }
            
            // åˆ›å»ºæ–°æ–‡ä»¶
            async function createNewFile() {
                // éªŒè¯è¡¨å•
                const fileName = fileNameInput.value.trim();
                if (!fileName) {
                    showNotification('è¯·è¾“å…¥æ–‡ä»¶å', 'error');
                    fileNameInput.focus();
                    return;
                }
                
                const fileType = fileTypeSelect.value;
                const fileContent = fileContentTextarea.value;
                
                try {
                    showLoading(true);
                    
                    // å‡†å¤‡æ–‡ä»¶æ•°æ®
                    const formData = new FormData();
                    formData.append('file_name', fileName);
                    formData.append('file_type', fileType);
                    formData.append('file_content', fileContent);
                    
                    // å‘é€è¯·æ±‚
                    const response = await fetch(`${API_BASE_URL}/api/cloud_disk/create_file`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('åˆ›å»ºæ–‡ä»¶å¤±è´¥');
                    }
                    
                    const result = await response.json();
                    showNotification('æ–‡ä»¶åˆ›å»ºæˆåŠŸ', 'success');
                    closeCreateFileModal();
                    loadFilesList(); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                } catch (error) {
                    console.error('åˆ›å»ºæ–‡ä»¶é”™è¯¯:', error);
                    showNotification('åˆ›å»ºæ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                } finally {
                    showLoading(false);
                }
            }
            
            // æ–°å»ºæ–‡ä»¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            createFileBtn.addEventListener('click', openCreateFileModal);
            
            // å…³é—­æ¨¡æ€æ¡†äº‹ä»¶
            closeModalBtn.addEventListener('click', closeCreateFileModal);
            cancelCreateFileBtn.addEventListener('click', closeCreateFileModal);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            createFileModal.addEventListener('click', function(e) {
                if (e.target === createFileModal) {
                    closeCreateFileModal();
                }
            });
            
            // ç¡®è®¤åˆ›å»ºæ–‡ä»¶
            confirmCreateFileBtn.addEventListener('click', createNewFile);
            
            // ESCé”®å…³é—­æ¨¡æ€æ¡†
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && createFileModal.style.display === 'flex') {
                    closeCreateFileModal();
                }
            });
            
            // ä¸Šä¼ æ–‡ä»¶å‡½æ•° - å¸¦é‡è¯•æœºåˆ¶
            function uploadFiles(files, retryCount = 0, maxRetries = 3) {
                // ç¡®ä¿tokenæœ‰æ•ˆ
                validateToken().then(() => {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    showLoading(true);
                    
                    const formData = new FormData();
                    
                    // æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ°FormData
                    for (let i = 0; i < files.length; i++) {
                        formData.append('file', files[i]);
                    }
                    
                    // æ·»åŠ ç”¨æˆ·ID
                    if (currentUser && currentUser.user_id) {
                        formData.append('user_id', currentUser.user_id);
                    }
                    
                    // æ˜¾ç¤ºè¿›åº¦æ¡
                    progressContainer.style.display = 'block';
                    progressFill.style.width = '0%';
                    progressText.textContent = '0%';
                    
                    // åˆ›å»ºXMLHttpRequestä»¥æ”¯æŒè¿›åº¦ç›‘æ§
                    const xhr = new XMLHttpRequest();
                    
                    // ç›‘æ§ä¸Šä¼ è¿›åº¦
                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            progressFill.style.width = percentComplete + '%';
                            progressText.textContent = Math.round(percentComplete) + '%';
                        }
                    });
                    
                    // è¯·æ±‚å®Œæˆå¤„ç†
                    xhr.addEventListener('load', function() {
                        showLoading(false);
                        progressContainer.style.display = 'none';
                        
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                
                                // å¤„ç†ä¸Šä¼ ç»“æœ
                                if (response.success_count > 0) {
                                    let message = `æˆåŠŸä¸Šä¼  ${response.success_count} ä¸ªæ–‡ä»¶`;
                                    if (response.error_count > 0) {
                                        message += `ï¼Œæœ‰ ${response.error_count} ä¸ªæ–‡ä»¶ä¸Šä¼ å¤±è´¥`;
                                        // æ˜¾ç¤ºå¤±è´¥çš„æ–‡ä»¶ä¿¡æ¯
                                        if (response.errors && response.errors.length > 0) {
                                            response.errors.forEach(err => {
                                                showNotification(`æ–‡ä»¶ "${err.filename}": ${err.error}`, 'error');
                                            });
                                        }
                                    } else {
                                        // å…¨éƒ¨æˆåŠŸï¼Œæ¸…ç©ºé€‰æ‹©åˆ—è¡¨
                                        selectedFiles = [];
                                        fileInput.value = '';
                                        selectedFilesContainer.style.display = 'none';
                                        uploadBtn.disabled = true;
                                    }
                                    
                                    showNotification(message, response.error_count > 0 ? 'warning' : 'success');
                                    loadFilesList(); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                                } else {
                                    // æ‰€æœ‰æ–‡ä»¶éƒ½å¤±è´¥äº†
                                    let errorMsg = 'æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å¤±è´¥';
                                    try {
                                        const errorData = JSON.parse(xhr.responseText);
                                        if (errorData.errors && errorData.errors.length > 0) {
                                            errorData.errors.forEach(err => {
                                                showNotification(`æ–‡ä»¶ "${err.filename}": ${err.error}`, 'error');
                                            });
                                        }
                                    } catch (e) {
                                        errorMsg += ': ' + (xhr.responseText || 'æœªçŸ¥é”™è¯¯');
                                    }
                                    showNotification(errorMsg, 'error');
                                }
                            } catch (e) {
                                console.error('è§£æå“åº”å¤±è´¥:', e);
                                showNotification('ä¸Šä¼ æˆåŠŸï¼Œä½†å¤„ç†å“åº”æ—¶å‡ºé”™', 'error');
                            }
                        } else {
                            let errorMsg = 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥';
                            try {
                                const errorData = JSON.parse(xhr.responseText);
                                errorMsg += ': ' + (errorData.detail || xhr.statusText || 'æœªçŸ¥é”™è¯¯');
                            } catch {
                                errorMsg += ': ' + (xhr.statusText || 'æœªçŸ¥é”™è¯¯');
                            }
                            
                            // ç½‘ç»œé”™è¯¯æ—¶è‡ªåŠ¨é‡è¯•
                            if ((xhr.status === 0 || xhr.status >= 500) && retryCount < maxRetries) {
                                retryCount++;
                                const retryDelay = Math.pow(2, retryCount) * 1000; // æŒ‡æ•°é€€é¿ç­–ç•¥
                                
                                showNotification(`${errorMsg}ï¼Œ${retryCount}ç§’åå°è¯•ç¬¬${retryCount}æ¬¡é‡è¯•...`, 'warning');
                                
                                setTimeout(() => {
                                    uploadFiles(files, retryCount, maxRetries);
                                }, retryDelay);
                            } else {
                                // é‡è¯•æ¬¡æ•°ç”¨å®Œæˆ–ä¸æ˜¯ç½‘ç»œé”™è¯¯ï¼Œæ˜¾ç¤ºæœ€ç»ˆé”™è¯¯
                                showNotification(errorMsg, 'error');
                                
                                // æä¾›æ‰‹åŠ¨é‡è¯•é€‰é¡¹
                                if (confirm(`ä¸Šä¼ å¤±è´¥ã€‚æ˜¯å¦é‡è¯•ï¼Ÿ\n${errorMsg}`)) {
                                    uploadFiles(files, 0, maxRetries);
                                }
                            }
                        }
                    });
                    
                    // è¯·æ±‚é”™è¯¯å¤„ç†
                    xhr.addEventListener('error', function() {
                        showLoading(false);
                        progressContainer.style.display = 'none';
                        
                        // ç½‘ç»œé”™è¯¯æ—¶è‡ªåŠ¨é‡è¯•
                        if (retryCount < maxRetries) {
                            retryCount++;
                            const retryDelay = Math.pow(2, retryCount) * 1000; // æŒ‡æ•°é€€é¿ç­–ç•¥
                            
                            showNotification(`ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ å¤±è´¥ï¼Œ${retryCount}ç§’åå°è¯•ç¬¬${retryCount}æ¬¡é‡è¯•...`, 'warning');
                            
                            setTimeout(() => {
                                uploadFiles(files, retryCount, maxRetries);
                            }, retryDelay);
                        } else {
                            // é‡è¯•æ¬¡æ•°ç”¨å®Œ
                            showNotification('ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°', 'error');
                            
                            // æä¾›æ‰‹åŠ¨é‡è¯•é€‰é¡¹
                            if (confirm('ç½‘ç»œé”™è¯¯å¯¼è‡´ä¸Šä¼ å¤±è´¥ã€‚æ˜¯å¦é‡è¯•ï¼Ÿ')) {
                                uploadFiles(files, 0, maxRetries);
                            }
                        }
                    });
                    
                    // è¯·æ±‚è¶…æ—¶å¤„ç†
                    xhr.timeout = 30000; // 30ç§’è¶…æ—¶
                    xhr.addEventListener('timeout', function() {
                        showLoading(false);
                        progressContainer.style.display = 'none';
                        
                        // è¶…æ—¶æ—¶ä¹Ÿå¯ä»¥é‡è¯•
                        if (retryCount < maxRetries) {
                            retryCount++;
                            const retryDelay = Math.pow(2, retryCount) * 1000;
                            
                            showNotification(`ä¸Šä¼ è¶…æ—¶ï¼Œ${retryCount}ç§’åå°è¯•ç¬¬${retryCount}æ¬¡é‡è¯•...`, 'warning');
                            
                            setTimeout(() => {
                                uploadFiles(files, retryCount, maxRetries);
                            }, retryDelay);
                        } else {
                            showNotification('ä¸Šä¼ è¶…æ—¶ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°', 'error');
                            
                            if (confirm('ä¸Šä¼ è¶…æ—¶ã€‚æ˜¯å¦é‡è¯•ï¼Ÿ')) {
                                uploadFiles(files, 0, maxRetries);
                            }
                        }
                    });
                    
                    // å‘é€è¯·æ±‚
                    xhr.open('POST', `${API_BASE_URL}/api/files/upload`);
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                    xhr.send(formData);
                }).catch(error => {
                    showLoading(false);
                    showNotification('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                });
            }
            
            // åŠ è½½æ–‡ä»¶åˆ—è¡¨å‡½æ•°
            function loadFilesList() {
                // ç¡®ä¿tokenæœ‰æ•ˆ
                validateToken().then(() => {
                    showLoading(true);
                    
                    // æ ¹æ®ç”¨æˆ·IDè·å–å¯¹åº”æ–‡ä»¶åˆ—è¡¨ï¼Œæ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
                    const timestamp = new Date().getTime();
                    const url = currentUser && currentUser.user_id 
                        ? `${API_BASE_URL}/api/cloud_disk/files?user_id=${currentUser.user_id}&_=${timestamp}`
                        : `${API_BASE_URL}/api/cloud_disk/files?_=${timestamp}`;
                    
                    fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
                        }
                        return response.json();
                    })
                    .then(data => {
                        showLoading(false);
                        // å¦‚æœè¿”å›çš„æ˜¯æ–°æ ¼å¼ï¼ˆå«treeå­—æ®µï¼‰ï¼Œä½¿ç”¨æ ‘å½¢ç»“æ„æ¸²æŸ“
                        if (data.tree) {
                            renderFileTree(data.tree);
                        } else if (Array.isArray(data)) {
                            // å…¼å®¹æ—§æ ¼å¼
                            renderFilesList(data);
                        }
                    })
                    .catch(error => {
                        showLoading(false);
                        console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨é”™è¯¯:', error);
                        showNotification('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                        // æ˜¾ç¤ºç©ºçŠ¶æ€
                        filesList.innerHTML = `
                            <tr class="empty-state">
                                <td colspan="4">
                                    <i>ğŸ“‚</i>
                                    <h3>åŠ è½½å¤±è´¥</h3>
                                    <p>æ— æ³•åŠ è½½æ–‡ä»¶åˆ—è¡¨ï¼Œè¯·ç¨åé‡è¯•</p>
                                </td>
                            </tr>
                        `;
                    });
                }).catch(error => {
                    showLoading(false);
                    showNotification('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                });
            }
            
            // æ ‘å½¢ç»“æ„æ¸²æŸ“å‡½æ•°
            function renderFileTree(treeData) {
                if (!treeData || treeData.length === 0) {
                    filesList.innerHTML = `
                        <tr class="empty-state">
                            <td colspan="4">
                                <i>ğŸ“‚</i>
                                <h3>æš‚æ— æ–‡ä»¶</h3>
                                <p>ä¸Šä¼ æ‚¨çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶å¼€å§‹ä½¿ç”¨äº‘ç›˜åŠŸèƒ½</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                filesList.innerHTML = '';
                
                // é€’å½’æ¸²æŸ“æ ‘ç»“æ„
                function renderTreeNode(node, level = 0) {
                    const paddingLeft = level * 20;
                    const nodeId = `tree-node-${node.path.replace(/\//g, '-')}`;
                    
                    // æ¸²æŸ“æ–‡ä»¶å¤¹
                    if (node.type === 'folder') {
                        const isExpanded = node.is_expanded !== false;
                        const hasChildren = node.children && node.children.length > 0;
                        const toggleId = `toggle-${nodeId}`;
                        
                        // æ–‡ä»¶å¤¹è¡Œ
                        const folderRow = document.createElement('tr');
                        folderRow.className = 'folder-row';
                        folderRow.style.backgroundColor = '#f9f9f9';
                        folderRow.innerHTML = `
                            <td style="padding-left: ${paddingLeft}px;">
                                <div class="folder-header" style="display: flex; align-items: center; gap: 10px;">
                                    ${hasChildren ? `<button id="${toggleId}" class="folder-toggle" style="background: none; border: none; cursor: pointer; font-size: 12px; padding: 0; width: 20px; font-weight: bold;">${isExpanded ? 'â–¼' : 'â–¶'}</button>` : '<span style="width: 20px;"></span>'}
                                    <span style="font-weight: 600;">ğŸ“ ${node.name}</span>
                                    <span style="color: #999; font-size: 0.85rem;">(${node.children ? node.children.length : 0})</span>
                                </div>
                            </td>
                            <td></td>
                            <td></td>
                            <td></td>
                        `;
                        filesList.appendChild(folderRow);
                        
                        // ç»™æ–‡ä»¶å¤¹è¡Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆä»…åœ¨æœ‰å­å…ƒç´ æ—¶ï¼‰
                        if (hasChildren) {
                            const toggleBtn = document.getElementById(toggleId);
                            if (toggleBtn) {
                                toggleBtn.onclick = function(e) {
                                    e.stopPropagation();
                                    const isCurrentlyExpanded = toggleBtn.textContent === 'â–¼';
                                    toggleBtn.textContent = isCurrentlyExpanded ? 'â–¶' : 'â–¼';
                                    
                                    // åˆ‡æ¢å­å…ƒç´ çš„æ˜¾ç¤º
                                    const childRows = document.querySelectorAll(`[data-parent="${nodeId}"]`);
                                    childRows.forEach(row => {
                                        row.style.display = isCurrentlyExpanded ? 'none' : '';
                                    });
                                };
                            }
                        }
                        
                        // æ¸²æŸ“æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶å’Œå­æ–‡ä»¶å¤¹
                        if (node.children && node.children.length > 0) {
                            node.children.forEach(item => {
                                // åŒºåˆ†æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
                                if (item.type === 'file') {
                                    // æ¸²æŸ“æ–‡ä»¶
                                    const fileRow = document.createElement('tr');
                                    fileRow.setAttribute('data-parent', nodeId);
                                    fileRow.className = 'file-row';
                                    fileRow.style.display = isExpanded ? '' : 'none';
                                    
                                    const fileIcon = getFileIcon(item.original_name || '');
                                    fileRow.innerHTML = `
                                        <td style="padding-left: ${paddingLeft + 40}px;">
                                            <div class="file-icon">
                                                <span>${fileIcon}</span>
                                                <span class="file-name">${item.original_name || 'æœªå‘½åæ–‡ä»¶'}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="file-size">${formatFileSize(item.file_size)}</span>
                                        </td>
                                        <td>
                                            <span class="file-date">${formatDate(item.upload_time)}</span>
                                        </td>
                                        <td>
                                            <div class="file-actions">
                                                <a href="#" class="action-btn download-btn" data-file-id="${item.id}" data-file-name="${item.original_name}">
                                                    <span>â¬‡ï¸</span> ä¸‹è½½
                                                </a>
                                                <button class="action-btn delete-btn" data-file-id="${item.id}">
                                                    <span>ğŸ—‘ï¸</span> åˆ é™¤
                                                </button>
                                            </div>
                                        </td>
                                    `;
                                    filesList.appendChild(fileRow);
                                } else if (item.type === 'folder') {
                                    // é€’å½’æ¸²æŸ“å­æ–‡ä»¶å¤¹
                                    renderTreeNode(item, level + 1);
                                }
                            });
                        }
                    }
                }
                
                // æ¸²æŸ“æ‰€æœ‰æ ‘èŠ‚ç‚¹
                treeData.forEach(node => renderTreeNode(node));
                
                // é‡æ–°ç»‘å®šåˆ é™¤å’Œä¸‹è½½äº‹ä»¶
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const fileId = this.getAttribute('data-file-id');
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                            deleteFile(fileId);
                        }
                    });
                });
                
                document.querySelectorAll('.download-btn').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const fileId = this.getAttribute('data-file-id');
                        const fileName = this.getAttribute('data-file-name');
                        if (fileId) {
                            downloadFile(fileId, fileName);
                        } else {
                            showNotification('æ–‡ä»¶ä¸‹è½½é“¾æ¥æ— æ•ˆ', 'error');
                        }
                    });
                });
            }
            
            // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
            function renderFilesList(files) {
                if (!files || files.length === 0) {
                    filesList.innerHTML = `
                        <tr class="empty-state">
                            <td colspan="4">
                                <i>ğŸ“‚</i>
                                <h3>æš‚æ— æ–‡ä»¶</h3>
                                <p>ä¸Šä¼ æ‚¨çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶å¼€å§‹ä½¿ç”¨äº‘ç›˜åŠŸèƒ½</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                filesList.innerHTML = '';
                
                // æŒ‰æ–‡ä»¶åç¼€åˆ†ç±»
                const categorizedFiles = {};
                
                files.forEach(file => {
                    // è·å–æ–‡ä»¶åç¼€ï¼ˆå°å†™ï¼‰ï¼Œæ— åç¼€çš„æ–‡ä»¶å½’ä¸º'other'
                    const fileExtension = file.original_name.includes('.') 
                        ? file.original_name.split('.').pop().toLowerCase() 
                        : 'other';
                    
                    if (!categorizedFiles[fileExtension]) {
                        categorizedFiles[fileExtension] = [];
                    }
                    categorizedFiles[fileExtension].push(file);
                });
                
                // å®šä¹‰åç¼€åˆ†ç±»çš„æ˜¾ç¤ºé¡ºåºï¼ˆå¸¸ç”¨ç±»å‹ä¼˜å…ˆï¼‰
                const extensionOrder = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 
                                       'jpg', 'jpeg', 'png', 'gif', 'svg', 'bmp', 
                                       'mp4', 'avi', 'mov', 'wmv', 'flv', 
                                       'mp3', 'wav', 'flac', 'aac', 
                                       'zip', 'rar', '7z', 'tar', 'gz', 
                                       'txt', 'md', 'html', 'css', 'js', 'json', 'xml', 
                                       'other'];
                
                // æŒ‰æŒ‡å®šé¡ºåºå¤„ç†æ–‡ä»¶åˆ†ç±»
                extensionOrder.forEach(ext => {
                    if (categorizedFiles[ext]) {
                        // æŒ‰ä¸Šä¼ æ—¶é—´é™åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                        categorizedFiles[ext].sort((a, b) => {
                            return new Date(b.upload_time) - new Date(a.upload_time);
                        });
                        
                        // æ·»åŠ åˆ†ç±»æ ‡é¢˜è¡Œ
                        const categoryRow = document.createElement('tr');
                        categoryRow.className = 'category-header';
                        categoryRow.innerHTML = `
                            <td colspan="4">
                                <div class="category-title">
                                    <span>${ext.toUpperCase() === 'OTHER' ? 'å…¶ä»–æ–‡ä»¶' : ext.toUpperCase() + ' æ–‡ä»¶'}</span>
                                    <span class="file-count">(${categorizedFiles[ext].length}ä¸ªæ–‡ä»¶)</span>
                                </div>
                            </td>
                        `;
                        filesList.appendChild(categoryRow);
                        
                        // æ¸²æŸ“è¯¥åˆ†ç±»ä¸‹çš„æ–‡ä»¶
                        categorizedFiles[ext].forEach(file => {
                            const row = document.createElement('tr');
                            
                            // è·å–æ–‡ä»¶å›¾æ ‡ï¼Œä½¿ç”¨original_nameä½œä¸ºæ–‡ä»¶å
                            const fileIcon = getFileIcon(file.original_name);
                            
                            row.innerHTML = `
                                <td>
                                    <div class="file-icon">
                                        <span>${fileIcon}</span>
                                        <span class="file-name">${file.original_name}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="file-size">${formatFileSize(file.file_size)}</span>
                                </td>
                                <td>
                                    <span class="file-date">${formatDate(file.upload_time)}</span>
                                </td>
                                <td>
                                    <div class="file-actions">
                                        <a href="#" class="action-btn download-btn" data-file-id="${file.id}" data-file-name="${file.original_name}">
                                            <span>â¬‡ï¸</span> ä¸‹è½½
                                        </a>
                                        <button class="action-btn delete-btn" data-file-id="${file.id}">
                                            <span>ğŸ—‘ï¸</span> åˆ é™¤
                                        </button>
                                    </div>
                                </td>
                            `;
                            
                            filesList.appendChild(row);
                        });
                    }
                });
                
                // å¤„ç†æœªåœ¨extensionOrderä¸­åˆ—å‡ºçš„å…¶ä»–åç¼€
                Object.keys(categorizedFiles).forEach(ext => {
                    if (!extensionOrder.includes(ext)) {
                        // æŒ‰ä¸Šä¼ æ—¶é—´é™åºæ’åº
                        categorizedFiles[ext].sort((a, b) => {
                            return new Date(b.upload_time) - new Date(a.upload_time);
                        });
                        
                        // æ·»åŠ åˆ†ç±»æ ‡é¢˜è¡Œ
                        const categoryRow = document.createElement('tr');
                        categoryRow.className = 'category-header';
                        categoryRow.innerHTML = `
                            <td colspan="4">
                                <div class="category-title">
                                    <span>${ext.toUpperCase()} æ–‡ä»¶</span>
                                    <span class="file-count">(${categorizedFiles[ext].length}ä¸ªæ–‡ä»¶)</span>
                                </div>
                            </td>
                        `;
                        filesList.appendChild(categoryRow);
                        
                        // æ¸²æŸ“è¯¥åˆ†ç±»ä¸‹çš„æ–‡ä»¶
                        categorizedFiles[ext].forEach(file => {
                            const row = document.createElement('tr');
                            const fileIcon = getFileIcon(file.original_name);
                            
                            row.innerHTML = `
                                <td>
                                    <div class="file-icon">
                                        <span>${fileIcon}</span>
                                        <span class="file-name">${file.original_name}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="file-size">${formatFileSize(file.file_size)}</span>
                                </td>
                                <td>
                                    <span class="file-date">${formatDate(file.upload_time)}</span>
                                </td>
                                <td>
                                    <div class="file-actions">
                                        <a href="#" class="action-btn download-btn" data-file-id="${file.id}" data-file-name="${file.original_name}">
                                            <span>â¬‡ï¸</span> ä¸‹è½½
                                        </a>
                                        <button class="action-btn delete-btn" data-file-id="${file.id}">
                                            <span>ğŸ—‘ï¸</span> åˆ é™¤
                                        </button>
                                    </div>
                                </td>
                            `;
                            
                            filesList.appendChild(row);
                        });
                    }
                });
                
                // æ·»åŠ CSSæ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .category-header {
                    background-color: #f5f7fa;
                    border-top: 2px solid #e6eaf0;
                    margin-top: 10px;
                }
                .category-header:first-child {
                    margin-top: 0;
                }
                .category-title {
                    padding: 8px 15px;
                    font-weight: bold;
                    color: #333;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                }
                .file-count {
                    font-size: 12px;
                    color: #666;
                    font-weight: normal;
                }
                /* åˆ é™¤æŒ‰é’®æ ·å¼ */
                .remove-file-btn {
                    background-color: #ff4757;
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    font-size: 12px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-left: auto;
                    transition: background-color 0.2s;
                }
                .remove-file-btn:hover {
                    background-color: #ff3742;
                }
                /* æ–‡ä»¶é¡¹å¸ƒå±€è°ƒæ•´ */
                .file-item {
                    display: flex;
                    align-items: center;
                    padding: 5px 0;
                }
                .file-item-icon,
                .file-item-name,
                .file-item-size {
                    margin-right: 10px;
                }
                .file-item-name {
                    flex: 1;
                }
            `;
            document.head.appendChild(style);
            
            // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const fileId = this.getAttribute('data-file-id');
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                            deleteFile(fileId);
                        }
                    });
                });
                
                // ä¸ºä¸‹è½½é“¾æ¥æ·»åŠ æˆæƒå¤´
                document.querySelectorAll('.download-btn').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        // ç›´æ¥ä»dataå±æ€§è·å–æ–‡ä»¶IDå’Œæ–‡ä»¶å
                        const fileId = this.getAttribute('data-file-id');
                        const fileName = this.getAttribute('data-file-name');
                        if (fileId) {
                            downloadFile(fileId, fileName);
                        } else {
                            showNotification('æ–‡ä»¶ä¸‹è½½é“¾æ¥æ— æ•ˆ', 'error');
                        }
                    });
                });
            }
            
            // åˆ é™¤æ–‡ä»¶å‡½æ•°
            function deleteFile(fileId) {
                // ç¡®ä¿tokenæœ‰æ•ˆ
                validateToken().then(() => {
                    showLoading(true);
                    
                    fetch(`${API_BASE_URL}/api/files/${fileId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        showLoading(false);
                        
                        if (response.ok) {
                            showNotification('æ–‡ä»¶åˆ é™¤æˆåŠŸ', 'success');
                            loadFilesList(); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                        } else {
                            showNotification('æ–‡ä»¶åˆ é™¤å¤±è´¥', 'error');
                        }
                    })
                    .catch(error => {
                        showLoading(false);
                        showNotification('åˆ é™¤æ–‡ä»¶æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    });
                }).catch(error => {
                    showLoading(false);
                    showNotification('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                });
            }
            
            // ä¸‹è½½æ–‡ä»¶å‡½æ•°
            function downloadFile(fileId, filename) {
                // ç¡®ä¿tokenæœ‰æ•ˆ
                validateToken().then(() => {
                    showLoading(true);
                    
                    // è·å–ç”¨æˆ·ID
                    const userId = currentUser.user_id;
                    
                    fetch(`${API_BASE_URL}/api/cloud_disk/download/${fileId}?user_id=${userId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        showLoading(false);
                        
                        if (!response.ok) {
                            throw new Error('æ–‡ä»¶ä¸‹è½½å¤±è´¥');
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // åˆ›å»ºä¸‹è½½é“¾æ¥å¹¶è§¦å‘ä¸‹è½½
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        
                        // æ¸…ç†
                        setTimeout(() => {
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                        }, 100);
                    })
                    .catch(error => {
                        showLoading(false);
                        showNotification('ä¸‹è½½æ–‡ä»¶æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    });
                }).catch(error => {
                    showLoading(false);
                    showNotification('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                });
            }
            
            // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
                else return (bytes / 1048576).toFixed(2) + ' MB';
            }
            
            // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸ
              function formatDate(dateString) {
                  // ç›´æ¥ä½¿ç”¨æœ¬åœ°æ—¶é—´æ–¹æ³•è§£ææ—¥æœŸï¼Œç¡®ä¿æ­£ç¡®æ˜¾ç¤ºåç«¯è¿”å›çš„åŸå§‹æ—¶é—´
                  const date = new Date(dateString);
                  
                  // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                  if (isNaN(date.getTime())) {
                      return 'æ—¶é—´æœªçŸ¥';
                  }
                  
                  // ä½¿ç”¨æœ¬åœ°æ—¶é—´æ–¹æ³•è·å–æ—¥æœŸå’Œæ—¶é—´
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  const day = String(date.getDate()).padStart(2, '0');
                  const hours = String(date.getHours()).padStart(2, '0');
                  const minutes = String(date.getMinutes()).padStart(2, '0');
                  
                  return `${year}/${month}/${day} ${hours}:${minutes}`;
            }
            
            // è¾…åŠ©å‡½æ•°ï¼šè·å–æ–‡ä»¶å›¾æ ‡
            function getFileIcon(filename) {
                if (!filename || typeof filename !== 'string') {
                    return 'ğŸ“„';
                }
                
                const extension = filename.split('.').pop().toLowerCase();
                
                const iconMap = {
                    // æ–‡æ¡£ç±»
                    'txt': 'ğŸ“„', 'pdf': 'ğŸ“‘', 'doc': 'ğŸ“ƒ', 'docx': 'ğŸ“ƒ',
                    'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š', 'ppt': 'ğŸ“½ï¸', 'pptx': 'ğŸ“½ï¸',
                    // å›¾ç‰‡ç±»
                    'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸', 'bmp': 'ğŸ–¼ï¸', 'svg': 'ğŸ–¼ï¸',
                    // è§†é¢‘ç±»
                    'mp4': 'ğŸ¬', 'avi': 'ğŸ¬', 'mov': 'ğŸ¬', 'wmv': 'ğŸ¬', 'flv': 'ğŸ¬', 'mkv': 'ğŸ¬',
                    // å‹ç¼©åŒ…
                    'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦', '7z': 'ğŸ“¦', 'tar': 'ğŸ“¦', 'gz': 'ğŸ“¦',
                    // ä»£ç æ–‡ä»¶
                    'py': 'ğŸ', 'js': 'ğŸ“', 'html': 'ğŸŒ', 'css': 'ğŸ¨', 'java': 'â˜•', 'cpp': 'ğŸ”§'
                };
                
                return iconMap[extension] || 'ğŸ“„';
            }
            
            // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
            function showLoading(show) {
                loadingOverlay.style.display = show ? 'flex' : 'none';
            }
            
            // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºé€šçŸ¥
            function showNotification(message, type = 'success') {
                notification.textContent = message;
                notification.className = 'notification ' + type;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        });
    </script>
</body>
</html>