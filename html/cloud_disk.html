    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>‰∫ëÁõòÁÆ°ÁêÜ - AIÊô∫ËÉΩÂ≠¶‰π†ÂØºÂ∏à</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }
            *::before,
            *::after {
                box-sizing: border-box;
            }
            
            :root {
                --primary-color: #3498db;
                --secondary-color: #2980b9;
                --accent-color: #e74c3c;
                --light-color: #ecf0f1;
                --dark-color: #2c3e50;
                --success-color: #27ae60;
                --gray-color: #95a5a6;
                --light-gray: #f1f2f3;
                --input-bg: #f7f9fc;
                --gradient-start: #2563eb;
                --gradient-end: #38bdf8;
                --card-border: rgba(15, 23, 42, 0.08);
                --shadow-soft: 0 20px 45px -20px rgba(15, 23, 42, 0.35);
                --chip-bg: rgba(59, 130, 246, 0.12);
                --chip-color: #2563eb;
                --icon-btn-bg: rgba(15, 23, 42, 0.08);
                --toolbar-btn-bg: rgba(59, 130, 246, 0.06);
                --toolbar-btn-border: rgba(59, 130, 246, 0.2);
                
                /* Êó•Èó¥Ê®°ÂºèËÉåÊôØÂíåÊñáÊú¨È¢úËâ≤ */
                --bg-primary: #f5f7fa;
                --bg-secondary: white;
                --text-primary: #333;
                --text-secondary: #666;
                --border-color: #eee;
                --chat-bg: #fafafa;
                --ai-message-bg: #e6e6e6;
            }
            
            /* Â§úÈó¥Ê®°ÂºèÂèòÈáè - ‰∏é‰∏ªÈ°µÈù¢‰øùÊåÅ‰∏ÄËá¥ */
            body.dark-mode {
                --bg-primary: #121212;
                --bg-secondary: #1e1e1e;
                --text-primary: #e0e0e0;
                --text-secondary: #b0b0b0;
                --border-color: #333;
                --gray-color: #707070;
                --light-gray: #333;
                --input-bg: #222;
                --card-border: rgba(148, 163, 184, 0.2);
                --shadow-soft: 0 24px 45px -20px rgba(15, 23, 42, 0.6);
                --chip-bg: rgba(59, 130, 246, 0.18);
                --chip-color: #93c5fd;
                --icon-btn-bg: rgba(148, 163, 184, 0.2);
                --toolbar-btn-bg: rgba(148, 163, 184, 0.08);
                --toolbar-btn-border: rgba(59, 130, 246, 0.35);
                --chat-bg: #2a2a2a;
                --ai-message-bg: #3d3d3d;
            }
            
            /* Â§úÈó¥Ê®°Âºè‰∏ãÁöÑÊåâÈíÆÊ†∑Âºè */
            body.dark-mode .btn-secondary {
                background-color: #333;
                color: #e0e0e0;
                border: 1px solid #555;
            }
            
            body.dark-mode .btn-secondary:hover {
                background-color: #444;
                color: white;
            }
            
            body {
                background: linear-gradient(180deg, var(--bg-primary), #eef2ff);
                color: var(--text-primary);
                line-height: 1.6;
                -webkit-font-smoothing: antialiased;
                min-height: 100vh;
                transition: background-color 0.3s ease, color 0.3s ease, background-image 0.3s ease;
            }
            
            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 32px 28px 56px;
                display: flex;
                flex-direction: column;
                gap: 24px;
            }
            
            /* ËøîÂõûÊåâÈíÆ */
            .back-btn {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 10px 18px;
                background-color: var(--bg-secondary);
                color: var(--text-primary);
                border-radius: 8px;
                text-decoration: none;
                transition: all 0.3s ease;
                font-size: 0.9rem;
                font-weight: 500;
                border: 1px solid var(--card-border);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }
            
            .back-btn:hover {
                background-color: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(52, 152, 219, 0.2);
            }
            
            /* Â§¥ÈÉ® */
            header {
                background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
                color: white;
                padding: 30px;
                border-radius: 12px;
                margin-bottom: 0;
                box-shadow: var(--shadow-soft);
                position: relative;
                overflow: hidden;
            }
            
            header::after {
                content: '';
                position: absolute;
                top: -50%;
                right: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
                animation: float 6s ease-in-out infinite;
            }
            
            @keyframes float {
                0%, 100% { transform: translateY(0%) rotate(0deg); }
                50% { transform: translateY(-10%) rotate(5deg); }
            }
            
            header h1 {
                font-size: 2.2rem;
                margin-bottom: 10px;
                position: relative;
                z-index: 1;
                font-weight: 700;
            }
            
            header p {
                opacity: 0.9;
                font-size: 1rem;
                position: relative;
                z-index: 1;
                max-width: 800px;
            }
            
            /* Ë∑ØÂæÑÊòæÁ§∫ */
            .breadcrumb {
                background: var(--bg-secondary);
                padding: 16px 24px;
                border-radius: 10px;
                margin-bottom: 0;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                border: 1px solid var(--card-border);
                font-size: 0.95rem;
                color: var(--text-primary);
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .breadcrumb-label {
                color: var(--gray-color);
                font-weight: 600;
                white-space: nowrap;
            }
            
            .breadcrumb-path {
                color: var(--chip-color);
                font-family: 'Monaco', 'Courier New', monospace;
                background-color: var(--chip-bg);
                padding: 4px 12px;
                border-radius: 16px;
                font-size: 0.9rem;
                font-weight: 500;
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            /* ÂÖ®Â±èÈ¢ÑËßàÊ†∑Âºè */
            .fullscreen-preview-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-color: rgba(0, 0, 0, 0.9);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .fullscreen-preview-content {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                position: relative;
            }
            
            .fullscreen-preview-controls {
                position: absolute;
                top: 20px;
                right: 20px;
                display: flex;
                gap: 10px;
                z-index: 10;
            }
            
            .fullscreen-preview-btn {
                background-color: rgba(255, 255, 255, 0.2);
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                font-size: 16px;
                cursor: pointer;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
                transition: all 0.3s ease;
                outline: none;
            }
            
            .fullscreen-preview-btn:hover {
                background-color: rgba(255, 255, 255, 0.3);
                transform: scale(1.05);
            }
            
            .fullscreen-preview-btn:active {
                transform: scale(0.95);
            }
            
            .fullscreen-preview-btn:focus {
                box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.5);
            }
            
            /* ÊåâÈíÆÂõæÊ†áÊ†∑Âºè‰ºòÂåñ */
            .fullscreen-preview-btn i {
                pointer-events: none;
            }
            
            /* ÁßªÂä®ËÆæÂ§á‰∏äÊåâÈíÆÂ∞∫ÂØ∏Ë∞ÉÊï¥ */
            @media (max-width: 768px) {
                .fullscreen-preview-btn {
                    width: 48px;
                    height: 48px;
                    font-size: 20px;
                }
                
                .fullscreen-preview-controls {
                    top: 10px;
                    right: 10px;
                    gap: 8px;
                }
            }
            
            .fullscreen-preview-wrapper {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }
            
            .fullscreen-preview-wrapper img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
                transition: transform 0.3s ease;
            }
            
            .fullscreen-preview-wrapper iframe {
                width: 100%;
                height: 100%;
                border: none;
            }
            
            /* Âä†ËΩΩÁä∂ÊÄÅÊ†∑Âºè */
            .loading-indicator {
                color: #ffffff;
                font-size: 18px;
                padding: 20px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                animation: pulse 1.5s ease-in-out infinite;
            }
            
            /* ÈîôËØØÊ∂àÊÅØÊ†∑Âºè */
            .error-message {
                color: #ff6b6b;
                font-size: 16px;
                padding: 20px;
                background: rgba(255, 107, 107, 0.1);
                border: 1px solid rgba(255, 107, 107, 0.3);
                border-radius: 8px;
                text-align: center;
                max-width: 400px;
            }
            
            /* ËÑâÂÜ≤Âä®ÁîªÔºåÂ¢ûÂº∫Âä†ËΩΩÁä∂ÊÄÅÁöÑÂèØËßÜÊÄß */
            @keyframes pulse {
                0% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.7;
                }
                100% {
                    opacity: 1;
                }
            }
            
            /* ‰∏ªÂÆπÂô® - ‰∏§ÂàóÂ∏ÉÂ±Ä */
            .main-content {
                display: grid;
                grid-template-columns: 300px 1fr;
                grid-auto-rows: 1fr;
                gap: 28px;
                margin-bottom: 40px;
                min-height: 65vh;
                align-items: start;
            }
            
            @media (max-width: 768px) {
                .main-content {
                    grid-template-columns: 1fr;
                    gap: 20px;
                }
            }
            
            /* Êñá‰ª∂Êìç‰ΩúÂ∑•ÂÖ∑Ê†è */
            .file-operations-toolbar {
                display: flex;
                gap: 10px;
                padding: 15px 20px;
                background: var(--light-gray);
                border-bottom: 1px solid var(--border-color);
                align-items: center;
                min-height: 50px;
            }
            
            .file-operations-toolbar.hidden {
                display: none;
            }
            
            .toolbar-info {
                flex: 1;
                font-size: 0.9rem;
                color: var(--dark-color);
                font-weight: 500;
            }
            
            .toolbar-actions {
                display: flex;
                gap: 8px;
                align-items: center;
                flex-wrap: wrap;
            }
            
            .selection-actions-group {
                display: flex;
                gap: 8px;
                align-items: center;
                flex-wrap: wrap;
            }
            
            .toolbar-btn {
                padding: 10px 18px;
                border: 1px solid transparent;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
                white-space: nowrap;
                font-weight: 500;
                position: relative;
                overflow: hidden;
            }
            
            .toolbar-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                transition: left 0.5s ease;
            }
            
            .toolbar-btn:hover::before {
                left: 100%;
            }
            
            .toolbar-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            
            .toolbar-btn:active {
                transform: translateY(0);
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            }
            
            .toolbar-btn-primary {
                background-color: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }
            
            .toolbar-btn-primary:hover {
                background-color: var(--secondary-color);
                border-color: var(--secondary-color);
                box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
            }
            
            .toolbar-btn-danger {
                background-color: var(--accent-color);
                color: white;
                border-color: var(--accent-color);
            }
            
            .toolbar-btn-danger:hover {
                background-color: #c0392b;
                border-color: #c0392b;
                box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
            }
            
            .toolbar-btn-success {
                background-color: var(--success-color);
                color: white;
                border-color: var(--success-color);
            }
            
            .toolbar-btn-success:hover {
                background-color: #229954;
                border-color: #229954;
                box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
            }
            
            .toolbar-btn-secondary {
                background-color: var(--light-color);
                color: var(--dark-color);
                border-color: var(--border-color);
            }
            
            .toolbar-btn-secondary:hover {
                background-color: var(--bg-secondary);
                border-color: var(--primary-color);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            
            /* Â∑¶‰æßÊñá‰ª∂Â§πÈù¢Êùø */
            .folder-panel {
                background: var(--bg-secondary);
                border-radius: 12px;
                box-shadow: var(--shadow-soft);
                border: 1px solid var(--card-border);
                overflow: hidden;
                display: flex;
                flex-direction: column;
                min-height: 100%;
                transition: all 0.3s ease;
            }
            
            .folder-panel:hover {
                transform: translateY(-2px);
                box-shadow: 0 25px 50px -20px rgba(15, 23, 42, 0.4);
            }
            
            .folder-panel-header {
                background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
                color: white;
                padding: 20px 24px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 12px;
                position: relative;
                overflow: hidden;
            }
            
            .folder-panel-header::after {
                content: '';
                position: absolute;
                top: -50%;
                right: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
                animation: float 8s ease-in-out infinite;
            }
            
            .folder-panel-header span {
                font-size: 1.3rem;
                position: relative;
                z-index: 1;
            }
            
            .folder-tree {
                flex: 1;
                overflow-y: auto;
                padding: 10px 0;
            }
            
            .folder-tree::-webkit-scrollbar {
                width: 6px;
            }
            
            .folder-tree::-webkit-scrollbar-track {
                background: transparent;
            }
            
            .folder-tree::-webkit-scrollbar-thumb {
                background: var(--light-gray);
                border-radius: 3px;
            }
            
            .folder-tree::-webkit-scrollbar-thumb:hover {
                background: var(--gray-color);
            }
            
            .folder-item {
                padding: 12px 15px;
                cursor: pointer;
                transition: all 0.2s;
                border-left: 3px solid transparent;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 0.95rem;
                color: var(--dark-color);
                user-select: none;
            }
            
            .folder-item:hover {
                background-color: var(--light-gray);
            }
            
            .folder-item.active {
                background-color: rgba(52, 152, 219, 0.1);
                border-left-color: var(--primary-color);
                color: var(--primary-color);
                font-weight: 600;
            }
            
            .folder-item-icon {
                font-size: 1rem;
                flex-shrink: 0;
            }
            
            .folder-item-name {
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .folder-item-toggle {
                background: none;
                border: none;
                cursor: pointer;
                color: var(--gray-color);
                font-size: 0.8rem;
                padding: 0;
                flex-shrink: 0;
            }
            
            .folder-item-nested {
                padding-left: 35px;
                font-size: 0.9rem;
                color: var(--gray-color);
            }
            
            /* Âè≥‰æßÂÜÖÂÆπÂå∫Âüü */
            .content-panel {
                background: var(--bg-secondary);
                border-radius: 12px;
                box-shadow: var(--shadow-soft);
                border: 1px solid var(--card-border);
                overflow: hidden;
                display: flex;
                flex-direction: column;
                height: 600px; /* Âõ∫ÂÆöÈ´òÂ∫¶ */
                transition: all 0.3s ease;
            }
            
            .content-panel:hover {
                transform: translateY(-2px);
                box-shadow: 0 25px 50px -20px rgba(15, 23, 42, 0.4);
            }
            
            .content-header {
                background: var(--toolbar-btn-bg);
                padding: 20px 24px;
                border-bottom: 1px solid var(--card-border);
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 16px;
            }
            
            .content-header-title {
                font-weight: 600;
                color: var(--text-primary);
                font-size: 1.1rem;
                flex: 1;
            }
            
            .content-header-actions {
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
            }
            
            /* Êñá‰ª∂ÂàóË°® */
            .file-list {
                flex: 1;
                overflow-y: auto;
                padding: 0;
                border-top: 1px solid var(--card-border);
                background-color: var(--bg-secondary);
            }
            
            .file-list::-webkit-scrollbar {
                width: 6px;
            }
            
            .file-list::-webkit-scrollbar-track {
                background: transparent;
            }
            
            .file-list::-webkit-scrollbar-thumb {
                background: var(--icon-btn-bg);
                border-radius: 3px;
                transition: background-color 0.3s ease;
            }
            
            .file-list::-webkit-scrollbar-thumb:hover {
                background: var(--gray-color);
            }
            
            /* Êñá‰ª∂È°πÊ†∑Âºè */
            .file-item {
                padding: 16px 24px;
                border-bottom: 1px solid var(--card-border);
                display: grid;
                grid-template-columns: 25px 40px 1fr 100px auto;
                gap: 16px;
                align-items: center;
                transition: all 0.3s ease;
                min-height: 72px;
                cursor: pointer;
                position: relative;
            }
            
            .file-item::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                width: 3px;
                background: transparent;
                transition: background-color 0.3s ease;
            }
            
            .file-item:hover {
                background-color: var(--toolbar-btn-bg);
                transform: translateX(2px);
            }
            
            .file-item:hover::before {
                background: var(--gradient-start);
            }
            
            .file-item.selected {
                background-color: var(--chip-bg);
                border-left: 3px solid var(--chip-color);
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
            }
            
            .file-item-checkbox {
                width: 20px;
                height: 20px;
                cursor: pointer;
                accent-color: var(--primary-color);
                border-radius: 4px;
                transition: all 0.2s ease;
            }
            
            .file-item-checkbox:checked {
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            }
            
            .file-item-icon {
                font-size: 1.6rem;
                text-align: center;
                flex-shrink: 0;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 8px;
                background: var(--chip-bg);
                color: var(--chip-color);
            }
            
            .file-item-info {
                min-width: 0;
                display: flex;
                flex-direction: column;
                gap: 4px;
            }
            
            .file-item-name {
                font-weight: 500;
                color: var(--text-primary);
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                font-size: 1rem;
                transition: color 0.2s ease;
            }
            
            .file-item:hover .file-item-name {
                color: var(--chip-color);
            }
            
            .file-item-meta {
                display: flex;
                gap: 12px;
                font-size: 0.85rem;
                color: var(--text-secondary);
                flex-wrap: wrap;
            }
            
            .file-item-preview-btn {
                background: var(--icon-btn-bg);
                border: none;
                color: var(--text-primary);
                font-size: 1.3rem;
                cursor: pointer;
                padding: 8px;
                border-radius: 8px;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 36px;
                height: 36px;
            }
            
            .file-item-preview-btn:hover {
                background-color: var(--primary-color);
                color: white;
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            }
            
            /* Êñá‰ª∂Â§ßÂ∞èÊòæÁ§∫ */
            .file-size {
                font-size: 0.85rem;
                color: var(--text-secondary);
                font-weight: 500;
                text-align: right;
                white-space: nowrap;
            }
            
            .empty-state {
                padding: 60px 20px;
                text-align: center;
                color: var(--gray-color);
            }
            
            .empty-state-icon {
                font-size: 3rem;
                margin-bottom: 15px;
                opacity: 0.5;
            }
            
            .empty-state-title {
                font-size: 1.1rem;
                margin-bottom: 8px;
                color: var(--dark-color);
            }
            
            .empty-state-text {
                font-size: 0.95rem;
            }
            
            /* Âä†ËΩΩÁä∂ÊÄÅ */
            .loading-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                justify-content: center;
                align-items: center;
            }
            
            .loading-overlay.show {
                display: flex;
            }
            
            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-top-color: white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            
            /* ÈÄöÁü• */
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 6px;
                color: white;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                max-width: 350px;
            }
            
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            .notification.success {
                background-color: var(--success-color);
            }
            
            .notification.error {
                background-color: var(--accent-color);
            }
            
            .notification.info {
                background-color: var(--primary-color);
            }
            
            .notification.warning {
                background-color: var(--warning-color);
            }
            
            /* ÊåâÈíÆÁªÑ */
            .button-group {
                display: flex;
                gap: 10px;
                margin-top: 20px;
            }
            
            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.95rem;
                transition: all 0.3s;
                font-weight: 500;
            }
            
            .btn-primary {
                background-color: var(--primary-color);
                color: white;
            }
            
            .btn-primary:hover {
                background-color: var(--secondary-color);
                box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
            }
            
            .btn-secondary {
                background-color: var(--light-color);
                color: var(--dark-color);
            }
            
            .btn-secondary:hover {
                background-color: var(--border-color);
            }
            
            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            /* Ëá™ÂÆö‰πâÂØπËØùÊ°ÜÊ†∑Âºè */
            .custom-dialog-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 2000;
                justify-content: center;
                align-items: center;
            }
            
            .custom-dialog-overlay.show {
                display: flex;
            }
            
            .custom-dialog {
                background: var(--bg-primary, white);
                border-radius: 16px;
                box-shadow: 
                    0 10px 40px rgba(0, 0, 0, 0.15),
                    0 4px 16px rgba(0, 0, 0, 0.1),
                    0 1px 3px rgba(0, 0, 0, 0.08);
                min-width: 380px;
                max-width: 500px;
                animation: slideUp 0.3s ease-out;
                border: 1px solid var(--border-color, #e0e0e0);
                backdrop-filter: blur(8px);
                position: relative;
                z-index: 1000;
            }
            
            .custom-dialog::before {
                content: '';
                position: absolute;
                top: -1px;
                left: -1px;
                right: -1px;
                height: 40px;
                background: linear-gradient(90deg, var(--primary-color, #3498db), var(--secondary-color, #2ecc71));
                opacity: 0.03;
                border-radius: 16px 16px 0 0;
                z-index: -1;
            }
            
            .custom-dialog.upload-edit-dialog {
                min-width: 600px;
                max-width: 900px;
                max-height: 70vh;
                display: flex;
                flex-direction: column;
            }
            
            .custom-dialog.preview-dialog {
                width: 85vw;
                height: 85vh;
                max-width: 1400px;
                max-height: 85vh;
                display: flex;
                flex-direction: column;
                min-width: auto;
                min-height: auto;
                border-radius: 20px;
            }
            
            .dialog-content.preview-content {
                flex: 1;
                overflow: auto;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--light-gray);
                padding: 20px;
            }
            
            .preview-content img,
            .preview-content iframe,
            .preview-content pre {
                max-width: 100%;
                max-height: 100%;
                width: auto;
                height: auto;
            }
            
            .preview-content iframe {
                width: 100%;
                height: 100%;
            }
            
            .upload-list-container {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            
            .upload-list-header {
                display: grid;
                grid-template-columns: 80px 1fr;
                gap: 15px;
                padding: 12px 15px;
                background: var(--light-gray);
                border-bottom: 2px solid var(--border-color);
                font-weight: 600;
                font-size: 0.85rem;
                color: var(--dark-color);
                flex-shrink: 0;
            }
            
            .upload-col-status {
                text-align: center;
            }
            
            .upload-col-name {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .upload-list-items {
                flex: 1;
                overflow-y: auto;
                padding: 0;
            }
            
            .upload-list-items::-webkit-scrollbar {
                width: 8px;
            }
            
            .upload-list-items::-webkit-scrollbar-track {
                background: transparent;
            }
            
            .upload-list-items::-webkit-scrollbar-thumb {
                background: var(--light-gray);
                border-radius: 4px;
            }
            
            .upload-list-items::-webkit-scrollbar-thumb:hover {
                background: var(--gray-color);
            }
            
            .upload-list-item {
                display: grid;
                grid-template-columns: 80px 1fr;
                gap: 15px;
                padding: 12px 15px;
                border-bottom: 1px solid var(--border-color);
                align-items: center;
                transition: background 0.2s;
            }
            
            .upload-list-item:hover {
                background: var(--light-gray);
            }
            
            .upload-item-status {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 5px;
                font-size: 0.8rem;
            }
            
            .upload-item-status.conflict {
                color: var(--accent-color);
            }
            
            .upload-item-status.normal {
                color: var(--success-color);
            }
            
            .upload-item-status-badge {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 0.75rem;
                font-weight: 500;
                white-space: nowrap;
            }
            
            .upload-item-status.conflict .upload-item-status-badge {
                background: rgba(231, 76, 60, 0.1);
                color: var(--accent-color);
            }
            
            .upload-item-status.normal .upload-item-status-badge {
                background: rgba(39, 174, 96, 0.1);
                color: var(--success-color);
            }
            
            .upload-item-name {
                font-size: 0.9rem;
                color: var(--dark-color);
                word-break: break-all;
            }
            
            .upload-item-name.editable {
                cursor: pointer;
                padding: 6px 8px;
                border-radius: 4px;
                transition: all 0.2s;
            }
            
            .upload-item-name.editable:hover {
                background: rgba(52, 152, 219, 0.1);
                color: var(--primary-color);
            }
            
            .upload-item-name-input {
                width: 100%;
                padding: 8px 10px;
                border: 2px solid var(--primary-color);
                border-radius: 4px;
                font-size: 0.9rem;
                font-family: inherit;
                transition: all 0.2s;
            }
            
            .upload-item-name-input:focus {
                outline: none;
                box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            }
            
            /* ÂÜ≤Á™ÅÁ°ÆËÆ§ÂØπËØùÊ°ÜÂàóË°®Ê†∑Âºè */
            .conflict-list-display {
                background: var(--bg-secondary, #f5f5f5);
                border-radius: 12px;
                padding: 12px 15px;
                margin: 12px 0;
                max-height: 300px;
                overflow-y: auto;
                border: 1px solid var(--border-color, #e0e0e0);
                box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            }
            
            .conflict-list-display::-webkit-scrollbar {
                width: 6px;
            }
            
            .conflict-list-display::-webkit-scrollbar-track {
                background: transparent;
            }
            
            .conflict-list-display::-webkit-scrollbar-thumb {
                background: var(--light-gray);
                border-radius: 3px;
            }
            
            .conflict-list-display::-webkit-scrollbar-thumb:hover {
                background: var(--gray-color);
            }
            
            .conflict-file-item {
                padding: 8px 0;
                border-bottom: 1px solid var(--border-color);
                font-size: 0.9rem;
                color: var(--dark-color);
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .conflict-file-item:last-child {
                border-bottom: none;
            }
            
            .conflict-file-icon {
                font-size: 1rem;
                flex-shrink: 0;
            }
            
            .conflict-file-name {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                flex: 1;
                color: var(--accent-color);
                font-weight: 500;
            }
            
            @keyframes slideUp {
                from {
                    transform: translateY(20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            
            .dialog-header {
                padding: 20px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .dialog-icon {
                font-size: 1.5rem;
            }
            
            .dialog-title {
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--dark-color);
            }
            
            .dialog-content {
                padding: 20px;
            }
            
            .dialog-message {
                font-size: 0.95rem;
                color: var(--dark-color);
                margin: 0 0 15px 0;
                line-height: 1.6;
            }
            
            .dialog-options {
                display: flex;
                flex-direction: column;
                gap: 8px;
                padding: 12px;
                background: var(--light-gray);
                border-radius: 6px;
            }
            
            .option-label {
                font-size: 0.85rem;
                color: var(--gray-color);
                padding-left: 8px;
            }
            
            .dialog-section {
                margin-bottom: 15px;
            }
            
            .dialog-section:last-child {
                margin-bottom: 0;
            }
            
            .dialog-label {
                display: block;
                font-size: 0.9rem;
                font-weight: 500;
                color: var(--dark-color);
                margin-bottom: 8px;
            }
            
            .dialog-text {
                padding: 10px 12px;
                background: var(--light-gray);
                border-radius: 6px;
                color: var(--dark-color);
                word-break: break-all;
                font-size: 0.9rem;
                border: 1px solid var(--border-color);
            }
            
            .dialog-input {
                width: 100%;
                padding: 10px 12px;
                border: 2px solid var(--border-color);
                border-radius: 6px;
                font-size: 0.9rem;
                transition: all 0.2s;
                box-sizing: border-box;
                font-family: inherit;
            }
            
            .dialog-input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            }
            
            .dialog-actions {
                padding: 15px 20px;
                border-top: 1px solid var(--border-color);
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }
            
            .dialog-btn {
                padding: 10px 24px;
                border: 1px solid transparent;
                border-radius: 8px;
                font-size: 0.95rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }
            
            .dialog-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                transition: left 0.5s ease;
            }
            
            .dialog-btn:hover::before {
                left: 100%;
            }
            
            .dialog-btn-primary {
                background-color: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }
            
            .dialog-btn-primary:hover {
                background-color: var(--secondary-color);
                border-color: var(--secondary-color);
                box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
                transform: translateY(-1px);
            }
            
            .dialog-btn-primary:active {
                transform: translateY(0) scale(0.98);
            }
            
            .dialog-btn-secondary {
                background-color: var(--light-color);
                color: var(--dark-color);
                border-color: var(--border-color);
            }
            
            .dialog-btn-secondary:hover {
                background-color: var(--bg-secondary);
                border-color: var(--primary-color);
                transform: translateY(-1px);
            }
            
            .dialog-btn-secondary:active {
                transform: translateY(0) scale(0.98);
            }
            
            .dialog-btn-danger {
                background-color: var(--accent-color);
                color: white;
                border-color: var(--accent-color);
            }
            
            .dialog-btn-danger:hover {
                background-color: #c0392b;
                border-color: #c0392b;
                box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
                transform: translateY(-1px);
            }
            
            .dialog-btn-danger:active {
                transform: translateY(0) scale(0.98);
            }
            
            /* ÂìçÂ∫îÂºèËÆæËÆ° */
            @media (max-width: 768px) {
                .main-content {
                    grid-template-columns: 1fr;
                }
                
                .folder-panel {
                    max-height: 300px;
                }
                
                header h1 {
                    font-size: 1.5rem;
                }
                
                .file-list {
                    height: 350px;
                }
                
                .file-item {
                    grid-template-columns: 25px 35px 1fr 40px;
                    gap: 10px;
                    min-height: 55px;
                }
                
                .file-item-meta {
                    display: none;
                }
                
                .file-operations-toolbar {
                    flex-direction: column;
                    gap: 10px;
                }
                
                .toolbar-actions {
                    width: 100%;
                    flex-wrap: wrap;
                }
                
                .toolbar-btn {
                    flex: 1;
                    min-width: 80px;
                }
            }
        </style>
    </head>
    <body>
        <a href="javascript:history.back()" class="back-btn">‚Üê ËøîÂõû</a>
        
        <div class="container">
            <!-- Â§¥ÈÉ® -->
            <header>
                <h1>üìÅ ‰∫ëÁõòÁÆ°ÁêÜ</h1>
                <p>ÁÆ°ÁêÜÊÇ®ÁöÑÊñá‰ª∂ÂíåÊñá‰ª∂Â§π</p>
            </header>
            
            <!-- Ë∑ØÂæÑÊòæÁ§∫ -->
            <div class="breadcrumb">
                <span class="breadcrumb-label">ÂΩìÂâç‰ΩçÁΩÆÔºö</span>
                <span class="breadcrumb-path" id="currentPath">/root/files</span>
            </div>
            
            <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
            <div class="main-content">
                <!-- Â∑¶‰æßÔºöÊñá‰ª∂Â§πÊ†ë -->
                <div class="folder-panel">
                    <div class="folder-panel-header">
                        üìÅ <span>Êñá‰ª∂Â§π</span>
                    </div>
                    <div class="folder-tree" id="folderTree">
                        <!-- Êñá‰ª∂Â§πÂàóË°®Â∞ÜÂä®ÊÄÅÊèíÂÖ•Ê≠§Â§Ñ -->
                    </div>
                </div>
                
                <!-- Âè≥‰æßÔºöÂÜÖÂÆπÂå∫Âüü -->
                <div class="content-panel">
                    <div class="content-header">
                        <div class="content-header-title" id="contentTitle">ÈÄâÊã©Êñá‰ª∂Â§π</div>
                        <div class="content-header-actions">
                            <button class="btn btn-secondary" id="backFolderBtn" onclick="goBackToParentFolder()" style="display: none;">
                                ‚Üê ËøîÂõû‰∏ä‰∏ÄÁ∫ß
                            </button>
                        </div>
                    </div>
                    
                    <!-- Êñá‰ª∂Êìç‰ΩúÂ∑•ÂÖ∑Ê†è -->
                    <div class="file-operations-toolbar" id="fileOperationsToolbar">
                        <!-- ÂßãÁªàÊòæÁ§∫ÁöÑÊåâÈíÆ -->
                        <button class="toolbar-btn toolbar-btn-success" id="uploadFileBtn" onclick="document.getElementById('fileInput').click()">
                            üì§ ‰∏ä‰º†Êñá‰ª∂
                        </button>
                        <button class="toolbar-btn toolbar-btn-secondary" id="newFolderToolbarBtn" onclick="createNewFolder()">
                            + Êñ∞Âª∫Êñá‰ª∂Â§π
                        </button>
                        <button class="toolbar-btn toolbar-btn-secondary" id="deleteFolderBtn" onclick="deleteFolder()" style="display: none;">
                            üóëÔ∏è Âà†Èô§Êñá‰ª∂Â§π
                        </button>
                        
                        <!-- ‰ªÖÂú®ÈÄâ‰∏≠Êñá‰ª∂Êó∂ÊòæÁ§∫ÁöÑÊåâÈíÆ -->
                        <div id="selectionActionsGroup" class="selection-actions-group" style="display: none; margin-left: auto;">
                            <span id="selectedFilesCount" class="toolbar-info">Â∑≤ÈÄâÊã© 0 ‰∏™Êñá‰ª∂</span>
                            <button class="toolbar-btn toolbar-btn-secondary" id="clearSelectionBtn" onclick="clearFileSelection()">
                                ‚úï ÂèñÊ∂àÈÄâÊã©
                            </button>
                            <button class="toolbar-btn toolbar-btn-primary" id="downloadSelectedBtn" onclick="downloadSelectedFiles()">
                                ‚¨áÔ∏è ‰∏ãËΩΩ
                            </button>
                            <button class="toolbar-btn toolbar-btn-danger" id="deleteSelectedBtn" onclick="deleteSelectedFiles()">
                                üóëÔ∏è Âà†Èô§
                            </button>
                        </div>
                    </div>
                    
                    <!-- Êñá‰ª∂ËæìÂÖ•Ê°ÜÔºàÈöêËóèÔºåÈÄöËøáÂ∑•ÂÖ∑Ê†èÊåâÈíÆËß¶ÂèëÔºâ -->
                    <input type="file" id="fileInput" multiple style="display: none;">
                    
                    <!-- Êñá‰ª∂ÂàóË°® -->
                    <div class="file-list" id="fileList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÇ</div>
                            <div class="empty-state-title">ÊöÇÊó†Êñá‰ª∂</div>
                            <div class="empty-state-text">ÈÄâÊã©Â∑¶‰æßÊñá‰ª∂Â§πÊü•ÁúãÂÜÖÂÆπ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Âä†ËΩΩÂä®Áîª -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
        </div>
        
        <!-- ‰∏ä‰º†Êñá‰ª∂ÁºñËæëÂØπËØùÊ°Ü -->
        <div class="custom-dialog-overlay" id="uploadEditDialogOverlay">
            <div class="custom-dialog upload-edit-dialog">
                <div class="dialog-header">
                    <span class="dialog-icon">üì§</span>
                    <span class="dialog-title">ÁºñËæë‰∏ä‰º†Êñá‰ª∂</span>
                </div>
                <div class="dialog-content">
                    <div class="upload-list-container">
                        <div class="upload-list-header">
                            <div class="upload-col-status">Áä∂ÊÄÅ</div>
                            <div class="upload-col-name">Êñá‰ª∂ÂêçÔºàÁÇπÂáªÁºñËæëÔºâ</div>
                        </div>
                        <div class="upload-list-items" id="uploadListItems">
                            <!-- ‰∏ä‰º†Êñá‰ª∂È°πÂ∞ÜÂä®ÊÄÅÊèíÂÖ•Ê≠§Â§Ñ -->
                        </div>
                    </div>
                </div>
                <div class="dialog-actions">
                    <button class="dialog-btn dialog-btn-primary" id="uploadEditConfirmBtn">Á°ÆÂÆö</button>
                    <button class="dialog-btn dialog-btn-secondary" id="uploadEditCancelBtn">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
        
        <!-- ÂÜ≤Á™ÅÊñá‰ª∂Á°ÆËÆ§ÂØπËØùÊ°Ü -->
        <div class="custom-dialog-overlay" id="conflictConfirmDialogOverlay">
            <div class="custom-dialog">
                <div class="dialog-header">
                    <span class="dialog-icon">‚ö†Ô∏è</span>
                    <span class="dialog-title">ÂèëÁé∞Êñá‰ª∂ÂÜ≤Á™Å</span>
                </div>
                <div class="dialog-content">
                    <p class="dialog-message">‰ª•‰∏ãÊñá‰ª∂Â∞ÜË¶ÜÁõñÁé∞ÊúâÊñá‰ª∂Ôºö</p>
                    <div class="conflict-list-display" id="conflictFilesList">
                        <!-- ÂÜ≤Á™ÅÊñá‰ª∂ÂàóË°®Â∞ÜÂä®ÊÄÅÊèíÂÖ•Ê≠§Â§Ñ -->
                    </div>
                    <p class="dialog-message" style="margin-top: 15px; color: #666;">ÊòØÂê¶ÁªßÁª≠Ôºü</p>
                </div>
                <div class="dialog-actions">
                    <button class="dialog-btn dialog-btn-primary" id="conflictConfirmBtn">Á°ÆÂÆöÁªßÁª≠</button>
                    <button class="dialog-btn dialog-btn-secondary" id="conflictCancelBtn">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
        
        <!-- Êñ∞Âª∫Êñá‰ª∂Â§πÂØπËØùÊ°Ü -->
        <div class="custom-dialog-overlay" id="createFolderDialogOverlay">
            <div class="custom-dialog">
                <div class="dialog-header">
                    <span class="dialog-icon">üìÅ</span>
                    <span class="dialog-title">Êñ∞Âª∫Êñá‰ª∂Â§π</span>
                </div>
                <div class="dialog-content">
                    <label class="dialog-label">Êñá‰ª∂Â§πÂêçÁß∞</label>
                    <input type="text" class="dialog-input" id="createFolderNameInput" placeholder="ËØ∑ËæìÂÖ•Êñá‰ª∂Â§πÂêçÁß∞">
                    <p class="dialog-message" id="folderNameError" style="color: var(--accent-color); margin-top: 10px; display: none;"></p>
                </div>
                <div class="dialog-actions">
                    <button class="dialog-btn dialog-btn-primary" id="createFolderConfirmBtn">Á°ÆÂÆö</button>
                    <button class="dialog-btn dialog-btn-secondary" id="createFolderCancelBtn">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
        
        <!-- Âà†Èô§Á°ÆËÆ§ÂØπËØùÊ°Ü -->
        <div class="custom-dialog-overlay" id="deleteConfirmDialogOverlay">
            <div class="custom-dialog">
                <div class="dialog-header">
                    <span class="dialog-icon">‚ö†Ô∏è</span>
                    <span class="dialog-title">Á°ÆËÆ§Âà†Èô§</span>
                </div>
                <div class="dialog-content">
                    <p class="dialog-message" id="deleteConfirmMessage"></p>
                    <p class="dialog-message" style="color: #ff6b6b; margin-top: 10px; font-size: 0.9rem;">Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ</p>
                </div>
                <div class="dialog-actions">
                    <button class="dialog-btn dialog-btn-secondary" id="deleteConfirmCancelBtn">ÂèñÊ∂à</button>
                    <button class="dialog-btn dialog-btn-danger" id="deleteConfirmBtn">Á°ÆËÆ§Âà†Èô§</button>
                </div>
            </div>
        </div>
        
        <!-- Êñá‰ª∂È¢ÑËßàÂØπËØùÊ°Ü -->
        <div class="custom-dialog-overlay" id="previewDialogOverlay">
            <div class="custom-dialog preview-dialog" id="previewDialog">
                <div class="dialog-header">
                    <span class="dialog-icon" id="previewIcon">üìÑ</span>
                    <span class="dialog-title" id="previewTitle">È¢ÑËßàÊñá‰ª∂</span>
                    <div style="margin-left: auto; display: flex; gap: 10px;" id="previewHeaderActions">
                        <button class="dialog-btn dialog-btn-primary" id="previewZoomBtn" style="font-size: 0.8rem; padding: 6px 12px; display: none;">ÊîæÂ§ß</button>
                        <button class="dialog-btn dialog-btn-primary" id="previewEditBtn" style="font-size: 0.8rem; padding: 6px 12px; display: none;">ÁºñËæë</button>
                        <button class="dialog-btn dialog-btn-success" id="previewSaveBtn" style="font-size: 0.8rem; padding: 6px 12px; display: none;">‰øùÂ≠ò</button>
                        <button class="dialog-btn dialog-btn-secondary" id="previewCancelEditBtn" style="font-size: 0.8rem; padding: 6px 12px; display: none;">ÂèñÊ∂à</button>
                    </div>
                </div>
                <div class="dialog-content preview-content" id="previewContent">
                    <div style="text-align: center; color: var(--gray-color);">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üìÇ</div>
                        <div>Âä†ËΩΩ‰∏≠...</div>
                    </div>
                </div>
                <div class="dialog-actions">
                    <button class="dialog-btn dialog-btn-primary" id="previewDownloadBtn">‰∏ãËΩΩ</button>
                    <button class="dialog-btn dialog-btn-secondary" id="previewCloseBtn">ÂÖ≥Èó≠</button>
                </div>
            </div>
        </div>
        
        <!-- ÂÖ®Â±èÊîæÂ§ßÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
        <div class="fullscreen-preview-overlay" id="fullscreenPreviewOverlay" style="display: none;">
            <div class="fullscreen-preview-content" id="fullscreenPreviewContent">
                <div class="fullscreen-preview-controls">
                    <button class="fullscreen-preview-btn" id="fullscreenZoomInBtn">üîç+</button>
                    <button class="fullscreen-preview-btn" id="fullscreenZoomOutBtn">üîç-</button>
                    <button class="fullscreen-preview-btn" id="fullscreenRotateBtn">üîÑ</button>
                    <button class="fullscreen-preview-btn" id="fullscreenCloseBtn">‚úï</button>
                </div>
                <div class="fullscreen-preview-wrapper" id="fullscreenPreviewWrapper">
                    <!-- ÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
                </div>
            </div>
        </div>
        
        <script>
            // ==================== Â∏∏ÈáèÈÖçÁΩÆ ====================
            // Ëá™Âä®Ê£ÄÊµãAPIÂü∫Á°ÄURLÔºå‰ºòÂÖà‰ΩøÁî®‰∏éÈ°µÈù¢Áõ∏ÂêåÁöÑÂçèËÆÆÔºàÈÅøÂÖçÊ∑∑ÂêàÂÜÖÂÆπÈóÆÈ¢òÔºâ
            // Â¶ÇÊûúÈ°µÈù¢ÊòØHTTPSÔºåAPI‰πü‰ΩøÁî®HTTPSÔºõÂ¶ÇÊûúÈ°µÈù¢ÊòØHTTPÔºåAPI‰ΩøÁî®HTTP
            // ÊîØÊåÅ‰ªélocalStorageËØªÂèñËá™ÂÆö‰πâAPIÂú∞ÂùÄ
            let API_BASE_URL = localStorage.getItem('cloud_disk_api_url');
            if (!API_BASE_URL) {
                // Â¶ÇÊûúÊ≤°ÊúâËá™ÂÆö‰πâÈÖçÁΩÆÔºå‰ΩøÁî®‰∏éÈ°µÈù¢Áõ∏ÂêåÁöÑÂçèËÆÆ
                if (window.location.protocol === 'https:') {
                    // HTTPSÈ°µÈù¢ÔºöÂ∞ùËØï‰ΩøÁî®HTTPS APIÔºàÁõ∏ÂêåÁ´ØÂè£ÊàñÈªòËÆ§443Ôºâ
                    // Â¶ÇÊûúÊúçÂä°Âô®Âú®5000Á´ØÂè£ÔºåÂèØËÉΩÈúÄË¶ÅÈÄöËøáÂèçÂêë‰ª£ÁêÜËÆøÈóÆ
                    API_BASE_URL = `https://${window.location.hostname}${window.location.port ? ':' + window.location.port : ''}`;
                } else {
                    // HTTPÈ°µÈù¢Ôºö‰ΩøÁî®HTTP API
                    API_BASE_URL = `${window.location.protocol}//${window.location.hostname}:5000`;
                }
            }
            let token = localStorage.getItem('access_token') || localStorage.getItem('aiLearningToken');
            let currentUser = JSON.parse(localStorage.getItem('aiLearningUser') || '{}');
            let selectedFolderPath = null;
            
            // ÁºìÂ≠òÊï∞ÊçÆÔºà‰∏ÄÊ¨°ÊÄßÂä†ËΩΩÔºåÈÅøÂÖçÈ¢ëÁπÅËØ∑Ê±ÇÔºâ
            let cachedTreeData = null;  // ÁºìÂ≠òÊ†ëÂΩ¢ÁªìÊûÑ
            let expandedFolders = new Set(['/']);  // ËÆ∞ÂΩïÂ±ïÂºÄÁöÑÊñá‰ª∂Â§πÔºåÈªòËÆ§Â±ïÂºÄÊ†πÁõÆÂΩï
            let selectedFiles = new Set();  // ËÆ∞ÂΩïÈÄâ‰∏≠ÁöÑÊñá‰ª∂ID
            
            // È¢ÑËßàÁºñËæëÁõ∏ÂÖ≥
            let currentPreviewFileId = null;  // ÂΩìÂâçÈ¢ÑËßàÁöÑÊñá‰ª∂ID
            let currentPreviewFileName = null;  // ÂΩìÂâçÈ¢ÑËßàÁöÑÊñá‰ª∂Âêç
            let isPreviewEditMode = false;  // ÊòØÂê¶Âú®ÁºñËæëÊ®°Âºè
            let previewOriginalContent = null;  // È¢ÑËßàÊñá‰ª∂ÁöÑÂéüÂßãÂÜÖÂÆπ
            
            // ÂÖ®Â±èÈ¢ÑËßàÁõ∏ÂÖ≥
            let fullscreenPreviewUrl = null;  // ÂÖ®Â±èÈ¢ÑËßàÁöÑÊñá‰ª∂URL
            let fullscreenPreviewType = null;  // ÂÖ®Â±èÈ¢ÑËßàÁöÑÊñá‰ª∂Á±ªÂûã
            let currentZoomLevel = 1;  // ÂΩìÂâçÁº©ÊîæÁ∫ßÂà´
            let currentRotation = 0;  // ÂΩìÂâçÊóãËΩ¨ËßíÂ∫¶
            
            // ==================== ÈÄöÁî®Â∑•ÂÖ∑ÂáΩÊï∞ ====================
            /**
            * Â¢ûÂº∫ÁöÑ fetch ÂáΩÊï∞ÔºåÊèê‰æõÊõ¥Â•ΩÁöÑÈîôËØØÂ§ÑÁêÜ
            * @param {string} url - ËØ∑Ê±ÇURL
            * @param {object} options - fetchÈÄâÈ°π
            * @returns {Promise} fetch Promise
            */
            function enhancedFetch(url, options = {}) {
                const timeout = 30000; // 30ÁßíË∂ÖÊó∂
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                // ÂêàÂπ∂ signal
                const fetchOptions = {
                    ...options,
                    signal: options.signal ? 
                        (() => {
                            // Â¶ÇÊûúÂ∑≤ÊúâsignalÔºåÂàõÂª∫‰∏Ä‰∏™ÁªÑÂêàsignal
                            const combinedController = new AbortController();
                            options.signal.addEventListener('abort', () => combinedController.abort());
                            controller.signal.addEventListener('abort', () => combinedController.abort());
                            return combinedController.signal;
                        })() : 
                        controller.signal
                };
                
                return fetch(url, fetchOptions)
                .then(response => {
                    clearTimeout(timeoutId);
                    return response;
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    
                    // Êèê‰æõÊõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
                    let errorMessage = 'ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•';
                    
                    if (error.name === 'AbortError') {
                        errorMessage = `ËØ∑Ê±ÇË∂ÖÊó∂Ôºà${timeout/1000}ÁßíÔºâÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÊúçÂä°Âô®Áä∂ÊÄÅ„ÄÇAPIÂú∞ÂùÄ: ${url}`;
                    } else if (error.message === 'Failed to fetch' || error.message.includes('Failed to fetch')) {
                        // ÂàÜÊûêÂèØËÉΩÁöÑÂ§±Ë¥•ÂéüÂõ†
                        try {
                            const urlObj = new URL(url);
                            const hostname = urlObj.hostname;
                            const protocol = urlObj.protocol;
                            const pageProtocol = window.location.protocol;
                            
                            // Ê£ÄÊü•Ê∑∑ÂêàÂÜÖÂÆπÈóÆÈ¢ò
                            if (pageProtocol === 'https:' && protocol === 'http:') {
                                errorMessage = `Ê∑∑ÂêàÂÜÖÂÆπÈîôËØØÔºöHTTPSÈ°µÈù¢Êó†Ê≥ïÂä†ËΩΩHTTPËµÑÊ∫ê„ÄÇ\n\nÂΩìÂâçÈ°µÈù¢: ${pageProtocol}//${window.location.hostname}\nAPIÂú∞ÂùÄ: ${url}\n\nËß£ÂÜ≥ÊñπÊ°àÔºö\n1. Â∞ÜAPIÊúçÂä°Âô®ÈÖçÁΩÆ‰∏∫HTTPS\n2. Êàñ‰ΩøÁî®ÂèçÂêë‰ª£ÁêÜÔºàÂ¶ÇNginxÔºâÂ∞ÜHTTP API‰ª£ÁêÜ‰∏∫HTTPS\n3. ÊàñÂú®ÊµèËßàÂô®‰∏≠ÂÖÅËÆ∏Ê∑∑ÂêàÂÜÖÂÆπÔºà‰∏çÊé®ËçêÔºå‰ªÖÁî®‰∫éÂºÄÂèëÔºâ`;
                            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                                errorMessage = `Êó†Ê≥ïËøûÊé•Âà∞Êú¨Âú∞ÊúçÂä°Âô® ${url}„ÄÇËØ∑Á°Æ‰øùÊúçÂä°Âô®Ê≠£Âú®ËøêË°å„ÄÇ`;
                            } else {
                                errorMessage = `Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô® ${url}„ÄÇÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n1. ÊúçÂä°Âô®Êú™ËøêË°å\n2. ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò\n3. CORSË∑®ÂüüÈóÆÈ¢ò\n4. Èò≤ÁÅ´Â¢ôÈòªÊ≠¢\n5. ÂçèËÆÆ‰∏çÂåπÈÖçÔºàHTTPSÈ°µÈù¢Êó†Ê≥ïËÆøÈóÆHTTP APIÔºâ`;
                            }
                        } catch (e) {
                            errorMessage = `Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô® ${url}„ÄÇÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n1. ÊúçÂä°Âô®Êú™ËøêË°å\n2. ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò\n3. CORSË∑®ÂüüÈóÆÈ¢ò\n4. Èò≤ÁÅ´Â¢ôÈòªÊ≠¢\n5. ÂçèËÆÆ‰∏çÂåπÈÖçÔºàHTTPSÈ°µÈù¢Êó†Ê≥ïËÆøÈóÆHTTP APIÔºâ`;
                        }
                    } else {
                        errorMessage = `ÁΩëÁªúÈîôËØØ: ${error.message}„ÄÇËØ∑Ê±ÇÂú∞ÂùÄ: ${url}`;
                    }
                    
                    let hostname = 'unknown';
                    try {
                        hostname = new URL(url).hostname;
                    } catch (e) {
                        // URLËß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄº
                    }
                    
                    console.error('FetchÈîôËØØËØ¶ÊÉÖ:', {
                        url,
                        error: error.message,
                        name: error.name,
                        hostname: hostname,
                        stack: error.stack
                    });
                    
                    // ÂàõÂª∫‰∏Ä‰∏™ÂåÖÂê´ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØÁöÑÈîôËØØÂØπË±°
                    const enhancedError = new Error(errorMessage);
                    enhancedError.originalError = error;
                    enhancedError.url = url;
                    throw enhancedError;
                });
            }
            
            /**
            * Ê£ÄÊü•ÁΩëÁªúËøûÊé•
            * @returns {Promise<boolean>} ÊòØÂê¶Âú®Á∫ø
            */
            function checkNetworkConnection() {
                return new Promise((resolve) => {
                    if (!navigator.onLine) {
                        resolve(false);
                        return;
                    }
                    
                    // Â∞ùËØïËøûÊé•APIÊúçÂä°Âô®
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    fetch(`${API_BASE_URL}/api/health`, {
                        method: 'GET',
                        signal: controller.signal
                    })
                    .then(() => {
                        clearTimeout(timeoutId);
                        resolve(true);
                    })
                    .catch(() => {
                        clearTimeout(timeoutId);
                        resolve(false);
                    });
                });
            }
            
            // ==================== ÂàùÂßãÂåñ ====================
            document.addEventListener('DOMContentLoaded', function() {
                console.log('‰∫ëÁõòÂàùÂßãÂåñ‰∏≠...');
                console.log('È°µÈù¢ÂçèËÆÆ:', window.location.protocol);
                console.log('È°µÈù¢Âú∞ÂùÄ:', window.location.href);
                console.log('API_BASE_URL:', API_BASE_URL);
                console.log('ÊèêÁ§∫: Â¶ÇÊûúÈÅáÂà∞ËøûÊé•ÈóÆÈ¢òÔºåÂèØ‰ª•Âú®ÊµèËßàÂô®ÊéßÂà∂Âè∞ÊâßË°å‰ª•‰∏ãÂëΩ‰ª§ËÆæÁΩÆËá™ÂÆö‰πâAPIÂú∞ÂùÄ:');
                console.log('localStorage.setItem("cloud_disk_api_url", "https://your-api-server.com:5000");');
                console.log('ÁÑ∂ÂêéÂà∑Êñ∞È°µÈù¢„ÄÇ');
                
                // Ê£ÄÊü•ÂçèËÆÆÂåπÈÖç
                const pageProtocol = window.location.protocol;
                const apiProtocol = new URL(API_BASE_URL).protocol;
                if (pageProtocol === 'https:' && apiProtocol === 'http:') {
                    console.warn('‚ö†Ô∏è Ê£ÄÊµãÂà∞Ê∑∑ÂêàÂÜÖÂÆπÈóÆÈ¢òÔºöHTTPSÈ°µÈù¢Â∞ùËØïËÆøÈóÆHTTP API');
                    console.warn('ËøôÂèØËÉΩÂØºËá¥ËØ∑Ê±ÇË¢´ÊµèËßàÂô®ÈòªÊ≠¢„ÄÇÂª∫ËÆÆÔºö');
                    console.warn('1. ÈÖçÁΩÆÂèçÂêë‰ª£ÁêÜÔºàÂ¶ÇNginxÔºâÂ∞ÜHTTP API‰ª£ÁêÜ‰∏∫HTTPS');
                    console.warn('2. ÊàñÂú®ÊéßÂà∂Âè∞ÊâßË°å: localStorage.setItem("cloud_disk_api_url", "https://your-api-server.com")');
                }
                
                // Ê£ÄÊü•ÁΩëÁªúËøûÊé•
                checkNetworkConnection().then(isOnline => {
                    if (!isOnline) {
                        console.warn('ÁΩëÁªúËøûÊé•Ê£ÄÊü•Â§±Ë¥•Ôºå‰ΩÜÁªßÁª≠Â∞ùËØïÂä†ËΩΩ');
                        showNotification('Ê£ÄÊµãÂà∞ÁΩëÁªúËøûÊé•ÈóÆÈ¢òÔºåËØ∑Ê£ÄÊü•ÊúçÂä°Âô®ÊòØÂê¶ËøêË°å', 'warning');
                    }
                });
                
                // ÁªëÂÆöÂÖ®Â±èÈ¢ÑËßàÊéßÂà∂ÊåâÈíÆ‰∫ã‰ª∂
                document.getElementById('fullscreenZoomInBtn').addEventListener('click', zoomIn);
                document.getElementById('fullscreenZoomOutBtn').addEventListener('click', zoomOut);
                document.getElementById('fullscreenRotateBtn').addEventListener('click', rotateImage);
                document.getElementById('fullscreenCloseBtn').addEventListener('click', closeFullscreenPreview);
                
                // ÁÇπÂáªÈÅÆÁΩ©Â±Ç‰πüÂèØ‰ª•ÂÖ≥Èó≠ÂÖ®Â±èÈ¢ÑËßà
                document.getElementById('fullscreenPreviewOverlay').addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeFullscreenPreview();
                    }
                });
                
                // ÊåâESCÈîÆÂÖ≥Èó≠ÂÖ®Â±èÈ¢ÑËßà
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && document.getElementById('fullscreenPreviewOverlay').style.display === 'flex') {
                        closeFullscreenPreview();
                    }
                    // ÈîÆÁõòÂø´Êç∑ÈîÆ
                    if (document.getElementById('fullscreenPreviewOverlay').style.display === 'flex') {
                        switch (e.key) {
                            case '+':
                            case '=':
                                if (e.shiftKey) {
                                    e.preventDefault();
                                    zoomIn();
                                }
                                break;
                            case '-':
                            case '_':
                                e.preventDefault();
                                zoomOut();
                                break;
                            case 'r':
                            case 'R':
                                if (fullscreenPreviewType === 'image') {
                                    e.preventDefault();
                                    rotateImage();
                                }
                                break;
                            case '0':
                                // ÈáçÁΩÆÁº©Êîæ
                                e.preventDefault();
                                if (fullscreenPreviewType === 'image') {
                                    const img = document.getElementById('fullscreenImage');
                                    if (img) {
                                        currentZoomLevel = 1;
                                        currentRotation = 0;
                                        img.style.transform = `scale(1) rotate(0deg)`;
                                        img.style.webkitTransform = `scale(1) rotate(0deg)`;
                                        img.style.msTransform = `scale(1) rotate(0deg)`;
                                    }
                                } else if (fullscreenPreviewType === 'pdf') {
                                    const wrapper = document.getElementById('fullscreenPreviewWrapper');
                                    const iframe = wrapper.querySelector('iframe');
                                    if (iframe) {
                                        currentZoomLevel = 1;
                                        iframe.style.transform = `scale(1)`;
                                        iframe.style.webkitTransform = `scale(1)`;
                                        iframe.style.msTransform = `scale(1)`;
                                        wrapper.style.overflow = 'hidden';
                                    }
                                }
                                break;
                        }
                    }
                });
                
                // Ê∑ªÂä†Èº†Ê†áÊªöËΩÆÁº©ÊîæÊîØÊåÅ
                document.getElementById('fullscreenPreviewOverlay').addEventListener('wheel', function(e) {
                    e.preventDefault();
                    if (e.deltaY < 0) {
                        zoomIn();
                    } else {
                        zoomOut();
                    }
                });
                
                // Ê∑ªÂä†Ëß¶Êë∏ÊîØÊåÅÔºàÁÆÄÂçïÁöÑÁº©ÊîæÊâãÂäøÔºâ
                let touchStartDistance = 0;
                let touchStartTime = 0;
                
                document.getElementById('fullscreenPreviewWrapper').addEventListener('touchstart', function(e) {
                    if (e.touches.length === 2) {
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        touchStartDistance = Math.sqrt(dx * dx + dy * dy);
                        touchStartTime = Date.now();
                    }
                });
                
                document.getElementById('fullscreenPreviewWrapper').addEventListener('touchmove', function(e) {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        const touchDistance = Math.sqrt(dx * dx + dy * dy);
                        
                        // Âè™ÊúâÂú®Êó∂Èó¥Â∑ÆÂ§ß‰∫é50msÊó∂ÊâçÂ§ÑÁêÜÔºåÈÅøÂÖçËøá‰∫éÈ¢ëÁπÅÁöÑÁº©Êîæ
                        const currentTime = Date.now();
                        if (currentTime - touchStartTime > 50) {
                            const scaleFactor = touchDistance / touchStartDistance;
                            
                            // ËÆ°ÁÆóÊñ∞ÁöÑÁº©ÊîæÁ∫ßÂà´
                            const newZoomLevel = currentZoomLevel * scaleFactor;
                            
                            // ÈôêÂà∂Áº©ÊîæËåÉÂõ¥
                            if (newZoomLevel > 0.1 && newZoomLevel < 10) {
                                currentZoomLevel = newZoomLevel;
                                
                                // Â∫îÁî®Áº©Êîæ
                                if (fullscreenPreviewType === 'image') {
                                    const img = document.getElementById('fullscreenImage');
                                    if (img) {
                                        img.style.transform = `scale(${currentZoomLevel}) rotate(${currentRotation}deg)`;
                                        img.style.webkitTransform = `scale(${currentZoomLevel}) rotate(${currentRotation}deg)`;
                                        img.style.msTransform = `scale(${currentZoomLevel}) rotate(${currentRotation}deg)`;
                                    }
                                } else if (fullscreenPreviewType === 'pdf') {
                                    const wrapper = document.getElementById('fullscreenPreviewWrapper');
                                    const iframe = wrapper.querySelector('iframe');
                                    if (iframe) {
                                        iframe.style.transform = `scale(${currentZoomLevel})`;
                                        iframe.style.webkitTransform = `scale(${currentZoomLevel})`;
                                        iframe.style.msTransform = `scale(${currentZoomLevel})`;
                                        wrapper.style.overflow = currentZoomLevel > 1 ? 'auto' : 'hidden';
                                    }
                                }
                            }
                            
                            // Êõ¥Êñ∞Ëµ∑ÂßãË∑ùÁ¶ªÂíåÊó∂Èó¥
                            touchStartDistance = touchDistance;
                            touchStartTime = currentTime;
                        }
                    }
                });
                
                // Ê£ÄÊü•Âü∫Êú¨ÁôªÂΩï‰ø°ÊÅØ
                if (!token) {
                    showNotification('Êú™ÊâæÂà∞ÁôªÂΩï‰ª§ÁâåÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï', 'error');
                    console.warn('Êú™ÊâæÂà∞tokenÔºåÈúÄË¶ÅÈáçÊñ∞ÁôªÂΩï');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }
                
                if (!currentUser || !currentUser.id) {
                    showNotification('Áî®Êà∑‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï', 'error');
                    console.warn('Áî®Êà∑‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÈúÄË¶ÅÈáçÊñ∞ÁôªÂΩï');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }
                
                console.log('ÂºÄÂßãÈ™åËØÅToken...', currentUser.id);
                
                // È™åËØÅÁôªÂΩïÁä∂ÊÄÅ
                validateToken().then(() => {
                    console.log('TokenÈ™åËØÅÊàêÂäüÔºåÂàùÂßãÂåñÊñá‰ª∂Â§πÁªìÊûÑ');
                    // ÂÖàÂàùÂßãÂåñÊñá‰ª∂Â§πÁªìÊûÑÔºåÁ°Æ‰øùÊï∞ÊçÆÊ≠£Á°Æ
                    initFolderStructure().then(() => {
                        console.log('Êñá‰ª∂Â§πÁªìÊûÑÂàùÂßãÂåñÂÆåÊàêÔºåÂä†ËΩΩÊñá‰ª∂Â§πÊ†ë');
                        loadFolderTree();
                    }).catch((error) => {
                        console.warn('ÂàùÂßãÂåñÊñá‰ª∂Â§πÁªìÊûÑÂ§±Ë¥•ÔºåÁªßÁª≠Âä†ËΩΩ:', error);
                        // Âç≥‰ΩøÂàùÂßãÂåñÂ§±Ë¥•Ôºå‰πüÁªßÁª≠Âä†ËΩΩÊñá‰ª∂Â§πÊ†ë
                        loadFolderTree();
                    });
                }).catch((error) => {
                    console.error('TokenÈ™åËØÅÂ§±Ë¥•:', error);
                    showNotification('ÁôªÂΩïÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                });
                
                // ËÆæÁΩÆÊñá‰ª∂‰∏ä‰º†‰∫ã‰ª∂
                setupFileUpload();
            });
            
            // ==================== ‰ª§ÁâåÈ™åËØÅ ====================
            function validateToken() {
                // Âú®ÂáΩÊï∞ÂÜÖÈÉ®ÈáçÊñ∞Ëé∑ÂèñtokenÔºåÂ∞ùËØïÂ§öÁßçÂèØËÉΩÁöÑÂ≠òÂÇ®‰ΩçÁΩÆ
                const token = localStorage.getItem('access_token') || localStorage.getItem('aiLearningToken');
                
                return new Promise((resolve, reject) => {
                    enhancedFetch(`${API_BASE_URL}/api/auth/verify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        console.log('È™åËØÅTokenÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                        
                        if (!response.ok) {
                            // Ëé∑ÂèñÈîôËØØËØ¶ÊÉÖ
                            return response.json().then(data => {
                                throw new Error(data.detail || 'TokenÈ™åËØÅÂ§±Ë¥•');
                            }).catch(() => {
                                throw new Error(`HTTP ${response.status}: TokenÈ™åËØÅÂ§±Ë¥•`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('È™åËØÅTokenÂìçÂ∫îÊï∞ÊçÆ:', data);
                        
                        // ÂêåÊó∂Ê£ÄÊü•data.validÂíådata.user_idÔºå‰∏éÂêéÁ´ØÂÆûÁé∞ÂåπÈÖç
                        if (data.valid || data.user_id) {
                            resolve(data);
                        } else {
                            throw new Error('TokenÊó†Êïà');
                        }
                    })
                    .catch(error => {
                        console.error('TokenÈ™åËØÅÂºÇÂ∏∏:', error.message);
                        // ÊòæÁ§∫ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
                        if (error.message.includes('Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®') || error.message.includes('ËØ∑Ê±ÇË∂ÖÊó∂')) {
                            showNotification(error.message, 'error');
                        }
                        // ‰∏çËá™Âä®Ê∏ÖÈô§tokenÔºåÈÅøÂÖçÁî®Êà∑È¢ëÁπÅÁôªÂá∫
                        resolve({valid: false});
                    });
                });
            }
            
            // ==================== ÂàùÂßãÂåñÊñá‰ª∂Â§πÁªìÊûÑ ====================
            function initFolderStructure() {
                return new Promise((resolve, reject) => {
                    const token = localStorage.getItem('access_token') || localStorage.getItem('aiLearningToken');
                    
                    if (!currentUser || !currentUser.id) {
                        reject(new Error('Áî®Êà∑‰ø°ÊÅØ‰∏çÂÆåÊï¥'));
                        return;
                    }
                    
                    enhancedFetch(`${API_BASE_URL}/api/cloud_disk/init-folder-structure`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ÂàùÂßãÂåñÊñá‰ª∂Â§πÁªìÊûÑÂ§±Ë¥•`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Êñá‰ª∂Â§πÁªìÊûÑÂàùÂßãÂåñÊàêÂäü:', data);
                        resolve(data);
                    })
                    .catch(error => {
                        console.error('ÂàùÂßãÂåñÊñá‰ª∂Â§πÁªìÊûÑÂºÇÂ∏∏:', error.message);
                        // ÊòæÁ§∫ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
                        if (error.message.includes('Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®') || error.message.includes('ËØ∑Ê±ÇË∂ÖÊó∂')) {
                            showNotification(`ÂàùÂßãÂåñÊñá‰ª∂Â§πÁªìÊûÑÂ§±Ë¥•: ${error.message}`, 'error');
                        }
                        reject(error);
                    });
                });
            }
            
            // ==================== Âä†ËΩΩÊñá‰ª∂Â§πÊ†ëÔºà‰∏ÄÊ¨°ÊÄßÂä†ËΩΩÂπ∂ÁºìÂ≠òÔºâ ====================
            function loadFolderTree(forceRefresh = false) {
                console.log('Âä†ËΩΩÊñá‰ª∂Â§πÊ†ë... Âº∫Âà∂Âà∑Êñ∞:', forceRefresh);
                
                // Â¶ÇÊûúÂ∑≤ÊúâÁºìÂ≠ò‰∏î‰∏çÊòØÂº∫Âà∂Âà∑Êñ∞ÔºåÁõ¥Êé•‰ΩøÁî®ÁºìÂ≠òÔºà‰∏çÊòæÁ§∫Âä†ËΩΩÊù°Ôºå‰∏çÂèëËØ∑Ê±ÇÔºâ
                if (cachedTreeData && !forceRefresh) {
                    console.log('‚úì ‰ΩøÁî®ÁºìÂ≠òÁöÑÊ†ëÊï∞ÊçÆÔºåÊó†ÈúÄÁΩëÁªúËØ∑Ê±Ç');
                    renderFolderTree(cachedTreeData);
                    return;
                }
                
                // ÈúÄË¶ÅÂà∑Êñ∞Êï∞ÊçÆÊó∂ÊâçÊòæÁ§∫Âä†ËΩΩÊù°
                showLoading(true);
                
                // ÂÜçÊ¨°Ëé∑ÂèñÊúÄÊñ∞ÁöÑtokenÂíåÁî®Êà∑‰ø°ÊÅØÔºåÁ°Æ‰øù‰ΩøÁî®ÊúÄÊñ∞ÂÄº
                const latestToken = localStorage.getItem('access_token') || localStorage.getItem('aiLearningToken');
                const latestUser = JSON.parse(localStorage.getItem('aiLearningUser') || '{}');
                
                // Á°Æ‰øùÊúâÁî®Êà∑ID
                if (!latestUser || !latestUser.id) {
                    showLoading(false);
                    console.error('Áî®Êà∑‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÂä†ËΩΩÊñá‰ª∂Â§πÊ†ë');
                    showNotification('Áî®Êà∑‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï', 'error');
                    return;
                }
                
                // Ë∞ÉÁî®APIÊó∂‰º†ÈÄíuser_idÂèÇÊï∞
                enhancedFetch(`${API_BASE_URL}/api/cloud_disk/files?user_id=${latestUser.id}`, {
                    headers: {
                        'Authorization': `Bearer ${latestToken}`
                    }
                })
                .then(response => {
                    console.log('Ëé∑ÂèñÊñá‰ª∂Â§πÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: Ëé∑ÂèñÊñá‰ª∂Â§πÂ§±Ë¥•`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Ëé∑ÂèñÊñá‰ª∂Â§πÂìçÂ∫îÊï∞ÊçÆ:', data);
                    showLoading(false);
                    
                    if (!data) {
                        throw new Error('ÊúçÂä°Âô®ËøîÂõûÁ©∫Êï∞ÊçÆ');
                    }
                    
                    if (data.tree && data.tree.length > 0) {
                        // ÁºìÂ≠òÊ†ëÊï∞ÊçÆ
                        cachedTreeData = data.tree[0];
                        console.log('‚úì ÁºìÂ≠òÊ†ëÊï∞ÊçÆÊàêÂäü');
                        renderFolderTree(cachedTreeData);
                    } else {
                        console.warn('Ê≤°ÊúâÊñá‰ª∂Â§πÊï∞ÊçÆÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ');
                        showNotification('ÊöÇÊó†Êñá‰ª∂', 'info');
                    }
                })
                .catch(error => {
                    showLoading(false);
                    console.error('Âä†ËΩΩÊñá‰ª∂Â§πÂ§±Ë¥•:', error.message);
                    // ÊòæÁ§∫ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
                    showNotification(`Âä†ËΩΩÊñá‰ª∂Â§πÂ§±Ë¥•: ${error.message}`, 'error');
                });
            }
            
            // ==================== Ê∏≤ÊüìÊñá‰ª∂Â§πÊ†ë ====================
            function renderFolderTree(rootFolder, level = 0) {
                const container = document.getElementById('folderTree');
                
                if (level === 0) {
                    container.innerHTML = '';
                }
                
                // Ê∏≤ÊüìÊ†πÊñá‰ª∂Â§π
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item' + (level === 0 ? ' active' : '');
                folderItem.dataset.folderPath = rootFolder.path;  // Ê∑ªÂä†Ë∑ØÂæÑÊ†áËØÜ
                folderItem.onclick = (e) => {
                    e.stopPropagation();
                    selectFolder(rootFolder.path, rootFolder.name, e.target);
                };
                
                folderItem.innerHTML = `
                    <span class="folder-item-icon">${level === 0 ? 'üìÅ' : 'üìÇ'}</span>
                    <span class="folder-item-name">${rootFolder.name}</span>
                `;
                
                if (level === 0) {
                    container.appendChild(folderItem);
                    // ÂÖàË∞ÉÁî® selectFolder Âä†ËΩΩÊñá‰ª∂ÔºåÂÜçËÆæÁΩÆ selectedFolderPathÔºàÈÅøÂÖçÂàùÂßãÂåñÊó∂Êù°‰ª∂Ê£ÄÊü•ËøáÊó©ËøîÂõûÔºâ
                    selectFolder(rootFolder.path, rootFolder.name, folderItem);
                } else {
                    const parentItem = container.querySelector('.folder-item.active');
                    if (parentItem) {
                        parentItem.parentNode.insertBefore(folderItem, parentItem.nextSibling);
                    }
                }
                
                // ÈÄíÂΩíÊ∏≤ÊüìÂ≠êÊñá‰ª∂Â§π
                if (rootFolder.children && rootFolder.children.length > 0) {
                    rootFolder.children.forEach(child => {
                        if (child.type === 'folder') {
                            renderSubFolder(child, level + 1, container);
                        }
                    });
                }
            }
            
            // Ê∏≤ÊüìÂ≠êÊñá‰ª∂Â§πÔºàÊîØÊåÅÂ±ïÂºÄ/Êî∂Ëµ∑Ôºâ
            function renderSubFolder(folder, level, container) {
                const indent = level * 20;
                const hasChildren = folder.children && folder.children.some(c => c.type === 'folder');
                const isExpanded = expandedFolders.has(folder.path);
                
                // ÂàõÂª∫Êñá‰ª∂Â§πÈ°πÁõÆÂÆπÂô®
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item folder-item-nested';
                folderItem.style.paddingLeft = indent + 'px';
                folderItem.dataset.folderPath = folder.path;
                
                // ÂàõÂª∫Â±ïÂºÄ/Êî∂Ëµ∑ÊåâÈíÆ
                let toggleHTML = '';
                if (hasChildren) {
                    toggleHTML = `<span class="folder-toggle" onclick="toggleFolder(event, '${folder.path}')">
                        ${isExpanded ? '‚ñº' : '‚ñ∂'}
                    </span>`;
                } else {
                    toggleHTML = `<span class="folder-toggle" style="opacity: 0;">¬∑</span>`;
                }
                
                // ÂàõÂª∫ÁÇπÂáªÈÄâÊã©Êñá‰ª∂Â§πÁöÑÈÉ®ÂàÜ
                const selectHTML = `
                    <span class="folder-item-icon">üìÇ</span>
                    <span class="folder-item-name">${folder.name}</span>
                `;
                
                folderItem.innerHTML = toggleHTML + selectHTML;
                
                // ÁÇπÂáªÊñá‰ª∂Â§πÂêçÁß∞Êó∂ÈÄâÊã©Êñá‰ª∂Â§π
                folderItem.querySelector('.folder-item-name').parentElement.onclick = (e) => {
                    e.stopPropagation();
                    selectFolder(folder.path, folder.name, folderItem);
                };
                
                container.appendChild(folderItem);
                
                // ÈÄíÂΩíÊ∏≤ÊüìÂ≠êÊñá‰ª∂Â§π
                if (hasChildren && isExpanded) {
                    folder.children.forEach(child => {
                        if (child.type === 'folder') {
                            renderSubFolder(child, level + 1, container);
                        }
                    });
                }
            }
            
            // ÂàáÊç¢Êñá‰ª∂Â§πÂ±ïÂºÄ/Êî∂Ëµ∑
            function toggleFolder(event, folderPath) {
                event.stopPropagation();
                
                if (expandedFolders.has(folderPath)) {
                    expandedFolders.delete(folderPath);
                    console.log(`‚ñ∂ Êî∂Ëµ∑Êñá‰ª∂Â§π: ${folderPath}`);
                } else {
                    expandedFolders.add(folderPath);
                    console.log(`‚ñº Â±ïÂºÄÊñá‰ª∂Â§π: ${folderPath}`);
                }
                
                // ÈáçÊñ∞Ê∏≤ÊüìÔºà‰ΩøÁî®ÁºìÂ≠òÔºå‰∏çÂèëËØ∑Ê±ÇÔºâ
                if (cachedTreeData) {
                    renderFolderTree(cachedTreeData);
                }
            }
            
            // ==================== ÈÄâÊã©Êñá‰ª∂Â§π ====================
            function selectFolder(folderPath, folderName, eventElement) {
                // Â¶ÇÊûúÈÄâÊã©Âêå‰∏Ä‰∏™Êñá‰ª∂Â§πÔºå‰∏çÈúÄË¶ÅÈáçÊñ∞Âä†ËΩΩÔºà‰ΩÜÂàùÂßãÂåñÊó∂ selectedFolderPath ‰∏∫ nullÔºåÈúÄË¶ÅÂä†ËΩΩÔºâ
                if (selectedFolderPath && selectedFolderPath === folderPath) {
                    console.log('Âêå‰∏ÄÊñá‰ª∂Â§πÔºåÊó†ÈúÄÈáçÊñ∞Âä†ËΩΩ');
                    return;
                }
                
                selectedFolderPath = folderPath;
                console.log(`ÂàáÊç¢Êñá‰ª∂Â§π: ${folderPath}`);
                
                // Ê∏ÖÈô§‰πãÂâçÈÄâ‰∏≠ÁöÑÊñá‰ª∂
                selectedFiles.clear();
                updateFileOperationsToolbar();
                
                // Êõ¥Êñ∞UI
                document.querySelectorAll('.folder-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Ê†áËÆ∞ÂΩìÂâçÊñá‰ª∂Â§π‰∏∫Ê¥ªË∑É
                if (eventElement) {
                    try {
                        const folderElement = eventElement.closest('.folder-item');
                        if (folderElement) {
                            folderElement.classList.add('active');
                        }
                    } catch (e) {
                        console.warn('Êõ¥Êñ∞Ê¥ªË∑ÉÁä∂ÊÄÅÂ§±Ë¥•:', e);
                    }
                }
                
                // Êõ¥Êñ∞Ë∑ØÂæÑÊòæÁ§∫
                document.getElementById('currentPath').textContent = folderPath;
                document.getElementById('contentTitle').textContent = folderName;
                
                // ÊòæÁ§∫Âà†Èô§ÊåâÈíÆÂíåËøîÂõû‰∏ä‰∏ÄÁ∫ßÊåâÈíÆÔºà‰ΩÜ‰ªÖÂú®ÈùûÊ†πÁõÆÂΩïÊó∂Ôºâ
                const isRootFolder = folderPath === '/' || folderPath === '/root/files';
                document.getElementById('deleteFolderBtn').style.display = isRootFolder ? 'none' : 'inline-block';
                document.getElementById('backFolderBtn').style.display = isRootFolder ? 'none' : 'inline-block';
                
                // Áõ¥Êé•‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆÊ∏≤ÊüìÊñá‰ª∂ÂàóË°®ÔºåÊó†ÈúÄÁΩëÁªúËØ∑Ê±ÇÂíåÂä†ËΩΩÊù°
                if (cachedTreeData) {
                    const files = findFilesInFolder(cachedTreeData, folderPath);
                    console.log(`‚úì ‰ªéÁºìÂ≠òËé∑ÂèñÊñá‰ª∂: ${files.length} ‰∏™`);
                    renderFilesList(files);
                } else {
                    // Ê≤°ÊúâÁºìÂ≠òÊó∂ÊâçÂä†ËΩΩÔºàÁ¨¨‰∏ÄÊ¨°ËøõÂÖ•Êñá‰ª∂Â§πÔºâ
                    loadFilesList(folderPath, false);
                }
            }
            
            // ==================== ËøîÂõû‰∏ä‰∏ÄÁ∫ßÁõÆÂΩï ====================
            function goBackToParentFolder() {
                if (!selectedFolderPath) return;
                
                // ÁßªÈô§Êú´Â∞æÁöÑÊñúÊù†
                let path = selectedFolderPath.replace(/\/$/, '');
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÊ†πÁõÆÂΩï
                const isRootFolder = path === '/' || path === '/root/files';
                if (isRootFolder) {
                    showNotification('Â∑≤ÁªèÂú®Ê†πÁõÆÂΩï', 'info');
                    return;
                }
                
                // Ëé∑ÂèñÁà∂ÁõÆÂΩïË∑ØÂæÑ
                const lastSlashIndex = path.lastIndexOf('/');
                let parentPath = path.substring(0, lastSlashIndex + 1);
                
                // Â¶ÇÊûúÁà∂Ë∑ØÂæÑ‰∏∫Á©∫ÔºåËÆæ‰∏∫Ê†πÁõÆÂΩï
                if (!parentPath) {
                    parentPath = '/';
                }
                
                console.log(`ËøîÂõû‰∏ä‰∏ÄÁ∫ß: ${selectedFolderPath} ‚Üí ${parentPath}`);
                
                // ‰ªéÊ†ë‰∏≠ÊâæÂà∞Áà∂Êñá‰ª∂Â§πÁöÑÂêçÁß∞
                let parentFolderName = 'ËøîÂõû';
                if (cachedTreeData) {
                    const parent = findFolderByPath(cachedTreeData, parentPath);
                    if (parent) {
                        parentFolderName = parent.name;
                    }
                }
                
                // ÈÄâÊã©Áà∂Êñá‰ª∂Â§π
                const parentElements = document.querySelectorAll(`[data-folder-path="${parentPath}"]`);
                const parentElement = parentElements.length > 0 ? parentElements[0] : null;
                selectFolder(parentPath, parentFolderName, parentElement);
            }
            
            // Ê†πÊçÆË∑ØÂæÑÊü•ÊâæÊñá‰ª∂Â§π
            function findFolderByPath(tree, targetPath) {
                if (tree.path === targetPath) {
                    return tree;
                }
                
                if (tree.children) {
                    for (let child of tree.children) {
                        if (child.type === 'folder') {
                            const result = findFolderByPath(child, targetPath);
                            if (result) {
                                return result;
                            }
                        }
                    }
                }
                
                return null;
            }
            
            // ==================== Âà∑Êñ∞ÂΩìÂâçÊñá‰ª∂Â§πÔºàÂè™Êõ¥Êñ∞Êñá‰ª∂ÂàóË°®Ôºå‰∏çÊõ¥Êñ∞ÁºìÂ≠òÔºâ ====================
            function refreshCurrentFolder() {
                if (!selectedFolderPath) return;
                
                console.log(`Âà∑Êñ∞Êñá‰ª∂Â§π ${selectedFolderPath} ÁöÑÊñá‰ª∂ÂàóË°®`);
                
                // Â¶ÇÊûúÊúâÁºìÂ≠òÔºåÁõ¥Êé•‰ªéÁºìÂ≠ò‰∏≠Ëé∑ÂèñÂπ∂Ê∏≤ÊüìÊñá‰ª∂ÂàóË°®
                if (cachedTreeData) {
                    const files = findFilesInFolder(cachedTreeData, selectedFolderPath);
                    renderFilesList(files);
                    console.log(`‚úì Â∑≤Âà∑Êñ∞ ${selectedFolderPath} ÁöÑÊñá‰ª∂ÂàóË°® (${files.length} ‰∏™Êñá‰ª∂)`);
                } else {
                    // Ê≤°ÊúâÁºìÂ≠òÊó∂‰ΩøÁî® loadFilesList
                    loadFilesList(selectedFolderPath, false);
                }
            }
            
            // ==================== Âà∑Êñ∞ÂΩìÂâçÊñá‰ª∂Â§πÔºàÊõ¥Êñ∞ÁºìÂ≠òÔºâ ====================
            function refreshCurrentFolderWithUpdate() {
                if (!selectedFolderPath) return;
                
                console.log(`Âà∑Êñ∞Êñá‰ª∂Â§π ${selectedFolderPath} ÁöÑÊñá‰ª∂ÂàóË°®ÔºàÊõ¥Êñ∞ÁºìÂ≠òÔºâ`);
                
                // Ê∏ÖÈô§ÁºìÂ≠òÔºåÂº∫Âà∂ÈáçÊñ∞Âä†ËΩΩÊ†ëÊï∞ÊçÆ
                cachedTreeData = null;
                
                enhancedFetch(`${API_BASE_URL}/api/cloud_disk/files?user_id=${currentUser.id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.tree && data.tree.length > 0) {
                        cachedTreeData = data.tree[0];
                        // ‰ªéÊñ∞ÁºìÂ≠ò‰∏≠Ëé∑ÂèñÂΩìÂâçÊñá‰ª∂Â§πÁöÑÊñá‰ª∂
                        const files = findFilesInFolder(cachedTreeData, selectedFolderPath);
                        renderFilesList(files);
                        console.log(`‚úì Â∑≤Âà∑Êñ∞ ${selectedFolderPath} ÁöÑÊñá‰ª∂ÂàóË°® (${files.length} ‰∏™Êñá‰ª∂) - ÁºìÂ≠òÂ∑≤Êõ¥Êñ∞`);
                    }
                })
                .catch(error => {
                    console.error('Âà∑Êñ∞Êñá‰ª∂ÂàóË°®Â§±Ë¥•:', error);
                    showNotification(`Âà∑Êñ∞Â§±Ë¥•: ${error.message}`, 'error');
                });
            }
            
            // ==================== Âà∑Êñ∞Ê†ëÁªìÊûÑÂπ∂‰øùÊåÅÂΩìÂâçÊñá‰ª∂Â§πÈÄâÊã© ====================
            function refreshTreeAndRestoreFolder() {
                const previousFolderPath = selectedFolderPath;
                cachedTreeData = null;
                
                console.log(`Âà∑Êñ∞Ê†ëÁªìÊûÑÔºå‰øùÊåÅÊñá‰ª∂Â§πÈÄâÊã©: ${previousFolderPath}`);
                showLoading(true);
                
                enhancedFetch(`${API_BASE_URL}/api/cloud_disk/files?user_id=${currentUser.id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: Ëé∑ÂèñÊñá‰ª∂Â§πÂ§±Ë¥•`);
                    }
                    return response.json();
                })
                .then(data => {
                    showLoading(false);
                    
                    if (data.tree && data.tree.length > 0) {
                        cachedTreeData = data.tree[0];
                        renderFolderTree(cachedTreeData);
                        
                        // Â¶ÇÊûú‰πãÂâçÈÄâ‰∏≠ÁöÑÊñá‰ª∂Â§π‰∏çÊòØÊ†πÊñá‰ª∂Â§πÔºåÊâãÂä®ÊÅ¢Â§çÈÄâÊã©
                        if (previousFolderPath && previousFolderPath !== cachedTreeData.path) {
                            // Âú®‰∏ã‰∏Ä‰∏™‰∫ã‰ª∂Âæ™ÁéØ‰∏≠ÊâßË°åÔºåÁ°Æ‰øùDOMÂ∑≤Êõ¥Êñ∞
                            setTimeout(() => {
                                const targetElements = document.querySelectorAll(`[data-folder-path="${previousFolderPath}"]`);
                                if (targetElements.length > 0) {
                                    const targetElement = targetElements[0];
                                    const folderName = targetElement.querySelector('.folder-item-name')?.textContent || previousFolderPath;
                                    selectFolder(previousFolderPath, folderName, targetElement);
                                    console.log(`‚úì ÊÅ¢Â§çÊñá‰ª∂Â§πÈÄâÊã©: ${previousFolderPath}`);
                                } else {
                                    console.log(`‚ö† Êñá‰ª∂Â§π ${previousFolderPath} ‰∏çÂ≠òÂú®ÔºåÂ∑≤ÂàáÊç¢Âà∞Ê†πÁõÆÂΩï`);
                                }
                            }, 0);
                        }
                    }
                })
                .catch(error => {
                    showLoading(false);
                    console.error('Âà∑Êñ∞Ê†ëÂ§±Ë¥•:', error);
                    showNotification(`Âà∑Êñ∞Â§±Ë¥•: ${error.message}`, 'error');
                });
            }
            
            // ==================== Âä†ËΩΩÊñá‰ª∂ÂàóË°® ====================
            function loadFilesList(folderPath, showLoadingBar = true) {
                console.log('ÂºÄÂßãÂä†ËΩΩÊñá‰ª∂ÂàóË°®ÔºåÊñá‰ª∂Â§πË∑ØÂæÑ:', folderPath);
                if (showLoadingBar) showLoading(true);
                
                enhancedFetch(`${API_BASE_URL}/api/cloud_disk/files?user_id=${currentUser.id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    console.log('Ëé∑ÂèñÊñá‰ª∂ÂàóË°®ÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: Ëé∑ÂèñÊñá‰ª∂ÂàóË°®Â§±Ë¥•`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Ëé∑ÂèñÊñá‰ª∂ÂàóË°®ÊàêÂäüÔºåÊï∞ÊçÆ:', data);
                    if (showLoadingBar) showLoading(false);
                    
                    if (!data || !data.tree || !Array.isArray(data.tree)) {
                        console.warn('ÂìçÂ∫îÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÊ≤°ÊúâtreeÂ≠óÊÆµ');
                        renderFilesList([]);
                        return;
                    }
                    
                    // ÊâæÂà∞ÂØπÂ∫îÊñá‰ª∂Â§πÁöÑÊñá‰ª∂
                    const files = findFilesInFolder(data.tree[0], folderPath);
                    console.log(`ÊâæÂà∞ ${files.length} ‰∏™Êñá‰ª∂Âú®Êñá‰ª∂Â§π ${folderPath}`);
                    renderFilesList(files);
                })
                .catch(error => {
                    if (showLoadingBar) showLoading(false);
                    console.error('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•:', error.message);
                    showNotification(`Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•: ${error.message}`, 'error');
                });
            }
            
            // Êü•ÊâæÊñá‰ª∂Â§π‰∏≠ÁöÑÊñá‰ª∂
            function findFilesInFolder(tree, targetPath) {
                if (tree.path === targetPath) {
                    return tree.children ? tree.children.filter(c => c.type === 'file') : [];
                }
                
                if (tree.children) {
                    for (let child of tree.children) {
                        if (child.type === 'folder') {
                            const result = findFilesInFolder(child, targetPath);
                            if (result.length > 0) {
                                return result;
                            }
                        }
                    }
                }
                
                return [];
            }
            
            // ==================== Ê∏≤ÊüìÊñá‰ª∂ÂàóË°® ====================
            function renderFilesList(files) {
                const fileList = document.getElementById('fileList');
                
                if (!files || files.length === 0) {
                    fileList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÑ</div>
                            <div class="empty-state-title">ÊöÇÊó†Êñá‰ª∂</div>
                            <div class="empty-state-text">‰∏ä‰º†Êñá‰ª∂Âà∞Ê≠§Êñá‰ª∂Â§π</div>
                        </div>
                    `;
                    // Ê∏ÖÁ©∫ÈÄâ‰∏≠Êñá‰ª∂
                    selectedFiles.clear();
                    updateFileOperationsToolbar();
                    return;
                }
                
                fileList.innerHTML = '';
                files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.dataset.fileId = file.id;
                    fileItem.dataset.fileName = file.original_name;
                    
                    const isSelected = selectedFiles.has(file.id);
                    if (isSelected) {
                        fileItem.classList.add('selected');
                    }
                    
                    fileItem.innerHTML = `
                        <input type="checkbox" class="file-item-checkbox" ${isSelected ? 'checked' : ''} data-file-id="${file.id}">
                        <div class="file-item-icon">${getFileIcon(file.original_name)}</div>
                        <div class="file-item-info">
                            <div class="file-item-name">${file.original_name}</div>
                            <div class="file-item-meta">
                                <span>${formatFileSize(file.file_size)}</span>
                                <span>${formatDate(file.upload_time)}</span>
                            </div>
                        </div>
                        <button class="file-item-preview-btn" title="È¢ÑËßàÊñá‰ª∂" data-file-id="${file.id}" data-file-name="${file.original_name}">
                            üëÅÔ∏è
                        </button>
                    `;
                    
                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    fileItem.addEventListener('click', (e) => {
                        // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØcheckboxÔºå‰∏çÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
                        if (e.target.className === 'file-item-checkbox') {
                            return;
                        }
                        // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÈ¢ÑËßàÊåâÈíÆ
                        if (e.target.closest('.file-item-preview-btn')) {
                            e.stopPropagation();
                            return;
                        }
                        // Âê¶ÂàôÂàáÊç¢checkboxÁä∂ÊÄÅ
                        e.stopPropagation();
                        const checkbox = fileItem.querySelector('.file-item-checkbox');
                        checkbox.checked = !checkbox.checked;
                        toggleFileSelection(file.id, checkbox.checked, fileItem);
                    });
                    
                    // Ê∑ªÂä†checkboxÂèòÊõ¥‰∫ã‰ª∂
                    const checkbox = fileItem.querySelector('.file-item-checkbox');
                    checkbox.addEventListener('change', (e) => {
                        e.stopPropagation();
                        toggleFileSelection(file.id, checkbox.checked, fileItem);
                    });
                    
                    // Ê∑ªÂä†È¢ÑËßàÊåâÈíÆ‰∫ã‰ª∂
                    const previewBtn = fileItem.querySelector('.file-item-preview-btn');
                    previewBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        previewFile(file.id, file.original_name);
                    });
                    
                    fileList.appendChild(fileItem);
                });
            }
            
            // ==================== Êñá‰ª∂ÈÄâÊã©ÁÆ°ÁêÜ ====================
            function toggleFileSelection(fileId, isSelected, fileElement) {
                if (isSelected) {
                    selectedFiles.add(fileId);
                    fileElement.classList.add('selected');
                    console.log(`‚úì ÈÄâ‰∏≠Êñá‰ª∂: ${fileId}`);
                } else {
                    selectedFiles.delete(fileId);
                    fileElement.classList.remove('selected');
                    console.log(`‚úó ÂèñÊ∂àÈÄâ‰∏≠Êñá‰ª∂: ${fileId}`);
                }
                updateFileOperationsToolbar();
            }
            
            function updateFileOperationsToolbar() {
                const selectionGroup = document.getElementById('selectionActionsGroup');
                const count = selectedFiles.size;
                
                if (count === 0) {
                    // Êú™ÈÄâ‰∏≠Êñá‰ª∂ÔºåÈöêËóèÈÄâÊã©Áõ∏ÂÖ≥ÊåâÈíÆ
                    selectionGroup.style.display = 'none';
                } else {
                    // ÈÄâ‰∏≠Êñá‰ª∂ÔºåÊòæÁ§∫ÈÄâÊã©Áõ∏ÂÖ≥ÊåâÈíÆ
                    selectionGroup.style.display = 'flex';
                    document.getElementById('selectedFilesCount').textContent = `Â∑≤ÈÄâÊã© ${count} ‰∏™Êñá‰ª∂`;
                }
            }
            
            function clearFileSelection() {
                selectedFiles.clear();
                document.querySelectorAll('.file-item-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('selected');
                });
                updateFileOperationsToolbar();
                console.log('Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâÈÄâÊã©');
            }
            
            // ==================== Êñá‰ª∂‰∏ä‰º† ====================
            function setupFileUpload() {
                const fileInput = document.getElementById('fileInput');
                
                fileInput.addEventListener('change', function(e) {
                    uploadFiles(e.target.files);
                    this.value = '';
                });
            }
            
            // ==================== ÁîüÊàêÊñ∞Êñá‰ª∂Âêç ====================
            function generateNewFileName(originalName) {
                const lastDotIndex = originalName.lastIndexOf('.');
                if (lastDotIndex === -1) {
                    return originalName + '_1';
                }
                const name = originalName.substring(0, lastDotIndex);
                const ext = originalName.substring(lastDotIndex);
                return name + '_1' + ext;
            }
            
            // ==================== Ëá™ÂÆö‰πâÂØπËØùÊ°ÜÂáΩÊï∞ ====================
            
            // ÊòæÁ§∫Âà†Èô§Á°ÆËÆ§ÂØπËØùÊ°Ü
            function showDeleteConfirmDialog(message) {
                return new Promise((resolve) => {
                    const overlay = document.getElementById('deleteConfirmDialogOverlay');
                    const messageEl = document.getElementById('deleteConfirmMessage');
                    const confirmBtn = document.getElementById('deleteConfirmBtn');
                    const cancelBtn = document.getElementById('deleteConfirmCancelBtn');
                    
                    messageEl.textContent = message;
                    
                    const handleConfirm = () => {
                        cleanup();
                        resolve(true);
                    };
                    
                    const handleCancel = () => {
                        cleanup();
                        resolve(false);
                    };
                    
                    const cleanup = () => {
                        overlay.classList.remove('show');
                        confirmBtn.removeEventListener('click', handleConfirm);
                        cancelBtn.removeEventListener('click', handleCancel);
                    };
                    
                    confirmBtn.addEventListener('click', handleConfirm);
                    cancelBtn.addEventListener('click', handleCancel);
                    
                    overlay.classList.add('show');
                    confirmBtn.focus();
                });
            }
            
            // ÊòæÁ§∫ÂÜ≤Á™ÅÊñá‰ª∂Á°ÆËÆ§ÂØπËØùÊ°Ü
            function showConflictConfirmDialog(conflictFiles) {
                return new Promise((resolve) => {
                    const overlay = document.getElementById('conflictConfirmDialogOverlay');
                    const filesList = document.getElementById('conflictFilesList');
                    const confirmBtn = document.getElementById('conflictConfirmBtn');
                    const cancelBtn = document.getElementById('conflictCancelBtn');
                    
                    // Ê∏ÖÁ©∫ÂàóË°®
                    filesList.innerHTML = '';
                    
                    // Ê∑ªÂä†ÂÜ≤Á™ÅÊñá‰ª∂ÂàóË°®
                    conflictFiles.forEach((fileName) => {
                        const item = document.createElement('div');
                        item.className = 'conflict-file-item';
                        item.innerHTML = `
                            <span class="conflict-file-icon">üìÑ</span>
                            <span class="conflict-file-name" title="${fileName}">${fileName}</span>
                        `;
                        filesList.appendChild(item);
                    });
                    
                    const handleConfirm = () => {
                        cleanup();
                        resolve(true);
                    };
                    
                    const handleCancel = () => {
                        cleanup();
                        resolve(false);
                    };
                    
                    const cleanup = () => {
                        overlay.classList.remove('show');
                        confirmBtn.removeEventListener('click', handleConfirm);
                        cancelBtn.removeEventListener('click', handleCancel);
                    };
                    
                    confirmBtn.addEventListener('click', handleConfirm);
                    cancelBtn.addEventListener('click', handleCancel);
                    
                    overlay.classList.add('show');
                    confirmBtn.focus();
                });
            }
            
            // ÊòæÁ§∫‰∏ä‰º†Êñá‰ª∂ÁºñËæëÂØπËØùÊ°ÜÔºàÊòæÁ§∫ÊâÄÊúâÊñá‰ª∂ÔºåÂÖÅËÆ∏ÁÇπÂáªÁºñËæëÔºâ
            function showUploadEditDialog(allFiles, conflictFileNames) {
                return new Promise((resolve) => {
                    const overlay = document.getElementById('uploadEditDialogOverlay');
                    const itemsContainer = document.getElementById('uploadListItems');
                    const confirmBtn = document.getElementById('uploadEditConfirmBtn');
                    const cancelBtn = document.getElementById('uploadEditCancelBtn');
                    
                    // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
                    if (!overlay || !itemsContainer || !confirmBtn || !cancelBtn) {
                        console.error('ÂØπËØùÊ°ÜÂÖÉÁ¥†Êâæ‰∏çÂà∞!', {
                            overlay: !!overlay,
                            itemsContainer: !!itemsContainer,
                            confirmBtn: !!confirmBtn,
                            cancelBtn: !!cancelBtn
                        });
                        resolve(null);
                        return;
                    }
                    
                    console.log(`ÊòæÁ§∫ÁºñËæëÂØπËØùÊ°ÜÔºåÂÖ± ${allFiles.length} ‰∏™Êñá‰ª∂`);
                    
                    // Ê∏ÖÁ©∫ÂàóË°®
                    itemsContainer.innerHTML = '';
                    
                    // ÂàõÂª∫ÁªìÊûúÂØπË±°Êù•Â≠òÂÇ®Êñá‰ª∂ÂêçÊò†Â∞Ñ
                    const result = {};
                    
                    // ‰∏∫ÊØè‰∏™‰∏ä‰º†Êñá‰ª∂ÂàõÂª∫ÂàóË°®È°π
                    allFiles.forEach((file, index) => {
                        const item = document.createElement('div');
                        item.className = 'upload-list-item';
                        
                        const isConflict = conflictFileNames.has(file.name);
                        const fileId = `upload-item-${index}`;
                        
                        // ÂàùÂßãÂåñÁªìÊûú
                        result[index] = {
                            originalName: file.name,
                            finalName: file.name,
                            isConflict: isConflict,
                            file: file
                        };
                        
                        const statusClass = isConflict ? 'conflict' : 'normal';
                        const statusText = isConflict ? '‚ö†Ô∏è ÂÜ≤Á™Å' : '‚úì Êñ∞Êñá‰ª∂';
                        
                        item.innerHTML = `
                            <div class="upload-item-status ${statusClass}">
                                <span class="upload-item-status-badge">${statusText}</span>
                            </div>
                            <div class="upload-item-name editable" id="${fileId}" title="ÁÇπÂáªÁºñËæëÊñá‰ª∂Âêç">${file.name}</div>
                        `;
                        
                        itemsContainer.appendChild(item);
                        
                        // Ëé∑ÂèñÁä∂ÊÄÅÊòæÁ§∫ÂÖÉÁ¥†
                        const statusElement = item.querySelector('.upload-item-status');
                        
                        // ÁªëÂÆöÁºñËæë‰∫ã‰ª∂
                        const nameElement = item.querySelector(`#${fileId}`);
                        let isEditing = false;
                        
                        nameElement.addEventListener('click', (e) => {
                            if (isEditing) return;
                            isEditing = true;
                            
                            // ÂàõÂª∫ËæìÂÖ•Ê°Ü
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.className = 'upload-item-name-input';
                            input.value = result[index].finalName;
                            
                            nameElement.innerHTML = '';
                            nameElement.appendChild(input);
                            input.focus();
                            input.select();
                            
                            // ÂÆûÊó∂ÁõëÂê¨ËæìÂÖ•ÔºåÊõ¥Êñ∞ÂÜ≤Á™ÅÁä∂ÊÄÅ
                            input.addEventListener('input', (e) => {
                                const currentName = e.target.value.trim();
                                
                                console.log(`ÂÆûÊó∂Ê£ÄÊü•Êñá‰ª∂Âêç: ${currentName}`);
                                
                                // Ê£ÄÊü•ÂΩìÂâçÂêçÁß∞ÊòØÂê¶ÂÜ≤Á™ÅÔºàÊ£ÄÊü•‰∏éÁé∞ÊúâÊñá‰ª∂ÂêçÔºâ
                                const hasConflictWithExisting = conflictFileNames.has(currentName);
                                console.log(`‰∏éÁé∞ÊúâÊñá‰ª∂ÂÜ≤Á™Å: ${hasConflictWithExisting}`);
                                
                                // Ê£ÄÊü•‰∏éÂÖ∂‰ªñÂæÖ‰∏ä‰º†Êñá‰ª∂ÁöÑÂÜ≤Á™ÅÔºàÈúÄË¶ÅÈÅçÂéÜÊâÄÊúâËæìÂÖ•Ê°ÜÔºâ
                                let hasConflictWithOthers = false;
                                const allInputs = itemsContainer.querySelectorAll('.upload-item-name-input, .upload-item-name');
                                for (let otherItem of allInputs) {
                                    // Ë∑≥ËøáËá™Â∑±
                                    if (otherItem === input) continue;
                                    
                                    let otherName = '';
                                    if (otherItem.className === 'upload-item-name-input') {
                                        // ÂÖ∂‰ªñÈ°π‰πüÂú®ÁºñËæë
                                        otherName = otherItem.value.trim();
                                    } else if (otherItem.className.includes('upload-item-name')) {
                                        // ÂÖ∂‰ªñÈ°π‰∏çÂú®ÁºñËæëÔºåÊòæÁ§∫ÁöÑÊòØÊúÄÁªàÂêçÁß∞
                                        otherName = otherItem.textContent.trim();
                                    }
                                    
                                    if (otherName && otherName === currentName) {
                                        hasConflictWithOthers = true;
                                        console.log(`‰∏éÂÖ∂‰ªñÂæÖ‰∏ä‰º†Êñá‰ª∂ÂÜ≤Á™Å: ${otherName}`);
                                        break;
                                    }
                                }
                                
                                const hasConflict = hasConflictWithExisting || hasConflictWithOthers;
                                console.log(`ÊúÄÁªàÂÜ≤Á™ÅÂà§Êñ≠: ${hasConflict}`);
                                
                                // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
                                if (hasConflict) {
                                    statusElement.className = 'upload-item-status conflict';
                                    statusElement.innerHTML = '<span class="upload-item-status-badge">‚ö†Ô∏è ÂÜ≤Á™Å</span>';
                                } else {
                                    statusElement.className = 'upload-item-status normal';
                                    statusElement.innerHTML = '<span class="upload-item-status-badge">‚úì Êñ∞Êñá‰ª∂</span>';
                                }
                            });
                            
                            // ‰øùÂ≠òÊñá‰ª∂Âêç
                            const saveFileName = () => {
                                const newName = input.value.trim();
                                if (newName === '') {
                                    showNotification('Êñá‰ª∂Âêç‰∏çËÉΩ‰∏∫Á©∫', 'warning');
                                    return;
                                }
                                result[index].finalName = newName;
                                nameElement.classList.add('editable');
                                nameElement.innerHTML = newName;
                                
                                // ÊúÄÁªàÁ°ÆËÆ§ÂÜ≤Á™ÅÁä∂ÊÄÅ
                                const hasConflictWithExisting = conflictFileNames.has(newName);
                                let hasConflictWithOthers = false;
                                for (let key in result) {
                                    if (key !== String(index) && result[key].finalName === newName) {
                                        hasConflictWithOthers = true;
                                        break;
                                    }
                                }
                                
                                const hasConflict = hasConflictWithExisting || hasConflictWithOthers;
                                
                                if (hasConflict) {
                                    statusElement.className = 'upload-item-status conflict';
                                    statusElement.innerHTML = '<span class="upload-item-status-badge">‚ö†Ô∏è ÂÜ≤Á™Å</span>';
                                } else {
                                    statusElement.className = 'upload-item-status normal';
                                    statusElement.innerHTML = '<span class="upload-item-status-badge">‚úì Êñ∞Êñá‰ª∂</span>';
                                }
                                
                                isEditing = false;
                            };
                            
                            // ÂõûËΩ¶ÊàñÂ§±ÁÑ¶Êó∂‰øùÂ≠ò
                            input.addEventListener('keydown', (e) => {
                                if (e.key === 'Enter') {
                                    saveFileName();
                                } else if (e.key === 'Escape') {
                                    nameElement.innerHTML = result[index].finalName;
                                    isEditing = false;
                                }
                            });
                            
                            input.addEventListener('blur', saveFileName);
                        });
                    });
                    
                    const handleConfirm = async () => {
                        // È™åËØÅÊâÄÊúâÊñá‰ª∂Âêç
                        const fileNameSet = new Set();
                        const conflictingFiles = [];
                        
                        for (let key in result) {
                            const newName = result[key].finalName.trim();
                            if (newName === '') {
                                showNotification(`Êñá‰ª∂ "${result[key].originalName}" ÁöÑÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫`, 'warning');
                                return;
                            }
                            result[key].finalName = newName;
                            
                            // Ê£ÄÊü•ÊòØÂê¶‰∏éÁé∞ÊúâÊñá‰ª∂ÂÜ≤Á™Å
                            if (conflictFileNames.has(newName)) {
                                conflictingFiles.push(newName);
                            }
                            
                            // Ê£ÄÊü•ÊòØÂê¶‰∏éÂÖ∂‰ªñÂæÖ‰∏ä‰º†Êñá‰ª∂ÈáçÂ§ç
                            if (fileNameSet.has(newName)) {
                                showNotification(`Êñá‰ª∂Âêç "${newName}" ÈáçÂ§çÔºåËØ∑‰øÆÊîπ`, 'warning');
                                return;
                            }
                            fileNameSet.add(newName);
                        }
                        
                        // Â¶ÇÊûúÊúâÂÜ≤Á™ÅÊñá‰ª∂ÔºåÊèêÁ§∫Áî®Êà∑
                        if (conflictingFiles.length > 0) {
                            // ‰ΩøÁî®Ëá™ÂÆö‰πâÂØπËØùÊ°ÜËÄå‰∏çÊòØÂéüÁîü confirm
                            const shouldContinue = await showConflictConfirmDialog(conflictingFiles);
                            if (!shouldContinue) {
                                return;
                            }
                        }
                        
                        cleanup();
                        resolve(result);
                    };
                    
                    const handleCancel = () => {
                        cleanup();
                        resolve(null);
                    };
                    
                    const cleanup = () => {
                        overlay.classList.remove('show');
                        confirmBtn.removeEventListener('click', handleConfirm);
                        cancelBtn.removeEventListener('click', handleCancel);
                    };
                    
                    confirmBtn.addEventListener('click', handleConfirm);
                    cancelBtn.addEventListener('click', handleCancel);
                    
                    overlay.classList.add('show');
                    confirmBtn.focus();
                });
            }
            
            // ==================== Ê£ÄÊü•ÂíåÂ§ÑÁêÜÊñá‰ª∂ÂÜ≤Á™ÅÔºàÂºÇÊ≠•Ôºâ ====================
            async function checkAndHandleFileConflicts(files, folderPath) {
                // Ëé∑ÂèñÂΩìÂâçÊñá‰ª∂Â§πÁöÑÁé∞ÊúâÊñá‰ª∂
                let existingFileNames = new Set();
                
                if (cachedTreeData) {
                    const existingFiles = findFilesInFolder(cachedTreeData, folderPath);
                    existingFileNames = new Set(existingFiles.map(f => f.original_name));
                    console.log(`ÊâæÂà∞ ${existingFiles.length} ‰∏™Áé∞ÊúâÊñá‰ª∂`);
                } else {
                    console.log('ÁºìÂ≠ò‰∏çÂ≠òÂú®ÔºåÂ∞ÜË∑≥ËøáÂÜ≤Á™ÅÊ£ÄÊü•');
                }
                
                // Êó†ËÆ∫ÊúâÊ≤°ÊúâÂÜ≤Á™ÅÔºåÈÉΩÊòæÁ§∫ÁºñËæëÂØπËØùÊ°ÜÁªôÁî®Êà∑È¢ÑËßàÂíåÁºñËæë
                console.log('ÊòæÁ§∫‰∏ä‰º†Êñá‰ª∂ÁºñËæëÂØπËØùÊ°Ü...');
                const editResult = await showUploadEditDialog(files, existingFileNames);
                
                if (editResult === null) {
                    // Áî®Êà∑ÂèñÊ∂à‰∫ÜÊï¥‰∏™Êìç‰Ωú
                    console.log('Áî®Êà∑Â∑≤ÂèñÊ∂à‰∏ä‰º†');
                    return [];
                }
                
                // Â§ÑÁêÜÁî®Êà∑ÁöÑÈÄâÊã©ÔºåÊûÑÂª∫ÊúÄÁªà‰∏ä‰º†ÁöÑÊñá‰ª∂ÂàóË°®
                const processedFiles = [];
                for (let key in editResult) {
                    const entry = editResult[key];
                    processedFiles.push({
                        originalFile: entry.file,
                        finalName: entry.finalName
                    });
                    
                    if (entry.originalName !== entry.finalName) {
                        console.log(`‚úì Êñá‰ª∂Â∞ÜÈáçÂëΩÂêç: ${entry.originalName} ‚Üí ${entry.finalName}`);
                    } else {
                        console.log(`‚úì Êñá‰ª∂Â∞Ü‰∏ä‰º†: ${entry.finalName}`);
                    }
                }
                
                console.log(`ÂáÜÂ§á‰∏ä‰º† ${processedFiles.length} ‰∏™Êñá‰ª∂`);
                return processedFiles;
            }
            
            async function uploadFiles(files) {
                if (!selectedFolderPath) {
                    showNotification('ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂Â§π', 'warning');
                    return;
                }
                
                if (files.length === 0) return;
                
                // Â∞Ü FileList ËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
                const fileArray = Array.from(files);
                console.log(`Áî®Êà∑ÈÄâÊã©‰∫Ü ${fileArray.length} ‰∏™Êñá‰ª∂`);
                
                // Ê£ÄÊü•Âπ∂Â§ÑÁêÜÊñá‰ª∂ÂÜ≤Á™ÅÔºàÁ≠âÂæÖÁî®Êà∑ÁºñËæëÔºâ
                const processedFiles = await checkAndHandleFileConflicts(fileArray, selectedFolderPath);
                
                if (processedFiles.length === 0) {
                    showNotification('Â∑≤ÂèñÊ∂à‰∏ä‰º†', 'info');
                    return;
                }
                
                console.log(`ÂºÄÂßã‰∏ä‰º† ${processedFiles.length} ‰∏™Êñá‰ª∂Âà∞ ${selectedFolderPath}`);
                showLoading(true);
                
                let uploadedCount = 0;
                let errorCount = 0;
                
                // È°∫Â∫è‰∏ä‰º†ÊØè‰∏™Êñá‰ª∂
                for (let i = 0; i < processedFiles.length; i++) {
                    const { originalFile, finalName } = processedFiles[i];
                    console.log(`‰∏ä‰º†Êñá‰ª∂ ${i + 1}/${processedFiles.length}: ${finalName}`);
                    
                    try {
                        const formData = new FormData();
                        // ‰ΩøÁî® FormData ÁöÑÁ¨¨‰∏â‰∏™ÂèÇÊï∞ÊåáÂÆö‰∏ä‰º†ÂêéÁöÑÊñá‰ª∂Âêç
                        formData.append('file', originalFile, finalName);
                        formData.append('folder_path', selectedFolderPath);
                        
                        console.log(`Ê≠£Âú®‰∏ä‰º†: ${finalName}`);
                        const response = await enhancedFetch(`${API_BASE_URL}/api/cloud_disk/upload`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            body: formData
                        });
                        
                        console.log(`${finalName} ÂìçÂ∫îÁä∂ÊÄÅ: ${response.status}`);
                        
                    if (!response.ok) {
                        // Â∞ùËØïËØªÂèñÊúçÂä°Âô®ËøîÂõûÁöÑÈîôËØØËØ¶ÊÉÖ
                        let errorDetail = `HTTP ${response.status}`;
                        let errorData = null;
                        try {
                            errorData = await response.json();
                            errorDetail = errorData.detail || errorData.message || errorData.error || errorDetail;
                            console.error(`${finalName} ÊúçÂä°Âô®ÈîôËØØËØ¶ÊÉÖ:`, errorData);
                            
                            // ÂàÜÊûêÂ∏∏ËßÅÈîôËØØÁ±ªÂûãÔºåÊèê‰æõÊõ¥ÂèãÂ•ΩÁöÑÊèêÁ§∫
                            if (errorDetail.includes('Permission denied') || errorDetail.includes('ÊùÉÈôê')) {
                                errorDetail = `Êñá‰ª∂Á≥ªÁªüÊùÉÈôêÈîôËØØÔºöÊúçÂä°Âô®Êó†Ê≥ïÂú®ÁõÆÊ†áÁõÆÂΩïÂàõÂª∫Êñá‰ª∂„ÄÇ\n\nÈîôËØØËØ¶ÊÉÖÔºö${errorDetail}\n\nËß£ÂÜ≥ÊñπÊ°àÔºö\n1. Ê£ÄÊü•ÊúçÂä°Âô®ÁõÆÂΩïÊùÉÈôêÔºàÈúÄË¶ÅÂÜôÂÖ•ÊùÉÈôêÔºâ\n2. Á°Æ‰øùËøêË°åÊúçÂä°Âô®ÁöÑÁî®Êà∑ÊúâÊùÉÈôêËÆøÈóÆÁõÆÊ†áÁõÆÂΩï\n3. ËÅîÁ≥ªÁÆ°ÁêÜÂëòÊ£ÄÊü•ÊúçÂä°Âô®ÈÖçÁΩÆ`;
                            } else if (errorDetail.includes('No space left') || errorDetail.includes('Á£ÅÁõòÁ©∫Èó¥')) {
                                errorDetail = `Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºöÊúçÂä°Âô®Á£ÅÁõòÁ©∫Èó¥Â∑≤Êª°„ÄÇ\n\nÈîôËØØËØ¶ÊÉÖÔºö${errorDetail}\n\nËß£ÂÜ≥ÊñπÊ°àÔºö\n1. Ê∏ÖÁêÜÊúçÂä°Âô®Á£ÅÁõòÁ©∫Èó¥\n2. Âà†Èô§‰∏çÈúÄË¶ÅÁöÑÊñá‰ª∂\n3. ËÅîÁ≥ªÁÆ°ÁêÜÂëòÂ¢ûÂä†Â≠òÂÇ®Á©∫Èó¥`;
                            } else if (errorDetail.includes('File too large') || errorDetail.includes('Êñá‰ª∂Â§™Â§ß')) {
                                errorDetail = `Êñá‰ª∂Â§ßÂ∞èË∂ÖÈôêÔºöÊñá‰ª∂Ë∂ÖËøáÊúçÂä°Âô®ÂÖÅËÆ∏ÁöÑÊúÄÂ§ßÂ§ßÂ∞è„ÄÇ\n\nÈîôËØØËØ¶ÊÉÖÔºö${errorDetail}\n\nËß£ÂÜ≥ÊñπÊ°àÔºö\n1. ÂéãÁº©Êñá‰ª∂ÂêéÈáçÊñ∞‰∏ä‰º†\n2. ÂàÜÂâ≤Â§ßÊñá‰ª∂\n3. ËÅîÁ≥ªÁÆ°ÁêÜÂëòË∞ÉÊï¥Êñá‰ª∂Â§ßÂ∞èÈôêÂà∂`;
                            } else if (errorDetail.includes('Invalid file type') || errorDetail.includes('Êñá‰ª∂Á±ªÂûã')) {
                                errorDetail = `‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûãÔºöÊúçÂä°Âô®‰∏çÂÖÅËÆ∏‰∏ä‰º†Ê≠§Á±ªÂûãÁöÑÊñá‰ª∂„ÄÇ\n\nÈîôËØØËØ¶ÊÉÖÔºö${errorDetail}\n\nËß£ÂÜ≥ÊñπÊ°àÔºö\n1. Ê£ÄÊü•Êñá‰ª∂Á±ªÂûãÊòØÂê¶Âú®ÂÖÅËÆ∏ÂàóË°®‰∏≠\n2. ËÅîÁ≥ªÁÆ°ÁêÜÂëòÊ∑ªÂä†Êñá‰ª∂Á±ªÂûãÊîØÊåÅ`;
                            }
                        } catch (e) {
                            // Â¶ÇÊûúÊó†Ê≥ïËß£ÊûêJSONÔºåÂ∞ùËØïËØªÂèñÊñáÊú¨
                            try {
                                const errorText = await response.text();
                                if (errorText) {
                                    errorDetail = `${errorDetail}: ${errorText.substring(0, 200)}`;
                                }
                            } catch (e2) {
                                // ÂøΩÁï•ÊñáÊú¨ËØªÂèñÈîôËØØ
                            }
                        }
                        throw new Error(errorDetail);
                    }
                        
                        // Â∞ùËØïËß£ÊûêJSON
                        let data;
                        try {
                            data = await response.json();
                            console.log(`${finalName} ‰∏ä‰º†ÊàêÂäü:`, data);
                        } catch (e) {
                            console.log(`${finalName} ‰∏ä‰º†ÊàêÂäüÔºàÊó†JSONÔºâ`);
                            data = { message: 'ÊàêÂäü' };
                        }
                        
                        uploadedCount++;
                        console.log(`‚úì ${finalName} ‰∏ä‰º†ÊàêÂäü (${uploadedCount}/${processedFiles.length})`);
                        
                } catch (error) {
                    errorCount++;
                    const errorMsg = error.message || 'Êú™Áü•ÈîôËØØ';
                    console.error(`‚úó ${finalName} ‰∏ä‰º†Â§±Ë¥•: ${errorMsg} (${uploadedCount + errorCount}/${processedFiles.length})`);
                    console.error('ÂÆåÊï¥ÈîôËØØ‰ø°ÊÅØ:', error);
                    
                    // Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™Â§±Ë¥•ÁöÑÊñá‰ª∂ÔºåÊòæÁ§∫ËØ¶ÁªÜÈîôËØØÈÄöÁü•
                    if (errorCount === 1) {
                        // ÂØπ‰∫éÊùÉÈôêÈîôËØØÔºåÊòæÁ§∫Êõ¥ÂèãÂ•ΩÁöÑÊèêÁ§∫
                        if (errorMsg.includes('ÊùÉÈôê') || errorMsg.includes('Permission denied')) {
                            showNotification('‰∏ä‰º†Â§±Ë¥•ÔºöÊñá‰ª∂Á≥ªÁªüÊùÉÈôêÈîôËØØ„ÄÇËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëòÊ£ÄÊü•ÊúçÂä°Âô®ÁõÆÂΩïÊùÉÈôê„ÄÇ', 'error');
                        } else {
                            // Êà™Êñ≠ËøáÈïøÁöÑÈîôËØØ‰ø°ÊÅØÔºåÂè™ÊòæÁ§∫Ââç100‰∏™Â≠óÁ¨¶
                            const shortMsg = errorMsg.length > 100 ? errorMsg.substring(0, 100) + '...' : errorMsg;
                            showNotification(`‰∏ä‰º†Â§±Ë¥•: ${shortMsg}`, 'error');
                        }
                    }
                }
                }
                
                // ÊâÄÊúâÊñá‰ª∂Â§ÑÁêÜÂÆåÊØï
                console.log(`\n=== ‰∏ä‰º†ÂÆåÊàê ===`);
                console.log(`ÊàêÂäü: ${uploadedCount}, Â§±Ë¥•: ${errorCount}`);
                showLoading(false);
                
                // ÊòæÁ§∫ÈÄöÁü•
                if (errorCount === 0 && uploadedCount > 0) {
                    showNotification(`‚úì ÊàêÂäü‰∏ä‰º† ${uploadedCount} ‰∏™Êñá‰ª∂`, 'success');
                } else if (uploadedCount === 0) {
                    showNotification(`‚úó ‰∏ä‰º†Â§±Ë¥•Ôºå${errorCount} ‰∏™Êñá‰ª∂Â§±Ë¥•„ÄÇËØ∑Êü•ÁúãÊéßÂà∂Âè∞‰∫ÜËß£ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ`, 'error');
                } else if (errorCount > 0) {
                    showNotification(`‚ö† ÊàêÂäü‰∏ä‰º† ${uploadedCount} ‰∏™ÔºåÂ§±Ë¥• ${errorCount} ‰∏™„ÄÇËØ∑Êü•ÁúãÊéßÂà∂Âè∞‰∫ÜËß£ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ`, 'warning');
                }
                
                // Âª∂ËøüÂà∑Êñ∞ÂΩìÂâçÊñá‰ª∂Â§πÁöÑÊñá‰ª∂ÂàóË°®ÔºàÊõ¥Êñ∞ÁºìÂ≠òÔºåÂÆûÊó∂ÊòæÁ§∫Êñ∞Êñá‰ª∂Ôºâ
                console.log('Á≠âÂæÖ1ÁßíÂêéÂà∑Êñ∞ÂΩìÂâçÊñá‰ª∂Â§πÁöÑÊñá‰ª∂ÂàóË°®...');
                setTimeout(() => {
                    console.log('ÂºÄÂßãÂà∑Êñ∞Êñá‰ª∂ÂàóË°®');
                    // Âà∑Êñ∞ÂΩìÂâçÊñá‰ª∂Â§πÁöÑÊñá‰ª∂ÂàóË°®Âπ∂Êõ¥Êñ∞ÁºìÂ≠òÔºå‰øùÊåÅÁî®Êà∑Âú®Âêå‰∏Ä‰∏™Êñá‰ª∂Â§π‰∏≠ÔºåÂπ∂ÂÆûÊó∂ÊòæÁ§∫Êñ∞Êñá‰ª∂
                    refreshCurrentFolderWithUpdate();
                }, 1000);
            }
            
            // ==================== È¢ÑËßàÊñá‰ª∂ ====================
            function previewFile(fileId, fileName) {
                console.log(`ÂºÄÂßãÈ¢ÑËßàÊñá‰ª∂: ${fileName} (ID: ${fileId})`);
                
                // ‰øùÂ≠òÂΩìÂâçÈ¢ÑËßàÊñá‰ª∂ÁöÑ‰ø°ÊÅØ
                currentPreviewFileId = fileId;
                currentPreviewFileName = fileName;
                isPreviewEditMode = false;
                previewOriginalContent = null;
                
                // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
                const ext = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();
                // Ê∑ªÂä†Êõ¥Â§ö‰ª£Á†ÅÊñá‰ª∂Á±ªÂûãÊîØÊåÅ
                const imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
                const codeTypes = ['cpp', 'c', 'h', 'hpp', 'cc', 'cxx', 'js', 'py', 'java', 'css', 'html', 'xml', 'json', 'sh', 'bat'];
                const textTypes = ['txt', 'log', 'md', 'sql', 'yaml', 'yml', 'ini', 'conf', 'config'];
                const editableTypes = [...codeTypes, ...textTypes];  // ÂèØÁºñËæëÁöÑÊñá‰ª∂Á±ªÂûã
                const previewableTypes = [...imageTypes, 'pdf', ...editableTypes];
                
                if (!previewableTypes.includes(ext)) {
                    showNotification('Ê≠§Êñá‰ª∂Á±ªÂûã‰∏çÊîØÊåÅÈ¢ÑËßàÔºåËØ∑‰∏ãËΩΩÊü•Áúã', 'warning');
                    return;
                }
                
                const overlay = document.getElementById('previewDialogOverlay');
                const content = document.getElementById('previewContent');
                const titleEl = document.getElementById('previewTitle');
                const iconEl = document.getElementById('previewIcon');
                const downloadBtn = document.getElementById('previewDownloadBtn');
                const closeBtn = document.getElementById('previewCloseBtn');
                
                // ËÆæÁΩÆÊ†áÈ¢òÂíåÂõæÊ†á
                titleEl.textContent = fileName;
                iconEl.textContent = getFileIcon(fileName);
                
                // ÊòæÁ§∫Âä†ËΩΩ‰∏≠
                content.innerHTML = `
                    <div style="text-align: center; color: var(--gray-color);">
                        <div style="font-size: 3rem; margin-bottom: 15px;">‚è≥</div>
                        <div>Âä†ËΩΩ‰∏≠...</div>
                    </div>
                `;
                
                overlay.classList.add('show');
                
                // Ëé∑ÂèñÊñá‰ª∂ÂÜÖÂÆπ
                enhancedFetch(`${API_BASE_URL}/api/cloud_disk/download/${fileId}?user_id=${currentUser.id}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    console.log('È¢ÑËßàÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: Ëé∑ÂèñÊñá‰ª∂Â§±Ë¥•`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    console.log('Êñá‰ª∂Â§ßÂ∞è:', blob.size, 'Â≠óËäÇ');
                    
                    // Ê†πÊçÆÊñá‰ª∂Á±ªÂûãÂ§ÑÁêÜ
                    if (imageTypes.includes(ext)) {
                        // ÂõæÁâáÈ¢ÑËßà
                        const url = window.URL.createObjectURL(blob);
                        content.innerHTML = `<img src="${url}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
                        // ‰øùÂ≠òURLÂπ∂ÊòæÁ§∫ÊîæÂ§ßÊåâÈíÆ
                        fullscreenPreviewUrl = url;
                        fullscreenPreviewType = 'image';
                        document.getElementById('previewZoomBtn').style.display = 'block';
                    } else if (ext === 'pdf') {
                        // PDFÈ¢ÑËßà
                        const url = window.URL.createObjectURL(blob);
                        content.innerHTML = `
                            <iframe src="${url}" style="width: 100%; height: 100%; border: none;"></iframe>
                        `;
                        // ‰øùÂ≠òURLÂπ∂ÊòæÁ§∫ÊîæÂ§ßÊåâÈíÆ
                        fullscreenPreviewUrl = url;
                        fullscreenPreviewType = 'pdf';
                        document.getElementById('previewZoomBtn').style.display = 'block';
                    } else {
                        // ÊñáÊú¨Êñá‰ª∂È¢ÑËßàÔºàÂåÖÊã¨‰ª£Á†ÅÊñá‰ª∂Ôºâ
                        blob.text()
                            .then(text => {
                                renderTextPreview(text, ext, content);
                            })
                            .catch(error => {
                                console.error('ÊñáÊú¨ËΩ¨Êç¢Â§±Ë¥•:', error);
                                // Â¶ÇÊûúblob.text()Â§±Ë¥•ÔºåÂ∞ùËØïÁî®FileReader
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    try {
                                        renderTextPreview(e.target.result, ext, content);
                                    } catch (err) {
                                        throw err;
                                    }
                                };
                                reader.onerror = () => {
                                    throw new Error('Êó†Ê≥ïËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ');
                                };
                                reader.readAsText(blob);
                            });
                    }
                    
                    // ËÆæÁΩÆ‰∏ãËΩΩÊåâÈíÆ
                    downloadBtn.onclick = () => {
                        downloadFile(fileId, fileName);
                    };
                    
                    // ËÆæÁΩÆÂÖ≥Èó≠ÊåâÈíÆ
                    closeBtn.onclick = () => {
                        overlay.classList.remove('show');
                        document.getElementById('previewZoomBtn').style.display = 'none';
                    };
                    
                    // ËÆæÁΩÆÊîæÂ§ßÊåâÈíÆ
                    const zoomBtn = document.getElementById('previewZoomBtn');
                    zoomBtn.onclick = () => {
                            openFullscreenPreview();
                        };
                })
                .catch(error => {
                    console.error('È¢ÑËßàÂ§±Ë¥•:', error);
                    let errorMsg = error.message;
                    if (errorMsg.includes('500')) {
                        errorMsg = 'ÊúçÂä°Âô®ÈîôËØØÔºöÊó†Ê≥ïËØªÂèñÊñá‰ª∂ÔºåÂèØËÉΩÊòØÊñá‰ª∂ÊçüÂùè';
                    }
                    // ÈöêËóèÊîæÂ§ßÊåâÈíÆ
                    document.getElementById('previewZoomBtn').style.display = 'none';
                    
                    content.innerHTML = `
                        <div style="text-align: center; color: var(--accent-color); padding: 20px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">‚ùå</div>
                            <div style="margin-bottom: 10px;">È¢ÑËßàÂ§±Ë¥•</div>
                            <div style="font-size: 0.9rem; color: var(--gray-color);">${errorMsg}</div>
                            <div style="margin-top: 15px; font-size: 0.85rem; color: var(--gray-color);">ËØ∑Â∞ùËØï‰∏ãËΩΩÊü•Áúã</div>
                        </div>
                    `;
                });
            }
            
            // ==================== ÂÖ®Â±èÈ¢ÑËßàÂäüËÉΩ ====================
            function openFullscreenPreview() {
                try {
                    const overlay = document.getElementById('fullscreenPreviewOverlay');
                    const wrapper = document.getElementById('fullscreenPreviewWrapper');
                    
                    if (!overlay || !wrapper) {
                        console.error('ÂÖ®Â±èÈ¢ÑËßàÂÖÉÁ¥†Êú™ÊâæÂà∞');
                        alert('ÂÖ®Â±èÈ¢ÑËßàÂäüËÉΩÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                        return;
                    }
                    
                    // ÈáçÁΩÆÁº©ÊîæÂíåÊóãËΩ¨
                    currentZoomLevel = 1;
                    currentRotation = 0;
                    
                    // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                    wrapper.innerHTML = '<div class="loading-indicator">Âä†ËΩΩ‰∏≠...</div>';
                    
                    // Ê†πÊçÆÊñá‰ª∂Á±ªÂûãÊòæÁ§∫ÂÜÖÂÆπ
                    if (fullscreenPreviewType === 'image') {
                        // ‰ΩøÁî®DOMÂàõÂª∫ÂÖÉÁ¥†ËÄå‰∏çÊòØinnerHTMLÔºåÊõ¥ÂÆâÂÖ®‰∏îÊÄßËÉΩÊõ¥Â•Ω
                        const img = document.createElement('img');
                        img.id = 'fullscreenImage';
                        img.src = fullscreenPreviewUrl;
                        img.alt = 'È¢ÑËßàÂõæÁâá';
                        
                        // Âü∫Á°ÄÊ†∑ÂºèËÆæÁΩÆ
                        img.style.maxWidth = '100%';
                        img.style.maxHeight = '100%';
                        img.style.objectFit = 'contain';
                        
                        // ÊµèËßàÂô®ÂÖºÂÆπÊÄßÂ§ÑÁêÜ - ÊîØÊåÅÊóßÁâàÊµèËßàÂô®
                        img.style.webkitTransform = 'scale(1) rotate(0deg)';
                        img.style.msTransform = 'scale(1) rotate(0deg)';
                        img.style.transform = 'scale(1) rotate(0deg)';
                        
                        // Âä†ËΩΩÂÆåÊàêÂ§ÑÁêÜ
                        img.onload = function() {
                            wrapper.innerHTML = '';
                            wrapper.appendChild(img);
                        };
                        
                        // Âä†ËΩΩÈîôËØØÂ§ÑÁêÜ
                        img.onerror = function() {
                            console.error('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•:', fullscreenPreviewUrl);
                            wrapper.innerHTML = '<div class="error-message">ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Â∞ùËØïÈáçÊñ∞È¢ÑËßà</div>';
                        };
                        
                        // Ë∂ÖÊó∂Â§ÑÁêÜ
                        setTimeout(function() {
                            if (img.complete === false) {
                                wrapper.innerHTML = '<div class="error-message">ÂõæÁâáÂä†ËΩΩË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•</div>';
                            }
                        }, 30000); // 30ÁßíË∂ÖÊó∂
                    } else if (fullscreenPreviewType === 'pdf') {
                        // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅPDFÈ¢ÑËßà
                        const iframe = document.createElement('iframe');
                        iframe.src = fullscreenPreviewUrl;
                        iframe.title = 'PDFÈ¢ÑËßà';
                        iframe.style.width = '100%';
                        iframe.style.height = '100%';
                        iframe.style.border = 'none';
                        
                        // ÊµèËßàÂô®ÂÖºÂÆπÊÄßÂ§ÑÁêÜ
                        iframe.style.webkitTransform = 'scale(1)';
                        iframe.style.msTransform = 'scale(1)';
                        iframe.style.transform = 'scale(1)';
                        iframe.style.webkitTransformOrigin = 'center center';
                        iframe.style.msTransformOrigin = 'center center';
                        iframe.style.transformOrigin = 'center center';
                        
                        // Ê∑ªÂä†PDFÂä†ËΩΩÁä∂ÊÄÅÂ§ÑÁêÜ
                        iframe.onload = function() {
                            wrapper.innerHTML = '';
                            wrapper.appendChild(iframe);
                            
                            // ËÆæÁΩÆÈÄÇÂΩìÁöÑÊªöÂä®Ë°å‰∏∫
                            wrapper.style.overflow = 'hidden';
                        };
                        
                        // Áî±‰∫éiframeË∑®ÂüüÈôêÂà∂ÔºåÊàë‰ª¨Êó†Ê≥ïÁõ¥Êé•Ê£ÄÊµãPDFÂä†ËΩΩÂ§±Ë¥•
                        // ‰ΩøÁî®try-catchÊù•ÊçïËé∑ÂèØËÉΩÁöÑÈîôËØØ
                        try {
                            wrapper.appendChild(iframe);
                        } catch (e) {
                            console.error('PDFÈ¢ÑËßàÂä†ËΩΩÂºÇÂ∏∏:', e);
                            wrapper.innerHTML = '<div class="error-message">PDFÂä†ËΩΩÂºÇÂ∏∏ÔºåËØ∑Â∞ùËØï‰∏ãËΩΩÊñá‰ª∂</div>';
                        }
                    }
                    
                    // ÊòæÁ§∫ÂÖ®Â±èÈ¢ÑËßàÔºå‰ΩøÁî®flexboxÁ°Æ‰øùÂÖºÂÆπÊÄß
                    overlay.style.display = 'flex';
                    overlay.style.display = '-webkit-flex'; // ÊóßÁâàWebKitÊµèËßàÂô®
                    
                    // Á¶ÅÁî®ËÉåÊôØÊªöÂä®ÔºåÂÖºÂÆπÊâÄÊúâÁé∞‰ª£ÊµèËßàÂô®
                    document.body.style.overflow = 'hidden';
                    document.body.style.position = 'fixed';
                    document.body.style.width = '100%';
                    document.body.style.height = '100%';
                    
                } catch (error) {
                    console.error('ÂÖ®Â±èÈ¢ÑËßàÊâìÂºÄÂ§±Ë¥•:', error);
                    alert('ÊâìÂºÄÂÖ®Â±èÈ¢ÑËßàÊó∂Âá∫ÈîôÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                }
            }
            
            function zoomIn() {
                currentZoomLevel += 0.1;
                
                if (fullscreenPreviewType === 'image') {
                    const img = document.getElementById('fullscreenImage');
                    if (img) {
                        img.style.transform = `scale(${currentZoomLevel}) rotate(${currentRotation}deg)`;
                    }
                } else if (fullscreenPreviewType === 'pdf') {
                    const wrapper = document.getElementById('fullscreenPreviewWrapper');
                    const iframe = wrapper.querySelector('iframe');
                    if (iframe) {
                        // ÂØπ‰∫éPDFÔºåÊàë‰ª¨ÂèØ‰ª•‰øÆÊîπiframeÁöÑÁº©Êîæ
                        iframe.style.transform = `scale(${currentZoomLevel})`;
                        iframe.style.transformOrigin = 'center center';
                        // Ë∞ÉÊï¥wrapperÁöÑoverflow‰ª•ÂÖÅËÆ∏ÊªöÂä®
                        wrapper.style.overflow = 'auto';
                    }
                }
            }
            
            function zoomOut() {
                if (currentZoomLevel > 0.2) {
                    currentZoomLevel -= 0.1;
                    
                    if (fullscreenPreviewType === 'image') {
                        const img = document.getElementById('fullscreenImage');
                        if (img) {
                            img.style.transform = `scale(${currentZoomLevel}) rotate(${currentRotation}deg)`;
                        }
                    } else if (fullscreenPreviewType === 'pdf') {
                        const wrapper = document.getElementById('fullscreenPreviewWrapper');
                        const iframe = wrapper.querySelector('iframe');
                        if (iframe) {
                            iframe.style.transform = `scale(${currentZoomLevel})`;
                            iframe.style.transformOrigin = 'center center';
                            // Ê†πÊçÆÁº©ÊîæÁ∫ßÂà´ÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫ÊªöÂä®Êù°
                            if (currentZoomLevel <= 1) {
                                wrapper.style.overflow = 'hidden';
                            } else {
                                wrapper.style.overflow = 'auto';
                            }
                        }
                    }
                }
            }
            
            function rotateImage() {
                if (fullscreenPreviewType === 'image') {
                    currentRotation += 90;
                    const img = document.getElementById('fullscreenImage');
                    if (img) {
                        img.style.transform = `scale(${currentZoomLevel}) rotate(${currentRotation}deg)`;
                    }
                }
                // Ê≥®ÊÑèÔºöPDFÊóãËΩ¨ÈÄöÂ∏∏ÈúÄË¶ÅPDF.jsÊàñÂÖ∂‰ªñ‰∏ìÈó®ÁöÑPDFÂ§ÑÁêÜÂ∫ì
                // ËøôÈáå‰∏çÂÆûÁé∞PDFÊóãËΩ¨ÔºåÂõ†‰∏∫ÊµèËßàÂô®ÂéüÁîüiframe‰∏çÊîØÊåÅPDFÊóãËΩ¨
            }
            
            function closeFullscreenPreview() {
                try {
                    const overlay = document.getElementById('fullscreenPreviewOverlay');
                    const wrapper = document.getElementById('fullscreenPreviewWrapper');
                    
                    if (!overlay) {
                        return;
                    }
                    
                    // ÈöêËóèÂÖ®Â±èÈ¢ÑËßà
                    overlay.style.display = 'none';
                    
                    // Ê∏ÖÁ©∫ÂÜÖÂÆπÔºåÈò≤Ê≠¢ÂÜÖÂ≠òÊ≥ÑÊºè
                    if (wrapper) {
                        wrapper.innerHTML = '';
                    }
                    
                    // ÈáçÁΩÆÁº©ÊîæÂíåÊóãËΩ¨
                    currentZoomLevel = 1;
                    currentRotation = 0;
                    
                    // ÊÅ¢Â§çËÉåÊôØÊªöÂä®ÔºåÂÖºÂÆπÊâÄÊúâÊµèËßàÂô®
                    document.body.style.overflow = '';
                    document.body.style.position = '';
                    document.body.style.width = '';
                    document.body.style.height = '';
                    
                    // ÁßªÈô§ÁÑ¶ÁÇπÔºåÈò≤Ê≠¢ÈîÆÁõò‰∫ã‰ª∂Âπ≤Êâ∞
                    if (document.activeElement) {
                        document.activeElement.blur();
                    }
                    
                    // Ëß¶Âèëfocusin‰∫ã‰ª∂ÔºåÁ°Æ‰øùÈ°µÈù¢ÂèØ‰∫§‰∫í
                    setTimeout(function() {
                        document.dispatchEvent(new Event('focusin'));
                    }, 0);
                    
                } catch (error) {
                    console.error('ÂÖ≥Èó≠ÂÖ®Â±èÈ¢ÑËßàÂ§±Ë¥•:', error);
                }
            }
            
            // ==================== Ê∏≤ÊüìÊñáÊú¨È¢ÑËßà ====================
            function renderTextPreview(text, ext, contentElement) {
                // ÈôêÂà∂ÊòæÁ§∫Â§ßÂ∞èÔºåÈò≤Ê≠¢Ë∂ÖÂ§ßÊñá‰ª∂Âç°È°ø
                const maxLength = 100000;
                let displayText = text;
                let isLimited = false;
                
                if (text.length > maxLength) {
                    displayText = text.substring(0, maxLength);
                    isLimited = true;
                }
                
                // ‰øùÂ≠òÂéüÂßãÂÜÖÂÆπÁî®‰∫éÁºñËæë
                previewOriginalContent = text;
                
                // HTMLËΩ¨‰πâ
                const escapedText = displayText
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
                
                // ‰ª£Á†ÅÊñá‰ª∂Á±ªÂûãÂàóË°®
                const codeTypes = ['cpp', 'c', 'h', 'hpp', 'cc', 'cxx', 'js', 'py', 'java', 'css', 'html', 'xml', 'json', 'sh', 'bat', 'sql', 'yaml', 'yml'];
                const editableTypes = [...codeTypes, 'txt', 'log', 'md', 'ini', 'conf', 'config'];
                
                // ‰∏∫‰ª£Á†ÅÊñá‰ª∂Ê∑ªÂä†ËØ≠Ê≥ïÈ´ò‰∫ÆÊ†∑Âºè
                const isCodeFile = codeTypes.includes(ext);
                const isEditable = editableTypes.includes(ext);
                const preStyle = isCodeFile ? 
                    `margin: 0; padding: 15px; background: #282c34; border-radius: 4px; overflow: auto; white-space: pre-wrap; word-wrap: break-word; font-family: 'Monaco', 'Courier New', monospace; font-size: 0.85rem; line-height: 1.5; color: #abb2bf; text-align: left; width: 100%; min-height: 300px;` :
                    `margin: 0; padding: 15px; background: var(--light-gray); border-radius: 4px; overflow: auto; white-space: pre-wrap; word-wrap: break-word; font-family: 'Monaco', 'Courier New', monospace; font-size: 0.85rem; line-height: 1.4; color: var(--dark-color); text-align: left; width: 100%; min-height: 300px;`;
                
                const limitedMsg = isLimited ? `<div style="padding: 10px; background: rgba(243, 156, 18, 0.1); color: var(--warning-color); border-radius: 4px; margin-bottom: 10px;">‚ö†Ô∏è Êñá‰ª∂ËøáÂ§ßÔºå‰ªÖÊòæÁ§∫Ââç100KBÂÜÖÂÆπ</div>` : '';
                
                const fileTypeLabel = isCodeFile ? `<div style="padding: 8px 12px; background: var(--primary-color); color: white; border-radius: 4px 4px 0 0; font-size: 0.8rem; font-weight: 500;">‰ª£Á†ÅÊñá‰ª∂ (.${ext})</div>` : '';
                
                contentElement.innerHTML = `
                    ${limitedMsg}
                    ${fileTypeLabel}
                    <pre id="previewTextContent" style="${preStyle}">${escapedText}</pre>
                    <textarea id="previewTextEditor" style="width: 100%; height: 100%; padding: 15px; background: #282c34; border: none; border-radius: 4px; font-family: 'Monaco', 'Courier New', monospace; font-size: 0.85rem; line-height: 1.5; color: #abb2bf; resize: none; display: none;">${text}</textarea>
                `;
                
                // ÊòæÁ§∫/ÈöêËóèÁºñËæëÊåâÈíÆ
                const editBtn = document.getElementById('previewEditBtn');
                const saveBtn = document.getElementById('previewSaveBtn');
                const cancelBtn = document.getElementById('previewCancelEditBtn');
                
                if (isEditable) {
                    editBtn.style.display = 'block';
                    
                    // ÁºñËæëÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
                    editBtn.onclick = () => enablePreviewEdit();
                    
                    // ‰øùÂ≠òÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
                    saveBtn.onclick = () => savePreviewChanges();
                    
                    // ÂèñÊ∂àÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
                    cancelBtn.onclick = () => cancelPreviewEdit();
                } else {
                    editBtn.style.display = 'none';
                    saveBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';
                }
            }
            
            // ==================== ÂêØÁî®È¢ÑËßàÁºñËæë ====================
            function enablePreviewEdit() {
                isPreviewEditMode = true;
                
                const textContent = document.getElementById('previewTextContent');
                const textEditor = document.getElementById('previewTextEditor');
                const editBtn = document.getElementById('previewEditBtn');
                const saveBtn = document.getElementById('previewSaveBtn');
                const cancelBtn = document.getElementById('previewCancelEditBtn');
                
                textContent.style.display = 'none';
                textEditor.style.display = 'block';
                editBtn.style.display = 'none';
                saveBtn.style.display = 'block';
                cancelBtn.style.display = 'block';
                
                textEditor.focus();
                showNotification('ËøõÂÖ•ÁºñËæëÊ®°ÂºèÔºå‰øÆÊîπÂÆåÊàêÂêéÁÇπÂáª‰øùÂ≠ò', 'info');
            }
            
            // ==================== ÂèñÊ∂àÈ¢ÑËßàÁºñËæë ====================
            function cancelPreviewEdit() {
                isPreviewEditMode = false;
                
                const textContent = document.getElementById('previewTextContent');
                const textEditor = document.getElementById('previewTextEditor');
                const editBtn = document.getElementById('previewEditBtn');
                const saveBtn = document.getElementById('previewSaveBtn');
                const cancelBtn = document.getElementById('previewCancelEditBtn');
                
                // ÊÅ¢Â§çÂéüÂßãÂÜÖÂÆπ
                textEditor.value = previewOriginalContent;
                
                textContent.style.display = 'block';
                textEditor.style.display = 'none';
                editBtn.style.display = 'block';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                
                showNotification('Â∑≤ÂèñÊ∂àÁºñËæë', 'info');
            }
            function cancelPreviewEdit_1() {
                isPreviewEditMode = false;

                const textContent = document.getElementById('previewTextContent');
                const textEditor = document.getElementById('previewTextEditor');
                const editBtn = document.getElementById('previewEditBtn');
                const saveBtn = document.getElementById('previewSaveBtn');
                const cancelBtn = document.getElementById('previewCancelEditBtn');

                // ÊÅ¢Â§çÂéüÂßãÂÜÖÂÆπ
                textEditor.value = previewOriginalContent;

                textContent.style.display = 'block';
                textEditor.style.display = 'none';
                editBtn.style.display = 'block';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';


            }
            
            // ==================== ‰øùÂ≠òÈ¢ÑËßàÊõ¥Êîπ ====================
            function savePreviewChanges() {
                if (!currentPreviewFileId) {
                    showNotification('Êó†Ê≥ï‰øùÂ≠òÔºöÊñá‰ª∂ID‰∏¢Â§±', 'error');
                    return;
                }
                
                const textEditor = document.getElementById('previewTextEditor');
                const newContent = textEditor.value;
                
                if (newContent === previewOriginalContent) {
                    showNotification('Êñá‰ª∂ÂÜÖÂÆπÊú™‰øÆÊîπ', 'warning');
                    return;
                }
                
                showLoading(true);
                
                // Â∞ÜÊñáÊú¨ÂÜÖÂÆπËΩ¨Êç¢‰∏∫ Blob Âπ∂‰∏ä‰º†
                const blob = new Blob([newContent], { type: 'text/plain' });
                const formData = new FormData();
                formData.append('file', blob, currentPreviewFileName);
                formData.append('folder_path', selectedFolderPath);
                
                enhancedFetch(`${API_BASE_URL}/api/cloud_disk/update-file/${currentPreviewFileId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                })
                .then(response => {
                    console.log('‰øùÂ≠òÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ‰øùÂ≠òÂ§±Ë¥•`);
                    }
                    return response.json();
                })
                .then(data => {
                    showLoading(false);
                    showNotification('‚úì Êñá‰ª∂‰øùÂ≠òÊàêÂäü', 'success');
                    
                    // Êõ¥Êñ∞ÂéüÂßãÂÜÖÂÆπÂπ∂ÈÄÄÂá∫ÁºñËæëÊ®°Âºè
                    previewOriginalContent = newContent;
                    cancelPreviewEdit_1();
                    
                    // Âà∑Êñ∞Êñá‰ª∂ÂàóË°®ÔºàÂ¶ÇÊûúÂ∑≤‰øÆÊîπÔºâ
                    refreshCurrentFolder();
                })
                .catch(error => {
                    showLoading(false);
                    console.error('‰øùÂ≠òÊñá‰ª∂Â§±Ë¥•:', error.message);
                    showNotification(`‰øùÂ≠òÂ§±Ë¥•: ${error.message}`, 'error');
                });
            }
            
            // ==================== ‰∏ãËΩΩÊñá‰ª∂ ====================
            function downloadFile(fileId, fileName) {
                console.log(`ÂºÄÂßã‰∏ãËΩΩÊñá‰ª∂: ${fileName} (ID: ${fileId})`);
                showLoading(true);
                
                enhancedFetch(`${API_BASE_URL}/api/cloud_disk/download/${fileId}?user_id=${currentUser.id}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    console.log('‰∏ãËΩΩÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ‰∏ãËΩΩÂ§±Ë¥•`);
                    }
                    
                    return response.blob();
                })
                .then(blob => {
                    console.log('‰∏ãËΩΩÂÆåÊàêÔºåÊñá‰ª∂Â§ßÂ∞è:', blob.size, 'Â≠óËäÇ');
                    showLoading(false);
                    
                    // ÂàõÂª∫‰∏¥Êó∂ÈìæÊé•‰∏ãËΩΩÊñá‰ª∂
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName || '‰∏ãËΩΩÊñá‰ª∂';
                    document.body.appendChild(link);
                    link.click();
                    
                    // Ê∏ÖÁêÜ
                    setTimeout(() => {
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                    
                    showNotification('‚úì Êñá‰ª∂‰∏ãËΩΩÊàêÂäü', 'success');
                })
                .catch(error => {
                    showLoading(false);
                    console.error('‰∏ãËΩΩÂ§±Ë¥•:', error.message);
                    showNotification(`‰∏ãËΩΩÂ§±Ë¥•: ${error.message}`, 'error');
                });
            }
            
            // ==================== ÊâπÈáè‰∏ãËΩΩÊñá‰ª∂ ====================
            function downloadSelectedFiles() {
                if (selectedFiles.size === 0) {
                    showNotification('ËØ∑ÂÖàÈÄâÊã©Ë¶Å‰∏ãËΩΩÁöÑÊñá‰ª∂', 'warning');
                    return;
                }
                
                console.log(`ÂºÄÂßãÊâπÈáè‰∏ãËΩΩ ${selectedFiles.size} ‰∏™Êñá‰ª∂`);
                
                // ÈÄê‰∏™‰∏ãËΩΩÈÄâ‰∏≠ÁöÑÊñá‰ª∂
                selectedFiles.forEach((fileId) => {
                    const fileElement = document.querySelector(`[data-file-id="${fileId}"]`);
                    if (fileElement) {
                        const fileName = fileElement.dataset.fileName;
                        // Âª∂Ëøü‰∏ãËΩΩÔºåÈÅøÂÖçÊµèËßàÂô®ÈòªÊ≠¢
                        setTimeout(() => {
                            downloadFile(fileId, fileName);
                        }, 500);
                    }
                });
                
                showNotification(`ÂºÄÂßã‰∏ãËΩΩ ${selectedFiles.size} ‰∏™Êñá‰ª∂`, 'info');
            }
            
            // ==================== Âà†Èô§Êñá‰ª∂ ====================
            async function deleteFile(fileId) {
                const shouldDelete = await showDeleteConfirmDialog('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§Êñá‰ª∂ÂêóÔºü');
                if (!shouldDelete) return;
                
                showLoading(true);
                
                enhancedFetch(`${API_BASE_URL}/api/cloud_disk/delete/${fileId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    showLoading(false);
                    showNotification('Êñá‰ª∂Â∑≤Âà†Èô§', 'success');
                    // ‰ΩøÁî®Êõ¥Êñ∞ÁºìÂ≠òÁöÑÂà∑Êñ∞ÊñπÂºèÔºåÂÆûÊó∂ÊòæÁ§∫Âà†Èô§ÊïàÊûú
                    refreshCurrentFolderWithUpdate();
                })
                .catch(error => {
                    showLoading(false);
                    console.error('Âà†Èô§Â§±Ë¥•:', error);
                    showNotification('Âà†Èô§Â§±Ë¥•', 'error');
                });
            }
            
            // ==================== ÊâπÈáèÂà†Èô§Êñá‰ª∂ ====================
            async function deleteSelectedFiles() {
                if (selectedFiles.size === 0) {
                    showNotification('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊñá‰ª∂', 'warning');
                    return;
                }
                
                const count = selectedFiles.size;
                const shouldDelete = await showDeleteConfirmDialog(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${count} ‰∏™Êñá‰ª∂ÂêóÔºü`);
                if (!shouldDelete) return;
                
                console.log(`ÂºÄÂßãÊâπÈáèÂà†Èô§ ${count} ‰∏™Êñá‰ª∂`);
                showLoading(true);
                
                let deletedCount = 0;
                let errorCount = 0;
                const fileIds = Array.from(selectedFiles);
                
                // È°∫Â∫èÂà†Èô§ÊØè‰∏™Êñá‰ª∂
                function deleteNext(index) {
                    if (index >= fileIds.length) {
                        showLoading(false);
                        console.log(`\n=== Âà†Èô§ÂÆåÊàê ===`);
                        console.log(`ÊàêÂäü: ${deletedCount}, Â§±Ë¥•: ${errorCount}`);
                        
                        if (errorCount === 0) {
                            showNotification(`‚úì ÊàêÂäüÂà†Èô§ ${deletedCount} ‰∏™Êñá‰ª∂`, 'success');
                        } else if (deletedCount === 0) {
                            showNotification(`‚úó Âà†Èô§Â§±Ë¥•Ôºå${errorCount} ‰∏™Êñá‰ª∂Âà†Èô§Â§±Ë¥•`, 'error');
                        } else {
                            showNotification(`‚ö† ÊàêÂäü ${deletedCount} ‰∏™ÔºåÂ§±Ë¥• ${errorCount} ‰∏™`, 'warning');
                        }
                        
                        // Âà∑Êñ∞ÂΩìÂâçÊñá‰ª∂Â§πÁöÑÊñá‰ª∂ÂàóË°®Âπ∂Êõ¥Êñ∞ÁºìÂ≠òÔºå‰øùÊåÅÁî®Êà∑Âú®Âêå‰∏Ä‰∏™Êñá‰ª∂Â§π‰∏≠
                        refreshCurrentFolderWithUpdate();
                        clearFileSelection();
                        return;
                    }
                    
                    const fileId = fileIds[index];
                    enhancedFetch(`${API_BASE_URL}/api/cloud_disk/delete/${fileId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        deletedCount++;
                        console.log(`‚úì Âà†Èô§Êñá‰ª∂ ${fileId} (${deletedCount + errorCount}/${fileIds.length})`);
                        deleteNext(index + 1);
                    })
                    .catch(error => {
                        errorCount++;
                        console.error(`‚úó Âà†Èô§Êñá‰ª∂ ${fileId} Â§±Ë¥•: ${error.message} (${deletedCount + errorCount}/${fileIds.length})`);
                        deleteNext(index + 1);
                    });
                }
                
                deleteNext(0);
            }
            
            // ==================== ÊòæÁ§∫Êñ∞Âª∫Êñá‰ª∂Â§πÂØπËØùÊ°Ü ====================
            function showCreateFolderDialog(existingFolderNames) {
                return new Promise((resolve) => {
                    const overlay = document.getElementById('createFolderDialogOverlay');
                    const input = document.getElementById('createFolderNameInput');
                    const errorMsg = document.getElementById('folderNameError');
                    const confirmBtn = document.getElementById('createFolderConfirmBtn');
                    const cancelBtn = document.getElementById('createFolderCancelBtn');
                    
                    // ÈáçÁΩÆ
                    input.value = '';
                    errorMsg.style.display = 'none';
                    errorMsg.textContent = '';
                    
                    // ÂÆûÊó∂Ê£ÄÊü•Êñá‰ª∂Â§πÂêçÁß∞
                    input.addEventListener('input', (e) => {
                        const folderName = e.target.value.trim();
                        if (existingFolderNames.has(folderName)) {
                            errorMsg.textContent = `‚ö†Ô∏è ÂêåÂêçÊñá‰ª∂Â§πÂ∑≤Â≠òÂú®ÔºåËØ∑‰øÆÊîπ`;
                            errorMsg.style.display = 'block';
                        } else if (folderName === '') {
                            errorMsg.style.display = 'none';
                        } else {
                            errorMsg.style.display = 'none';
                        }
                    });
                    
                    const handleConfirm = () => {
                        const folderName = input.value.trim();
                        
                        if (folderName === '') {
                            showNotification('Êñá‰ª∂Â§πÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫', 'warning');
                            return;
                        }
                        
                        if (existingFolderNames.has(folderName)) {
                            showNotification('ÂêåÂêçÊñá‰ª∂Â§πÂ∑≤Â≠òÂú®ÔºåËØ∑‰øÆÊîπ', 'warning');
                            input.focus();
                            return;
                        }
                        
                        cleanup();
                        resolve(folderName);
                    };
                    
                    const handleCancel = () => {
                        cleanup();
                        resolve(null);
                    };
                    
                    const cleanup = () => {
                        overlay.classList.remove('show');
                        confirmBtn.removeEventListener('click', handleConfirm);
                        cancelBtn.removeEventListener('click', handleCancel);
                        input.removeEventListener('keydown', handleKeydown);
                    };
                    
                    const handleKeydown = (e) => {
                        if (e.key === 'Enter') {
                            handleConfirm();
                        } else if (e.key === 'Escape') {
                            handleCancel();
                        }
                    };
                    
                    confirmBtn.addEventListener('click', handleConfirm);
                    cancelBtn.addEventListener('click', handleCancel);
                    input.addEventListener('keydown', handleKeydown);
                    
                    overlay.classList.add('show');
                    input.focus();
                });
            }
            
            // ==================== Êñ∞Âª∫Êñá‰ª∂Â§π ====================
            async function createNewFolder() {
                if (!cachedTreeData) {
                    showNotification('Êñá‰ª∂Â§πÊï∞ÊçÆÊú™Âä†ËΩΩ', 'warning');
                    return;
                }
                
                // Ëé∑ÂèñÂΩìÂâçÊñá‰ª∂Â§π‰∏≠ÁöÑÊâÄÊúâÂ≠êÊñá‰ª∂Â§πÂêçÁß∞
                const currentFolderChildren = findFolderChildren(cachedTreeData, selectedFolderPath);
                const existingFolderNames = new Set(
                    currentFolderChildren
                        .filter(child => child.type === 'folder')
                        .map(child => child.name)
                );
                
                // ÊòæÁ§∫Ëá™ÂÆö‰πâÂØπËØùÊ°Ü
                const folderName = await showCreateFolderDialog(existingFolderNames);
                if (!folderName) return;
                
                const newPath = selectedFolderPath.replace(/\/$/, '') + '/' + folderName + '/';
                
                showLoading(true);
                
                enhancedFetch(`${API_BASE_URL}/api/cloud_disk/create-folder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        folder_path: newPath
                    })
                })
                .then(response => response.json())
                .then(data => {
                    showLoading(false);
                    showNotification('Êñá‰ª∂Â§πÂàõÂª∫ÊàêÂäü', 'success');
                    // Âà∑Êñ∞Ê†ëÁªìÊûÑ‰ª•ÊòæÁ§∫Êñ∞Êñá‰ª∂Â§πÔºåÂêåÊó∂‰øùÊåÅÂΩìÂâçÊñá‰ª∂Â§πÁöÑÈÄâÊã©
                    refreshTreeAndRestoreFolder();
                })
                .catch(error => {
                    showLoading(false);
                    console.error('ÂàõÂª∫Êñá‰ª∂Â§πÂ§±Ë¥•:', error);
                    showNotification('ÂàõÂª∫Êñá‰ª∂Â§πÂ§±Ë¥•', 'error');
                });
            }
            
            // ==================== Êü•ÊâæÊñá‰ª∂Â§πÁöÑÂ≠êÈ°π ====================
            function findFolderChildren(tree, targetPath) {
                if (tree.path === targetPath) {
                    return tree.children || [];
                }
                
                if (tree.children) {
                    for (let child of tree.children) {
                        if (child.type === 'folder') {
                            const result = findFolderChildren(child, targetPath);
                            if (result.length > 0 || child.path === targetPath) {
                                return result;
                            }
                        }
                    }
                }
                
                return [];
            }
            
            // ==================== Âà†Èô§Êñá‰ª∂Â§π ====================
            async function deleteFolder() {
                // ‰∏çÂÖÅËÆ∏Âà†Èô§Ê†πÁõÆÂΩï
                if (selectedFolderPath === '/' || selectedFolderPath === '/root/files' || !selectedFolderPath) {
                    showNotification('‰∏çËÉΩÂà†Èô§Ê†πÁõÆÂΩï', 'warning');
                    return;
                }
                
                // Ëé∑ÂèñÂΩìÂâçÊñá‰ª∂Â§πÂêçÁß∞
                const folderName = document.getElementById('contentTitle').textContent || 'Ê≠§Êñá‰ª∂Â§π';
                const message = `Á°ÆÂÆöË¶ÅÂà†Èô§Êñá‰ª∂Â§π"${folderName}"ÂêóÔºü\n\nËØ•Êìç‰Ωú‰ºöÂà†Èô§Êñá‰ª∂Â§π‰∏≠ÁöÑÊâÄÊúâÊñá‰ª∂ÔºåÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ`;
                const shouldDelete = await showDeleteConfirmDialog(message);
                if (!shouldDelete) return;
                
                showLoading(true);
                
                enhancedFetch(`${API_BASE_URL}/api/cloud_disk/delete-folder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        folder_path: selectedFolderPath
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    showLoading(false);
                    showNotification('Êñá‰ª∂Â§πÂ∑≤Âà†Èô§', 'success');
                    // Ê∏ÖÈô§ÁºìÂ≠òÔºåÂº∫Âà∂Âà∑Êñ∞Ê†ëÁªìÊûÑÔºàÂõ†‰∏∫Âà†Èô§ÁöÑÊòØÂΩìÂâçÊñá‰ª∂Â§πÔºâ
                    cachedTreeData = null;
                    // ÈáçÊñ∞Âä†ËΩΩÊ†ëÂπ∂Ëá™Âä®ÈÄâ‰∏≠Ê†πÁõÆÂΩï
                    loadFolderTree(true);
                })
                .catch(error => {
                    showLoading(false);
                    console.error('Âà†Èô§Êñá‰ª∂Â§πÂ§±Ë¥•:', error);
                    showNotification('Âà†Èô§Êñá‰ª∂Â§πÂ§±Ë¥•: ' + error.message, 'error');
                });
            }
            
            // ==================== Â∑•ÂÖ∑ÂáΩÊï∞ ====================
            function getFileIcon(filename) {
                if (!filename || typeof filename !== 'string') {
                    return 'üìÑ';
                }
                
                const extension = filename.split('.').pop().toLowerCase();
                
                const iconMap = {
                    'txt': 'üìÑ', 'pdf': 'üìë', 'doc': 'üìÉ', 'docx': 'üìÉ',
                    'xls': 'üìä', 'xlsx': 'üìä', 'ppt': 'üìΩÔ∏è', 'pptx': 'üìΩÔ∏è',
                    'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è',
                    'mp4': 'üé¨', 'avi': 'üé¨', 'mov': 'üé¨',
                    'zip': 'üì¶', 'rar': 'üì¶', '7z': 'üì¶',
                    'py': 'üêç', 'js': 'üìù', 'html': 'üåê', 'css': 'üé®'
                };
                
                return iconMap[extension] || 'üìÑ';
            }
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            }
            
            function formatDate(isoString) {
                const date = new Date(isoString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}/${month}/${day} ${hours}:${minutes}`;
            }
            
            function showLoading(show) {
                document.getElementById('loadingOverlay').classList.toggle('show', show);
            }
            
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        </script>
    </body>
    </html>

