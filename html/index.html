<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 补充兼容性元标签，参考摘要1/4，适配IE浏览器 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能学习导师系统</title>
    <style>
        /* 1. CSS 重置：参考摘要2的cssreset.css，清除默认样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        *::before,
        *::after {
            box-sizing: border-box; /* 统一伪元素盒模型 */
        }
        a {
            color: inherit; /* 继承父元素颜色 */
            text-decoration: none; /* 清除默认下划线 */
        }
        input,
        button,
        textarea {
            font-family: inherit; /* 继承字体，保证样式统一 */
            outline: none; /* 清除默认聚焦外框，后续自定义 */
        }
        ol,
        ul {
            list-style: none; /* 清除列表默认圆点/数字 */
        }
        table {
            border-collapse: collapse; /* 表格边框合并 */
            border-spacing: 0; /* 表格边框间距清零 */
        }
        /* 2. 全局变量定义：统一主题色，便于维护 */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
            --gray-color: #95a5a6;
            --light-gray: #f1f2f3;
            --input-bg: #f7f9fc;
            --gradient-start: #2563eb;
            --gradient-end: #38bdf8;
            --card-border: rgba(15, 23, 42, 0.08);
            --shadow-soft: 0 20px 45px -20px rgba(15, 23, 42, 0.35);
            --chip-bg: rgba(59, 130, 246, 0.12);
            --chip-color: #2563eb;
            --icon-btn-bg: rgba(15, 23, 42, 0.08);
            --toolbar-btn-bg: rgba(59, 130, 246, 0.06);
            --toolbar-btn-border: rgba(59, 130, 246, 0.2);
            
            /* 日间模式背景和文本颜色 */
            --bg-primary: #f5f7fa;
            --bg-secondary: white;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #eee;
            --chat-bg: #fafafa;
            --ai-message-bg: #e6e6e6;
        }
        
        /* 夜间模式变量 */
        body.dark-mode {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #333;
            --chat-bg: #2a2a2a;
            --ai-message-bg: #3d3d3d;
            --gray-color: #707070;
            --light-gray: #333;
            --input-bg: #222;
            --card-border: rgba(148, 163, 184, 0.2);
            --shadow-soft: 0 24px 45px -20px rgba(15, 23, 42, 0.6);
            --chip-bg: rgba(59, 130, 246, 0.18);
            --chip-color: #93c5fd;
            --icon-btn-bg: rgba(148, 163, 184, 0.2);
            --toolbar-btn-bg: rgba(148, 163, 184, 0.08);
            --toolbar-btn-border: rgba(59, 130, 246, 0.35);
            background: linear-gradient(180deg, var(--bg-primary), #0f172a);
        }
        /* 夜间模式下的按钮样式 */
        body.dark-mode .btn-secondary {
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #555;
        }
        body.dark-mode .btn-secondary:hover {
            background-color: #444;
            color: white;
        }
        /* 3. 基础样式：页面整体布局 */
        body {
            background: linear-gradient(180deg, var(--bg-primary), #eef2ff);
            color: var(--text-primary);
            line-height: 1.6;
            overflow: hidden; /* 首次登录时禁止页面滚动 */
            transition: background-color 0.3s ease, color 0.3s ease, background-image 0.3s ease;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        /* 登录后允许页面滚动 */
        body.logged-in {
            overflow: auto;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 28px 56px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        /* 4. 组件样式：按功能模块拆分 */
        /* 4.1 登录模态框 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .auth-modal {
            background-color: white;
            width: 100%;
            max-width: 420px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        .auth-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            text-align: center;
        }
        .auth-header h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        .auth-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        /* 表单切换标签 */
        .auth-tabs {
            display: flex;
            border-bottom: 1px solid var(--light-gray);
        }
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--gray-color);
            cursor: pointer;
            transition: all 0.3s;
        }
        .auth-tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }
        .auth-tab:hover:not(.active) {
            color: var(--dark-color);
        }
        /* 表单容器 */
        .auth-forms {
            padding: 25px;
        }
        .auth-form {
            display: none; /* 默认隐藏所有表单 */
        }
        .auth-form.active {
            display: block; /* 仅显示当前激活的表单 */
        }
        
        /* 表格样式 */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .table-bordered {
            border: 1px solid #ddd;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .table-hover tbody tr:hover {
            background-color: #f5f5f5;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--dark-color);
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        /* 按钮样式 */
        .btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--dark-color);
        }
        .btn-secondary:hover {
            background-color: var(--gray-color);
            color: white;
        }
        /* 辅助文字（切换表单、错误提示） */
        .form-help {
            text-align: center;
            margin-top: 15px;
            font-size: 0.85rem;
            color: var(--gray-color);
        }
        .form-help a:hover {
            text-decoration: underline; /* hover时显示下划线，提升交互感 */
        }
        .error-message {
            color: var(--accent-color);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none; /* 默认隐藏错误提示 */
        }
        .success-message {
            color: var(--success-color);
        }
        
        /* 聊天框错误消息样式 */
        .chat-error-message {
            color: #e74c3c;
            text-align: center;
            padding: 15px;
            background-color: #fadbd8;
            border-radius: 6px;
            margin: 10px 0;
        }
        /* 聊天框成功提示样式 */
        .chat-success-message {
            font-size: 0.85rem;
            margin-top: 5px;
            display: none; /* 默认隐藏成功提示 */
        }
        /* 验证码输入组（并排布局） */
        .verify-code-group {
            display: flex;
            gap: 10px;
        }
        .verify-code-group .form-control {
            flex: 1; /* 输入框占满剩余空间 */
        }
        #getVerifyCodeBtn,
        #getVerifyCodeBtn_create {
            width: auto; /* 取消按钮100%宽度 */
            padding: 12px 15px; /* 适配输入框高度 */
            flex-shrink: 0; /* 按钮不收缩 */
            white-space: nowrap; /* 确保按钮文本不换行 */
        }
        #getVerifyCodeBtn:disabled,
        #getVerifyCodeBtn_create:disabled {
            background-color: var(--gray-color);
            cursor: not-allowed;
        }

        /* 4.2 页面头部 */
        header {
            position: relative;
            background: radial-gradient(120% 120% at 0% 0%, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0) 48%), linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 28px 48px;
            border-radius: 32px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-soft);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        header::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(120% 120% at 100% 0%, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0) 55%);
            pointer-events: none;
        }
        header > * {
            position: relative;
            z-index: 1;
        }
        header h1 {
            font-size: 2.6rem;
            margin: 0 0 8px;
            font-weight: 700;
            letter-spacing: 0.02em;
        }
        header p {
            font-size: 1.1rem;
            opacity: 0.92;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }
        .hero-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.2);
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.02em;
        }
        .hero-tag::before {
            content: "●";
            font-size: 0.6rem;
        }
        .header-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .hero-user {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.85);
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        /* 模式切换按钮样式 */
        .theme-toggle-btn {
            background-color: rgba(255, 255, 255, 0.22);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.35);
            padding: 10px 20px;
            border-radius: 999px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .theme-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        .feedback-btn {
            background-color: rgba(255, 255, 255, 0.22);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.35);
            padding: 10px 20px;
            border-radius: 999px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .feedback-btn:hover {
            background-color: rgba(255, 255, 255, 0.32);
            transform: translateY(-1px);
        }
        
        /* 反馈模态框样式 */
        .feedback-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }
        
        .feedback-modal-content {
            background-color: white;
            width: 100%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        
        .feedback-modal-header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .feedback-modal-header h2 {
            margin: 0;
            font-size: 1.3rem;
        }
        
        .close-feedback-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .feedback-modal-body {
            padding: 25px;
        }
        
        .feedback-form-group {
            margin-bottom: 20px;
            overflow: visible;
            position: relative;
        }
        
        .feedback-form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--dark-color);
            font-weight: 500;
        }
        
        .feedback-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.95rem;
            resize: vertical;
            transition: border-color 0.3s;
        }
        .feedback-textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        
        .feedback-type-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .feedback-type-option {
            flex: 1;
            min-width: calc(33.333% - 10px);
            padding: 10px;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .feedback-type-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .feedback-type-option:hover:not(.selected) {
            border-color: var(--gray-color);
        }
        
        .feedback-modal-footer {
            padding: 0 25px 25px;
            display: flex;
            gap: 10px;
        }
        
        /* 反馈状态消息 */
        .feedback-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }
        
        .feedback-status.success {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
            display: block;
        }
        
        .feedback-status.error {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--accent-color);
            display: block;
        }
        .user-profile-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #4caf50;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            border: 3px solid var(--primary-color);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* 头像上传遮罩层 */
        .avatar-upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            color: white;
            font-size: 12px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        }
        
        .user-avatar:hover .avatar-upload-overlay {
            opacity: 1;
        }
        
        .avatar-upload-overlay i {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        /* 头像操作按钮 */
        .avatar-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .avatar-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: var(--primary-color);
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .avatar-action-btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }
        
        .avatar-action-btn i {
            font-size: 12px;
        }
        
        .avatar-action-btn.delete-btn {
            background: #ef4444;
        }
        
        .avatar-action-btn.delete-btn:hover {
            background: #dc2626;
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }
        
        .user-info {
            text-align: center;
        }
        #profileUsername {
            margin: 0 0 5px;
            color: var(--dark-color);
            font-size: 1.2rem;
        }
        #profileEmail {
            margin: 0 0 5px;
            color: var(--gray-color);
            font-size: 0.9rem;
        }
        #profileUserType {
            margin: 0;
            color: var(--gray-color);
            font-size: 0.8rem;
        }
        .profile-settings-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .profile-settings-section h4 {
            margin: 0 0 15px;
            color: var(--dark-color);
            font-size: 1rem;
        }
        .toggle-switch {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }
        .toggle-switch span {
            font-size: 14px;
        }
        .added-models-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        #profileSidebar {
            left: auto;
            right: -380px;
            width: 360px;
            border-radius: 16px 0 0 16px;
            box-shadow: -20px 0 40px rgba(15, 23, 42, 0.18);
            background: #ffffff;
            transition: right 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }

        #profileSidebar.open {
            right: 0;
            left: auto;
        }

        #profileSidebar .history-header {
            background: linear-gradient(135deg, #2563eb, #60a5fa);
            padding: 28px 24px;
            border-radius: 16px 0 0 0;
        }

        #profileSidebar .history-header h3 {
            font-size: 1.35rem;
            font-weight: 600;
        }

        #profileSidebar .close-history-btn {
            background-color: rgba(255, 255, 255, 0.25);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        #profileSidebar .close-history-btn:hover {
            background-color: rgba(255, 255, 255, 0.35);
            transform: rotate(90deg);
        }

        #profileSidebar .history-list {
            padding: 24px;
            background: linear-gradient(180deg, #f1f5ff 0%, #ffffff 45%);
        }

        #profileSidebar .user-profile-section {
            background: #ffffff;
            border-radius: 14px;
            padding: 24px 20px 28px;
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.08);
            margin-bottom: 24px;
        }

        #profileSidebar .user-avatar {
            box-shadow: 0 8px 16px rgba(37, 99, 235, 0.25);
            border: 4px solid rgba(255, 255, 255, 0.9);
            background: linear-gradient(135deg, #34d399, #059669);
        }

        #profileSidebar .profile-sidebar-btn {
            background: rgba(37, 99, 235, 0.08);
            border-radius: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #1f2937;
        }

        #profileSidebar .profile-sidebar-btn::after {
            content: '›';
            font-size: 1.25rem;
            color: #2563eb;
            transition: transform 0.3s ease;
        }

        #profileSidebar .profile-sidebar-btn:hover {
            background: rgba(37, 99, 235, 0.18);
            transform: translateX(4px);
            box-shadow: 0 6px 14px rgba(37, 99, 235, 0.16);
        }

        #profileSidebar .profile-sidebar-btn:hover::after {
            transform: translateX(6px);
        }

        #profileSidebar .profile-settings-section {
            background: rgba(255, 255, 255, 0.85);
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.15);
            border-radius: 14px;
            padding: 18px 20px;
        }
        #profileSidebar .profile-settings-section h4 {
            color: #1f2937;
            font-weight: 600;
        }

        #profileSidebar .toggle-switch span {
            color: #374151;
            font-weight: 500;
        }
        .model-item {
            display: flex;
            align-items: center;
            background-color: var(--input-bg);
            border-radius: 6px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
        }
        .model-name {
            font-weight: 500;
            margin-right: 10px;
            min-width: 120px;
        }
        .use-model-btn,
        .delete-model-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-left: 5px;
        }
        .use-model-btn {
            background-color: var(--primary-color);
            color: white;
        }
        .use-model-btn:hover {
            background-color: #2c5aa0;
        }
        .delete-model-btn {
            background-color: #dc3545;
            color: white;
        }
        .delete-model-btn:hover {
            background-color: #c82333;
        }
        .model-params-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow: visible;
        }
        .param-control {
            display: flex;
            flex-direction: column;
            overflow: visible;
            position: relative;
        }
        .param-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            overflow: visible;
            position: relative;
        }
        .param-header span:last-child {
            font-weight: 600;
            color: var(--primary-color);
        }
        .param-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--input-bg);
            outline: none;
            margin-bottom: 5px;
        }
        .param-slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        .param-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
        }
        .param-range {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--gray-color);
        }
        /* 参数提示工具 */
        .param-label {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted var(--gray-color);
            transition: color 0.2s ease;
            display: inline-block;
        }
        .param-label:hover {
            color: var(--primary-color);
        }
        /* JavaScript创建的tooltip样式 */
        .param-tooltip {
            position: fixed;
            padding: 14px 18px;
            background: rgba(30, 30, 30, 0.98);
            color: #ffffff;
            font-size: 0.875rem;
            line-height: 1.75;
            white-space: normal;
            border-radius: 8px;
            width: 420px;
            max-width: calc(100vw - 40px);
            min-width: 300px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.6);
            z-index: 999999;
            word-wrap: break-word;
            word-break: normal;
            overflow-wrap: break-word;
            text-align: left;
            box-sizing: border-box;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .param-tooltip.show {
            opacity: 1;
        }
        .param-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 7px solid transparent;
            border-top-color: rgba(30, 30, 30, 0.98);
        }
        .param-tooltip.tooltip-below::after {
            top: auto;
            bottom: 100%;
            border-top-color: transparent;
            border-bottom-color: rgba(30, 30, 30, 0.98);
        }
        /* 响应式调整 */
        @media (max-width: 768px) {
            .param-tooltip {
                width: 350px;
                max-width: calc(100vw - 40px);
                font-size: 0.85rem;
                padding: 12px 16px;
                line-height: 1.7;
            }
        }
        @media (max-width: 480px) {
            .param-tooltip {
                width: 300px;
                max-width: calc(100vw - 30px);
                font-size: 0.8rem;
                padding: 10px 14px;
                line-height: 1.65;
            }
        }
        .modal-footer-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        .modal-footer-actions .btn {
            width: 100px;
        }
        .modal-action {
            width: 48%;
            height: 40px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        .modal-lg {
            width: min(640px, 90vw);
        }
        .modal-xl {
            width: min(720px, 92vw);
        }
        .note-list {
            max-height: 180px;
            overflow-y: auto;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 12px;
            background: var(--bg-primary);
        }
        .note-list p {
            color: var(--text-secondary);
            text-align: center;
            margin: 0;
        }
        .footer-spaced {
            justify-content: space-between;
            align-items: center;
            padding: 0;
            gap: 0;
            width: 100%;
        }
        .status-controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .model-selector-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .model-selector-container label {
            font-size: 0.9rem;
            color: #666;
        }
        .model-selector {
            appearance: none;
            padding: 6px 30px 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .model-selector:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        .model-selector-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #666;
        }
        /* 推荐模型样式已移除 - 改为只显示用户自定义模型 */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196f3;
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        .form-actions {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        .form-actions .btn {
            flex: 1;
            border-radius: 8px;
        }
        .button-row {
            display: flex;
            gap: 10px;
        }
        
        /* 用户设置模态框样式 */
        .settings-modal-content {
            max-width: 800px !important;
            width: 95% !important;
        }
        
        .settings-tabs {
            display: flex;
            border-bottom: 2px solid #e8e8e8;
            padding: 0 20px;
            gap: 5px;
            overflow-x: auto;
            scrollbar-width: thin;
        }
        .settings-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--gray-color);
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .settings-tab i {
            font-size: 1rem;
        }
        
        .settings-tab:hover {
            color: var(--primary-color);
            background-color: rgba(0, 123, 255, 0.05);
        }
        
        .settings-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 500;
        }
        
        .settings-toggle-group .settings-toggle-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        
        .settings-modal-body {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: visible;
            padding: 30px;
        }
        
        .settings-panel {
            display: none;
            overflow: visible;
        }
        
        .settings-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
            overflow: visible;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .settings-panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-color);
            border-bottom: 1px solid #e8e8e8;
            padding-bottom: 10px;
        }
        
        .settings-switch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }
        
        .switch-info {
            flex: 1;
        }
        
        .switch-info strong {
            display: block;
            font-size: 0.95rem;
            margin-bottom: 4px;
            color: var(--text-color);
        }
        
        .switch-info p {
            font-size: 0.85rem;
            color: var(--gray-color);
            margin: 0;
        }
        /* 登录后用户信息 */
        #userInfo {
            display: none;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        /* 移除退出登录按钮的特殊样式，让它使用profile-sidebar-btn类的统一样式 */

        .delete-account {
            color: #ff4d4f;
            text-decoration: underline;
            cursor: pointer;
        }

        .delete-account:hover {
            color: #ff7875;
            text-decoration: none;
            cursor: pointer;
        }

        /* 4.3 主内容区（语义化改造：div→section） */
        .main-content {
            display: grid;
            grid-template-columns: minmax(0, 2.2fr) minmax(320px, 1fr);
            gap: 24px;
            margin-bottom: 28px;
            align-items: stretch;
        }
        .main-content.resources-hidden {
            grid-template-columns: minmax(0, 1fr);
        }
        /* 聊天容器（添加ARIA属性，提升可访问性） */
        .chat-container,
        .resources-container {
            display: flex;
            flex-direction: column;
            gap: 0;
            height: 100%;
        }

        /* 4.4 聊天功能 */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            box-shadow: var(--shadow-soft);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            backdrop-filter: blur(6px);
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 26px 60px -30px rgba(15, 23, 42, 0.45);
        }
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 24px 28px;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.12), rgba(56, 189, 248, 0.08));
            border-bottom: 1px solid var(--card-border);
        }
        body.dark-mode .card-header {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.25), rgba(56, 189, 248, 0.18));
        }
        .card-header-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .card-title {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--dark-color);
        }
        body.dark-mode .card-title {
            color: var(--text-primary);
        }
        .card-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .card-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chip-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 999px;
            background-color: var(--chip-bg);
            color: var(--chip-color);
            font-weight: 600;
            border: 1px solid transparent;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
        }
        .chip-button:hover {
            border-color: rgba(59, 130, 246, 0.35);
            transform: translateY(-1px);
        }
        .icon-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--icon-btn-bg);
            border: 1px solid transparent;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
            font-size: 1.1rem;
        }
        .icon-button:hover {
            transform: translateY(-1px);
            border-color: rgba(148, 163, 184, 0.45);
        }
        .card-body {
            padding: 24px 28px 28px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 20px 24px;
            background-color: var(--chat-bg);
            transition: background-color 0.3s ease;
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.18);
        }
        
        /* 历史记录按钮样式 */
        .history-btn {
            background-color: #f0f0f0;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--dark-color);
        }
        
        .history-btn:hover {
            background-color: #e0e0e0;
            transform: translateY(-1px);
        }
        
        /* 历史记录侧边栏样式 */
        .history-sidebar {
            position: fixed;
            left: -350px;
            top: 0;
            width: 350px;
            height: 100vh;
            background-color: white;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .history-sidebar.open {
            left: 0;
        }
        
        .history-header {
            padding: 20px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        /* 侧边栏通用样式 - 统一左侧位置 */
        .sidebar {
            position: fixed;
            top: 0;
            left: -400px;
            width: 400px;
            height: 100vh;
            background-color: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .close-sidebar-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        /* 个人中心侧边栏按钮样式 */
        .profile-sidebar-btn {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            color: var(--dark-color);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        .profile-sidebar-btn:hover {
            background-color: #e3f2fd;
            transform: translateX(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .close-history-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .history-item {
            padding: 12px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        .history-item:hover {
            background-color: #e9ecef;
            border-left: 3px solid var(--primary-color);
            transform: translateX(2px);
        }
        
        .history-item.active {
            background-color: #e3f2fd;
            border-left: 3px solid var(--primary-color);
        }
        
        .history-question {
            font-weight: 500;
            color: var(--dark-color);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .history-time {
                font-size: 0.8rem;
                color: var(--gray-color);
            }
            
            .delete-session-btn {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: #ff6b6b;
                color: white;
                border: none;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                font-size: 14px;
                cursor: pointer;
                display: none;
                align-items: center;
                justify-content: center;
            }
            
            .history-item:hover .delete-session-btn {
                display: flex;
            }
            
            .delete-session-btn:hover {
                background: #ff5252;
            }
            
            .new-session-btn {
                background: #f8f9fa;
                border: 2px dashed #dee2e6;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .new-session-btn:hover {
                background: #e9ecef;
                border-color: #adb5bd;
            }
            
            .new-session-btn .icon {
                font-size: 18px;
                font-weight: bold;
                margin-right: 5px;
            }
        
        /* 侧边栏遮罩 */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
        }
        
        .sidebar-overlay.show {
            display: block;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            white-space: pre-wrap; /* 保留空格和换行 */
            word-wrap: break-word;
        }
        .user-message {
            background-color: var(--primary-color);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .ai-message {
            background-color: var(--ai-message-bg);
            color: var(--text-primary);
            margin-right: auto;
            border-bottom-left-radius: 4px;
            transition: background-color 0.3s ease;
        }
        /* 聊天输入区 */
        .chat-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .toolbar-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            border-radius: 12px;
            border: 1px solid var(--toolbar-btn-border);
            background: var(--toolbar-btn-bg);
            color: var(--chip-color);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .toolbar-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px -12px rgba(37, 99, 235, 0.6);
            background: rgba(59, 130, 246, 0.12);
        }
        .ghost-button {
            margin-top: 8px;
            padding: 8px 18px;
            border-radius: 12px;
            border: 1px solid var(--toolbar-btn-border);
            background: transparent;
            color: var(--chip-color);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .ghost-button:hover {
            transform: translateY(-1px);
            background: rgba(59, 130, 246, 0.08);
            box-shadow: 0 8px 20px -14px rgba(37, 99, 235, 0.5);
        }
        .chat-input {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            padding: 0;
        }
        .chat-input-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
        }
        .chat-input textarea {
            flex: 1;
            padding: 16px 18px;
            border: 1px solid var(--card-border);
            border-radius: 16px;
            font-size: 1rem;
            line-height: 1.6;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            resize: vertical;
            min-height: 72px;
            max-height: 200px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .chat-input textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
        }
        .chat-submit-btn {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            border: none;
            padding: 14px 26px;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 700;
            letter-spacing: 0.02em;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .chat-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 18px 28px -18px rgba(37, 99, 235, 0.65);
        }
        .chat-submit-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .stop-answer-btn {
            display: none;
            border: none;
            border-radius: 16px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            color: #fff;
            background: linear-gradient(135deg, #ef4444, #f97316);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        }
        .stop-answer-btn:hover:enabled {
            transform: translateY(-1px);
            box-shadow: 0 16px 28px -18px rgba(239, 68, 68, 0.6);
        }
        .stop-answer-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }
        .stop-message-hint {
            display: block;
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--accent-color);
        }
        .fullscreen-chat-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 12, 24, 0.96);
            z-index: 9999;
            overflow: hidden;
            backdrop-filter: blur(4px);
            transition: background 0.3s ease;
        }
        /* 日间模式下的全屏对话框背景 */
        body:not(.dark-mode) .fullscreen-chat-overlay {
            background: rgba(241, 245, 249, 0.97);
        }
        .fullscreen-chat-shell {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
            box-sizing: border-box;
        }
        .fullscreen-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: rgba(30, 41, 59, 0.85);
            color: white;
            border-bottom: 1px solid rgba(148, 163, 184, 0.18);
            flex-shrink: 0;
            transition: background 0.3s ease, color 0.3s ease;
        }
        /* 日间模式下的头部 */
        body:not(.dark-mode) .fullscreen-chat-header {
            background: rgba(255, 255, 255, 0.95);
            color: #1e293b;
            border-bottom: 1px solid rgba(15, 23, 42, 0.12);
        }
        .fullscreen-chat-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        .fullscreen-exit-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 4px 12px;
            border-radius: 8px;
            transition: background 0.2s ease, color 0.3s ease;
            line-height: 1;
        }
        .fullscreen-exit-btn:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        /* 日间模式下的退出按钮 */
        body:not(.dark-mode) .fullscreen-exit-btn {
            color: #1e293b;
        }
        body:not(.dark-mode) .fullscreen-exit-btn:hover {
            background: rgba(15, 23, 42, 0.08);
        }
        .fullscreen-chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 24px;
            background: rgba(17, 24, 39, 0.9);
            width: 100%;
            box-sizing: border-box;
            transition: background 0.3s ease;
        }
        /* 日间模式下的消息区域 */
        body:not(.dark-mode) .fullscreen-chat-messages {
            background: rgba(248, 250, 252, 0.95);
        }
        .fullscreen-chat-input {
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            gap: 16px;
            padding: 20px 24px;
            background: rgba(30, 41, 59, 0.92);
            border-top: 1px solid rgba(148, 163, 184, 0.18);
            flex-shrink: 0;
            transition: background 0.3s ease;
        }
        /* 日间模式下的输入区域 */
        body:not(.dark-mode) .fullscreen-chat-input {
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(15, 23, 42, 0.12);
        }
        .fullscreen-chat-input textarea {
            flex: 1;
            min-height: 80px;
            max-height: 200px;
            padding: 16px;
            border-radius: 12px;
            border: 2px solid rgba(148, 163, 184, 0.3);
            background: rgba(15, 23, 42, 0.9);
            color: white;
            font-size: 1rem;
            line-height: 1.5;
            resize: vertical;
            box-sizing: border-box;
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        /* 日间模式下的输入框 */
        body:not(.dark-mode) .fullscreen-chat-input textarea {
            background: white;
            color: #1e293b;
            border: 2px solid rgba(15, 23, 42, 0.2);
        }
        body:not(.dark-mode) .fullscreen-chat-input textarea::placeholder {
            color: #94a3b8;
        }
        .fullscreen-chat-input textarea:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.8);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .fullscreen-chat-input .chat-input-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
        }
        .fullscreen-ask-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #2563eb, #38bdf8);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            white-space: nowrap;
            min-height: 80px;
        }
        .fullscreen-ask-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(37, 99, 235, 0.4);
        }
        .fullscreen-ask-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* 全屏模式下的停止回答按钮 */
        .fullscreen-chat-input .stop-answer-btn {
            padding: 14px 28px;
            font-size: 1rem;
            min-height: 80px;
            white-space: nowrap;
        }
        
        /* 响应式设计 - 小屏幕 */
        @media (max-width: 1024px) {
            .fullscreen-chat-input {
                flex-direction: column;
                align-items: stretch;
            }
            .fullscreen-chat-input .chat-input-controls {
                flex-direction: row;
                justify-content: flex-end;
            }
            .fullscreen-ask-btn,
            .fullscreen-chat-input .stop-answer-btn {
                min-height: auto;
                padding: 12px 24px;
            }
        }
        
        @media (max-width: 768px) {
            .fullscreen-chat-header {
                padding: 16px;
            }
            .fullscreen-chat-header h2 {
                font-size: 1.25rem;
            }
            .fullscreen-chat-messages {
                padding: 16px;
            }
            .fullscreen-chat-input {
                padding: 16px;
                gap: 12px;
            }
            .fullscreen-chat-input textarea {
                min-height: 60px;
                font-size: 0.95rem;
            }
            .fullscreen-ask-btn,
            .fullscreen-chat-input .stop-answer-btn {
                padding: 12px 20px;
                font-size: 0.95rem;
            }
        }
        /* 加载状态（添加ARIA实时通知） */
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: var(--primary-color);
        }
        .loading::after {
            content: "•••";
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }
        /* 流式响应光标 */
        .streaming-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            background-color: var(--primary-color);
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* 4.5 资源列表 */
        .resources-list {
            padding: 15px;
            height: 540px;
            overflow-y: auto;
        }
        .resource-item {
            padding: 12px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            border-radius: 4px;
        }
        .resource-title {
            font-weight: bold;
            color: var(--dark-color);
            margin-bottom: 5px;
        }
        .resource-desc {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
        }
        .resource-link {
            display: inline-block;
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.9rem;
        }
        .resource-link:hover {
            text-decoration: underline;
        }

        /* 4.6 状态栏 */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid var(--card-border);
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        body.dark-mode .status-bar {
            background: rgba(59, 130, 246, 0.1);
        }
        .ipv6-badge {
            background: linear-gradient(120deg, #22c55e, #16a34a);
            color: white;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.02em;
        }
        /* 4.7 页脚（语义化标签保留） */
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }

        /* 5. 响应式样式：适配移动端 */
        @media (max-width: 1080px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .auth-modal {
                margin: 0 15px; /* 移动端留边距，避免贴边 */
            }
            header h1 {
                font-size: 1.8rem; /* 移动端缩小标题字号 */
            }
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .card-actions {
                width: 100%;
                justify-content: flex-start;
            }
            .chat-input {
                flex-direction: column;
                align-items: stretch;
            }
            .chat-input-controls {
                width: 100%;
                flex-direction: row;
            }
            .chat-input-controls .chat-submit-btn,
            .chat-input-controls .stop-answer-btn {
                flex: 1;
            }
        }
         /* 模型选择器交互效果 */
    #modelSelector:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    #modelSelector:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
    }

    /* 下拉选项样式 */
    #modelSelector option {
        padding: 8px;
        background-color: white;
        color: #333;
    }

    #modelSelector option:checked {
        background-color: var(--primary-color);
        color: white;
    }

    #modelSelector option:hover {
        background-color: #f0f7ff;
    }
    
    /* 思考内容样式 - 字体较小且透明，与正文形成区别 */
    .thought-content {
        font-size: 0.85em; /* 字体比正文小 */
        opacity: 0.8; /* 透明度设置，使其看起来更淡 */
        color: #666; /* 颜色更深灰色，进一步区分 */
        margin-top: 8px;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 4px;
        line-height: 1.5;
    }
    
    /* 思考容器和标题样式 */
    .thought-container {
        margin-bottom: 10px;
    }
    
    .thought-header {
        font-size: 0.9em;
        font-weight: 600;
        color: #555;
        cursor: pointer;
        user-select: none;
        padding: 5px 0;
    }
    
    .thought-toggle {
        display: inline-block;
        width: 16px;
        height: 16px;
        margin-right: 8px;
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .thought-toggle.collapsed {
        transform: rotate(-90deg);
    }
    </style>
<style>
      /* 反馈模态框样式 */
      .feedback-modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          justify-content: center;
          align-items: center;
      }
      
      .feedback-modal-content {
          background-color: white;
          border-radius: 8px;
          width: 90%;
          max-width: 500px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      
      .feedback-modal-header {
          padding: 20px;
          border-bottom: 1px solid var(--light-gray);
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      
      .feedback-modal-header h2 {
          margin: 0;
          font-size: 1.5rem;
          color: var(--dark-blue);
      }
      
      .close-feedback-btn {
          background: none;
          border: none;
          font-size: 1.5rem;
          cursor: pointer;
          color: var(--gray);
      }
      
      .feedback-modal-body {
          padding: 20px;
      }
      
      .feedback-form-group {
          margin-bottom: 15px;
      }
      
      .feedback-form-group label {
          display: block;
          margin-bottom: 5px;
          font-weight: 500;
          color: var(--dark-gray);
      }
      
      .feedback-textarea {
          width: 100%;
          padding: 10px;
          border: 1px solid var(--light-gray);
          border-radius: 4px;
          font-size: 1rem;
          resize: vertical;
      }
      
      .feedback-status {
          margin: 15px 0;
          padding: 10px;
          border-radius: 4px;
          text-align: center;
      }
      
      .feedback-modal-footer {
          padding: 15px 20px;
          border-top: 1px solid var(--light-gray);
          display: flex;
          justify-content: flex-end;
          gap: 10px;
      }
      
      .hidden {
          display: none !important;
      }
      
      /* 流式输出优化：避免闪烁 */
      .message-container {
          transition: none !important;
          /* 开启GPU硬件加速 */
          transform: translateZ(0);
          backface-visibility: hidden;
      }
      
      .message-container.streaming {
          /* 流式消息容器标记 - 在流式输出期间使用增量更新 */
          opacity: 1;
      }
      
      /* 平滑滚动优化 - 仅在非流式输出时启用 */
      #chatMessages {
          scroll-behavior: auto;
      }
      
      #fullscreenChatMessages {
          scroll-behavior: auto;
      }
      
      /* 优化消息内容渲染性能 */
      .ai-message,
      .user-message {
          /* GPU加速优化 */
          will-change: contents;
          transform: translateZ(0);
          /* 使用contain属性隔离重绘 */
          contain: layout style paint;
      }
      
      /* 优化滚动性能 */
      #chatMessages,
      #fullscreenChatMessages {
          /* 使用GPU加速滚动 */
          -webkit-overflow-scrolling: touch;
          /* 优化重绘 */
          will-change: scroll-position;
      }
    </style>
  </head>
<body>
    <!-- 添加资源模态框 -->
    <div id="addResourceModal" class="feedback-modal" style="display: none;">
        <div class="feedback-modal-content">
            <div class="feedback-modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px 30px; border-radius: 12px 12px 0 0;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-plus-circle" style="font-size: 24px;"></i>
                    <h2 style="margin: 0; font-size: 1.4rem; font-weight: 600; color: white;">添加课程资源</h2>
                </div>
                <button id="closeAddResourceBtn" class="close-feedback-btn" style="color: white; opacity: 0.9;">&times;</button>
            </div>
            <div class="feedback-modal-body" style="padding: 30px;">
                <form id="addResourceForm">
                    <div class="feedback-form-group" style="margin-bottom: 24px;">
                        <label for="resourceCategory" style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 0.95rem;">
                            <i class="fas fa-tag" style="color: #667eea;"></i>
                            资源分类
                        </label>
                        <input type="text" id="resourceCategory" class="feedback-textarea" 
                               placeholder="请输入分类名（如：微积分、Python编程）" required 
                               style="height: 48px; min-height: auto; padding: 12px 16px; font-size: 0.95rem; border: 2px solid #e5e7eb; border-radius: 8px; transition: all 0.3s ease;"
                               onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'"
                               onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                        <div class="error-message" id="resourceCategoryError"></div>
                    </div>
                    <div class="feedback-form-group" style="margin-bottom: 24px;">
                        <label for="resourceTitle" style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 0.95rem;">
                            <i class="fas fa-book" style="color: #667eea;"></i>
                            资源标题
                        </label>
                        <input type="text" id="resourceTitle" class="feedback-textarea" 
                               placeholder="请输入课程/资源标题（不超过200字）" required 
                               style="height: 48px; min-height: auto; padding: 12px 16px; font-size: 0.95rem; border: 2px solid #e5e7eb; border-radius: 8px; transition: all 0.3s ease;"
                               onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'"
                               onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                        <div class="error-message" id="resourceTitleError"></div>
                    </div>
                    <div class="feedback-form-group" style="margin-bottom: 24px;">
                        <label for="resourceUrl" style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 0.95rem;">
                            <i class="fas fa-link" style="color: #667eea;"></i>
                            资源链接
                        </label>
                        <input type="url" id="resourceUrl" class="feedback-textarea" 
                               placeholder="请输入完整链接（如https://pan.baidu.com/...）" required 
                               style="height: 48px; min-height: auto; padding: 12px 16px; font-size: 0.95rem; border: 2px solid #e5e7eb; border-radius: 8px; transition: all 0.3s ease;"
                               onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'"
                               onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                        <div class="error-message" id="resourceUrlError"></div>
                    </div>
                    <div class="feedback-form-group" style="margin-bottom: 20px;">
                        <label for="resourceDesc" style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 0.95rem;">
                            <i class="fas fa-align-left" style="color: #667eea;"></i>
                            资源描述
                            <span style="color: #9ca3af; font-weight: normal; font-size: 0.85rem;">（可选）</span>
                        </label>
                        <textarea id="resourceDesc" class="feedback-textarea" 
                                  placeholder="请简要描述资源内容" 
                                  style="min-height: 100px; padding: 12px 16px; font-size: 0.95rem; border: 2px solid #e5e7eb; border-radius: 8px; transition: all 0.3s ease; resize: vertical;"
                                  onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'"
                                  onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"></textarea>
                        <div class="error-message" id="resourceDescError"></div>
                    </div>
                    <div class="feedback-status" id="addResourceFormFeedback"></div>
                </form>
            </div>
            <div class="feedback-modal-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: #f9fafb; border-radius: 0 0 12px 12px; gap: 12px;">
                <button id="cancelAddResourceBtn" class="btn btn-secondary" style="flex: 1; height: 48px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 500; font-size: 0.95rem; background: white; color: #6b7280; border: 2px solid #e5e7eb; transition: all 0.3s ease;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#d1d5db'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                    <i class="fas fa-times" style="margin-right: 8px;"></i>
                    取消
                </button>
                <button id="submitAddResourceBtn" class="btn btn-primary" style="flex: 1; height: 48px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 500; font-size: 0.95rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(102, 126, 234, 0.3)'">
                    <i class="fas fa-check" style="margin-right: 8px;"></i>
                    确认添加
                </button>
            </div>
        </div>
    </div>
    <!-- 登录/注册/找回密码模态框 -->
    <div class="modal-overlay" id="authModal">
        <div class="auth-modal">
            <div class="auth-header">
                <h2>欢迎使用 AI 智能学习</h2>
                <p>请登录或注册以继续</p>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">登录</div>
                <div class="auth-tab" data-tab="register">注册</div>
                <div class="auth-tab" data-tab="forgot">找回密码</div>
            </div>
            <div class="auth-forms">
                <!-- 登录表单 -->
                <form class="auth-form active" id="loginForm">
                    <div class="form-group">
                        <label for="loginUsername">邮箱</label>
                        <input type="text" id="loginUseremail" class="form-control" placeholder="请输入登录邮箱" required>
                        <div class="error-message" id="loginUsernameError"></div>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">密码</label>
                        <div class="password-input-container">
                            <input type="password" id="loginPassword" class="form-control password-input" placeholder="请输入密码" required>
                            <button type="button" class="toggle-password-btn" data-target="loginPassword">👁️</button>
                        </div>
                        <div class="error-message" id="loginPasswordError"></div>
                    </div>
                    <div class="form-group">
                        <div class="error-message" id="loginFormError"></div>
                        <div class="success-message" id="loginFormSuccess"></div>
                        <!-- 隐私政策同意勾选 -->
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: flex-start; font-weight: normal; font-size: 12px; color: #666; line-height: 1.5;">
                                <input type="checkbox" id="loginAgreeTerms" style="margin-top: 2px; margin-right: 8px;" required>
                                <span>我已阅读并同意<a href="terms_of_service.html" style="color: #007bff; text-decoration: underline;">使用条款</a>和<a href="privacy_policy.html" style="color: #007bff; text-decoration: underline;">隐私政策</a>，并承诺妥善保管账号安全</span>
                            </label>
                            <div class="error-message" id="loginTermsError" style="display: none; margin-top: 5px; font-size: 12px;"></div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="loginBtn">登录</button>
                            <button type="button" class="btn btn-secondary" id="loginCancelBtn">取消</button>
                        </div>
                    </div>
                    <div class="form-help">
                        还没有账号？<a href="javascript:;" data-switch="register">立即注册</a>
                    </div>
                </form>

                <!-- 注册表单 -->
                <form class="auth-form" id="registerForm">
                    <div class="form-group">
                        <label for="regUsername">用户名</label>
                        <input type="text" id="regUsername" class="form-control" placeholder="请输入用户名（3-20字符）" required>
                        <div class="error-message" id="regUsernameError"></div>
                    </div>
                    <div class="form-group">
                        <label for="regEmail">邮箱</label>
                        <input type="email" id="regEmail" class="form-control" placeholder="请输入常用邮箱" required>
                        <div class="error-message" id="regEmailError"></div>
                    </div>
                    <div class="form-group">
                        <label for="createVerifyCode">验证码</label>
                        <div class="verify-code-group">
                            <input type="text" id="createVerifyCode" class="form-control" placeholder="请输入6位验证码" maxlength="6" required>
                            <button type="button" class="btn btn-primary" id="getVerifyCodeBtn_create">获取验证码</button>
                        </div>
                        <div class="error-message" id="regVerifyCodeError"></div>
                    </div>
                    <div class="form-group">
                        <label for="regPassword">密码</label>
                        <div class="password-input-container">
                            <input type="password" id="regPassword" class="form-control password-input" placeholder="请输入密码（6-20字符）" required>
                            <button type="button" class="toggle-password-btn" data-target="regPassword">👁️</button>
                        </div>
                        <div class="error-message" id="regPasswordError"></div>
                    </div>
                    <div class="form-group">
                        <label for="regConfirmPassword">确认密码</label>
                        <div class="password-input-container">
                            <input type="password" id="regConfirmPassword" class="form-control password-input" placeholder="请再次输入密码" required>
                            <button type="button" class="toggle-password-btn" data-target="regConfirmPassword">👁️</button>
                        </div>
                        <div class="error-message" id="regConfirmPasswordError"></div>
                    </div>
                    <div class="form-group">
                        <div class="error-message" id="registerFormError"></div>
                        <div class="success-message" id="registerFormSuccess"></div>
                        <!-- 隐私政策同意勾选 -->
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: flex-start; font-weight: normal; font-size: 12px; color: #666; line-height: 1.5;">
                                <input type="checkbox" id="registerAgreeTerms" style="margin-top: 2px; margin-right: 8px;" required>
                                <span>我已阅读并同意<a href="terms_of_service.html" style="color: #007bff; text-decoration: underline;">使用条款</a>和<a href="privacy_policy.html" style="color: #007bff; text-decoration: underline;">隐私政策</a>，并承诺妥善保管账号安全</span>
                            </label>
                            <div class="error-message" id="registerTermsError" style="display: none; margin-top: 5px; font-size: 12px;"></div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="registerBtn">注册</button>
                            <button type="button" class="btn btn-secondary" id="registerCancelBtn">取消</button>
                        </div>
                    </div>
                    <div class="form-help">
                        已有账号？<a href="javascript:;" data-switch="login">返回登录</a>
                    </div>
                </form>
                <!-- 找回密码表单（验证码版） -->
                <form class="auth-form" id="forgotForm">
                    <div class="form-group">
                        <label for="forgotEmail">注册邮箱</label>
                        <input type="email" id="forgotEmail" class="form-control" placeholder="请输入注册时的邮箱" required>
                        <div class="error-message" id="forgotEmailError"></div>
                    </div>
                    <div class="form-group">
                        <label for="forgotVerifyCode">验证码</label>
                        <div class="verify-code-group">
                            <input type="text" id="forgotVerifyCode" class="form-control" placeholder="请输入6位验证码" maxlength="6" required>
                            <button type="button" class="btn btn-primary" id="getVerifyCodeBtn">获取验证码</button>
                        </div>
                        <div class="error-message" id="forgotVerifyCodeError"></div>
                    </div>
                    <div class="form-group">
                        <label for="forgotNewPassword">新密码</label>
                        <div class="password-input-container">
                            <input type="password" id="forgotNewPassword" class="form-control password-input" placeholder="请输入新密码（6-20字符）" required>
                            <button type="button" class="toggle-password-btn" data-target="forgotNewPassword">👁️</button>
                        </div>
                        <div class="error-message" id="forgotNewPasswordError"></div>
                    </div>
                    <div class="form-group">
                        <label for="forgotConfirmPassword">确认新密码</label>
                        <div class="password-input-container">
                            <input type="password" id="forgotConfirmPassword" class="form-control password-input" placeholder="请再次输入新密码" required>
                            <button type="button" class="toggle-password-btn" data-target="forgotConfirmPassword">👁️</button>
                        </div>
                        <div class="error-message" id="forgotConfirmPasswordError"></div>
                    </div>
                    <div class="form-group">
                        <div class="error-message" id="forgotFormError"></div>
                        <div class="success-message" id="forgotFormSuccess">密码重置成功！即将跳转登录页...</div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="forgotBtn">重置密码</button>
                            <button type="button" class="btn btn-secondary" id="forgotCancelBtn">取消</button>
                        </div>
                    </div>
                    <div class="form-help">
                        想起密码了？<a href="javascript:;" data-switch="login">返回登录</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 历史记录侧边栏 -->
    <aside class="history-sidebar" id="historySidebar" role="complementary" aria-label="历史聊天记录">
        <div class="history-header">
            <h3>历史聊天记录</h3>
            <button class="close-history-btn" id="closeHistoryBtn">×</button>
        </div>
        <div class="history-list" id="historyList">
            <!-- 历史记录将通过JavaScript动态加载 -->
        </div>
    </aside>
    <!-- 侧边栏遮罩 -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- 页面主体内容 -->
    <main class="container" role="main">
        <header>
            <div class="header-top">
                <span class="hero-tag">AI 学习助手</span>
                <div class="header-actions">
                    <button id="profileBtn" class="feedback-btn">个人中心</button>
                    <button class="theme-toggle-btn" id="themeToggleBtn" onclick="toggleTheme()">
                        <span id="themeIcon">🌙</span>
                        <span id="themeText">夜间模式</span>
                    </button>
                </div>
            </div>
            <div class="header-content">
                <h1>AI 智能学习导师系统</h1>
                <p>AI赋能互联网技术创新发展 - 智能学习助手</p>
                <!-- 登录后显示用户名 -->
                <div id="userInfo" class="hero-user">
                    欢迎，<span id="usernameDisplay" style="text-decoration: underline;"></span>
                </div>
            </div>
        </header>
        
        <!-- 个人中心侧边栏 -->
        <aside id="profileSidebar" class="history-sidebar" role="complementary" aria-label="个人中心">
            <div class="history-header">
                <h3>个人中心</h3>
                <button id="closeProfileBtn" class="close-history-btn">&times;</button>
            </div>
            <div class="history-list">
                <!-- 用户信息区域 -->
                <div class="user-profile-section">
                    <!-- 用户头像 -->
                    <div class="user-avatar" id="userAvatarContainer">
                        <img id="userAvatarImg" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22100%22%20height%3D%22100%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_18bc6f87a3f%20text%20%7B%20fill%3Argba(153%2C153%2C153%2C.5)%3Bfont-weight%3Anormal%3Bfont-family%3AHelvetica%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_18bc6f87a3f%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2235%22%20y%3D%2254%22%3E%E5%A4%B4%E5%83%8F%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E" alt="用户头像">
                        <div class="avatar-upload-overlay" id="avatarUploadOverlay">
                            <i class="fas fa-camera"></i>
                            <span>更换头像</span>
                        </div>
                        <input type="file" id="avatarFileInput" accept="image/*" style="display: none;">
                    </div>
                    <!-- 用户信息 -->
                    <div class="user-info">
                        <h4 id="profileUsername">用户名</h4>
                        <p id="profileEmail">邮箱@example.com</p>
                        <p id="profileUserType">普通用户</p>
                    </div>
                </div>

                <button id="showAddResourceBtn" class="profile-sidebar-btn">添加课程资源</button>
                <button id="cloudDiskBtn" class="profile-sidebar-btn">云盘管理</button>
                
                <button id="userSettingsBtn" class="profile-sidebar-btn">用户设置</button>
                <button id="profileFeedbackBtn" class="profile-sidebar-btn">提交反馈</button>
                <button id="logoutBtn" class="profile-sidebar-btn">退出登录</button>
                <button id="deleteAccountBtn" class="profile-sidebar-btn">注销账户</button>
            </div>
        </aside>

        <!-- 用户设置模态框 -->
        <div id="userSettingsModal" class="feedback-modal settings-modal">
            <div class="feedback-modal-content settings-modal-content">
                <div class="feedback-modal-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 24px 30px; border-radius: 12px 12px 0 0;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-cog fa-spin" style="font-size: 24px; animation-duration: 3s;"></i>
                        <h2 style="margin: 0; font-size: 1.4rem; font-weight: 600; color: white;">用户设置</h2>
                    </div>
                    <button id="closeUserSettingsBtn" class="close-feedback-btn" style="color: white; opacity: 0.9;">&times;</button>
                </div>
                
                <!-- 设置标签页导航 -->
                <div class="settings-tabs" style="background: linear-gradient(to bottom, #f0f9ff 0%, white 100%); padding: 0 20px; border-bottom: 2px solid #e0f2fe; box-shadow: 0 2px 8px rgba(79, 172, 254, 0.08);">
                    <button class="settings-tab active" data-tab="profile" style="position: relative; padding: 16px 24px; background: none; border: none; border-bottom: 3px solid #4facfe; cursor: pointer; font-size: 0.9rem; color: #0284c7; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-user" style="font-size: 1.1rem;"></i>
                        <span>个人信息</span>
                    </button>
                    <button class="settings-tab" data-tab="security" style="position: relative; padding: 16px 24px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 0.9rem; color: #6b7280; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;" onmouseover="if(!this.classList.contains('active')) {this.style.color='#0284c7'; this.style.borderBottomColor='#bfdbfe'}" onmouseout="if(!this.classList.contains('active')) {this.style.color='#6b7280'; this.style.borderBottomColor='transparent'}">
                        <i class="fas fa-lock" style="font-size: 1.1rem;"></i>
                        <span>安全设置</span>
                    </button>
                    <button class="settings-tab" data-tab="ai-model" style="position: relative; padding: 16px 24px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 0.9rem; color: #6b7280; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;" onmouseover="if(!this.classList.contains('active')) {this.style.color='#0284c7'; this.style.borderBottomColor='#bfdbfe'}" onmouseout="if(!this.classList.contains('active')) {this.style.color='#6b7280'; this.style.borderBottomColor='transparent'}">
                        <i class="fas fa-robot" style="font-size: 1.1rem;"></i>
                        <span>AI模型</span>
                    </button>
                    <button class="settings-tab" data-tab="notifications" style="position: relative; padding: 16px 24px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 0.9rem; color: #6b7280; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;" onmouseover="if(!this.classList.contains('active')) {this.style.color='#0284c7'; this.style.borderBottomColor='#bfdbfe'}" onmouseout="if(!this.classList.contains('active')) {this.style.color='#6b7280'; this.style.borderBottomColor='transparent'}">
                        <i class="fas fa-bell" style="font-size: 1.1rem;"></i>
                        <span>通知</span>
                    </button>
                    <button class="settings-tab" data-tab="privacy" style="position: relative; padding: 16px 24px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 0.9rem; color: #6b7280; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;" onmouseover="if(!this.classList.contains('active')) {this.style.color='#0284c7'; this.style.borderBottomColor='#bfdbfe'}" onmouseout="if(!this.classList.contains('active')) {this.style.color='#6b7280'; this.style.borderBottomColor='transparent'}">
                        <i class="fas fa-shield-alt" style="font-size: 1.1rem;"></i>
                        <span>隐私</span>
                    </button>
                </div>
                
                <div class="feedback-modal-body settings-modal-body">
                    <!-- 个人信息设置 -->
                    <div class="settings-panel active" id="profile-panel">
                        <h3 class="settings-panel-title" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 24px; color: #0c4a6e; border-bottom: 2px solid #4facfe; padding-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-id-card" style="color: #4facfe;"></i>
                            基本信息
                        </h3>
                        <div class="feedback-form-group" style="margin-bottom: 24px;">
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151; margin-bottom: 12px; font-size: 0.95rem;">
                                <i class="fas fa-image" style="color: #4facfe;"></i>
                                头像设置
                            </label>
                            <div style="display: flex; align-items: center; gap: 20px; padding: 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 10px; border: 2px solid #bfdbfe;">
                                <div style="position: relative;">
                                    <img id="settingsAvatarImg" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22100%22%20height%3D%22100%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_18bc6f87a3f%20text%20%7B%20fill%3Argba(153%2C153%2C153%2C.5)%3Bfont-weight%3Anormal%3Bfont-family%3AHelvetica%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_18bc6f87a3f%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2235%22%20y%3D%2254%22%3E%E5%A4%B4%E5%83%8F%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E" alt="用户头像" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #4facfe; box-shadow: 0 2px 8px rgba(79, 172, 254, 0.2);">
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
                                    <div style="display: flex; gap: 10px;">
                                        <button id="settingsUploadAvatarBtn" class="btn" style="flex: 1; height: 40px; border-radius: 8px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none; color: white; font-weight: 500; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(79, 172, 254, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            <i class="fas fa-upload"></i>
                                            上传头像
                                        </button>
                                        <button id="settingsDeleteAvatarBtn" class="btn" style="flex: 1; height: 40px; border-radius: 8px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; color: white; font-weight: 500; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; display: none; align-items: center; justify-content: center; gap: 6px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            <i class="fas fa-trash"></i>
                                            删除头像
                                        </button>
                                    </div>
                                    <input type="file" id="settingsAvatarFileInput" accept="image/*" style="display: none;">
                                    <small style="color: #64748b; font-size: 0.8rem;">支持 JPG、PNG、GIF、WebP 格式，最大 5MB</small>
                                </div>
                            </div>
                        </div>
                        <div class="feedback-form-group" style="margin-bottom: 24px;">
                            <label for="settingsUsername" style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 0.95rem;">
                                <i class="fas fa-user" style="color: #4facfe;"></i>
                                用户名
                            </label>
                            <input type="text" id="settingsUsername" class="feedback-textarea" 
                                   placeholder="请输入用户名" 
                                   autocomplete="username"
                                   style="height: 48px; min-height: auto; padding: 12px 16px; font-size: 0.95rem; border: 2px solid #e5e7eb; border-radius: 8px; transition: all 0.3s ease;"
                                   onfocus="this.style.borderColor='#4facfe'; this.style.boxShadow='0 0 0 3px rgba(79, 172, 254, 0.1)'"
                                   onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                            <small style="color: #6b7280; font-size: 0.85rem; margin-top: 4px; display: block;">用户名长度3-80个字符</small>
                        </div>
                        <div class="feedback-form-group" style="margin-bottom: 24px;">
                            <label for="settingsEmail" style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 0.95rem;">
                                <i class="fas fa-envelope" style="color: #4facfe;"></i>
                                邮箱地址
                            </label>
                            <input type="email" id="settingsEmail" class="feedback-textarea" 
                                   placeholder="请输入邮箱地址" 
                                   autocomplete="email"
                                   readonly
                                   style="height: 48px; min-height: auto; padding: 12px 16px; font-size: 0.95rem; border: 2px solid #e5e7eb; border-radius: 8px; background-color: #f9fafb; cursor: not-allowed;">
                            <small style="color: #6b7280; font-size: 0.85rem; margin-top: 4px; display: block;">邮箱地址不可修改</small>
                        </div>
                        <!-- 头像设置 -->

                        <div class="feedback-form-group settings-toggle-group" style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%); border-radius: 10px; border: 2px solid #93c5fd;">
                            <div class="settings-toggle-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-book-open" style="color: #0284c7;"></i>
                                    <span style="font-weight: 500; color: #0c4a6e;">显示资源库</span>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="toggleResources" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <small style="color: #075985; font-size: 0.85rem; margin-left: 32px; display: block;">关闭后主页将隐藏学习资源板块</small>
                        </div>
                        <div class="feedback-form-group">
                            <button id="saveProfileBtn" class="btn btn-primary" style="width: 100%; height: 48px; border-radius: 8px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none; font-weight: 500; font-size: 1rem; box-shadow: 0 4px 6px rgba(79, 172, 254, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(79, 172, 254, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(79, 172, 254, 0.3)'">
                                <i class="fas fa-save" style="margin-right: 8px;"></i>
                                保存个人信息
                            </button>
                        </div>
                        <div class="feedback-status" id="profileStatus"></div>
                    </div>
                    
                    <!-- 安全设置 -->
                    <div class="settings-panel" id="security-panel">
                        <h3 class="settings-panel-title">修改密码</h3>
                        <form id="changePasswordForm" onsubmit="return false;">
                            <!-- 隐藏的用户名字段以满足可访问性要求 -->
                            <input type="text" id="changePasswordUsername" name="username" autocomplete="username" style="display: none;">
                            <div class="feedback-form-group">
                                <label for="currentPassword">当前密码</label>
                                <input type="password" id="currentPassword" class="feedback-textarea" 
                                       placeholder="请输入当前密码" 
                                       autocomplete="current-password"
                                       style="height: 40px; min-height: auto; padding: 8px 12px; font-size: 0.9rem;">
                            </div>
                            <div class="feedback-form-group">
                                <label for="newPassword">新密码</label>
                                <input type="password" id="newPassword" class="feedback-textarea" 
                                       placeholder="请输入新密码（6-20位）" 
                                       autocomplete="new-password"
                                       style="height: 40px; min-height: auto; padding: 8px 12px; font-size: 0.9rem;">
                                <small style="color: var(--gray-color); font-size: 0.8rem;">密码需包含字母和数字，长度6-20位</small>
                            </div>
                            <div class="feedback-form-group">
                                <label for="confirmPassword">确认新密码</label>
                                <input type="password" id="confirmPassword" class="feedback-textarea" 
                                       placeholder="请再次输入新密码" 
                                       autocomplete="new-password"
                                       style="height: 40px; min-height: auto; padding: 8px 12px; font-size: 0.9rem;">
                            </div>
                            <div class="feedback-form-group">
                                <button type="button" id="changePasswordBtn" class="btn btn-primary" style="width: 100%;">修改密码</button>
                            </div>
                        </form>
                        <div class="feedback-status" id="securityStatus"></div>
                    </div>
                    
                    <!-- AI模型设置 -->
                    <div class="settings-panel" id="ai-model-panel">
                        <h3 class="settings-panel-title" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 24px; color: #0c4a6e; border-bottom: 2px solid #4facfe; padding-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-robot" style="color: #4facfe;"></i>
                            AI模型配置
                        </h3>
                        <form id="aiModelForm" onsubmit="return false;">
                            <div class="feedback-form-group" style="margin-bottom: 24px;">
                                <label for="modelName" style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 0.95rem;">
                                    <i class="fas fa-brain" style="color: #4facfe;"></i>
                                    AI模型名称
                                </label>
                                <input type="text" id="modelName" class="feedback-textarea" 
                                       placeholder="请输入准确的模型名称，如 deepseek-chat" 
                                       autocomplete="off"
                                       style="height: 48px; min-height: auto; padding: 12px 16px; font-size: 0.95rem; border: 2px solid #e5e7eb; border-radius: 8px; transition: all 0.3s ease;"
                                       onfocus="this.style.borderColor='#4facfe'; this.style.boxShadow='0 0 0 3px rgba(79, 172, 254, 0.1)'; showModelNameSuggestions()"
                                       onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'; hideModelNameSuggestions()"
                                       oninput="validateModelName(this)">
                                
                                <!-- 模型名称建议下拉框 -->
                                <div id="modelNameSuggestions" style="display: none; position: absolute; z-index: 1000; background: white; border: 2px solid #4facfe; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 4px; max-height: 200px; overflow-y: auto;">
                                    <div class="model-suggestion" onclick="selectModelName('deepseek-chat')" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: all 0.2s ease;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                                        <div style="font-weight: 500; color: #0c4a6e;">deepseek-chat</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">DeepSeek 对话模型</div>
                                    </div>
                                    <div class="model-suggestion" onclick="selectModelName('deepseek-reasoner')" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: all 0.2s ease;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                                        <div style="font-weight: 500; color: #0c4a6e;">deepseek-reasoner</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">DeepSeek 推理模型（支持思考过程）</div>
                                    </div>
                                    <div class="model-suggestion" onclick="selectModelName('gpt-3.5-turbo')" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: all 0.2s ease;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                                        <div style="font-weight: 500; color: #0c4a6e;">gpt-3.5-turbo</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">OpenAI GPT-3.5 Turbo</div>
                                    </div>
                                    <div class="model-suggestion" onclick="selectModelName('gpt-4')" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: all 0.2s ease;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                                        <div style="font-weight: 500; color: #0c4a6e;">gpt-4</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">OpenAI GPT-4</div>
                                    </div>
                                    <div class="model-suggestion" onclick="selectModelName('gpt-4-turbo')" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: all 0.2s ease;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                                        <div style="font-weight: 500; color: #0c4a6e;">gpt-4-turbo</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">OpenAI GPT-4 Turbo</div>
                                    </div>
                                    <div class="model-suggestion" onclick="selectModelName('claude-3-sonnet')" style="padding: 12px 16px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                                        <div style="font-weight: 500; color: #0c4a6e;">claude-3-sonnet</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">Anthropic Claude 3 Sonnet</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 12px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 3px solid #f59e0b;">
                                    <p style="margin: 0; color: #92400e; font-size: 0.9rem; font-weight: 500;">⚠️ 重要提示：</p>
                                    <p style="margin: 8px 0 0 0; color: #92400e; font-size: 0.85rem;">请确保模型名称与API提供商的文档完全一致，错误的模型名称会导致调用失败</p>
                                </div>
                                
                                <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #0284c7;">
                                    <p style="margin: 0; color: #0c4a6e; font-size: 0.9rem; font-weight: 500;">💡 使用自己的 AI 模型：</p>
                                    <p style="margin: 8px 0 0 0; color: #475569; font-size: 0.85rem;">请先添加自定义 AI 模型，然后在下方的"已添加的模型"中选择使用</p>
                                </div>
                            </div>
                            <div class="feedback-form-group" style="margin-bottom: 24px;">
                                <label for="apiBase" style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 0.95rem;">
                                    <i class="fas fa-server" style="color: #4facfe;"></i>
                                    API 地址
                                </label>
                                <input type="text" id="apiBase" class="feedback-textarea" 
                                       placeholder="请输入API地址" 
                                       autocomplete="url"
                                       value=""
                                       style="height: 48px; min-height: auto; padding: 12px 16px; font-size: 0.95rem; border: 2px solid #e5e7eb; border-radius: 8px; transition: all 0.3s ease;"
                                       onfocus="this.style.borderColor='#4facfe'; this.style.boxShadow='0 0 0 3px rgba(79, 172, 254, 0.1)'"
                                       onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                                <small style="color: #6b7280; font-size: 0.85rem; margin-top: 4px; display: block;">例如: https://api.openai.com/v1</small>
                            </div>
                            <div class="feedback-form-group" style="margin-bottom: 24px;">
                                <label for="apiKey" style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 0.95rem;">
                                    <i class="fas fa-key" style="color: #4facfe;"></i>
                                    API 密钥
                                </label>
                                <input type="password" id="apiKey" class="feedback-textarea" 
                                       placeholder="请输入API密钥" 
                                       autocomplete="current-password"
                                       style="height: 48px; min-height: auto; padding: 12px 16px; font-size: 0.95rem; border: 2px solid #e5e7eb; border-radius: 8px; transition: all 0.3s ease;"
                                       onfocus="this.style.borderColor='#4facfe'; this.style.boxShadow='0 0 0 3px rgba(79, 172, 254, 0.1)'"
                                       onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                                <small style="color: #6b7280; font-size: 0.85rem; margin-top: 4px; display: block;">密钥将被安全存储，仅用于API调用</small>
                            </div>
                            <div class="feedback-form-group" style="margin-bottom: 24px; display: flex; gap: 12px;">
                                <button type="button" id="testAPIBtn" class="btn" style="flex: 1; height: 48px; border-radius: 8px; background: white; border: 2px solid #4facfe; color: #0284c7; font-weight: 500; font-size: 0.95rem; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.background='#f0f9ff'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='white'; this.style.transform='translateY(0)'">
                                    <i class="fas fa-plug"></i>
                                    测试连接
                                </button>
                                <button type="button" id="addModelBtn" class="btn btn-primary" style="flex: 1; height: 48px; border-radius: 8px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none; font-weight: 500; font-size: 0.95rem; box-shadow: 0 4px 6px rgba(79, 172, 254, 0.3); transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(79, 172, 254, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(79, 172, 254, 0.3)'">
                                    <i class="fas fa-plus"></i>
                                    添加模型
                                </button>
                            </div>
                        </form>
                        <div class="feedback-form-group" style="margin-bottom: 24px;">
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151; margin-bottom: 12px; font-size: 0.95rem;">
                                <i class="fas fa-list" style="color: #4facfe;"></i>
                                已添加的模型
                            </label>
                            <div id="addedModels" class="added-models-list" style="display: flex; flex-direction: column; gap: 12px; max-height: 300px; overflow-y: auto; padding: 4px;">
                                <!-- 已添加的模型将在这里动态显示 -->
                            </div>
                        </div>
                        <div class="feedback-form-group">
                            <label>模型参数</label>
                            <div class="model-params-container">
                                <div class="param-control">
                                    <div class="param-header">
                                        <span class="param-label" data-tooltip="控制输出的随机性和创造性。值越低（接近0），输出越确定、一致和可预测；值越高（接近2），输出越随机、多样和富有创造性。适合需要精确答案的场景使用较低值，需要创意内容时使用较高值。">温度 (temperature)</span>
                                        <span id="tempValue">0.7</span>
                                    </div>
                                    <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" class="param-slider">
                                    <div class="param-range">
                                        <span>0.0 (精确)</span>
                                        <span>2.0 (随机)</span>
                                    </div>
                                </div>
                                <div class="param-control">
                                    <div class="param-header">
                                        <span class="param-label" data-tooltip="限制AI生成回复的最大长度，以token为单位。值越大，允许生成更长的回复；值越小，回复更简洁。建议根据对话需求调整：简短问答可用较小值（如500-1000），长文本生成需要较大值（如2000-4096）。注意：较大的值会消耗更多的API配额。">最大生成长度 (max_tokens)</span>
                                        <span id="tokensValue">2000</span>
                                    </div>
                                    <input type="range" id="maxTokens" min="100" max="4096" step="100" value="2000" class="param-slider">
                                    <div class="param-range">
                                        <span>100</span>
                                        <span>4096</span>
                                    </div>
                                </div>
                                <div class="param-control">
                                    <div class="param-header">
                                        <span class="param-label" data-tooltip="控制采样时的多样性，使用核采样（nucleus sampling）方法。值越低（接近0），输出更集中、确定和保守；值越高（接近1），输出更多样、丰富和开放。通常与temperature参数配合使用。较低值适合需要准确性的任务，较高值适合需要创造性的任务。">多样性 (top_p)</span>
                                        <span id="topPValue">1.0</span>
                                    </div>
                                    <input type="range" id="topP" min="0" max="1" step="0.1" value="1.0" class="param-slider">
                                    <div class="param-range">
                                        <span>0.0</span>
                                        <span>1.0</span>
                                    </div>
                                </div>
                                <input type="hidden" id="modelParams" value='{"temperature": 0.7, "max_tokens": 2000, "top_p": 1.0}'>
                            </div>
                        </div>
                        <div class="feedback-status" id="aiSettingsStatus" style="display: none;"></div>
                    </div>
                    
                    <!-- 通知设置 -->
                    <div class="settings-panel" id="notifications-panel">
                        <h3 class="settings-panel-title">通知偏好</h3>
                        <div class="feedback-form-group">
                            <div class="settings-switch-item">
                                <div class="switch-info">
                                    <strong>系统通知</strong>
                                    <p>接收系统更新和重要通知</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="systemNotifications" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <div class="feedback-form-group">
                            <div class="settings-switch-item">
                                <div class="switch-info">
                                    <strong>学习提醒</strong>
                                    <p>每日学习计划和任务提醒</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="learningReminders" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <div class="feedback-form-group">
                            <div class="settings-switch-item">
                                <div class="switch-info">
                                    <strong>邮件通知</strong>
                                    <p>通过邮件接收重要信息</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="emailNotifications">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <div class="feedback-form-group">
                            <button id="saveNotificationsBtn" class="btn btn-primary" style="width: 100%;">保存通知设置</button>
                        </div>
                        <div class="feedback-status" id="notificationsStatus"></div>
                    </div>
                    
                    <!-- 隐私设置 -->
                    <div class="settings-panel" id="privacy-panel">
                        <h3 class="settings-panel-title">隐私与数据</h3>
                        <div class="feedback-form-group">
                            <div class="settings-switch-item">
                                <div class="switch-info">
                                    <strong>学习数据分析</strong>
                                    <p>允许系统分析学习数据以提供个性化建议</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="dataAnalytics" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <div class="feedback-form-group">
                            <div class="settings-switch-item">
                                <div class="switch-info">
                                    <strong>聊天记录保存</strong>
                                    <p>保存与AI导师的对话记录</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="saveChatHistory" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <div class="feedback-form-group">
                            <button id="exportDataBtn" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">
                                <i class="fas fa-download"></i> 导出我的数据
                            </button>
                            <button id="clearHistoryBtn" class="btn btn-secondary" style="width: 100%;">
                                <i class="fas fa-trash"></i> 清除所有聊天记录
                            </button>
                        </div>
                        <div class="feedback-form-group">
                            <button id="savePrivacyBtn" class="btn btn-primary" style="width: 100%;">保存隐私设置</button>
                        </div>
                        <div class="feedback-status" id="privacyStatus"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 反馈模态框 -->
        <div id="feedbackModal" class="feedback-modal">
            <div class="feedback-modal-content">
                <div class="feedback-modal-header" style="background: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%); color: white; padding: 24px 30px; border-radius: 12px 12px 0 0;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-comment-dots" style="font-size: 24px;"></i>
                        <h2 style="margin: 0; font-size: 1.4rem; font-weight: 600; color: white;">提交反馈</h2>
                    </div>
                    <button id="closeFeedbackBtn" class="close-feedback-btn" style="color: white; opacity: 0.9;">&times;</button>
                </div>
                <div class="feedback-modal-body" style="padding: 30px;">
                    <div class="feedback-form-group" style="margin-bottom: 24px;">
                        <label for="feedbackType" style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151; margin-bottom: 12px; font-size: 0.95rem;">
                            <i class="fas fa-list-ul" style="color: #48c6ef;"></i>
                            反馈类型
                        </label>
                        <div class="feedback-type-group" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 8px;">
                            <div class="feedback-type-option" data-type="suggestion" style="padding: 14px 20px; text-align: center; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; font-size: 0.9rem; background: white;" onmouseover="if(!this.classList.contains('selected')) {this.style.borderColor='#48c6ef'; this.style.background='#f0f9ff'}" onmouseout="if(!this.classList.contains('selected')) {this.style.borderColor='#e5e7eb'; this.style.background='white'}">
                                <i class="fas fa-lightbulb" style="margin-right: 6px; color: #fbbf24;"></i>
                                功能建议
                            </div>
                            <div class="feedback-type-option" data-type="bug" style="padding: 14px 20px; text-align: center; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; font-size: 0.9rem; background: white;" onmouseover="if(!this.classList.contains('selected')) {this.style.borderColor='#48c6ef'; this.style.background='#f0f9ff'}" onmouseout="if(!this.classList.contains('selected')) {this.style.borderColor='#e5e7eb'; this.style.background='white'}">
                                <i class="fas fa-bug" style="margin-right: 6px; color: #ef4444;"></i>
                                Bug 反馈
                            </div>
                            <div class="feedback-type-option" data-type="problem" style="padding: 14px 20px; text-align: center; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; font-size: 0.9rem; background: white;" onmouseover="if(!this.classList.contains('selected')) {this.style.borderColor='#48c6ef'; this.style.background='#f0f9ff'}" onmouseout="if(!this.classList.contains('selected')) {this.style.borderColor='#e5e7eb'; this.style.background='white'}">
                                <i class="fas fa-question-circle" style="margin-right: 6px; color: #3b82f6;"></i>
                                使用疑问
                            </div>
                            <div class="feedback-type-option" data-type="praise" style="padding: 14px 20px; text-align: center; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; font-size: 0.9rem; background: white;" onmouseover="if(!this.classList.contains('selected')) {this.style.borderColor='#48c6ef'; this.style.background='#f0f9ff'}" onmouseout="if(!this.classList.contains('selected')) {this.style.borderColor='#e5e7eb'; this.style.background='white'}">
                                <i class="fas fa-heart" style="margin-right: 6px; color: #ec4899;"></i>
                                好评
                            </div>
                            <div class="feedback-type-option" data-type="other" style="padding: 14px 20px; text-align: center; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; font-size: 0.9rem; background: white; grid-column: span 2;" onmouseover="if(!this.classList.contains('selected')) {this.style.borderColor='#48c6ef'; this.style.background='#f0f9ff'}" onmouseout="if(!this.classList.contains('selected')) {this.style.borderColor='#e5e7eb'; this.style.background='white'}">
                                <i class="fas fa-ellipsis-h" style="margin-right: 6px; color: #6b7280;"></i>
                                其他
                            </div>
                        </div>
                        <input type="hidden" id="feedbackType" value="">
                    </div>
                    <div class="feedback-form-group" style="margin-bottom: 20px;">
                        <label for="feedbackContent" style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 0.95rem;">
                            <i class="fas fa-edit" style="color: #48c6ef;"></i>
                            反馈内容
                        </label>
                        <textarea id="feedbackContent" class="feedback-textarea" 
                                  placeholder="请详细描述您的反馈..." 
                                  style="min-height: 140px; padding: 14px 16px; font-size: 0.95rem; border: 2px solid #e5e7eb; border-radius: 10px; transition: all 0.3s ease; resize: vertical; line-height: 1.6;"
                                  onfocus="this.style.borderColor='#48c6ef'; this.style.boxShadow='0 0 0 3px rgba(72, 198, 239, 0.1)'"
                                  onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"></textarea>
                    </div>
                    <div class="feedback-status" id="feedbackStatus"></div>
                </div>
                <div class="feedback-modal-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: #f9fafb; border-radius: 0 0 12px 12px; gap: 12px;">
                    <button id="cancelFeedbackBtn" class="btn btn-secondary" style="flex: 1; height: 48px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 500; font-size: 0.95rem; background: white; color: #6b7280; border: 2px solid #e5e7eb; transition: all 0.3s ease;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#d1d5db'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                        <i class="fas fa-times" style="margin-right: 8px;"></i>
                        取消
                    </button>
                    <button id="submitFeedbackBtn" class="btn btn-primary" style="flex: 1; height: 48px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 500; font-size: 0.95rem; background: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%); border: none; box-shadow: 0 4px 6px rgba(72, 198, 239, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(72, 198, 239, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(72, 198, 239, 0.3)'">
                        <i class="fas fa-paper-plane" style="margin-right: 8px;"></i>
                        提交
                    </button>
                </div>
            </div>
        </div>

        <!-- 主内容区（语义化改造：div→section） -->
        <section class="main-content">
            <!-- AI聊天容器 -->
            <article class="card chat-card chat-container" role="region" aria-label="AI导师聊天区域">
                <div class="card-header">
                    <div class="card-header-group">
                        <h2 class="card-title">与AI导师对话</h2>
                        <p class="card-subtitle">即时获取智能学习建议与知识点解析</p>
                    </div>
                    <div class="card-actions">
                        <button id="historyBtn" class="chip-button" title="查看历史聊天记录">历史记录</button>
                        <button id="fullscreenBtn" class="icon-button" title="全屏聊天模式">⛶</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai-message">
                            您好！我是您的AI学习导师，请问有什么学术问题需要帮助吗？
                        </div>
                    </div>
                    <div class="loading" id="loadingIndicator" aria-live="polite">思考中</div>
                    <!-- 功能按钮区 -->
                    <nav class="chat-toolbar" aria-label="聊天功能快捷操作">
                        <button id="translateBtn" class="toolbar-btn">
                            <span>📝</span>
                            <span>翻译</span>
                        </button>
                        <button id="noteBtn" class="toolbar-btn">
                            <span>📓</span>
                            <span>笔记</span>
                        </button>
                        <button id="navigateBtn" class="toolbar-btn">
                            <span>🚀</span>
                            <span>单词学习</span>
                        </button>
                        <button id="memoryBtn" class="toolbar-btn">
                            <span>🧠</span>
                            <span>单词记忆</span>
                        </button>
                    </nav>
                    
                    <div class="chat-input">
                        <textarea
                            id="questionInput"
                            placeholder="请输入您的学习问题..."
                            autocomplete="off"
                            rows="3"
                        ></textarea>
                        <div class="chat-input-controls">
                            <button id="stopAnswerButton" class="stop-answer-btn" type="button">停止回答</button>
                            <button id="askButton" class="chat-submit-btn" type="button">提问</button>
                        </div>
                    </div>
                    <div class="status-bar">
                        <span>系统状态: <span class="ipv6-badge">IPv6环境就绪</span></span>
                        <div class="status-controls">
                            <div class="model-selector-container" id="depthSelectordiv">
                                <label for="depthSelector">深度思考:</label>
                                <select id="depthSelector" class="model-selector">
                                    <option value="is_deep">是</option>
                                    <option value="not_depp">否</option>
                                </select>
                                <span class="model-selector-arrow" aria-hidden="true">▼</span>
                            </div>
                            <div class="model-selector-container">
                                <label for="modelSelector">AI模型:</label>
                                <select id="modelSelector" class="model-selector">
                                    <option value="deepseek">DeepSeek</option>
                                    <option value="doubao">豆包（自动判断深度思考）</option>
                                </select>
                                <span class="model-selector-arrow" aria-hidden="true">▼</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 翻译模态框 -->
                <div id="translateModal" class="feedback-modal">
                    <div class="feedback-modal-content modal-lg">
                        <div class="feedback-modal-header">
                            <h2>文本翻译</h2>
                            <button id="closeTranslateBtn" class="close-feedback-btn">&times;</button>
                        </div>
                        <div class="feedback-modal-body">
                            <div class="feedback-form-group">
                                <label for="sourceText">原文</label>
                                <textarea id="sourceText" class="feedback-textarea" placeholder="请输入要翻译的文本..." rows="6"></textarea>
                            </div>
                            <div class="feedback-form-group">
                                <label for="targetLanguage">目标语言</label>
                                <select id="targetLanguage" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                                    <option value="en">英语</option>
                                    <option value="zh">中文</option>
                                    <option value="ja">日语</option>
                                    <option value="ko">韩语</option>
                                    <option value="fr">法语</option>
                                    <option value="de">德语</option>
                                    <option value="es">西班牙语</option>
                                    <option value="ru">俄语</option>
                                </select>
                            </div>
                            <div class="feedback-form-group">
                                <label for="translatedText">翻译结果</label>
                                <textarea id="translatedText" class="feedback-textarea" placeholder="翻译结果将显示在这里..." rows="6" readonly></textarea>
                                <button id="copyTranslateBtn" class="ghost-button">
                                    复制结果
                                </button>
                            </div>
                            <div class="feedback-status" id="translateStatus"></div>
                        </div>
                        <div class="feedback-modal-footer modal-footer-actions">
                            <button id="cancelTranslateBtn" class="btn btn-secondary modal-action">取消</button>
                            <button id="translateTextBtn" class="btn btn-primary modal-action">翻译</button>
                        </div>
                    </div>
                </div>
                
                <!-- 笔记模态框 -->
                <div id="noteModal" class="feedback-modal">
                    <div class="feedback-modal-content modal-xl">
                        <div class="feedback-modal-header">
                            <h2>我的笔记</h2>
                            <button id="closeNoteBtn" class="close-feedback-btn">&times;</button>
                        </div>
                        <div class="feedback-modal-body">
                            <div class="feedback-form-group">
                                <label for="noteTitle">笔记标题</label>
                                <input type="text" id="noteTitle" class="feedback-textarea" placeholder="请输入笔记标题" style="height: 40px; min-height: auto;">
                            </div>
                            <div class="feedback-form-group">
                                <label for="noteContent">笔记内容</label>
                                <textarea id="noteContent" class="feedback-textarea" placeholder="请输入笔记内容..." rows="8"></textarea>
                            </div>
                            <div class="feedback-form-group">
                                <label>我的笔记列表</label>
                                <div id="noteList" class="note-list">
                                    <!-- 笔记列表将动态生成 -->
                                    <p>暂无笔记</p>
                                </div>
                            </div>
                            <div class="feedback-status" id="noteStatus"></div>
                        </div>
                        <div class="feedback-modal-footer modal-footer-actions">
                            <button id="deleteNoteBtn" class="btn btn-danger" style="display: none;">删除</button>
                            <div class="button-row">
                                <button id="cancelNoteBtn" class="btn btn-secondary">取消</button>
                                <button id="saveNoteBtn" class="btn btn-primary">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            </article>
            <!-- 学习资源容器 -->
            <article class="card resources-card resources-container" role="region" aria-label="学习资源库">
                <div class="card-header">
                    <div class="card-header-group">
                        <h2 class="card-title">资源库</h2>
                        <p class="card-subtitle">IPv6课程与实践资料实时更新</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="resources-list" id="resourcesList">
                        <!-- 资源将通过JavaScript动态加载 -->
                    </div>
                    <div class="status-bar">
                        <span>资源总数: <span id="resourceCount">0</span></span>
                        <span>实时更新</span>
                    </div>
                </div>
            </article>
        </section>

        <!-- 页脚 -->
        <footer>
            <p>© 2025 AI 智能学习导师系统</p>
        </footer>
    </main>
    <script>
        // ---------------------- 全局DOM元素获取 ----------------------
        // 1. 认证相关元素

        //const updateResources = document.getElementById('updateResources');
        const historyBtn = document.getElementById('historyBtn');
        const historySidebar = document.getElementById('historySidebar');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const historyList = document.getElementById('historyList');
        let chatHistory = []; // 存储聊天记录的数组
        let currentSessionId = null; // 当前会话ID
        let chatSessions = {}; // 按会话ID组织的聊天记录 {sessionId: {title, messages}}
        let sign_1 = 1;
        const authModal = document.getElementById('authModal');
        const authTabs = document.querySelectorAll('.auth-tab');
        const authForms = document.querySelectorAll('.auth-form');
        const switchLinks = document.querySelectorAll('[data-switch]');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const forgotForm = document.getElementById('forgotForm');
        const userInfo = document.getElementById('userInfo');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const logoutBtn = document.getElementById('logoutBtn');

        // 2. 找回密码（验证码版）新增元素
        const forgotEmail = document.getElementById('forgotEmail');
        const forgotVerifyCode = document.getElementById('forgotVerifyCode');
        const getVerifyCodeBtn = document.getElementById('getVerifyCodeBtn');
        const forgotNewPassword = document.getElementById('forgotNewPassword');
        const forgotConfirmPassword = document.getElementById('forgotConfirmPassword');
        const forgotEmailError = document.getElementById('forgotEmailError');
        const forgotVerifyCodeError = document.getElementById('forgotVerifyCodeError');
        const forgotNewPasswordError = document.getElementById('forgotNewPasswordError');
        const forgotConfirmPasswordError = document.getElementById('forgotConfirmPasswordError');
        const forgotFormError = document.getElementById('forgotFormError');
        const forgotFormSuccess = document.getElementById('forgotFormSuccess');

        // 3. 原有功能元素（聊天+资源）
        const chatMessages = document.getElementById('chatMessages');
        const questionInput = document.getElementById('questionInput');
        const askButton = document.getElementById('askButton');
        const resourcesList = document.getElementById('resourcesList');
        const resourceCount = document.getElementById('resourceCount');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const toggleResources = document.getElementById('toggleResources');
        const resourcesContainer = document.querySelector('.resources-container');
        const mainContent = document.querySelector('.main-content');
        const stopAnswerButton = document.getElementById('stopAnswerButton');
        const fullscreenStopButton = document.getElementById('fullscreenStopButton');
        
        let answerStreamAbortController = null;
        let streamingMessageContentEl = null;
        let streamingMessageContainerEl = null;
        let isFullscreenOpen = false; // 全屏模式状态标志，需要在全局作用域以便 askQuestion 函数访问
        
        // 更新全屏聊天区域的消息（全局函数，供 askQuestion 调用）
        // 使用增量更新策略避免闪烁
        function updateFullscreenMessages(forceRebuild = false) {
            const fullscreenChatMessages = document.getElementById('fullscreenChatMessages');
            const chatMessages = document.getElementById('chatMessages');
            
            if (!fullscreenChatMessages) {
                console.error('fullscreenChatMessages 元素不存在');
                return;
            }
            if (!chatMessages) {
                console.error('chatMessages 元素不存在');
                return;
            }
            
            console.log('开始更新全屏消息');
            
            // 复制原始聊天区域的所有消息容器（包括完整的消息结构）
            const allMessageContainers = chatMessages.querySelectorAll('.message-container');
            console.log('找到消息容器数量:', allMessageContainers.length);
            
            // 如果需要强制重建，清空并重建所有消息
            if (forceRebuild) {
                console.log('强制重建全屏消息');
                fullscreenChatMessages.innerHTML = '';
                
                // 如果没有消息容器，尝试查找.message元素（兼容旧格式）
                if (allMessageContainers.length === 0) {
                    const allMessages = chatMessages.querySelectorAll('.message');
                    console.log('找到消息数量（旧格式）:', allMessages.length);
                    allMessages.forEach(message => {
                        const clonedMessage = message.cloneNode(true);
                        fullscreenChatMessages.appendChild(clonedMessage);
                    });
                    return;
                }
                
                // 重建所有消息容器
                allMessageContainers.forEach((container, index) => {
                    const clonedContainer = container.cloneNode(true);
                    
                    // 移除可能存在的旧按钮
                    const oldButtons = clonedContainer.querySelectorAll('.copy-button, .favorite-button');
                    oldButtons.forEach(btn => btn.remove());
                    
                    // 获取消息文本用于复制
                    const messageEl = clonedContainer.querySelector('.message');
                    const originalText = messageEl?.dataset?.originalText || messageEl?.textContent || '';
                    
                    // 为每个消息添加复制按钮
                    if (messageEl) {
                        const copyButton = document.createElement('button');
                        copyButton.className = 'copy-button';
                        copyButton.innerHTML = '📋 复制';
                        copyButton.onclick = function(e) {
                            e.stopPropagation();
                            
                            // 使用存储的原始文本或获取文本内容
                            const textToCopy = originalText || Array.from(messageEl.querySelectorAll('*'))
                                .map(el => el.textContent)
                                .join(' ')
                                .trim() || messageEl.textContent.trim();
                            
                            // 复制到剪贴板
                            navigator.clipboard.writeText(textToCopy).then(() => {
                                // 创建或更新复制成功提示
                                let tooltip = clonedContainer.querySelector('.copy-tooltip');
                                if (!tooltip) {
                                    tooltip = document.createElement('div');
                                    tooltip.className = 'copy-tooltip';
                                    tooltip.innerHTML = '✅ 已复制到剪贴板';
                                    clonedContainer.appendChild(tooltip);
                                } else {
                                    tooltip.innerHTML = '✅ 已复制到剪贴板';
                                }
                                
                                // 显示复制成功状态
                                copyButton.classList.add('copied');
                                copyButton.innerHTML = '✅ 已复制';
                                copyButton.style.backgroundColor = '#10b981';
                                
                                // 添加按钮动画
                                copyButton.style.transform = 'scale(0.95)';
                                setTimeout(() => {
                                    copyButton.style.transform = 'scale(1)';
                                }, 100);
                                
                                // 2秒后恢复
                                setTimeout(() => {
                                    copyButton.classList.remove('copied');
                                    copyButton.innerHTML = '📋 复制';
                                    copyButton.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                                    if (tooltip) {
                                        tooltip.style.opacity = '0';
                                        tooltip.style.transform = 'translateY(10px)';
                                        setTimeout(() => tooltip.remove(), 300);
                                    }
                                }, 2000);
                            }).catch(err => {
                                console.error('复制失败:', err);
                                // 复制失败时的反馈
                                copyButton.innerHTML = '❌ 复制失败';
                                copyButton.style.backgroundColor = '#ef4444';
                                setTimeout(() => {
                                    copyButton.innerHTML = '📋 复制';
                                    copyButton.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                                }, 2000);
                            });
                        };
                        
                        messageEl.appendChild(copyButton);
                    }
                    
                    fullscreenChatMessages.appendChild(clonedContainer);
                });
                
                console.log('全屏消息重建完成，消息数量:', fullscreenChatMessages.children.length);
                return;
            }
            
            // 获取现有的全屏消息容器（用于增量更新）
            const existingContainers = fullscreenChatMessages.querySelectorAll('.message-container');
            
            // 如果没有消息容器，什么都不做
            if (allMessageContainers.length === 0) {
                console.log('没有消息容器');
                return;
            }
            
            // 增量更新：只处理新增或修改的消息
            // 为每个消息容器添加唯一标识（基于索引）
            allMessageContainers.forEach((container, index) => {
                // 检查对应索引的全屏消息是否存在
                const existingContainer = existingContainers[index];
                
                if (existingContainer) {
                    // 消息已存在，检查内容是否有变化（针对流式输出）
                    const sourceMessageEl = container.querySelector('.message');
                    const existingMessageEl = existingContainer.querySelector('.message');
                    
                    // 快速检查：对于流式消息，直接更新innerHTML（性能优化）
                    if (existingMessageEl && sourceMessageEl && container.classList.contains('streaming')) {
                        // 流式消息直接更新，不做内容比较（减少字符串比较开销）
                        existingMessageEl.innerHTML = sourceMessageEl.innerHTML;
                    } else if (existingMessageEl && sourceMessageEl) {
                        // 非流式消息才做内容比较
                        const sourceContent = sourceMessageEl.innerHTML;
                        const existingContent = existingMessageEl.innerHTML;
                        if (sourceContent !== existingContent) {
                            existingMessageEl.innerHTML = sourceContent;
                        }
                    }
                } else {
                    // 新消息，需要添加
                    const clonedContainer = container.cloneNode(true);
                    
                    // 移除可能存在的旧按钮
                    const oldButtons = clonedContainer.querySelectorAll('.copy-button, .favorite-button');
                    oldButtons.forEach(btn => btn.remove());
                    
                    // 获取消息文本用于复制
                    const messageEl = clonedContainer.querySelector('.message');
                    const originalText = messageEl?.dataset?.originalText || messageEl?.textContent || '';
                    
                    // 为每个消息添加复制按钮
                    if (messageEl) {
                        const copyButton = document.createElement('button');
                        copyButton.className = 'copy-button';
                        copyButton.innerHTML = '📋 复制';
                        copyButton.onclick = function(e) {
                            e.stopPropagation();
                            
                            // 使用存储的原始文本或获取文本内容
                            const textToCopy = originalText || Array.from(messageEl.querySelectorAll('*'))
                                .map(el => el.textContent)
                                .join(' ')
                                .trim() || messageEl.textContent.trim();
                            
                            // 复制到剪贴板
                            navigator.clipboard.writeText(textToCopy).then(() => {
                                // 创建或更新复制成功提示
                                let tooltip = clonedContainer.querySelector('.copy-tooltip');
                                if (!tooltip) {
                                    tooltip = document.createElement('div');
                                    tooltip.className = 'copy-tooltip';
                                    tooltip.innerHTML = '✅ 已复制到剪贴板';
                                    clonedContainer.appendChild(tooltip);
                                } else {
                                    tooltip.innerHTML = '✅ 已复制到剪贴板';
                                }
                                
                                // 显示复制成功状态
                                copyButton.classList.add('copied');
                                copyButton.innerHTML = '✅ 已复制';
                                copyButton.style.backgroundColor = '#10b981';
                                
                                // 添加按钮动画
                                copyButton.style.transform = 'scale(0.95)';
                                setTimeout(() => {
                                    copyButton.style.transform = 'scale(1)';
                                }, 100);
                                
                                // 2秒后恢复
                                setTimeout(() => {
                                    copyButton.classList.remove('copied');
                                    copyButton.innerHTML = '📋 复制';
                                    copyButton.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                                    if (tooltip) {
                                        tooltip.style.opacity = '0';
                                        tooltip.style.transform = 'translateY(10px)';
                                        setTimeout(() => tooltip.remove(), 300);
                                    }
                                }, 2000);
                            }).catch(err => {
                                console.error('复制失败:', err);
                                // 复制失败时的反馈
                                copyButton.innerHTML = '❌ 复制失败';
                                copyButton.style.backgroundColor = '#ef4444';
                                setTimeout(() => {
                                    copyButton.innerHTML = '📋 复制';
                                    copyButton.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                                }, 2000);
                            });
                        };
                        
                        messageEl.appendChild(copyButton);
                    }
                    
                    fullscreenChatMessages.appendChild(clonedContainer);
                }
            });
            
            // 删除多余的消息（如果源消息少于全屏消息）
            while (existingContainers.length > allMessageContainers.length) {
                const lastContainer = fullscreenChatMessages.lastElementChild;
                if (lastContainer && lastContainer.classList.contains('message-container')) {
                    lastContainer.remove();
                } else {
                    break;
                }
            }
            
            console.log('全屏消息更新完成，消息数量:', fullscreenChatMessages.children.length);
        }
        
        function showStopButtons() {
            [stopAnswerButton, fullscreenStopButton].forEach(btn => {
                if (!btn) return;
                btn.style.display = 'inline-flex';
                btn.disabled = false;
                btn.textContent = '停止回答';
            });
        }
        
        function disableStopButtonsDuringAbort() {
            [stopAnswerButton, fullscreenStopButton].forEach(btn => {
                if (!btn) return;
                btn.disabled = true;
                btn.textContent = '停止中...';
            });
        }
        
        function hideStopButtons() {
            [stopAnswerButton, fullscreenStopButton].forEach(btn => {
                if (!btn) return;
                btn.style.display = 'none';
                btn.disabled = true;
                btn.textContent = '停止回答';
            });
        }
        function handleStopAnswerClick() {
            if (answerStreamAbortController) {
                disableStopButtonsDuringAbort();
                answerStreamAbortController.abort();
            }
        }
        
        if (stopAnswerButton) {
            stopAnswerButton.addEventListener('click', handleStopAnswerClick);
        }
        if (fullscreenStopButton) {
            fullscreenStopButton.addEventListener('click', handleStopAnswerClick);
        }
        
        // 4. 翻译和笔记功能元素
        // 翻译功能
        const translateBtn = document.getElementById('translateBtn');
        const translateModal = document.getElementById('translateModal');
        const closeTranslateBtn = document.getElementById('closeTranslateBtn');
        const cancelTranslateBtn = document.getElementById('cancelTranslateBtn');
        const sourceText = document.getElementById('sourceText');
        const targetLanguage = document.getElementById('targetLanguage');
        const translatedText = document.getElementById('translatedText');
        const translateTextBtn = document.getElementById('translateTextBtn');
        const copyTranslateBtn = document.getElementById('copyTranslateBtn');
        const translateStatus = document.getElementById('translateStatus');
        
        // 笔记功能
        const noteBtn = document.getElementById('noteBtn');
        const noteModal = document.getElementById('noteModal');
        const closeNoteBtn = document.getElementById('closeNoteBtn');
        const cancelNoteBtn = document.getElementById('cancelNoteBtn');
        const noteTitle = document.getElementById('noteTitle');
        const noteContent = document.getElementById('noteContent');
        const noteList = document.getElementById('noteList');
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        const deleteNoteBtn = document.getElementById('deleteNoteBtn');
        const noteStatus = document.getElementById('noteStatus');
        let currentNoteId = null; // 当前选中的笔记ID
        
        function updateResourcesLayout(isVisible) {
            if (resourcesContainer) {
                resourcesContainer.style.display = isVisible ? '' : 'none';
            }
            if (mainContent) {
                mainContent.classList.toggle('resources-hidden', !isVisible);
            }
        }

        // 初始化资源库显示状态
        function initResourcesVisibility() {
            const savedVisibility = localStorage.getItem('showResources');
            const isVisible = savedVisibility !== 'false';

            updateResourcesLayout(isVisible);

            if (!toggleResources) {
                return;
            }

            toggleResources.checked = isVisible;

            toggleResources.addEventListener('change', function() {
                const newVisibility = this.checked;
                updateResourcesLayout(newVisibility);
                localStorage.setItem('showResources', newVisibility.toString());
            });
        }
        
        // 资源库显示/隐藏功能已集成到initResourcesVisibility函数中
        const depthSelector = document.getElementById('depthSelector');
        const modelSelector = document.getElementById('modelSelector');
        const depthSelectordiv = document.getElementById('depthSelectordiv');
        const createVerifyCode =document.getElementById('createVerifyCode');
        const getVerifyCodeBtn_create = document.getElementById('getVerifyCodeBtn_create')


        // 隐藏元素（完全消失，不占空间）
        //depthSelectordiv.style.display = 'none';
        // ---------------------- 全局配置与变量 ----------------------
        // 使用当前页面域名作为API基础地址，便于部署到云服务器
const API_BASE_URL = `${window.location.origin}`;
let currentUser = null; // 缓存当前用户信息，避免依赖浏览器本地存储
let countdownTimer = null; // 验证码倒计时定时器（全局作用域，避免切换表单残留）
        const COUNTDOWN_SECONDS = 60; // 验证码重新获取倒计时（秒）
        
        // 全局变量和函数定义
        let userCustomModels = []; // 用户自定义模型列表
        
        // 全局函数：删除自定义模型
        async function deleteCustomModel(modelId) {
            if (!confirm('确定要删除这个模型吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/custom-models/${modelId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && (result.status === 'success' || result.message)) {
                    alert('✅ 模型删除成功！');
                    if (typeof loadUserCustomModels === 'function') {
                        await loadUserCustomModels();
                    }
                } else {
                    alert('❌ 删除失败\n\n' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('删除模型失败:', error);
                alert('❌ 删除失败\n\n' + error.message);
            }
        }
        
        // 全局函数：使用模型
        function useModel(modelId) {
            const model = userCustomModels.find(m => m.id === modelId);
            if (model) {
                // 更新聊天界面的模型选择器
                const modelSelector = document.getElementById('modelSelector');
                if (modelSelector) {
                    modelSelector.value = `custom_${modelId}`;
                }
                alert(`已切换到模型: ${model.display_name || model.model_name}`);
            }
        }
        
        // 全局函数：加载用户自定义模型
        async function loadUserCustomModels() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/custom-models`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && (data.status === 'success' || data.data)) {
                    // 支持两种响应格式：data.data 或 data.models
                    userCustomModels = data.data || data.models || [];
                    if (typeof displayCustomModels === 'function') {
                        displayCustomModels();
                    }
                    if (typeof updateModelSelector === 'function') {
                        updateModelSelector();
                    }
                } else {
                    console.warn('加载自定义模型失败:', data);
                }
            } catch (error) {
                console.error('加载自定义模型失败:', error);
            }
        }
        
        // 全局函数：显示自定义模型列表
        function displayCustomModels() {
            const container = document.getElementById('addedModels');
            if (!container) return;
            
            if (userCustomModels.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 24px; color: #9ca3af; font-size: 0.9rem;">暂无添加的模型，请先在上方添加自定义 AI 模型</div>';
                return;
            }
            
            container.innerHTML = userCustomModels.map(model => `
                <div style="padding: 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #93c5fd; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #0c4a6e; font-size: 0.95rem; margin-bottom: 4px;">
                            <i class="fas fa-brain" style="margin-right: 6px; color: #4facfe;"></i>
                            ${model.model_display_name || model.display_name || model.model_name}
                        </div>
                        <div style="font-size: 0.85rem; color: #075985;">
                            ${model.api_base_url || model.api_base || 'N/A'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="testCustomModel(${model.id})" style="padding: 8px 16px; background: white; border: 1px solid #10b981; color: #059669; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;" onmouseover="this.style.background='#f0fdf4'" onmouseout="this.style.background='white'">
                            <i class="fas fa-plug"></i> 测试
                        </button>
                        <button onclick="useModel(${model.id})" style="padding: 8px 16px; background: white; border: 1px solid #4facfe; color: #0284c7; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                            <i class="fas fa-check"></i> 使用
                        </button>
                        <button onclick="deleteCustomModel(${model.id})" style="padding: 8px 16px; background: white; border: 1px solid #ef4444; color: #dc2626; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='white'">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // 全局函数：更新模型选择器
        function updateModelSelector() {
            const modelSelector = document.getElementById('modelSelector');
            if (!modelSelector) return;
            
            // 移除之前添加的自定义模型选项
            const options = Array.from(modelSelector.options);
            options.forEach(option => {
                if (option.value.startsWith('custom_')) {
                    option.remove();
                }
            });
            
            // 添加用户自定义模型
            userCustomModels.forEach(model => {
                const option = document.createElement('option');
                option.value = `custom_${model.id}`;
                option.textContent = `${model.model_display_name || model.display_name || model.model_name} (自定义)`;
                modelSelector.appendChild(option);
            });
        }

        // ---------------------- 页面初始化入口 ----------------------
        // 页面初始化：DOM加载完毕后执行
        document.addEventListener('DOMContentLoaded', async function() {
            // 调用主初始化函数
            await init();
        });
        // 翻译功能实现
        function initTranslateFeature() {
            // 打开翻译模态框
            translateBtn.addEventListener('click', () => {
                // 如果聊天输入框有内容，自动填入原文
                if (questionInput.value.trim()) {
                    sourceText.value = questionInput.value;
                }
                translateModal.style.display = 'flex';
                translateStatus.textContent = '';
                translateStatus.className = 'feedback-status';
            });
            
            // 关闭翻译模态框
            function closeTranslateModal() {
                translateModal.style.display = 'none';
                sourceText.value = '';
                translatedText.value = '';
                translateStatus.textContent = '';
            }
            
            closeTranslateBtn.addEventListener('click', closeTranslateModal);
            cancelTranslateBtn.addEventListener('click', closeTranslateModal);
            
            // 翻译文本
            translateTextBtn.addEventListener('click', async () => {
                const text = sourceText.value.trim();
                if (!text) {
                    translateStatus.textContent = '请输入要翻译的文本';
                    translateStatus.className = 'feedback-status error';
                    return;
                }
                
                translateStatus.textContent = '翻译中...';
                translateStatus.className = 'feedback-status success';
                
                try {
                    // 获取目标语言名称
                    const langSelect = targetLanguage;
                    const langName = langSelect.options[langSelect.selectedIndex].text;
                    
                    // 构造翻译提示词
                    const translatePrompt = `请将下面的文本翻译成${langName}，保持原文的意思和语气：\n\n${text}`;
                    
                    // 调用后端AI模型API进行翻译
                    const response = await fetch(`${API_BASE_URL}/api/ask/translate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`
                        },
                        body: JSON.stringify({
                            question: translatePrompt,
                            session_id: 'translate_session_' + Date.now()
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('翻译请求失败');
                    }
                    
                    const data = await response.json();
                    
                    // 提取翻译结果（去除翻译提示词部分）
                    let translation = data.content || '翻译失败：无法获取翻译结果';
                    
                    // 清理翻译结果，移除可能的多余说明
                    if (translation.includes('翻译结果')) {
                        translation = translation.split('翻译结果')[1].trim();
                    }
                    
                    translatedText.value = translation;
                    translateStatus.textContent = '翻译完成';
                    translateStatus.className = 'feedback-status success';
                } catch (error) {
                    console.error('翻译错误:', error);
                    translateStatus.textContent = '翻译失败：请稍后重试';
                    translateStatus.className = 'feedback-status error';
                }
            });
            // 复制翻译结果
            copyTranslateBtn.addEventListener('click', () => {
                if (translatedText.value) {
                    translatedText.select();
                    document.execCommand('copy');
                    
                    // 显示复制成功提示
                    const originalText = copyTranslateBtn.textContent;
                    copyTranslateBtn.textContent = '已复制！';
                    setTimeout(() => {
                        copyTranslateBtn.textContent = originalText;
                    }, 2000);
                }
            });
            
            // 简化版回译功能 - 直接在翻译结果框下方添加回译按钮
            // 当用户在翻译结果框中右击时显示回译选项
            translatedText.addEventListener('contextmenu', function(e) {
                e.preventDefault(); // 阻止默认右键菜单
                
                const selectedText = window.getSelection().toString().trim();
                if (selectedText) {
                    // 检查是否已经有回译菜单，如果有则移除
                    const existingMenu = document.getElementById('backTranslateMenu');
                    if (existingMenu) {
                        existingMenu.remove();
                    }
                    
                    // 创建简单的回译菜单
                    const menu = document.createElement('div');
                    menu.id = 'backTranslateMenu';
                    menu.style.cssText = `
                        position: fixed;
                        background: white;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        padding: 4px 0;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                        z-index: 10000;
                        min-width: 80px;
                    `;
                    menu.style.left = e.clientX + 'px';
                    menu.style.top = e.clientY + 'px';
                    
                    // 添加回译选项
                    const backTranslateOption = document.createElement('div');
                    backTranslateOption.textContent = '回译选中部分';
                    backTranslateOption.style.cssText = `
                        padding: 6px 12px;
                        cursor: pointer;
                        font-size: 14px;
                    `;
                    backTranslateOption.onmouseover = function() {
                        this.style.backgroundColor = '#f5f5f5';
                    };
                    backTranslateOption.onmouseout = function() {
                        this.style.backgroundColor = '';
                    };
                    backTranslateOption.onclick = function() {
                        handleBackTranslation(selectedText);
                        menu.remove();
                    };
                    
                    menu.appendChild(backTranslateOption);
                    document.body.appendChild(menu);
                    
                    // 点击其他地方关闭菜单
                    setTimeout(() => {
                        document.addEventListener('click', function closeMenu(e) {
                            if (!menu.contains(e.target)) {
                                menu.remove();
                                document.removeEventListener('click', closeMenu);
                            }
                        });
                    }, 0);
                }
            });
            
            // 回译功能处理函数
            function handleBackTranslation(selectedText) {
                console.log('执行回译，选中文本:', selectedText);
                
                // 获取当前目标语言并切换
                const currentLang = targetLanguage.value;
                let newLang;
                
                // 简单的语言切换逻辑
                if (currentLang === 'zh') {
                    newLang = 'en';
                } else if (currentLang === 'en') {
                    newLang = 'zh';
                } else {
                    // 检测文本是否包含中文
                    const hasChinese = /[\u4e00-\u9fa5]/.test(selectedText);
                    newLang = hasChinese ? 'en' : 'zh';
                }
                
                // 更新UI状态
                targetLanguage.value = newLang;
                sourceText.value = selectedText;
                translatedText.value = '';
                translateStatus.textContent = '翻译中...';
                translateStatus.style.color = '#4a90e2';
                
                // 调用翻译API
                fetch(`${API_BASE_URL}/api/ask/translate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`
                    },
                    body: JSON.stringify({
                        text: selectedText,
                        target_language: newLang
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('翻译结果:', data);
                    translatedText.value = data.translated_text || '翻译失败';
                    translateStatus.textContent = '翻译完成';
                    translateStatus.style.color = '#52c41a';
                })
                .catch(error => {
                    console.error('翻译错误:', error);
                    translateStatus.textContent = '翻译失败';
                    translateStatus.style.color = '#ff4d4f';
                });
            }
        }
        // 笔记功能实现
        function initNoteFeature() {
            // 加载笔记列表
            async function loadNotes() {
                noteStatus.textContent = '加载中...';
                noteStatus.style.color = 'var(--primary-color)';
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/notes/list`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('加载笔记失败');
                    }
                    
                    const data = await response.json();
                    const notes = data.notes || [];
                    
                    if (notes.length === 0) {
                        noteList.innerHTML = '<p style="color: #999; text-align: center;">暂无笔记</p>';
                        return;
                    }
                    
                    noteList.innerHTML = '';
                    notes.forEach(note => {
                        const noteItem = document.createElement('div');
                        noteItem.className = 'note-item';
                        noteItem.style = 'padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;';
                        noteItem.setAttribute('data-id', note.id);
                        noteItem.setAttribute('data-name', note.title);
                        
                        const noteTitleSpan = document.createElement('span');
                        noteTitleSpan.textContent = note.title || '未命名笔记';
                        noteTitleSpan.style = 'font-weight: 500; flex: 1;';
                        
                        const noteDateSpan = document.createElement('span');
                        noteDateSpan.textContent = new Date(note.created_at).toLocaleString();
                        noteDateSpan.style = 'font-size: 0.8rem; color: #999; margin-left: 10px;';
                        
                        noteItem.appendChild(noteTitleSpan);
                        noteItem.appendChild(noteDateSpan);
                        noteList.appendChild(noteItem);
                        
                        // 点击笔记项
                        noteItem.addEventListener('click', () => {
                            selectNote(note.id, note.title);
                        });
                    });
                } catch (error) {
                    console.error('加载笔记错误:', error);
                    noteList.innerHTML = '<p style="color: #999; text-align: center;">加载笔记失败</p>';
                } finally {
                    noteStatus.textContent = '';
                }
            }
            
            // 选择并加载笔记内容
            async function selectNote(noteId, title) {
                currentNoteId = noteId;
                noteTitle.value = title || '未命名笔记';
                deleteNoteBtn.style.display = 'inline-block';
                
                // 高亮选中的笔记项
                const allNoteItems = document.querySelectorAll('.note-item');
                allNoteItems.forEach(item => {
                    if (item.getAttribute('data-id') === noteId.toString()) {
                        item.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
                    } else {
                        item.style.backgroundColor = 'transparent';
                    }
                });
                
                // 加载笔记内容
                try {
                    const response = await fetch(`${API_BASE_URL}/api/notes/${noteId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('加载笔记内容失败');
                    }
                    
                    const note = await response.json();
                    noteContent.value = note.content || '';
                } catch (error) {
                    console.error('加载笔记内容错误:', error);
                    noteContent.value = '无法加载笔记内容';
                }
            }
            
            // 保存笔记
            async function saveNote() {
                const title = noteTitle.value.trim() || '未命名笔记';
                const content = noteContent.value.trim();
                
                if (!content) {
                    noteStatus.textContent = '请输入笔记内容';
                    noteStatus.style.color = 'var(--accent-color)';
                    return;
                }
                
                noteStatus.textContent = '保存中...';
                noteStatus.style.color = 'var(--primary-color)';
                
                try {
                    const noteData = {
                        id: currentNoteId || null,
                        title: title,
                        content: content
                    };
                    
                    // 调用后端API保存笔记
                    const response = await fetch(`${API_BASE_URL}/api/notes/save`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(noteData)
                    });
                    
                    if (!response.ok) {
                        throw new Error('保存笔记失败');
                    }
                    
                    await response.json();
                    noteStatus.textContent = '保存成功';
                    noteStatus.style.color = 'var(--success-color)';
                    
                    // 重新加载笔记列表
                    await loadNotes();
                    
                    // 重置表单
                    resetNoteForm();
                    
                    // 清除提示信息
                    setTimeout(() => {
                        noteStatus.textContent = '';
                    }, 2000);
                } catch (error) {
                    console.error('保存笔记错误:', error);
                    noteStatus.textContent = '保存失败：请稍后重试';
                    noteStatus.style.color = 'var(--accent-color)';
                }
            }
            
            // 删除笔记
            async function deleteNote() {
                if (currentNoteId && confirm('确定要删除这条笔记吗？')) {
                    noteStatus.textContent = '删除中...';
                    noteStatus.style.color = 'var(--primary-color)';
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/notes/${currentNoteId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error('删除笔记失败');
                        }
                        
                        // 重置表单
                        resetNoteForm();
                        
                        // 重新加载笔记列表
                        await loadNotes();
                        
                        noteStatus.textContent = '删除成功';
                        noteStatus.style.color = 'var(--success-color)';
                    } catch (error) {
                        noteStatus.textContent = '删除失败：请稍后重试';
                        noteStatus.style.color = 'var(--accent-color)';
                    } finally {
                        setTimeout(() => {
                            noteStatus.textContent = '';
                        }, 2000);
                    }
                }
            }
            
            // 重置笔记表单
            function resetNoteForm() {
                noteTitle.value = '';
                noteContent.value = '';
                currentNoteId = null;
                deleteNoteBtn.style.display = 'none';
                
                // 清除所有笔记项的高亮
                const allNoteItems = document.querySelectorAll('.note-item');
                allNoteItems.forEach(item => {
                    item.style.backgroundColor = 'transparent';
                });
            }
            
            // 打开笔记模态框
            noteBtn.addEventListener('click', () => {
                noteModal.style.display = 'flex';
                noteStatus.textContent = '';
                resetNoteForm();
                loadNotes();
            });
            
            // 关闭笔记模态框
            function closeNoteModal() {
                noteModal.style.display = 'none';
                resetNoteForm();
            }
            closeNoteBtn.addEventListener('click', closeNoteModal);
            cancelNoteBtn.addEventListener('click', closeNoteModal);
            
            // 保存笔记
            saveNoteBtn.addEventListener('click', saveNote);
            
            // 删除笔记
            deleteNoteBtn.addEventListener('click', deleteNote);
        }
        
        // ---------------------- 初始化参数tooltip ----------------------
        function initParamTooltips() {
            let tooltipElement = null;
            let hideTimeout = null;

            // 创建tooltip元素
            function createTooltip() {
                if (!tooltipElement) {
                    tooltipElement = document.createElement('div');
                    tooltipElement.className = 'param-tooltip';
                    document.body.appendChild(tooltipElement);
                }
                return tooltipElement;
            }

            // 显示tooltip
            function showTooltip(element, text) {
                const tooltip = createTooltip();
                tooltip.textContent = text;
                
                // 先添加show类以便测量tooltip的实际高度
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
                tooltip.classList.add('show');
                
                // 获取元素位置（使用getBoundingClientRect，相对于viewport）
                const rect = element.getBoundingClientRect();
                
                // 计算tooltip位置（在元素上方）
                const tooltipWidth = Math.min(420, window.innerWidth - 40);
                tooltip.style.width = tooltipWidth + 'px';
                tooltip.style.maxWidth = (window.innerWidth - 40) + 'px';
                
                // 强制重排以获取tooltip实际高度
                const tooltipHeight = tooltip.offsetHeight || 150;
                
                let left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
                let top = rect.top - tooltipHeight - 12;
                
                // 确保tooltip不超出屏幕左边界
                if (left < 20) {
                    left = 20;
                }
                // 确保tooltip不超出屏幕右边界
                if (left + tooltipWidth > window.innerWidth - 20) {
                    left = window.innerWidth - tooltipWidth - 20;
                }
                
                // 如果上方空间不够，显示在下方
                if (top < 20) {
                    top = rect.bottom + 12;
                    tooltip.classList.add('tooltip-below');
                } else {
                    tooltip.classList.remove('tooltip-below');
                }
                
                // 使用fixed定位，不受滚动影响
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
                tooltip.style.visibility = 'visible';
                
                // 延迟显示以提供平滑过渡
                requestAnimationFrame(() => {
                    tooltip.style.opacity = '1';
                });
            }

            // 隐藏tooltip
            function hideTooltip() {
                if (tooltipElement) {
                    tooltipElement.classList.remove('show');
                    // 等待动画完成后再移除
                    setTimeout(() => {
                        if (tooltipElement && !tooltipElement.classList.contains('show')) {
                            tooltipElement.remove();
                            tooltipElement = null;
                        }
                    }, 200);
                }
            }

            // 为所有带data-tooltip属性的元素绑定事件
            function bindTooltipEvents() {
                document.querySelectorAll('.param-label[data-tooltip]').forEach(label => {
                    const tooltipText = label.getAttribute('data-tooltip');
                    
                    label.addEventListener('mouseenter', function(e) {
                        if (hideTimeout) {
                            clearTimeout(hideTimeout);
                            hideTimeout = null;
                        }
                        showTooltip(this, tooltipText);
                    });
                    
                    label.addEventListener('mouseleave', function(e) {
                        hideTimeout = setTimeout(() => {
                            hideTooltip();
                        }, 100);
                    });
                    
                });
            }

            // 初始化绑定
            bindTooltipEvents();

            // 使用MutationObserver监听DOM变化，以便在动态添加参数时也能绑定tooltip
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                if (node.classList && node.classList.contains('param-label') && node.hasAttribute('data-tooltip')) {
                                    const tooltipText = node.getAttribute('data-tooltip');
                                    node.addEventListener('mouseenter', function() {
                                        if (hideTimeout) {
                                            clearTimeout(hideTimeout);
                                            hideTimeout = null;
                                        }
                                        showTooltip(this, tooltipText);
                                    });
                                    node.addEventListener('mouseleave', function() {
                                        hideTimeout = setTimeout(() => {
                                            hideTooltip();
                                        }, 100);
                                    });
                                }
                                // 检查子节点
                                const labels = node.querySelectorAll && node.querySelectorAll('.param-label[data-tooltip]');
                                if (labels && labels.length) {
                                    labels.forEach(label => {
                                        const tooltipText = label.getAttribute('data-tooltip');
                                        label.addEventListener('mouseenter', function() {
                                            if (hideTimeout) {
                                                clearTimeout(hideTimeout);
                                                hideTimeout = null;
                                            }
                                            showTooltip(this, tooltipText);
                                        });
                                        label.addEventListener('mouseleave', function() {
                                            hideTimeout = setTimeout(() => {
                                                hideTooltip();
                                            }, 100);
                                        });
                                    });
                                }
                            }
                        });
                    }
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
        
        async function init() {
            console.log('[系统初始化] 开始初始化...');
            // 初始化资源库显示状态
            initResourcesVisibility();
            
            // 初始化翻译和笔记功能
            initTranslateFeature();
            initNoteFeature();
            
            // 初始化参数tooltip
            initParamTooltips();

            const token = localStorage.getItem('access_token');
            console.log('[系统初始化] Token存在:', !!token);

            if (token) {
                try {
                    console.log('[系统初始化] 验证token...');
                    const isValid = await verifyToken();
                    console.log('[系统初始化] Token验证结果:', isValid);
                    if (!isValid) {
                        Logout();
                        authModal.style.display = 'flex';
                        document.body.classList.remove('logged-in');
                        initAuthTabs();
                        bindAuthEvents();
                        return;
                    }

                    loginEvent();
                    authModal.style.display = 'none';
                    document.body.classList.add('logged-in');

                    console.log('[系统初始化] 刷新用户信息...');
                    await refreshCurrentUser();

                    // 初始化功能（加载资源+聊天交互）
                    console.log('[系统初始化] 加载学习资源...');
                    await loadResources();
                    console.log('[系统初始化] 加载自定义AI模型...');
                    await loadUserCustomModels();
                    console.log('[系统初始化] 绑定聊天事件...');
                    bindChatEvents();
                    console.log('[系统初始化] 初始化历史记录...');
                    initHistoryFeature(); // 初始化历史记录功能
                    console.log('[系统初始化] 初始化完成！');
                } catch (err) {
                    console.error("验证令牌出错：", err);
                    authModal.style.display = 'flex';
                    document.body.classList.remove('logged-in');
                    initAuthTabs();
                    bindAuthEvents();
                }
            } else {
                // 未登录：显示登录模态框，禁止页面滚动
                authModal.style.display = 'flex';
                document.body.classList.remove('logged-in');
                // 2. 初始化认证表单切换（登录/注册/找回密码）
                initAuthTabs();
                // 3. 绑定所有认证表单提交事件
                bindAuthEvents();
            }
        }

        // ---------------------- 1. 认证表单切换逻辑 ----------------------
        function initAuthTabs() {
            // 标签切换（点击"登录/注册/找回密码"标签）
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;
                    switchAuthTab(targetTab);
                });
            });

            // 链接切换（点击"立即注册/返回登录"等文字链接）
            switchLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const targetTab = link.dataset.switch;
                    switchAuthTab(targetTab);
                    clearAllFormErrors(); // 切换时清除所有错误提示
                });
            });

            // 取消按钮逻辑
            document.getElementById('loginCancelBtn').addEventListener('click', () => {
                authModal.style.display = 'none'; // 登录页取消：隐藏模态框
                document.body.classList.add('logged-in');
            });
            document.getElementById('registerCancelBtn').addEventListener('click', () => {
                switchAuthTab('login'); // 注册页取消：切回登录页
            });
            document.getElementById('forgotCancelBtn').addEventListener('click', () => {
                switchAuthTab('login'); // 找回密码页取消：切回登录页
            });
        }

        // 切换认证表单（核心函数）
        function switchAuthTab(targetTab) {
            // 1. 切换标签激活状态
            authTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === targetTab);
            });

            // 2. 切换表单显示状态
            authForms.forEach(form => {
                form.classList.toggle('active', form.id === `${targetTab}Form`);
            });

            // 3. 切换非找回密码表单时，清除验证码倒计时（避免定时器残留）
            if (targetTab !== 'forgot' && countdownTimer || targetTab !== 'register') {
                clearInterval(countdownTimer);
                getVerifyCodeBtn.disabled = false;
                getVerifyCodeBtn.textContent = '获取验证码';
                getVerifyCodeBtn_create.disabled = false;
                getVerifyCodeBtn_create.textContent = '获取验证码';
            }
            // 4. 切换表单时清除所有错误提示
            clearAllFormErrors();
        }
        async function verifyToken() {
            const token = localStorage.getItem('access_token');
            // 检查token是否存在
            if (!token) {
                console.log('未找到令牌，需要登录');
                return false;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ token: token })
                });

                // 检查HTTP状态码（200-299为成功）
                if (!response.ok) {
                    // 非成功状态：抛出错误，进入catch处理
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Token验证失败（状态码：${response.status}）`);
                }

                // 解析成功响应
                const data = await response.json();
                if (data.valid || data.user_id) {
                    // 验证成功后的逻辑（例如：更新用户状态、允许访问页面）
                    return true;
                } else {
                    localStorage.removeItem('access_token');  // 清除无效令牌
                    return false;
                }

            } catch (error) {
                // 捕获所有异常（网络错误、后端错误等）
                console.error('令牌验证出错：', error.message);
                // 不自动清除token，避免用户频繁被登出
                return false;
            }
        }
            // ---------------------- 2. 认证表单事件绑定（登录/注册/找回密码） ----------------------
            function bindAuthEvents() {
                // 2.1 登录表单提交
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    clearFormErrors('login'); // 清除当前表单错误

                    // 表单验证
                    const useremail = document.getElementById('loginUseremail').value.trim();
                    const password = document.getElementById('loginPassword').value.trim();
                    const agreeTerms = document.getElementById('loginAgreeTerms').checked;
                    let isValid = true;

                    if (!useremail) {
                        showError('loginUsernameError', '用户邮箱不能为空');
                        isValid = false;
                    }
                    if (!password) {
                        showError('loginPasswordError', '密码不能为空');
                        isValid = false;
                    }
                    if (!agreeTerms) {
                        showError('loginTermsError', '请阅读并同意隐私政策');
                        isValid = false;
                    }

                    if (!isValid) return;

                    // 提交请求（按钮加载状态）
                    const loginBtn = document.getElementById('loginBtn');
                    loginBtn.disabled = true;
                    loginBtn.textContent = '登录中...';

                    try {
                        const response = await fetch(`${API_BASE_URL}/api/login`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({useremail, password, agree_terms: agreeTerms})
                        });
                        const data = await response.json();

                        if (response.ok) {
                            // 登录成功：存储访问令牌（同时设置两个键名以确保与其他页面的兼容性）
                            localStorage.setItem('access_token', data.access_token);
                            localStorage.setItem('aiLearningToken', data.access_token);
                            await refreshCurrentUser();
                            showSuccess('loginFormSuccess', '登录成功，正在进入系统...');
                            
                            // 检查是否为管理员
                            try {
                                const adminRes = await fetch(`${API_BASE_URL}/api/admin/verify`, {
                                    method: 'GET',
                                    headers: {
                                        'Authorization': `Bearer ${data.access_token}`
                                    }
                                });
                                
                                const adminData = await adminRes.json();
                                
                                if (adminRes.ok && adminData.is_admin) {
                                    // 是管理员，跳转到管理员页面
                                    setTimeout(() => {
                                        window.location.href = '/html/admin.html';
                                    }, 1500);
                                } else {
                                    // 普通用户，正常进入系统
                                    setTimeout(() => {
                                        authModal.style.display = 'none';
                                        document.body.classList.add('logged-in');
                                    }, 1500);

                                    // 绑定账户注销事件
                                    document.getElementById('deleteAccountBtn').addEventListener('click', handleAccountDelete);
                                    sign_1 = 0
                                    await loadResources();
                                    bindChatEvents();
                                    initHistoryFeature(); // 初始化历史记录功能
                                }
                            } catch (adminErr) {
                                console.error('管理员验证错误:', adminErr);
                                // 如果验证失败，当作普通用户处理
                                setTimeout(() => {
                                    authModal.style.display = 'none';
                                    document.body.classList.add('logged-in');
                                }, 1500);
                                
                                document.getElementById('deleteAccountBtn').addEventListener('click', handleAccountDelete);
                                sign_1 = 0
                                await loadResources();
                                bindChatEvents();
                                initHistoryFeature();
                            }
                        } else {
                            // 登录失败：显示错误
                            showError('loginFormError', data.error || '登录失败，请检查用户名或密码');
                        }
                    } catch (error) {
                        showError('loginFormError', '网络错误，请稍后重试');
                        console.error('登录请求失败:', error);
                    } finally {
                        // 恢复按钮状态
                        loginBtn.disabled = false;
                        loginBtn.textContent = '登录';
                    }
                });

                // 2.2 注册表单提交
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    clearFormErrors('register'); // 清除当前表单错误

                    // 表单验证
                    const username = document.getElementById('regUsername').value.trim();
                    const agreeTerms = document.getElementById('registerAgreeTerms').checked;
                    let isValid = true;

                    // 先检查协议是否勾选
                    if (!agreeTerms) {
                        showError('registerTermsError', '请阅读并同意隐私政策');
                        isValid = false;
                    }
                    const email = document.getElementById('regEmail').value.trim();
                    const password = document.getElementById('regPassword').value.trim();
                    const confirmPassword = document.getElementById('regConfirmPassword').value.trim();
                    const emailReg = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    const createVerifyCode_value = createVerifyCode.value.trim();
                    if (!createVerifyCode_value){
                        showError('regVerifyCodeError', '验证码不能为空');
                        isValid = false;
                    }
                    // 用户名验证（3-20字符）
                    if (!username) {
                        showError('regUsernameError', '用户名不能为空');
                        isValid = false;
                    } else if (username.length < 3 || username.length > 20) {
                        showError('regUsernameError', '用户名长度需在3-20字符之间');
                        isValid = false;
                    }

                    // 邮箱验证
                    if (!email) {
                        showError('regEmailError', '邮箱不能为空');
                        isValid = false;
                    } else if (!emailReg.test(email)) {
                        showError('regEmailError', '请输入有效的邮箱格式（如xxx@xxx.com）');
                        isValid = false;
                    }




                    // 密码验证（6-20字符）
                    if (!password) {
                        showError('regPasswordError', '密码不能为空');
                        isValid = false;
                    } else if (password.length < 6 || password.length > 20) {
                        showError('regPasswordError', '密码长度需在6-20字符之间');
                        isValid = false;
                    }

                    // 确认密码验证
                    if (!confirmPassword) {
                        showError('regConfirmPasswordError', '请确认密码');
                        isValid = false;
                    } else if (confirmPassword !== password) {
                        showError('regConfirmPasswordError', '两次输入的密码不一致');
                        isValid = false;
                    }

                    if (!isValid) return;
                    // 提交请求（按钮加载状态）
                    const registerBtn = document.getElementById('registerBtn');
                    registerBtn.disabled = true;
                    registerBtn.textContent = '注册中...';

                    try {
                        const response = await fetch(`${API_BASE_URL}/api/register`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({username, email, password, createVerifyCode_value, agree_terms: agreeTerms})
                        });
                        const data = await response.json();

                        if (response.ok) {
                            // 注册成功：提示并切回登录页
                            showSuccess('registerFormSuccess', '注册成功，请登录');
                            setTimeout(() => {
                                switchAuthTab('login');
                                document.getElementById('loginUsername').value = username; // 自动填充用户名
                            }, 1500);
                        } else {
                            // 注册失败：显示错误
                            showError('registerFormError', data.error || '注册失败，请稍后重试');
                        }
                    } catch (error) {
                        showError('registerFormError', '网络错误，请稍后重试');
                        console.error('注册请求失败:', error);
                    } finally {
                        // 恢复按钮状态
                        registerBtn.disabled = false;
                        registerBtn.textContent = '注册';
                    }
                });


                // 2.5 注册表单 - 获取验证码按钮
                getVerifyCodeBtn_create.addEventListener('click', async () => {
                    clearFormErrors('register'); // 清除当前表单错误
                    const email = document.getElementById('regEmail').value.trim();
                    const emailReg = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                    // 邮箱验证
                    if (!email) {
                        showError('regEmailError', '请输入注册邮箱');
                        return;
                    }
                    if (!emailReg.test(email)) {
                        showError('regEmailError', '请输入有效的邮箱格式（如xxx@xxx.com）');
                        return;
                    }

                    // 按钮倒计时状态
                    getVerifyCodeBtn_create.disabled = true;
                    let remainingSeconds = COUNTDOWN_SECONDS;
                    getVerifyCodeBtn_create.textContent = `${remainingSeconds}秒后重新获取`;

                    try {
                        // 调用后端"发送验证码"接口
                    const response = await fetch(`${API_BASE_URL}/api/register/email`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ email })
                    });
                        const data = await response.json();

                        if (!response.ok) {
                            // 特别处理频率限制错误（429状态码）
                        if (response.status === 429) {
                            // 使用后端返回的错误消息，包含动态剩余秒数
                            throw new Error(data.detail || '操作过于频繁，请稍后再试');
                        }
                            throw new Error(data.error || '验证码发送失败，请稍后重试');
                        }

                        // 发送成功提示
                        showSuccess('registerFormSuccess', '验证码已发送至邮箱，请注意查收（含垃圾邮件）');
                    } catch (error) {
                        // 发送失败：恢复按钮并显示错误
                        clearInterval(countdownTimer);
                        getVerifyCodeBtn_create.disabled = false;
                        getVerifyCodeBtn_create.textContent = '获取验证码';
                        showError('registerFormError', error.message);
                        console.error('验证码发送失败:', error);
                        return;
                    }

                    // 启动倒计时定时器
                    countdownTimer = setInterval(() => {
                        remainingSeconds--;
                        getVerifyCodeBtn_create.textContent = `${remainingSeconds}秒后重新获取`;
                        if (remainingSeconds <= 0) {
                            clearInterval(countdownTimer);
                            getVerifyCodeBtn_create.disabled = false;
                            getVerifyCodeBtn_create.textContent = '获取验证码';
                        }
                    }, 1000);
                });



                // 2.3 找回密码表单 - 获取验证码按钮
                getVerifyCodeBtn.addEventListener('click', async () => {
                    clearFormErrors('forgot'); // 清除当前表单错误
                    const email = forgotEmail.value.trim();
                    const emailReg = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                    // 邮箱验证
                    if (!email) {
                        showError('forgotEmailError', '请输入注册邮箱');
                        return;
                    }
                    if (!emailReg.test(email)) {
                        showError('forgotEmailError', '请输入有效的邮箱格式（如xxx@xxx.com）');
                        return;
                    }

                    // 按钮倒计时状态
                    getVerifyCodeBtn.disabled = true;
                    let remainingSeconds = COUNTDOWN_SECONDS;
                    getVerifyCodeBtn.textContent = `${remainingSeconds}秒后重新获取`;

                    try {
                        // 调用后端"发送验证码"接口
                    const response = await fetch(`${API_BASE_URL}/api/forgot-password/email`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ email })
                    });
                        const data = await response.json();

                        if (!response.ok) {
                            // 特别处理频率限制错误（429状态码）
                        if (response.status === 429) {
                            // 使用后端返回的错误消息，包含动态剩余秒数
                            throw new Error(data.detail || '操作过于频繁，请稍后再试');
                        }
                            throw new Error(data.error || '验证码发送失败，请稍后重试');
                        }

                        // 发送成功提示
                        showSuccess('forgotFormSuccess', '验证码已发送至邮箱，请注意查收（含垃圾邮件）');
                    } catch (error) {
                        // 发送失败：恢复按钮并显示错误
                        clearInterval(countdownTimer);
                        getVerifyCodeBtn.disabled = false;
                        getVerifyCodeBtn.textContent = '获取验证码';
                        showError('forgotFormError', error.message);
                        console.error('验证码发送失败:', error);
                        return;
                    }

                    // 启动倒计时定时器
                    countdownTimer = setInterval(() => {
                        remainingSeconds--;
                        getVerifyCodeBtn.textContent = `${remainingSeconds}秒后重新获取`;
                        if (remainingSeconds <= 0) {
                            clearInterval(countdownTimer);
                            getVerifyCodeBtn.disabled = false;
                            getVerifyCodeBtn.textContent = '获取验证码';
                        }
                    }, 1000);
                });

                // 2.4 找回密码表单 - 提交重置
                forgotForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    clearFormErrors('forgot'); // 清除当前表单错误
                    let isValid = true;

                    // 表单验证
                    const email = forgotEmail.value.trim();
                    const verifyCode = forgotVerifyCode.value.trim();
                    const newPassword = forgotNewPassword.value.trim();
                    const confirmPassword = forgotConfirmPassword.value.trim();
                    const emailReg = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                    // 邮箱验证
                    if (!email) {
                        showError('forgotEmailError', '请输入注册邮箱');
                        isValid = false;
                    } else if (!emailReg.test(email)) {
                        showError('forgotEmailError', '请输入有效的邮箱格式');
                        isValid = false;
                    }

                    // 验证码验证（6位）
                    if (!verifyCode) {
                        showError('forgotVerifyCodeError', '请输入验证码');
                        isValid = false;
                    } else if (verifyCode.length !== 6) {
                        showError('forgotVerifyCodeError', '验证码必须为6位数字');
                        isValid = false;
                    }

                    // 新密码验证（同注册规则）
                    if (!newPassword) {
                        showError('forgotNewPasswordError', '请输入新密码');
                        isValid = false;
                    } else if (newPassword.length < 6 || newPassword.length > 20) {
                        showError('forgotNewPasswordError', '新密码长度需在6-20字符之间');
                        isValid = false;
                    }

                    // 确认新密码验证
                    if (!confirmPassword) {
                        showError('forgotConfirmPasswordError', '请确认新密码');
                        isValid = false;
                    } else if (confirmPassword !== newPassword) {
                        showError('forgotConfirmPasswordError', '两次输入的密码不一致');
                        isValid = false;
                    }

                    if (!isValid) return;

                    // 提交请求（按钮加载状态）
                    const forgotBtn = document.getElementById('forgotBtn');
                    forgotBtn.disabled = true;
                    forgotBtn.textContent = '重置中...';

                    try {
                        // 调用后端"验证码验证+密码重置"接口
                        const response = await fetch(`${API_BASE_URL}/api/forgot-password`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                email,
                                verifyCode,
                                newPassword
                            })
                        });
                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || '密码重置失败，请检查验证码是否正确');
                        }

                        // 重置成功：提示并切回登录页
                        forgotFormSuccess.style.display = 'block';
                        setTimeout(() => {
                            switchAuthTab('login');
                            document.getElementById('loginUsername').value = email; // 自动填充邮箱为用户名
                            clearInterval(countdownTimer); // 清除倒计时
                        }, 2000);
                    } catch (error) {
                        showError('forgotFormError', error.message);
                        console.error('密码重置失败:', error);
                    } finally {
                        // 恢复按钮状态
                        forgotBtn.disabled = false;
                        forgotBtn.textContent = '重置密码';
                    }
                });
            }

            // ---------------------- 3. 认证辅助函数（提示/清除错误/用户信息） ----------------------
            // 显示错误提示
            function showError(elementId, message) {
                const errorEl = document.getElementById(elementId);
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                }
            }

            // 显示成功提示
            function showSuccess(elementId, message) {
                const successEl = document.getElementById(elementId);
                if (successEl) {
                    successEl.textContent = message;
                    successEl.style.display = 'block';
                }
            }

            // 清除单个表单的错误提示（如login/register/forgot）
            function clearFormErrors(formType) {
                // 1. 清除字段级错误（如loginUsernameError/forgotVerifyCodeError）
                const fieldErrors = document.querySelectorAll(`[id^="${formType}"][id$="Error"]`);
                fieldErrors.forEach(el => {
                    el.textContent = '';
                    el.style.display = 'none';
                });

                // 2. 清除表单级错误/成功提示（如loginFormError/forgotFormSuccess）
                const formError = document.getElementById(`${formType}FormError`);
                const formSuccess = document.getElementById(`${formType}FormSuccess`);
                if (formError) {
                    formError.textContent = '';
                    formError.style.display = 'none';
                }
                if (formSuccess) {
                    formSuccess.textContent = '';
                    formSuccess.style.display = 'none';
                }
            }

            // 清除所有表单的错误提示
            function clearAllFormErrors() {
                clearFormErrors('login');
                clearFormErrors('register');
                clearFormErrors('forgot');
            }

            function updateCachedUser(user) {
                currentUser = user || null;
                if (currentUser) {
                    try {
                        localStorage.setItem('aiLearningUser', JSON.stringify(currentUser));
                    } catch (err) {
                        console.warn('无法在本地存储用户信息，将仅在内存中缓存:', err);
                    }
                } else {
                    localStorage.removeItem('aiLearningUser');
                }
            }
            async function refreshCurrentUser({ applyUI = true, silent = false } = {}) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    console.log('[用户信息] 没有token，无法刷新用户信息');
                    updateCachedUser(null);
                    return null;
                }

                try {
                    console.log('[用户信息] 开始请求用户信息...');
                    const response = await fetch(`${API_BASE_URL}/api/users/me`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    console.log('[用户信息] API响应状态:', response.status, response.ok);
                    const result = await response.json();
                    console.log('[用户信息] API返回结果:', result);

                    // 修复：兼容多种后端响应格式
                    if (!response.ok) {
                        throw new Error(result.message || '获取用户信息失败');
                    }
                    
                    // 检查业务状态：兼容 code 和 status 两种格式
                    const isSuccess = (result.code === 200) || (result.status === 'success');
                    if (!isSuccess) {
                        throw new Error(result.message || '服务器返回错误: ' + (result.code || result.status));
                    }
                    
                    if (!result.data) {
                        throw new Error('服务器未返回用户数据');
                    }

                    console.log('[用户信息] 用户信息获取成功:', result.data);
                    updateCachedUser(result.data);

                    if (applyUI) {
                        showUserInfo(result.data);
                    }

                    return result.data;
                } catch (error) {
                    if (!silent) {
                        console.error('[用户信息] 获取用户信息失败:', error);
                    }
                    return null;
                }
            }

            // 登录后显示用户信息
            function showUserInfo(user) {
                console.log('[用户信息] 开始更新用户信息:', user);
                updateCachedUser(user);

                if (user && usernameDisplay) {
                    // 更新页面顶部的用户名显示
                    usernameDisplay.textContent = user.username || user.email; // 优先显示用户名，无则显示邮箱
                    userInfo.style.display = 'block';
                    
                    // 设置显示名称
                    const displayName = user.username || user.email;
                    const initial = displayName.charAt(0).toUpperCase() || '?';
                    console.log('[用户信息] 显示名称:', displayName, '首字母:', initial);
                    
                    // 更新侧边栏中的用户信息
                    const userAvatar = document.getElementById('userAvatar');
                    const userProfileName = document.getElementById('userProfileName');
                    const userProfileEmail = document.getElementById('userProfileEmail');
                    
                    // 更新顶部侧边栏信息
                    if (userAvatar && userProfileName && userProfileEmail) {
                        userProfileName.textContent = displayName;
                        userProfileEmail.textContent = user.email || '';
                        userAvatar.textContent = initial;
                    }
                    
                    // 更新个人中心侧边栏的用户信息
                    const sidebarUsername = document.getElementById('profileUsername');
                    const sidebarEmail = document.getElementById('profileEmail');
                    const sidebarUserType = document.getElementById('profileUserType');
                    const sidebarAvatarImg = document.getElementById('userAvatarImg');
                    
                    console.log('[用户信息] 更新个人中心侧边栏, 头像URL:', user.avatar);
                    
                    // 更新个人中心侧边栏信息
                    if (sidebarUsername && sidebarEmail && sidebarUserType && sidebarAvatarImg) {
                        sidebarUsername.textContent = displayName;
                        sidebarEmail.textContent = user.email || '';
                        sidebarUserType.textContent = user.role === 'admin' ? '管理员' : '普通用户';
                        
                        // 如果有头像URL则使用，否则使用默认占位图
                        if (user.avatar && user.avatar !== '') {
                            console.log('[用户信息] 使用用户头像:', user.avatar);
                            sidebarAvatarImg.src = user.avatar;
                            sidebarAvatarImg.style.display = 'block';
                            // 隐藏字符头像
                            const initialElement = sidebarAvatarImg.parentElement.querySelector('.avatar-initial');
                            if (initialElement) {
                                initialElement.style.display = 'none';
                            }
                        } else {
                            console.log('[用户信息] 使用首字母头像');
                            // 使用用户名第一个字符作为头像
                            const avatarContainer = sidebarAvatarImg.parentElement;
                            // 创建或更新头像字符
                            let initialElement = avatarContainer.querySelector('.avatar-initial');
                            if (!initialElement) {
                                initialElement = document.createElement('span');
                                initialElement.className = 'avatar-initial';
                                initialElement.style.fontSize = '36px';
                                initialElement.style.color = '#fff';
                                initialElement.style.fontWeight = 'bold';
                                initialElement.style.position = 'absolute';
                                avatarContainer.appendChild(initialElement);
                            }
                            initialElement.textContent = initial;
                            // 隐藏图片元素
                            sidebarAvatarImg.style.display = 'none';
                            initialElement.style.display = 'block';
                        }
                    }
                    
                    // 更新个人中心的用户信息（新添加的部分）
                    const profileUsername = document.getElementById('profileUsername');
                    const profileEmail = document.getElementById('profileEmail');
                    const profileUserType = document.getElementById('profileUserType');
                    const userAvatarImg = document.getElementById('userAvatarImg');
                    
                    if (profileUsername) {
                        profileUsername.textContent = user.username || '用户名';
                    }
                    if (profileEmail) {
                        profileEmail.textContent = user.email || '邮箱@example.com';
                    }
                    if (profileUserType) {
                        // 根据用户角色显示不同的用户类型
                        profileUserType.textContent = user.is_admin ? '管理员' : '普通用户';
                    }
                    if (userAvatarImg) {
                        // 如果用户有头像则使用用户头像，否则使用默认头像
                        const defaultAvatar = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22100%22%20height%3D%22100%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_18bc6f87a3f%20text%20%7B%20fill%3Argba(153%2C153%2C153%2C.5)%3Bfont-weight%3Anormal%3Bfont-family%3AHelvetica%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_18bc6f87a3f%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2235%22%20y%3D%2254%22%3E头像%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';
                        
                        if (user.avatar) {
                            const avatarUrl = `${API_BASE_URL}${user.avatar}`;
                            console.log('[用户信息] 设置个人中心头像URL:', avatarUrl);
                            userAvatarImg.src = avatarUrl;
                            userAvatarImg.style.display = 'block';
                        } else {
                            console.log('[用户信息] 使用默认头像');
                            userAvatarImg.src = defaultAvatar;
                        }
                    }
                } else {
                    console.log('[用户信息] 未找到用户信息或必要的DOM元素');
                }
            }

            function clearAuthStorage() {
                try {
                    localStorage.removeItem('access_token');
                } catch (err) {
                    console.warn('无法移除访问令牌:', err);
                }
                updateCachedUser(null);
            }

            function Logout() {
                clearAuthStorage();
                // 刷新页面恢复初始状态
                window.location.reload();
            }
            // 退出登录处理
            function handleLogout() {
                if (confirm('确定要退出登录吗？退出后需重新登录才能使用系统')) {
                    // 清除本地缓存的用户信息
                    clearAuthStorage();
                    // 刷新页面恢复初始状态
                    window.location.reload();
                }
            }

            // 账户注销处理
            function handleAccountDelete() {
                if (confirm('警告：账户注销后将无法恢复！确定要注销您的账户吗？')) {
                     // 发送请求到服务器删除账户
                    fetch(`${API_BASE_URL}/api/delete-account`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        }
                    }).then(response => {
                        if (response.ok) {
                            alert('账户已成功注销！');
                            // 清除本地存储并刷新页面
                            clearAuthStorage();
                            window.location.reload();
                        } else {
                            alert('账户注销失败，请稍后再试。');
                        }
                    }).catch(error => {
                        console.error('注销账户时发生错误：', error);
                        alert('网络错误，请检查您的连接后重试。');
                    });
                }
            }

            // ---------------------- 4. IPv6学习资源加载 ----------------------
            async function loadResources() {
                try {
                    console.log('[资源加载] 开始加载学习资源...');
                    let user = currentUser;
                    if (!user) {
                        user = await refreshCurrentUser({ silent: true });
                    }
                    if (!user) {
                        try {
                            user = JSON.parse(localStorage.getItem('aiLearningUser') || 'null');
                        } catch {
                            user = null;
                        }
                    }
                    if (!user || !user.id) {
                        console.log('[资源加载] 用户未登录');
                        resourcesList.innerHTML = '<div class="resource-item">请先登录以查看资源</div>';
                        resourceCount.textContent = '0';
                        return;
                    }

                    console.log('[资源加载] 用户已登录，用户ID:', user.id);
                    
                    // 获取资源（现在后端会返回用户收藏的资源）
                    const response = await fetch(`${API_BASE_URL}/api/resources`, {
                        method: "GET",
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        }
                    });

                    console.log('[资源加载] API响应状态:', response.status);
                    const data = await response.json();
                    console.log('[资源加载] API返回数据:', data);

                    // 清空资源列表
                    resourcesList.innerHTML = '';
                    let totalResources = 0;

                    // 处理资源 - 只显示用户收藏的资源（is_favorite为true）
                    if (data.resources && Array.isArray(data.resources) && data.resources.length > 0) {
                        // 筛选出用户收藏的资源
                        const favoriteResources = data.resources.filter(resource => resource.is_favorite === true);
                        
                        // 按分类组织资源
                        const resourcesByCategory = {};
                        favoriteResources.forEach(resource => {
                            const category = resource.category_name || '未分类';
                            if (!resourcesByCategory[category]) {
                                resourcesByCategory[category] = [];
                            }
                            resourcesByCategory[category].push(resource);
                        });

                        // 遍历分类创建资源列表
                        Object.keys(resourcesByCategory).forEach(categoryName => {
                            const categoryResources = resourcesByCategory[categoryName];
                            
                            // 创建分类标题
                            const categoryTitle = document.createElement('div');
                            categoryTitle.className = 'resource-category-title';
                            categoryTitle.textContent = categoryName;
                            resourcesList.appendChild(categoryTitle);

                            // 创建该分类下的所有资源项
                            categoryResources.forEach(resource => {
                                const resourceEl = document.createElement('div');
                                resourceEl.className = 'resource-item';
                                resourceEl.innerHTML = `
                                <div class="resource-title">${resource.title || '未命名资源'}</div>
                                <div class="resource-desc">${resource.description || '暂无描述'}</div>
                                <a href="${resource.url || '#'}" class="resource-link" target="_blank"
                                   ${!resource.url ? 'onclick="return false;"' : ''}>
                                    ${resource.url ? '访问资源' : '资源链接无效'}
                                </a>
                                <div class="resource-actions">
                                    <button class="btn btn-sm btn-danger" onclick="removeFavorite(${resource.id})">取消收藏</button>
                                </div>
                            `;
                                resourcesList.appendChild(resourceEl);
                                totalResources++;
                            });
                        });
                    }

                    // 更新资源总数
                    resourceCount.textContent = totalResources;
                    console.log('[资源加载] 资源总数:', totalResources);

                    // 无资源时显示提示
                    if (totalResources === 0) {
                        resourcesList.innerHTML = '<div class="resource-item">当前暂无可用学习资源，敬请期待</div>';
                        console.log('[资源加载] 没有找到收藏的资源');
                    }
                } catch (error) {
                    // 加载失败提示
                    resourcesList.innerHTML = '<div class="resource-item">资源加载失败，请检查网络连接或IPv6环境</div>';
                    console.error('[资源加载] 加载失败:', error);
                }
            }

            // ---------------------- 5. AI聊天交互（流式响应） ---------------------
            // 添加选择变化监听
            modelSelector.addEventListener('change', function () {
                if (this.value === 'deepseek') {
                    depthSelectordiv.style.display = 'block';
                } else {
                    depthSelectordiv.style.display = 'none';
                }
            });

            // 绑定聊天事件（提问按钮+回车提交）
            function bindChatEvents() {
                askButton.addEventListener('click', askQuestion);
                questionInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) { // 按Enter且不按Shift时提交
                        e.preventDefault();
                        askQuestion();
                    }
                });
            }
            // 发送问题给AI（流式响应）
            async function askQuestion() {
                const question = questionInput.value.trim();
                if (!question) {
                    alert('请输入您的学习问题后再提问');
                    return;
                }

                // 清空输入框
                questionInput.value = '';
                
                // 使用当前会话ID，如果没有则创建新的
                let sessionId = currentSessionId;
                if (!sessionId) {
                    sessionId = await createNewChatSession();
                    if (!sessionId) {
                        sessionId = Date.now().toString(); // 备用方案
                    }
                    currentSessionId = sessionId;
                }
                
                // 保存用户消息到服务器
                const result = await saveChatRecordToServer(sessionId, question, 'user', modelSelector.value);
                
                // 如果保存成功，显示用户消息
                if (result) {
                    addMessage(question, 'user');
                } else {
                    showErrorMessage('保存消息失败，请重试');
                    return;
                }

                // 2. 禁用按钮+显示加载状态
                askButton.disabled = true;
                askButton.textContent = '回答中...';
                loadingIndicator.style.display = 'block';
                showStopButtons();
                answerStreamAbortController = new AbortController();
                streamingMessageContentEl = null;
                streamingMessageContainerEl = null;
                let think = null;
                let model = modelSelector.value;
                let aiAnswer = '';
                let streamingMessageEl = null;
                let contentEl = null;

                try {
                    // 3. 调用AI流式接口
                    if (model === "deepseek") {
                        if (depthSelector.value === "is_deep") {
                            think = 'deepseek-reasoner'
                        } else {
                            think = 'deepseek-chat'
                        }
                    }

                    const response = await fetch(`${API_BASE_URL}/api/ask-stream`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                            'model': model,
                            'think': think
                        },
                        body: JSON.stringify({question, session_id: sessionId}),
                        signal: answerStreamAbortController.signal
                    });

                    if (!response.ok) {
                        throw new Error(`AI接口请求失败（状态码：${response.status}）`);
                    }

                    // 处理流式响应（实时显示）
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    
                    // 创建一个临时的流式消息元素
                    streamingMessageEl = document.createElement('div');
                    streamingMessageEl.className = 'message-container ai-message-container streaming';
                    
                    // 添加头像
                    const avatarEl = document.createElement('div');
                    avatarEl.className = 'message-avatar';
                    if (model === 'doubao') {
                        avatarEl.style.backgroundColor = '#2196F3';
                        avatarEl.textContent = '豆包';
                    } else {
                        avatarEl.style.backgroundColor = '#FF9800';
                        avatarEl.textContent = 'DS';
                    }
                    
                    // 添加消息内容容器
                    contentEl = document.createElement('div');
                    contentEl.className = 'message ai-message';
                    
                    // 组合消息容器
                    streamingMessageEl.appendChild(avatarEl);
                    streamingMessageEl.appendChild(contentEl);
                    chatMessages.appendChild(streamingMessageEl);
                    streamingMessageContainerEl = streamingMessageEl;
                    streamingMessageContentEl = contentEl;
                    
                    // 自动滚动到最新消息
                    chatMessages.scrollTop = chatMessages.scrollHeight;

                    while (true) {
                        const {value, done} = await reader.read();
                        if (done) break;

                        // 解码并拼接响应内容
                        const chunk = decoder.decode(value, {stream: true});
                        aiAnswer += chunk;
                        
                        // 实时更新消息内容
                        let displayContent = aiAnswer;
                        // 处理格式，确保思考过程正确包装在容器中
                            if (aiAnswer.includes('--------------------------------思考过程---------------------------------') && 
                                aiAnswer.includes('-------------------------------正文解答--------------------------------')) {
                                // 已经有标准格式，添加可折叠功能
                                const thoughtStart = aiAnswer.indexOf('--------------------------------思考过程---------------------------------');
                                const contentStart = aiAnswer.indexOf('-------------------------------正文解答--------------------------------');
                                const thoughtContent = aiAnswer.substring(thoughtStart, contentStart);
                                const answerContent = aiAnswer.substring(contentStart);
                                
                                displayContent = `<div class="thought-container"><div class="thought-header"><span class="thought-toggle" onclick="toggleThought(this)">▶</span>${thoughtContent.split('\n')[0]}</div><div class="thought-content" style="display: none;">${thoughtContent.replace(/\n/g, '<br>')}</div></div>${answerContent.replace(/\n/g, '<br>')}`;
                        } else if (aiAnswer.includes('思考过程') && aiAnswer.includes('正文解答')) {
                            // 如果包含思考过程和正文解答但格式不标准，提取关键内容并添加可折叠功能
                            const thoughtStart = aiAnswer.indexOf('思考过程');
                            const contentStart = aiAnswer.indexOf('正文解答');
                            if (thoughtStart !== -1 && contentStart !== -1) {
                                const thoughtContent = aiAnswer.substring(thoughtStart, contentStart);
                                const answerContent = aiAnswer.substring(contentStart);
                                
                                displayContent = `<div class="thought-container"><div class="thought-header"><span class="thought-toggle" onclick="toggleThought(this)">▶</span>思考过程</div><div class="thought-content" style="display: none;">${thoughtContent.replace(/\n/g, '<br>')}</div></div>${answerContent.replace(/\n/g, '<br>')}`;
                            }
                        }
                        
                        contentEl.innerHTML = displayContent.replace(/\n/g, '<br>');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        
                        // 完全放开流式输出：每个chunk都实时同步到全屏模式
                        // 使用增量更新机制，只更新内容不重建DOM，避免闪烁
                        if (isFullscreenOpen) {
                            updateFullscreenMessages();
                            const fullscreenChatMessages = document.getElementById('fullscreenChatMessages');
                            if (fullscreenChatMessages) {
                                fullscreenChatMessages.scrollTop = fullscreenChatMessages.scrollHeight;
                            }
                        }
                    }

                    // 处理最终的回答格式
                    let processedAnswer = aiAnswer;
                    
                    // 检查是否包含思考过程和正文解答的分隔符
                    if (aiAnswer.includes('--------------------------------思考过程---------------------------------') && 
                        aiAnswer.includes('-------------------------------正文解答--------------------------------')) {
                        // 已经有标准格式，添加可折叠功能
                        const thoughtStart = aiAnswer.indexOf('--------------------------------思考过程---------------------------------');
                        const contentStart = aiAnswer.indexOf('-------------------------------正文解答--------------------------------');
                        const thoughtContent = aiAnswer.substring(thoughtStart, contentStart);
                        const answerContent = aiAnswer.substring(contentStart);
                        
                        processedAnswer = `<div class="thought-container"><div class="thought-header"><span class="thought-toggle" onclick="toggleThought(this)">▶</span>${thoughtContent.split('\n')[0]}</div><div class="thought-content" style="display: none;">${thoughtContent.replace(/\n/g, '<br>')}</div></div>${answerContent.replace(/\n/g, '<br>')}`;
                    } else if (aiAnswer.includes('思考过程') && aiAnswer.includes('正文解答')) {
                        // 如果包含思考过程和正文解答但格式不标准，提取关键内容并添加可折叠功能
                        const thoughtStart = aiAnswer.indexOf('思考过程');
                        const contentStart = aiAnswer.indexOf('正文解答');
                        if (thoughtStart !== -1 && contentStart !== -1) {
                            const thoughtContent = aiAnswer.substring(thoughtStart, contentStart);
                            const answerContent = aiAnswer.substring(contentStart);
                            
                            processedAnswer = `<div class="thought-container">
                                <div class="thought-header"><span class="thought-toggle" onclick="toggleThought(this)">▶</span>思考过程</div><div class="thought-content" style="display: none;">${thoughtContent.replace(/\n/g, '<br>')}</div>
                                </div>
                                ${answerContent.replace(/\n/g, '<br>')}`;
                        }
                    }

                    // 7. 加载推荐资源（基于AI回答内容）
                    //await loadRecommendedResources(aiAnswer);
                } catch (error) {
                    if (error.name === 'AbortError') {
                        if (streamingMessageContentEl) {
                            streamingMessageContentEl.innerHTML += `<span class="stop-message-hint">回答已停止</span>`;
                        } else {
                            addMessage('回答已停止', 'ai');
                        }
                    } else {
                        // 错误处理：添加错误消息到聊天框
                        if (model === 'deepseek' && think === 'deepseek-chat') {
                            // 非深度思考模式下显示更友好的消息
                            addMessage(`正在为您生成答案，请稍等片刻...`, 'ai');
                        } else {
                            addMessage(`抱歉，无法处理您的请求：${error.message}`, 'ai');
                        }
                        console.error('AI提问失败:', error);
                        if (streamingMessageContainerEl && streamingMessageContainerEl.parentNode) {
                            streamingMessageContainerEl.remove();
                        }
                        streamingMessageContentEl = null;
                        streamingMessageContainerEl = null;
                    }
                } finally {
                    // 移除流式标记，表示流式输出已完成
                    if (streamingMessageContainerEl) {
                        streamingMessageContainerEl.classList.remove('streaming');
                    }
                    
                    // 恢复按钮+隐藏加载状态
                    loadingIndicator.style.display = 'none';
                    askButton.disabled = false;
                    askButton.textContent = '提问';
                    hideStopButtons();
                    answerStreamAbortController = null;
                    streamingMessageContentEl = null;
                    streamingMessageContainerEl = null;
                    
                    // 流式回答结束后，立即更新全屏消息以显示完整内容
                    if (isFullscreenOpen) {
                        const fullscreenChatOverlay = document.getElementById('fullscreenChatOverlay');
                        if (fullscreenChatOverlay && fullscreenChatOverlay.style.display === 'block') {
                            setTimeout(() => {
                                updateFullscreenMessages();
                                const fullscreenChatMessages = document.getElementById('fullscreenChatMessages');
                                if (fullscreenChatMessages) {
                                    fullscreenChatMessages.scrollTop = fullscreenChatMessages.scrollHeight;
                                }
                            }, 100);
                        }
                    }
                }
            }

            // 取消收藏函数
            async function removeFavorite(resourceId) {
                if (!confirm('确定要取消收藏这个资源吗？')) {
                    return;
                }
                
                try {
                    const user = currentUser || JSON.parse(localStorage.getItem('aiLearningUser') || 'null');
                    if (!user || !user.id) {
                        alert('请先登录后再取消收藏');
                        return;
                    }
                    const response = await fetch(`${API_BASE_URL}/api/favorites/remove`, {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        },
                        body: JSON.stringify({
                            user_id: user.id,
                            resource_id: resourceId
                        })
                    });
                    
                    const data = await response.json();
                    if (response.ok) {
                        alert('取消收藏成功！');
                        await loadResources(); // 重新加载资源列表
                    } else {
                        alert('取消收藏失败：' + (data.error || '未知错误'));
                    }
                } catch (error) {
                    console.error('取消收藏失败:', error);
                    alert('网络错误，请稍后重试');
                }
            }
            
            // 公开removeFavorite函数，使其可以在HTML中直接调用
            window.removeFavorite = removeFavorite;
            
            // 加载AI回答相关的推荐资源
            async function loadRecommendedResources(aiAnswer) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/get-resources?text=${encodeURIComponent(aiAnswer)}`);
                    const data = await response.json();

                    // 有推荐资源时，添加到聊天框
                    if (data.resources && Array.isArray(data.resources) && data.resources.length > 0) {
                        const resourceMsgEl = document.createElement('div');
                        resourceMsgEl.className = 'resource-message';

                        // 拼接资源HTML
                        let resourcesHtml = `
                        <div style="margin-top: 2px; padding: 2px 6px; font-size: 0.85em;">
                            <strong style="font-size: 0.85em;">推荐学习资源：</strong><br>
                    `;
                        data.resources.forEach(res => {
                            resourcesHtml += `
                            <div style="margin: 2px 0; font-size: 0.8em;">
                                <a href="${res.url || '#'}" target="_blank" style="color: #3498db; text-decoration: none;">
                                    • ${res.title || '未命名资源'}
                                </a>
                                ${res.description ? `<div style="font-size: 0.75em; color: #666;">${res.description}</div>` : ''}
                            </div>
                        `;
                        });
                        resourcesHtml += '</div>';

                        resourceMsgEl.innerHTML = resourcesHtml;
                        chatMessages.appendChild(resourceMsgEl);
                        chatMessages.scrollTop = chatMessages.scrollHeight; // 滚动到底部
                    }
                } catch (error) {
                    console.error('推荐资源加载失败:', error);
                    // 不显示错误（避免影响用户体验）
                }
            }

            // 添加复制功能的CSS样式
            function addCopyStyles() {
                if (!document.getElementById('copy-styles')) {
                    const styleEl = document.createElement('style');
                    styleEl.id = 'copy-styles';
                    styleEl.textContent = `

                        
                        /* 浮动右键复制按钮 */
                        .floating-copy-button {
                            position: fixed;
                            color: white;
                            border: none;
                            border-radius: 12px;
                            padding: 4px 12px;
                            font-size: 12px;
                            cursor: pointer;
                            background: rgba(0, 0, 0, 0.7);
                            transition: background-color 0.2s;
                            z-index: 1000;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                        }
                        
                        .floating-copy-button:hover {
                            background: rgba(0, 0, 0, 0.9);
                        }
                        
                        .message {
                            position: relative;
                        }
                        
                        .message-content-wrapper {
                            position: relative;
                            z-index: 1;
                        }
                    `;
                    document.head.appendChild(styleEl);
                }
            }
            // 初始化复制样式
            addCopyStyles();
            
            // 复制文本到剪贴板的函数
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    // 可以添加一个短暂的成功提示
                }).catch(err => {
                    console.error('无法复制文本:', err);
                });
            }
            
            // 创建和管理浮动复制按钮
            function showFloatingCopyButton(x, y, messageText) {
                // 检查是否已存在浮动按钮，如果存在则移除
                let floatingBtn = document.getElementById('floating-copy-button');
                if (floatingBtn) {
                    document.body.removeChild(floatingBtn);
                }
                
                // 创建新的浮动按钮
                floatingBtn = document.createElement('button');
                floatingBtn.id = 'floating-copy-button';
                floatingBtn.className = 'floating-copy-button';
                floatingBtn.textContent = '复制';
                
                // 设置按钮位置（鼠标指针旁边）
                floatingBtn.style.left = (x + 10) + 'px';
                floatingBtn.style.top = (y + 10) + 'px';
                
                // 添加点击事件
                floatingBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // 阻止事件冒泡
                    copyToClipboard(messageText);
                    // 临时修改按钮文本表示已复制
                    const originalText = floatingBtn.textContent;
                    floatingBtn.textContent = '已复制';
                    setTimeout(() => {
                        if (document.body.contains(floatingBtn)) {
                            floatingBtn.textContent = originalText;
                        }
                    }, 1000);
                });
                
                // 添加到文档
                document.body.appendChild(floatingBtn);
                
                return floatingBtn;
            }
            
            // 隐藏浮动复制按钮
            function hideFloatingCopyButton() {
                const floatingBtn = document.getElementById('floating-copy-button');
                if (floatingBtn) {
                    document.body.removeChild(floatingBtn);
                }
            }
            
            // 处理右键菜单事件
            function handleRightClick(event, messageText) {
                event.preventDefault(); // 阻止默认右键菜单
                
                // 获取鼠标位置
                const x = event.clientX;
                const y = event.clientY;
                
                // 显示浮动复制按钮
                const floatingBtn = showFloatingCopyButton(x, y, messageText);
                
                // 添加点击其他区域时隐藏按钮的事件监听
                function handleClickOutside(event) {
                    // 如果点击的不是浮动按钮本身
                    if (event.target !== floatingBtn && !floatingBtn.contains(event.target)) {
                        hideFloatingCopyButton();
                        document.removeEventListener('click', handleClickOutside);
                    }
                }
                
                // 添加全局点击事件监听
                setTimeout(() => {
                    document.addEventListener('click', handleClickOutside);
                }, 0);
            }
            // 添加聊天消息到聊天框
            function addMessage(text, type, model = null) {
                // 创建消息容器
                const messageContainer = document.createElement('div');
                messageContainer.className = `message-container ${type}-message-container`;
                
                // 创建头像元素
                const avatarEl = document.createElement('div');
                avatarEl.className = 'message-avatar';
                
                // 设置不同的头像样式
                if (type === 'user') {
                    // 用户头像
                    avatarEl.style.backgroundColor = '#4CAF50';
                    avatarEl.textContent = '用户';
                } else {
                    // AI头像，根据模型类型区分
                    if (model === 'doubao') {
                        avatarEl.style.backgroundColor = '#2196F3';
                        avatarEl.textContent = '豆包';
                    } else {
                        // 默认DeepSeek头像
                        avatarEl.style.backgroundColor = '#FF9800';
                        avatarEl.textContent = 'DS';
                    }
                }
                
                // 创建消息内容元素
                const messageEl = document.createElement('div');
                messageEl.className = `message ${type}-message`;
                
                // 存储原始文本用于复制
                messageEl.dataset.originalText = text;
                
                // 添加右键菜单支持
                messageEl.addEventListener('contextmenu', (event) => {
                    handleRightClick(event, text);
                });
                
                // 创建内容包装器
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'message-content-wrapper';
                
                // 对AI消息进行特殊处理，确保只显示一次思考过程和正文解答
                if (type === 'ai') {
                    // 检查是否包含思考过程和正文解答的分隔符
                    let processedText = text;
                    if (text.includes('--------------------------------思考过程---------------------------------') && 
                        text.includes('-------------------------------正文解答--------------------------------')) {
                        // 已经有标准格式，添加可折叠功能
                        const thoughtStart = text.indexOf('--------------------------------思考过程---------------------------------');
                        const contentStart = text.indexOf('-------------------------------正文解答--------------------------------');
                        const thoughtContent = text.substring(thoughtStart, contentStart);
                        const answerContent = text.substring(contentStart);
                        
                        processedText = `<div class="thought-container"><div class="thought-header"><span class="thought-toggle" onclick="toggleThought(this)">▶</span>${thoughtContent.split('\n')[0]}</div><div class="thought-content" style="display: none;">${thoughtContent.replace(/\n/g, '<br>')}</div></div>${answerContent.replace(/\n/g, '<br>')}`;
                    } else if (text.includes('思考过程') && text.includes('正文解答')) {
                        // 如果包含思考过程和正文解答但格式不标准，提取关键内容并添加可折叠功能
                        const thoughtStart = text.indexOf('思考过程');
                        const contentStart = text.indexOf('正文解答');
                        if (thoughtStart !== -1 && contentStart !== -1) {
                            const thoughtContent = text.substring(thoughtStart, contentStart);
                            const answerContent = text.substring(contentStart);
                            
                            processedText = `<div class="thought-container"><div class="thought-header"><span class="thought-toggle" onclick="toggleThought(this)">▶</span>思考过程</div><div class="thought-content" style="display: none;">${thoughtContent.replace(/\n/g, '<br>')}</div></div>${answerContent.replace(/\n/g, '<br>')}`;
                        }
                    }
                    
                    // 使用innerHTML来保留格式和换行
                    contentWrapper.innerHTML = processedText;
                } else {
                    // 用户消息直接使用textContent
                    contentWrapper.textContent = text;
                }
                
                // 将内容包装器添加到消息元素
                messageEl.appendChild(contentWrapper);
                
                // 根据消息类型调整头像位置
                if (type === 'user') {
                    // 用户消息：先添加消息内容，再添加头像（头像在右侧）
                    messageContainer.appendChild(messageEl);
                    messageContainer.appendChild(avatarEl);
                } else {
                    // AI消息：先添加头像，再添加消息内容（头像在左侧）
                    messageContainer.appendChild(avatarEl);
                    messageContainer.appendChild(messageEl);
                }
                
                chatMessages.appendChild(messageContainer);

                // 自动滚动到最新消息
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // 创建一个新的聊天会话
            async function createNewChatSession() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/chat-records/new-session`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.session_id;
                    }
                    return null;
                } catch (error) {
                    console.error('创建会话失败:', error);
                    return null;
                }
            }
            
            // 保存聊天记录到服务器
            async function saveChatRecordToServer(sessionId, content, type, model) {
                try {
                    const senderType = type === 'user' ? 1 : 2;
                    const response = await fetch(`${API_BASE_URL}/api/chat-records/save`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        },
                        body: JSON.stringify({
                            content: content,
                            sender_type: senderType,
                            session_id: sessionId,
                            ai_model: model
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('保存聊天记录失败');
                    }
                    
                    const result = await response.json();
                    
                    // 保存成功后重新加载会话列表以更新显示
                    await loadChatSessionsFromServer();
                    
                    return result;
                } catch (error) {
                    console.error('保存聊天记录到服务器失败:', error);
                    return false;
                }
            }
            
            // ---------------------- 6. 聊天记录功能 ----------------------
            // 初始化历史记录功能
            function initHistoryFeature() {
                // 尝试从服务器获取聊天会话列表
                loadChatSessionsFromServer();
                
                // 绑定历史记录按钮点击事件
                historyBtn.addEventListener('click', openHistorySidebar);
                closeHistoryBtn.addEventListener('click', closeHistorySidebar);
                
                // 遮罩层点击事件 - 关闭任何打开的侧边栏
                sidebarOverlay.addEventListener('click', function() {
                    const historySidebar = document.getElementById('historySidebar');
                    const profileSidebar = document.getElementById('profileSidebar');
                    
                    if (historySidebar && historySidebar.classList.contains('open')) {
                        closeHistorySidebar();
                    } else if (profileSidebar && profileSidebar.classList.contains('open')) {
                        hideProfileSidebar();
                    }
                });
            }
            
            // 打开历史记录侧边栏
            function openHistorySidebar() {
                historySidebar.classList.add('open');
                sidebarOverlay.classList.add('show');
                document.body.style.overflow = 'hidden'; // 禁止页面滚动
            }
            
            // 关闭历史记录侧边栏
            function closeHistorySidebar() {
                historySidebar.classList.remove('open');
                sidebarOverlay.classList.remove('show');
                document.body.style.overflow = ''; // 恢复页面滚动
            }
            
            // 显示个人中心侧边栏
            function showProfileSidebar() {
                const profileSidebar = document.getElementById('profileSidebar');
                const sidebarOverlay = document.getElementById('sidebarOverlay');
                if (profileSidebar) {
                    profileSidebar.classList.add('open');
                    if (sidebarOverlay) {
                        sidebarOverlay.classList.add('show');
                    }
                    document.body.style.overflow = 'hidden'; // 禁止页面滚动
                }
            }
            
            // 隐藏个人中心侧边栏
            function hideProfileSidebar() {
                const profileSidebar = document.getElementById('profileSidebar');
                const sidebarOverlay = document.getElementById('sidebarOverlay');
                if (profileSidebar) {
                    profileSidebar.classList.remove('open');
                    if (sidebarOverlay) {
                        sidebarOverlay.classList.remove('show');
                    }
                    document.body.style.overflow = ''; // 恢复页面滚动
                }
            }
            
            // 从服务器加载聊天会话列表
            async function loadChatSessionsFromServer() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/chat-records/sessions`, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        chatSessions = {};
                        
                        // 初始化会话对象并为每个会话生成标题
                        for (const session of data.sessions) {
                            let title = '无标题对话';
                            if (session.last_message) {
                                // 调用后端AI生成标题
                                title = await generateAISessionTitle(session.last_message);
                            }
                            
                            chatSessions[session.session_id] = {
                                id: session.session_id,
                                title: title,
                                lastMessage: session.last_message,
                                lastMessageTime: session.last_message_time,
                                messages: []
                            };
                        }
                        
                        // 渲染会话列表
                        renderSessionsList();
                        
                        // 如果存在会话，并且当前没有选中的会话，则自动加载最近的会话
                        if (Object.keys(chatSessions).length > 0 && !currentSessionId) {
                            // 按时间倒序排列会话，获取最新的会话
                            const sortedSessions = Object.values(chatSessions).sort((a, b) => {
                                return new Date(b.lastMessageTime) - new Date(a.lastMessageTime);
                            });
                            
                            if (sortedSessions.length > 0) {
                                // 加载最新的会话
                                await loadAndShowSession(sortedSessions[0].id);
                            }
                        }
                    }
                } catch (error) {
                    console.error('从服务器加载会话列表失败:', error);
                }
            }
            
            // 调用后端AI生成会话标题
            async function generateTitleByBackendAI(message) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/generate-title`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        },
                        body: JSON.stringify({
                            message: message
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.title || message.substring(0, 40) + '...';
                    }
                    
                    // 后端调用失败时的回退方案
                    console.warn('后端生成标题失败，使用备用方案');
                    return generateAISessionTitle(message);
                } catch (error) {
                    console.error('调用后端AI生成标题失败:', error);
                    // 异常情况下的回退方案
                    return generateAISessionTitle(message);
                }
            }
            // AI自动生成会话标题
            function generateAISessionTitle(lastMessage) {
                // 如果消息太短，直接返回消息内容
                if (!lastMessage || lastMessage.length <= 20) {
                    return lastMessage || '无标题对话';
                }
                
                // 提取关键词作为标题基础
                const keywords = extractKeywords(lastMessage);
                
                // 根据关键词生成标题
                if (keywords.length > 0) {
                    // 组合关键词生成标题
                    const title = keywords.join(' ');
                    return title.length > 40 ? title.substring(0, 40) + '...' : title;
                }
                
                // 回退方案：截取前几个词作为标题
                const words = lastMessage.trim().split(/\s+/);
                if (words.length > 3) {
                    return words.slice(0, 3).join(' ') + '...';
                }
                
                // 最终回退
                return lastMessage.substring(0, 40) + '...';
            }

            // 从消息中提取关键词
            function extractKeywords(text) {
                // 移除常见停用词
                const stopwords = ['的', '了', '在', '是', '我', '有', '和', '就', '不', '人', '都', '一', '一个', '上', '也', '很', '到', '说', '要', '去', '你', '会', '着', '没有', '看', '好', '自己', '这'];
                
                // 分词并过滤
                const words = text.trim().split(/\s+/);
                const keywords = [];
                
                // 提取有意义的词作为关键词
                for (let i = 0; i < words.length && keywords.length < 5; i++) {
                    const word = words[i].replace(/[,.!?;：，。！？；]/g, '');
                    if (word.length > 1 && !stopwords.includes(word) && !keywords.includes(word)) {
                        keywords.push(word);
                    }
                }
                
                return keywords;
            }
            
            // 从服务器加载特定会话的聊天记录
            async function loadSessionMessagesFromServer(sessionId) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/chat-records/session/${sessionId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.messages;
                    }
                    return [];
                } catch (error) {
                    console.error('从服务器加载会话消息失败:', error);
                    return [];
                }
            }
            // 渲染会话列表
            function renderSessionsList() {
                historyList.innerHTML = '';
                
                // 添加新建会话按钮
                const newSessionBtn = document.createElement('div');
                newSessionBtn.className = 'history-item new-session-btn';
                newSessionBtn.innerHTML = `
                    <div style="text-align: center; padding: 10px;">
                        <span class="icon">+</span> 新建对话
                    </div>
                `;
                newSessionBtn.addEventListener('click', createNewSession);
                historyList.appendChild(newSessionBtn);
                
                if (Object.keys(chatSessions).length === 0) {
                    const emptyEl = document.createElement('div');
                    emptyEl.className = 'history-item';
                    emptyEl.style.textAlign = 'center';
                    emptyEl.style.color = '#999';
                    emptyEl.style.cursor = 'default';
                    emptyEl.style.borderLeft = 'none';
                    emptyEl.innerHTML = '暂无聊天记录';
                    historyList.appendChild(emptyEl);
                    return;
                }
                
                // 按时间倒序排列会话
                const sortedSessions = Object.values(chatSessions).sort((a, b) => {
                    return new Date(b.lastMessageTime) - new Date(a.lastMessageTime);
                });
                
                sortedSessions.forEach(session => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'history-item';
                    itemEl.innerHTML = `
                        <div class="history-question">${session.title}</div>
                        <div class="history-time">${session.lastMessageTime}</div>
                        <button class="delete-session-btn" data-session-id="${session.id}">×</button>
                    `;
                    
                    itemEl.addEventListener('click', (e) => {
                        // 避免点击删除按钮时触发显示会话
                        if (!e.target.closest('.delete-session-btn')) {
                            loadAndShowSession(session.id);
                            closeHistorySidebar();
                        }
                    });
                    
                    // 绑定删除按钮事件
                    const deleteBtn = itemEl.querySelector('.delete-session-btn');
                    deleteBtn.addEventListener('click', async (e) => {
                        e.stopPropagation(); // 阻止冒泡
                        await deleteSession(session.id);
                    });
                    
                    historyList.appendChild(itemEl);
                });
            }
            
            // 新建会话
            async function createNewSession() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/chat-records/new-session`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        currentSessionId = data.session_id;
                        
                        // 清空当前聊天框
                        chatMessages.innerHTML = '';
                        
                        // 重新加载会话列表
                        await loadChatSessionsFromServer();
                        
                        showSuccessMessage('已开始新对话');
                    }
                } catch (error) {
                    console.error('创建会话失败:', error);
                    showErrorMessage('创建会话失败');
                }
            }
            
            // 删除会话
            async function deleteSession(sessionId) {
                if (!confirm('确定要删除这个对话吗？')) {
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/chat-records/session/${sessionId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        }
                    });
                    
                    if (response.ok) {
                        // 如果删除的是当前会话，清空聊天框
                        if (sessionId === currentSessionId) {
                            currentSessionId = null;
                            chatMessages.innerHTML = '';
                        }
                        
                        // 重新加载会话列表
                        await loadChatSessionsFromServer();
                        
                        showSuccessMessage('对话已删除');
                    } else {
                        const data = await response.json();
                        showErrorMessage(data.error || '删除失败');
                    }
                } catch (error) {
                    console.error('删除会话失败:', error);
                    showErrorMessage('删除会话失败');
                }
            }
            
            // 加载并显示特定会话
            async function loadAndShowSession(sessionId) {
                // 显示加载状态
                chatMessages.innerHTML = '';
                const loadingEl = document.createElement('div');
                loadingEl.className = 'loading-indicator';
                loadingEl.textContent = '正在加载聊天记录...';
                chatMessages.appendChild(loadingEl);
                
                try {
                    const messages = await loadSessionMessagesFromServer(sessionId);
                    chatMessages.innerHTML = '';
                    
                    // 显示所有消息
                    messages.sort((a, b) => a.message_order - b.message_order).forEach(msg => {
                        const messageType = msg.sender_type === 1 ? 'user' : 'ai';
                        // 从消息中获取模型类型，如果没有则默认为deepseek
                        const modelType = msg.model || 'deepseek';
                        addMessage(msg.content, messageType, modelType);
                    });
                    
                    currentSessionId = sessionId;
                } catch (error) {
                    console.error('加载会话消息失败:', error);
                    chatMessages.innerHTML = '<div class="chat-error-message">加载聊天记录失败，请重试</div>';
                } finally {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
            
            // 显示成功消息
            function showSuccessMessage(message) {
                const messageEl = document.createElement('div');
                messageEl.className = 'success-message';
                messageEl.textContent = message;
                messageEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4caf50;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    z-index: 10000;
                    animation: fadeInOut 3s ease-in-out;
                `;
                document.body.appendChild(messageEl);
                
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 3000);
            }
            // 显示错误消息
            function showErrorMessage(message) {
                const messageEl = document.createElement('div');
                messageEl.className = 'error-message';
                messageEl.textContent = message;
                messageEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #f44336;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    z-index: 10000;
                    animation: fadeInOut 3s ease-in-out;
                `;
                document.body.appendChild(messageEl);
                
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 3000);
            }
            
            // 添加淡入淡出动画和消息样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translateY(-20px); }
                    10% { opacity: 1; transform: translateY(0); }
                    90% { opacity: 1; transform: translateY(0); }
                    100% { opacity: 0; transform: translateY(-20px); }
                }
                
                /* 消息容器样式 */
                .message-container {
                    display: flex;
                    margin-bottom: 15px;
                    animation: fadeInOut 0.3s ease-in-out;
                }
                
                /* 用户消息容器 */
                .user-message-container {
                    justify-content: flex-end;
                }
                
                /* AI消息容器 */
                .ai-message-container {
                    justify-content: flex-start;
                }
                
                /* 消息头像样式 */
                .message-avatar {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 14px;
                    font-weight: bold;
                    margin: 0 10px;
                    flex-shrink: 0;
                }
                
                /* 用户消息样式 */
                .message {
                    max-width: 70%;
                    padding: 12px;
                    border-radius: 12px;
                    word-wrap: break-word;
                    line-height: 1.5;
                }
                
                /* 用户消息 */
                .user-message {
                    background-color: #4CAF50;
                    color: white;
                    border-bottom-left-radius: 4px;
                }
                
                /* AI消息 */
                .ai-message {
                    background-color: #f1f1f1;
                    color: black;
                    border-bottom-left-radius: 4px;
                }
                
                /* 推荐学习资源消息 */
                .resource-message {
                    max-width: 55%;
                    padding: 6px;
                    margin-left: 60px;
                    background-color: #f9f9f9;
                    border-radius: 6px;
                    font-size: 0.85em;
                    border-left: 3px solid #3498db;
                }
                
                /* 思考内容容器样式 */
                .thought-container {
                    margin-bottom: 10px;
                }
                .thought-header {
                    display: flex;
                    align-items: center;
                    padding: 5px 10px;
                    background-color: #f5f5f5;
                    border-radius: 6px 6px 0 0;
                    cursor: pointer;
                    font-weight: bold;
                    color: #555;
                    font-size: 0.9em;
                }
                
                .thought-toggle {
                    margin-right: 4px;
                    font-size: 0.4em; /* 进一步调小按钮大小 */
                    color: #888;
                    cursor: pointer;
                    padding: 1px 2px;
                    border-radius: 2px;
                    transition: all 0.2s ease;
                    min-width: 12px;
                    display: inline-block;
                    text-align: center;
                }
                
                .thought-toggle:hover {
                    background-color: rgba(0, 0, 0, 0.05);
                    color: #555;
                }
                
                .thought-content {
                    padding: 10px;
                    background-color: #fafafa;
                    border: 1px solid #eee;
                    border-radius: 0 0 6px 6px;
                    font-size: 0.9em;
                    color: #666;
                    line-height: 1.5;
                }
            `;
            document.head.appendChild(style);
            
            // 显示历史聊天记录
            async function showChatFromHistory(chat) {
                // 清空当前聊天框
                chatMessages.innerHTML = '';
                
                // 显示加载状态
                const loadingEl = document.createElement('div');
                loadingEl.className = 'loading-indicator';
                loadingEl.textContent = '正在加载聊天记录...';
                chatMessages.appendChild(loadingEl);
                
                try {
                    // 仅从服务器加载会话记录
                    if (chat.sessionId) {
                        const messages = await loadSessionMessagesFromServer(chat.sessionId);
                        if (messages && messages.length > 0) {
                            // 清空加载状态
                            chatMessages.innerHTML = '';
                            
                            // 根据消息顺序显示所有消息
                            messages.sort((a, b) => a.message_order - b.message_order).forEach(msg => {
                                const messageType = msg.sender_type === 1 ? 'user' : 'ai';
                                // 从消息中获取模型类型，如果没有则默认为deepseek
                                const modelType = msg.model || 'deepseek';
                                addMessage(msg.content, messageType, modelType);
                            });
                            
                            // 滚动到底部
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    }
                } catch (error) {
                    console.error('加载聊天记录失败:', error);
                    chatMessages.innerHTML = '<div class="chat-error-message">加载聊天记录失败，请重试</div>';
                } finally {
                    // 滚动到底部
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }



        // 密码可见性切换功能
        // 切换思考内容的显示和隐藏
        function toggleThought(element) {
            const container = element.closest('.thought-container');
            const content = container.querySelector('.thought-content');
            const icon = element;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▼';
            } else {
                content.style.display = 'none';
                icon.textContent = '▶';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // 添加密码输入容器的样式
            const style = document.createElement('style');
            style.textContent = `
                .password-input-container {
                    position: relative;
                    display: flex;
                    align-items: center;
                }
                
                .password-input {
                    width: 100%;
                    padding-right: 45px; /* 为按钮留出空间 */
                }
                
                .toggle-password-btn {
                    position: absolute;
                    right: 10px;
                    background: none;
                    border: none;
                    font-size: 18px;
                    cursor: pointer;
                    padding: 5px;
                    border-radius: 4px;
                    transition: background-color 0.3s;
                }
                
                .toggle-password-btn:hover {
                    background-color: rgba(0, 0, 0, 0.05);
                }
            `;
            document.head.appendChild(style);
            
            // 为所有切换密码可见性的按钮添加点击事件
            document.querySelectorAll('.toggle-password-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const passwordInput = document.getElementById(targetId);
                    
                    // 切换密码可见性
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        this.textContent = '👁️‍🗨️';
                    } else {
                        passwordInput.type = 'password';
                        this.textContent = '👁️';
                    }
                });
            });
        });
        // 反馈系统相关功能
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const feedbackBtn = document.getElementById('feedbackBtn');
            const feedbackModal = document.getElementById('feedbackModal');
            const closeFeedbackBtn = document.getElementById('closeFeedbackBtn');
            const cancelFeedbackBtn = document.getElementById('cancelFeedbackBtn');
            const submitFeedbackBtn = document.getElementById('submitFeedbackBtn');
            const feedbackTypeOptions = document.querySelectorAll('.feedback-type-option');
            const feedbackTypeInput = document.getElementById('feedbackType');
            const feedbackContent = document.getElementById('feedbackContent');
            const feedbackStatus = document.getElementById('feedbackStatus');
            
            // 显示反馈模态框
            function showFeedbackModal() {
                feedbackModal.style.display = 'flex';
                feedbackContent.focus();
                resetFeedbackForm();
            }
            
            // 隐藏反馈模态框
            function hideFeedbackModal() {
                feedbackModal.style.display = 'none';
                resetFeedbackForm();
            }
            
            // 重置反馈表单
            function resetFeedbackForm() {
                feedbackTypeInput.value = '';
                feedbackContent.value = '';
                feedbackStatus.textContent = '';
                feedbackStatus.className = 'feedback-status';
                
                // 重置反馈类型选项的样式
                feedbackTypeOptions.forEach(option => {
                    option.classList.remove('selected');
                });
            }
            
            // 提交反馈
            async function submitFeedback() {
                const feedbackType = feedbackTypeInput.value;
                const content = feedbackContent.value.trim();
                
                if (!feedbackType) {
                    feedbackStatus.textContent = '请选择反馈类型';
                    feedbackStatus.className = 'feedback-status error';
                    return;
                }
                
                if (!content) {
                    feedbackStatus.textContent = '请输入反馈内容';
                    feedbackStatus.className = 'feedback-status error';
                    return;
                }
                
                const submitBtn = document.getElementById('submitFeedbackBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/feedback`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        },
                        body: JSON.stringify({
                            feedback_type: feedbackType,
                            content: content
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        feedbackStatus.textContent = '反馈提交成功，感谢您的建议！';
                        feedbackStatus.className = 'feedback-status success';
                        
                        // 清空表单
                        feedbackContent.value = '';
                        feedbackTypeInput.value = '';
                        // 清除所有选中状态
                        document.querySelectorAll('.feedback-type-option').forEach(option => {
                            option.classList.remove('selected');
                        });
                        
                        // 3秒后自动关闭模态框
                        setTimeout(() => {
                            hideFeedbackModal();
                        }, 3000);
                    } else {
                        feedbackStatus.textContent = result.detail || result.message || '提交失败，请稍后重试';
                        feedbackStatus.className = 'feedback-status error';
                    }
                } catch (error) {
                    console.error('提交反馈失败:', error);
                    feedbackStatus.textContent = '网络错误，请稍后重试';
                    feedbackStatus.className = 'feedback-status error';
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }
            
            // 用户设置相关函数
            const userSettingsModal = document.getElementById('userSettingsModal');
            const closeUserSettingsBtn = document.getElementById('closeUserSettingsBtn');
            
            function showUserSettingsModal() {
                userSettingsModal.style.display = 'flex';
                // 重置状态文本
                const statusElements = document.querySelectorAll('.feedback-status');
                statusElements.forEach(el => {
                    el.textContent = '';
                    el.className = 'feedback-status';
                });
                // 加载用户个人信息
                loadUserProfile();
                // 加载用户自定义模型
                loadUserCustomModels();
                // 加载设置项
                loadUserPreferences();
            }
            
            function hideUserSettingsModal() {
                userSettingsModal.style.display = 'none';
            }
            
            // 标签页切换功能
            function initSettingsTabs() {
                const tabs = document.querySelectorAll('.settings-tab');
                const panels = document.querySelectorAll('.settings-panel');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        const targetTab = this.getAttribute('data-tab');
                        
                        // 移除所有active类
                        tabs.forEach(t => t.classList.remove('active'));
                        panels.forEach(p => p.classList.remove('active'));
                        
                        // 添加active类
                        this.classList.add('active');
                        document.getElementById(`${targetTab}-panel`).classList.add('active');
                        
                        // 当点击AI模型标签时，自动刷新用户已添加的模型和加载AI设置
                        if (targetTab === 'ai-model') {
                            loadUserCustomModels();
                            loadAISettings(); // 加载用户的AI设置参数
                        }
                    });
                });
            }
            
            // 加载用户个人信息
            async function loadUserProfile() {
                const user = currentUser || await refreshCurrentUser({ applyUI: false, silent: true });

                const usernameInput = document.getElementById('settingsUsername');
                const emailInput = document.getElementById('settingsEmail');
                const settingsAvatarImg = document.getElementById('settingsAvatarImg');
                const settingsDeleteAvatarBtn = document.getElementById('settingsDeleteAvatarBtn');

                if (!usernameInput || !emailInput) {
                    return;
                }

                if (!user) {
                    usernameInput.value = '';
                    emailInput.value = '';
                    if (settingsAvatarImg) {
                        settingsAvatarImg.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22100%22%20height%3D%22100%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_18bc6f87a3f%20text%20%7B%20fill%3Argba(153%2C153%2C153%2C.5)%3Bfont-weight%3Anormal%3Bfont-family%3AHelvetica%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_18bc6f87a3f%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2235%22%20y%3D%2254%22%3E%E5%A4%B4%E5%83%8F%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';
                    }
                    if (settingsDeleteAvatarBtn) {
                        settingsDeleteAvatarBtn.style.display = 'none';
                    }
                    return;
                }

                usernameInput.value = user.username || '';
                emailInput.value = user.email || '';
                
                // 加载头像
                if (settingsAvatarImg) {
                    if (user.avatar) {
                        const avatarUrl = `${API_BASE_URL}${user.avatar}`;
                        settingsAvatarImg.src = avatarUrl;
                        if (settingsDeleteAvatarBtn) {
                            settingsDeleteAvatarBtn.style.display = 'flex';
                        }
                    } else {
                        settingsAvatarImg.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22100%22%20height%3D%22100%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_18bc6f87a3f%20text%20%7B%20fill%3Argba(153%2C153%2C153%2C.5)%3Bfont-weight%3Anormal%3Bfont-family%3AHelvetica%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_18bc6f87a3f%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2235%22%20y%3D%2254%22%3E%E5%A4%B4%E5%83%8F%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';
                        if (settingsDeleteAvatarBtn) {
                            settingsDeleteAvatarBtn.style.display = 'none';
                        }
                    }
                }
            }
            
            // 保存个人信息
            async function saveProfile() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    showStatus('profileStatus', '请先登录', 'error');
                    return;
                }
                
                const username = document.getElementById('settingsUsername').value.trim();
                
                if (!username || username.length < 3) {
                    showStatus('profileStatus', '用户名至少需要3个字符', 'error');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/users/profile`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username })
                    });

                    let result = {};
                    try {
                        result = await response.json();
                    } catch (parseError) {
                        if (!response.ok) {
                            throw new Error('保存失败，请稍后重试');
                        }
                    }

                    // 检查响应状态：HTTP 200-299 表示成功，或者 result.code === 200
                    if (response.ok && (result.code === 200 || result.code === undefined)) {
                        // 成功：使用后端返回的消息或默认成功消息
                        const successMessage = result.message || '个人信息保存成功';
                        showStatus('profileStatus', successMessage, 'success');
                    } else {
                        // 失败：显示错误消息
                        throw new Error(result.message || result.detail || '保存失败，请重试');
                    }

                    // 重新获取并刷新界面显示
                    const updatedUser = await refreshCurrentUser();
                    if (updatedUser) {
                        document.getElementById('settingsUsername').value = updatedUser.username || '';
                        document.getElementById('settingsEmail').value = updatedUser.email || '';
                    }
                } catch (error) {
                    console.error('保存个人信息失败:', error);
                    showStatus('profileStatus', error.message || '保存失败，请重试', 'error');
                }
            }
            // 修改密码
            function changePassword() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    showStatus('securityStatus', '请先登录', 'error');
                    return;
                }
                
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showStatus('securityStatus', '请填写所有密码字段', 'error');
                    return;
                }
                
                if (newPassword.length < 6) {
                    showStatus('securityStatus', '新密码至少需要6位', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showStatus('securityStatus', '两次输入的新密码不一致', 'error');
                    return;
                }
                
                fetch(`${API_BASE_URL}/api/users/change-password`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        old_password: currentPassword,
                        new_password: newPassword
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        showStatus('securityStatus', '密码修改成功，请重新登录', 'success');
                        // 清空密码字段
                        document.getElementById('currentPassword').value = '';
                        document.getElementById('newPassword').value = '';
                        document.getElementById('confirmPassword').value = '';
                        // 3秒后自动退出登录
                        setTimeout(() => {
                            logout();
                        }, 3000);
                    } else {
                        showStatus('securityStatus', data.message || '密码修改失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('修改密码失败:', error);
                    showStatus('securityStatus', '修改失败，请重试', 'error');
                });
            }
            // ==================== 自定义AI模型管理 ====================
            // 注：loadUserCustomModels 和 updateModelSelector 已定义在全局作用域中
            
            // 测试自定义模型
            async function testCustomModel(modelId) {
                // 找到对应的测试按钮并显示加载状态
                const testButtons = document.querySelectorAll(`button[onclick="testCustomModel(${modelId})"]`);
                let testBtn = null;
                
                testButtons.forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes(`testCustomModel(${modelId})`)) {
                        testBtn = btn;
                    }
                });
                
                if (testBtn) {
                    const originalText = testBtn.innerHTML;
                    testBtn.disabled = true;
                    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
                    testBtn.style.opacity = '0.7';
                }
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/custom-models/${modelId}/test`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // 显示成功消息
                        showTestResult('success', '✅ API连接测试成功！', '模型可以正常使用，响应时间: ' + (result.response_time || 'N/A'));
                    } else {
                        // 显示失败消息
                        showTestResult('error', '❌ API连接测试失败', result.message || '未知错误');
                    }
                    
                    // 刷新模型列表显示最新状态
                    await loadUserCustomModels();
                } catch (error) {
                    console.error('测试模型连接失败:', error);
                    showTestResult('error', '❌ 测试失败', error.message || '网络连接错误');
                } finally {
                    // 恢复按钮状态
                    if (testBtn) {
                        testBtn.disabled = false;
                        testBtn.innerHTML = '<i class="fas fa-plug"></i> 测试';
                        testBtn.style.opacity = '1';
                    }
                }
            }
            
            // 显示测试结果
            function showTestResult(type, title, message) {
                const isSuccess = type === 'success';
                const bgColor = isSuccess ? '#f0fdf4' : '#fef2f2';
                const borderColor = isSuccess ? '#10b981' : '#ef4444';
                const textColor = isSuccess ? '#059669' : '#dc2626';
                const icon = isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle';
                
                // 创建临时通知元素
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${bgColor};
                    border: 2px solid ${borderColor};
                    border-radius: 8px;
                    padding: 16px 20px;
                    max-width: 400px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    z-index: 10001;
                    animation: slideInRight 0.3s ease-out;
                `;
                
                notification.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <i class="fas ${icon}" style="color: ${textColor}; font-size: 20px; margin-top: 2px;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: ${textColor}; margin-bottom: 4px;">${title}</div>
                            <div style="font-size: 0.9rem; color: ${textColor}; opacity: 0.8;">${message}</div>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: ${textColor}; font-size: 18px; cursor: pointer; opacity: 0.7; padding: 0; margin-left: 8px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // 3秒后自动移除
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 3000);
            }
            
            // 注：deleteCustomModel 已定义在全局作用域中
            
            // 测试API连接（在添加前测试）
            async function testAPIConnection() {
                const modelName = document.getElementById('modelName').value.trim();
                const apiBase = document.getElementById('apiBase').value.trim();
                const apiKey = document.getElementById('apiKey').value.trim();
                
                if (!modelName || !apiBase || !apiKey) {
                    alert('请填写完整的模型信息（模型名称、API地址和API密钥）');
                    return;
                }
                
                const testBtn = document.getElementById('testAPIBtn');
                const originalText = testBtn.innerHTML;
                testBtn.disabled = true;
                testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
                
                let modelId = null;
                try {
                    // 检查模型是否已存在，不存在则添加
                    let checkResponse = await fetch(`${API_BASE_URL}/api/custom-models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        }
                    });
                    
                    let existingModels = [];
                    if (checkResponse.ok) {
                        const checkData = await checkResponse.json();
                        existingModels = checkData.models || [];
                    }
                    
                    // 查找是否有同名模型
                    let existingModel = existingModels.find(m => m.model_name === modelName);
                    
                    if (!existingModel) {
                        // 添加新模型
                        const addResponse = await fetch(`${API_BASE_URL}/api/custom-models`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                            },
                            body: JSON.stringify({
                                model_name: modelName,
                                model_display_name: modelName,
                                api_base_url: apiBase,
                                api_key: apiKey
                            })
                        });
                        
                        const addResult = await addResponse.json();
                        
                        if (!addResponse.ok || addResult.status !== 'success') {
                            alert('❌ 添加模型失败\n\n' + (addResult.message || '未知错误'));
                            return;
                        }
                        modelId = addResult.data.id;
                    } else {
                        modelId = existingModel.id;
                    }
                    
                    // 测试模型
                    const testResponse = await fetch(`${API_BASE_URL}/api/custom-models/${modelId}/test`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        }
                    });
                    
                    const testResult = await testResponse.json();
                    
                    if (testResult.status === 'success') {
                        alert('✅ API连接测试成功！\n\n模型已保存，可以正常使用');
                        testBtn.style.borderColor = '#10b981';
                        testBtn.style.color = '#059669';
                        setTimeout(() => {
                            testBtn.style.borderColor = '#4facfe';
                            testBtn.style.color = '#0284c7';
                        }, 2000);
                    } else {
                        alert('❌ API连接测试失败\n\n' + testResult.message);
                        // 如果是新创建的模型且测试失败，则删除它
                        if (!existingModel && modelId) {
                            await fetch(`${API_BASE_URL}/api/custom-models/${modelId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                                }
                            });
                        }
                    }
                    
                    await loadUserCustomModels();
                } catch (error) {
                    console.error('测试API连接失败:', error);
                    alert('❌ 测试失败\n\n' + error.message);
                    // 如果出错且是新创建的模型，则删除它
                    if (modelId) {
                        try {
                            await fetch(`${API_BASE_URL}/api/custom-models/${modelId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                                }
                            });
                        } catch (e) {
                            console.error('删除失败的模型失败:', e);
                        }
                    }
                } finally {
                    testBtn.disabled = false;
                    testBtn.innerHTML = originalText;
                }
            }
            
            // 添加自定义模型
            async function addCustomModel() {
                const modelName = document.getElementById('modelName').value.trim();
                const apiBase = document.getElementById('apiBase').value.trim();
                const apiKey = document.getElementById('apiKey').value.trim();
                
                if (!modelName || !apiBase || !apiKey) {
                    alert('请填写完整的模型信息（模型名称、API地址和API密钥）');
                    return;
                }
                
                // 验证模型名称格式
                if (modelName.includes(' ') || modelName.includes('模型') || modelName.includes('Model')) {
                    const confirmed = confirm('⚠️ 模型名称格式可能不正确\n\n检测到模型名称包含空格或描述性文字，这可能导致API调用失败。\n\n正确的模型名称示例：\n• deepseek-chat\n• gpt-3.5-turbo\n• claude-3-sonnet\n\n是否仍要继续添加？');
                    if (!confirmed) {
                        return;
                    }
                }
                
                // 检查是否为常见的错误名称
                const commonErrors = {
                    'deepseek': 'deepseek-chat',
                    'gpt3.5': 'gpt-3.5-turbo',
                    'gpt4': 'gpt-4',
                    'claude3': 'claude-3-sonnet'
                };
                
                if (commonErrors[modelName.toLowerCase()]) {
                    const suggested = commonErrors[modelName.toLowerCase()];
                    const confirmed = confirm(`⚠️ 建议修正模型名称\n\n您输入的 "${modelName}" 可能不正确\n建议使用：${suggested}\n\n是否自动修正？`);
                    if (confirmed) {
                        document.getElementById('modelName').value = suggested;
                        return; // 让用户重新点击添加
                    }
                }
                
                const addBtn = document.getElementById('addModelBtn');
                const originalText = addBtn.innerHTML;
                addBtn.disabled = true;
                addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 添加中...';
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/custom-models`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        },
                        body: JSON.stringify({
                            model_name: modelName,
                            model_display_name: modelName,
                            api_base_url: apiBase,
                            api_key: apiKey
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.status === 'success') {
                        alert('✅ 模型添加成功！');
                        // 清空表单
                        document.getElementById('modelName').value = '';
                        document.getElementById('apiBase').value = '';
                        document.getElementById('apiKey').value = '';
                        // 刷新模型列表
                        await loadUserCustomModels();
                    } else {
                        alert('❌ 添加失败\n\n' + result.message);
                    }
                } catch (error) {
                    console.error('添加自定义模型失败:', error);
                    alert('❌ 添加失败\n\n' + error.message);
                } finally {
                    addBtn.disabled = false;
                    addBtn.innerHTML = originalText;
                }
            }
            
            // 模型名称建议和验证功能
            function showModelNameSuggestions() {
                const suggestions = document.getElementById('modelNameSuggestions');
                if (suggestions) {
                    suggestions.style.display = 'block';
                }
            }
            
            function hideModelNameSuggestions() {
                // 延迟隐藏，允许点击建议项
                setTimeout(() => {
                    const suggestions = document.getElementById('modelNameSuggestions');
                    if (suggestions) {
                        suggestions.style.display = 'none';
                    }
                }, 200);
            }
            
            function selectModelName(modelName) {
                const input = document.getElementById('modelName');
                if (input) {
                    input.value = modelName;
                    validateModelName(input);
                }
                hideModelNameSuggestions();
            }
            
            function validateModelName(input) {
                const value = input.value.trim();
                const commonModels = [
                    'deepseek-chat', 'deepseek-reasoner', 
                    'gpt-3.5-turbo', 'gpt-4', 'gpt-4-turbo', 'gpt-4o',
                    'claude-3-sonnet', 'claude-3-opus', 'claude-3-haiku'
                ];
                
                // 重置样式
                input.style.borderColor = '#e5e7eb';
                
                if (value.length > 0) {
                    if (commonModels.includes(value)) {
                        // 已知的正确模型名称
                        input.style.borderColor = '#10b981';
                        input.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
                    } else if (value.includes(' ') || value.includes('模型') || value.includes('Model')) {
                        // 可能的错误格式
                        input.style.borderColor = '#ef4444';
                        input.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                    } else {
                        // 自定义模型名称
                        input.style.borderColor = '#f59e0b';
                        input.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.1)';
                    }
                }
            }
            
            // 加载用户的自定义模型            
            // 注：loadUserCustomModels, displayCustomModels, useModel, updateModelSelector 已定义在全局作用域中
            
            // ==================== END 自定义AI模型管理 ====================
            
            // 保存AI设置
            function saveAISettings() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    showStatus('aiSettingsStatus', '请先登录', 'error');
                    return;
                }
                
                console.log('开始保存AI设置...');
                
                // 检查JSON格式是否正确
                let modelParams = null;
                const paramsText = document.getElementById('modelParams').value.trim();
                if (paramsText) {
                    // 检查是否是 "[object Object]" 字符串（说明之前设置错误）
                    if (paramsText === '[object Object]') {
                        console.error('modelParams 格式错误: 检测到 "[object Object]" 字符串');
                        showStatus('aiSettingsStatus', '模型参数格式错误，请重新加载设置', 'error');
                        return;
                    }
                    try {
                        modelParams = JSON.parse(paramsText);
                    } catch (e) {
                        console.error('JSON格式错误:', e);
                        showStatus('aiSettingsStatus', '模型参数JSON格式错误', 'error');
                        return;
                    }
                }
                
                // 获取API密钥，如果是掩码或空字符串，则不发送该字段（保持现有值）
                const apiKeyValue = document.getElementById('apiKey').value;
                const apiKeyMask = '•••••••••••••••';
                
                // 确保 model_params 是有效的JSON字符串
                let modelParamsString = null;
                if (modelParams && typeof modelParams === 'object') {
                    // 如果解析成功得到对象，转换为JSON字符串
                    modelParamsString = JSON.stringify(modelParams);
                } else if (paramsText && paramsText.trim() !== '' && paramsText !== '[object Object]') {
                    // 如果 paramsText 是有效的JSON字符串，直接使用
                    modelParamsString = paramsText.trim();
                }
                
                const settings = {
                    model_name: document.getElementById('modelName').value || null,
                    api_base: document.getElementById('apiBase').value || null,
                    model_params: modelParamsString || null // 确保是有效的JSON字符串
                };
                
                // 只有当用户实际输入了新密钥时才发送api_key字段
                if (apiKeyValue && apiKeyValue !== apiKeyMask && apiKeyValue.trim() !== '') {
                    settings.api_key = apiKeyValue;
                    console.log('用户输入了新的API密钥');
                }
                // 如果apiKeyValue是空字符串，说明用户想清空密钥，发送null
                else if (apiKeyValue === '' || apiKeyValue.trim() === '') {
                    settings.api_key = null;
                    console.log('用户清空了API密钥');
                }
                // 如果是掩码，不发送api_key字段，让后端保持现有值
                else {
                    console.log('保留现有的API密钥');
                }
                
                console.log('发送的设置数据:', settings);
                
                fetch(`${API_BASE_URL}/api/settings`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                })
                .then(response => {
                    console.log('API响应状态:', response.status, response.statusText);
                    
                    if (response.ok) {
                        return response.json().then(data => {
                            console.log('API返回的数据:', data);
                            console.log('API返回数据类型检查:', {
                                type: typeof data,
                                isObject: data && typeof data === 'object',
                                keys: data && typeof data === 'object' ? Object.keys(data) : 'N/A'
                            });
                            
                            // 直接从响应数据更新UI，确保显示最新值
                            if (data && typeof data === 'object') {
                                // 更新模型名称
                                const modelNameInput = document.getElementById('modelName');
                                if (modelNameInput && data.model_name !== undefined) {
                                    modelNameInput.value = data.model_name || '';
                                    console.log('已更新modelName:', modelNameInput.value);
                                }
                                
                                // 更新API地址
                                const apiBaseInput = document.getElementById('apiBase');
                                if (apiBaseInput && data.api_base !== undefined) {
                                    apiBaseInput.value = data.api_base || '';
                                    console.log('已更新apiBase:', apiBaseInput.value);
                                }
                                
                                // 更新API密钥显示
                                const apiKeyInput = document.getElementById('apiKey');
                                if (apiKeyInput) {
                                    if (data.api_key) {
                                        apiKeyInput.value = '•••••••••••••••';
                                    } else {
                                        apiKeyInput.value = '';
                                    }
                                    console.log('已更新apiKey掩码');
                                }
                                
                                // 更新模型参数
                                if (data.model_params !== undefined) {
                                    try {
                                        const modelParamsInput = document.getElementById('modelParams');
                                        if (modelParamsInput) {
                                            // 确保存储为 JSON 字符串格式
                                            const paramsString = typeof data.model_params === 'string' 
                                                ? data.model_params 
                                                : JSON.stringify(data.model_params);
                                            modelParamsInput.value = paramsString;
                                            console.log('已更新modelParams:', paramsString);
                                        }
                                        
                                        // 解析并更新参数滑块
                                        const params = typeof data.model_params === 'string' 
                                            ? JSON.parse(data.model_params) 
                                            : data.model_params;
                                        if (params.temperature !== undefined) {
                                            const tempSlider = document.getElementById('temperature');
                                            const tempValue = document.getElementById('tempValue');
                                            if (tempSlider && tempValue) {
                                                tempSlider.value = params.temperature;
                                                tempValue.textContent = params.temperature.toFixed(1);
                                                console.log('已更新temperature:', params.temperature);
                                            }
                                        }
                                        if (params.max_tokens !== undefined) {
                                            const tokensSlider = document.getElementById('maxTokens');
                                            const tokensValue = document.getElementById('tokensValue');
                                            if (tokensSlider && tokensValue) {
                                                tokensSlider.value = params.max_tokens;
                                                tokensValue.textContent = params.max_tokens;
                                                console.log('已更新maxTokens:', params.max_tokens);
                                            }
                                        }
                                        if (params.top_p !== undefined) {
                                            const topPSlider = document.getElementById('topP');
                                            const topPValue = document.getElementById('topPValue');
                                            if (topPSlider && topPValue) {
                                                topPSlider.value = params.top_p;
                                                topPValue.textContent = params.top_p.toFixed(1);
                                                console.log('已更新topP:', params.top_p);
                                            }
                                        }
                                    } catch (e) {
                                        console.error('解析返回的modelParams失败:', e);
                                    }
                                }
                            }
                            
                            showStatus('aiSettingsStatus', 'AI设置保存成功', 'success');
                        }).catch(parseError => {
                            console.error('解析响应JSON失败:', parseError);
                            showStatus('aiSettingsStatus', 'AI设置保存成功但响应解析失败', 'success');
                            // 即使解析失败，也尝试重新加载一次
                            setTimeout(() => loadAISettings(), 500);
                        });
                    } else {
                        return response.json().then(data => {
                            console.error('API返回的错误数据:', data);
                            const errorMsg = data.detail || 'AI设置保存失败';
                            showStatus('aiSettingsStatus', errorMsg, 'error');
                        }).catch(() => {
                            console.error('错误响应解析失败');
                            showStatus('aiSettingsStatus', 'AI设置保存失败', 'error');
                        });
                    }
                })
                .catch(error => {
                    console.error('保存AI设置请求失败:', error);
                    showStatus('aiSettingsStatus', `保存失败: ${error.message}`, 'error');
                });
            }
            
            // 实时更新模型参数
            function updateModelParams() {
                console.log('updateModelParams 被调用');
                const temperature = parseFloat(document.getElementById('temperature').value);
                const maxTokens = parseInt(document.getElementById('maxTokens').value);
                const topP = parseFloat(document.getElementById('topP').value);
                
                console.log('当前参数值:', { temperature, maxTokens, topP });
                
                // 更新显示值
                document.getElementById('tempValue').textContent = temperature.toFixed(1);
                document.getElementById('tokensValue').textContent = maxTokens;
                document.getElementById('topPValue').textContent = topP.toFixed(1);
                
                // 更新隐藏字段
                const params = {
                    temperature: temperature,
                    max_tokens: maxTokens,
                    top_p: topP
                };
                document.getElementById('modelParams').value = JSON.stringify(params);
                console.log('已更新modelParams隐藏字段:', JSON.stringify(params));
                
                // 触发自动保存
                console.log('触发自动保存...');
                autoSaveAISettings();
            }
            
            // 自动保存函数（静默保存，不显示状态消息）
            let saveTimeout;
            let isSaving = false;
            function autoSaveAISettings() {
                // 清除之前的定时器
                clearTimeout(saveTimeout);
                // 设置新的定时器，延迟800ms保存，避免频繁请求
                saveTimeout = setTimeout(() => {
                    if (isSaving) return; // 如果正在保存，跳过
                    isSaving = true;
                    
                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        isSaving = false;
                        return;
                    }
                    
                    // 获取当前参数值
                    const temperature = parseFloat(document.getElementById('temperature').value);
                    const maxTokens = parseInt(document.getElementById('maxTokens').value);
                    const topP = parseFloat(document.getElementById('topP').value);
                    
                    const modelParams = {
                        temperature: temperature,
                        max_tokens: maxTokens,
                        top_p: topP
                    };
                    
                    const settings = {
                        model_params: JSON.stringify(modelParams)
                    };
                    
                    console.log('自动保存模型参数:', settings);
                    console.log('发送的model_params值:', settings.model_params);
                    
                    fetch(`${API_BASE_URL}/api/settings`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(settings)
                    })
                    .then(response => {
                        console.log('自动保存响应状态:', response.status, response.statusText);
                        if (response.ok) {
                            return response.json().then(data => {
                                console.log('模型参数自动保存成功，返回数据:', data);
                                console.log('返回的model_params:', data.model_params);
                                console.log('返回的model_params类型:', typeof data.model_params);
                                
                                // 验证返回的数据是否包含model_params
                                if (data.model_params) {
                                    console.log('✓ model_params已成功保存并返回');
                                } else {
                                    console.warn('⚠ 返回的数据中没有model_params字段');
                                }
                                
                                // 静默保存，不显示状态消息
                                isSaving = false;
                            });
                        } else {
                            return response.json().then(data => {
                                console.error('模型参数自动保存失败:', data);
                                isSaving = false;
                            });
                        }
                    })
                    .catch(error => {
                        console.error('自动保存请求失败:', error);
                        isSaving = false;
                    });
                }, 800);
            }
            
            // 为滑块添加事件监听器（直接绑定，不依赖DOMContentLoaded）
            function attachSliderListeners() {
                const temperatureSlider = document.getElementById('temperature');
                const maxTokensSlider = document.getElementById('maxTokens');
                const topPSlider = document.getElementById('topP');
                
                console.log('尝试绑定滑块事件监听器...');
                console.log('找到的滑块元素:', {
                    temperature: !!temperatureSlider,
                    maxTokens: !!maxTokensSlider,
                    topP: !!topPSlider
                });
                
                if (temperatureSlider) {
                    temperatureSlider.addEventListener('input', function(e) {
                        console.log('温度滑块输入事件:', e.target.value);
                        updateModelParams();
                    });
                    console.log('✓ 已绑定温度滑块事件');
                }
                
                if (maxTokensSlider) {
                    maxTokensSlider.addEventListener('input', function(e) {
                        console.log('最大tokens滑块输入事件:', e.target.value);
                        updateModelParams();
                    });
                    console.log('✓ 已绑定最大tokens滑块事件');
                }
                
                if (topPSlider) {
                    topPSlider.addEventListener('input', function(e) {
                        console.log('top_p滑块输入事件:', e.target.value);
                        updateModelParams();
                    });
                    console.log('✓ 已绑定top_p滑块事件');
                }
            }
            
            // 在document加载完成后绑定监听器
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', attachSliderListeners);
            } else {
                // 如果已经加载完成，立即绑定
                attachSliderListeners();
            }
            
            // 保存通知设置
            function saveNotifications() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    showStatus('notificationsStatus', '请先登录', 'error');
                    return;
                }
                
                const settings = {
                    system_notifications: document.getElementById('systemNotifications').checked,
                    learning_reminders: document.getElementById('learningReminders').checked,
                    email_notifications: document.getElementById('emailNotifications').checked
                };
                
                // 保存到本地存储
                localStorage.setItem('notificationSettings', JSON.stringify(settings));
                showStatus('notificationsStatus', '通知设置保存成功', 'success');
            }
            // 保存隐私设置
            function savePrivacy() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    showStatus('privacyStatus', '请先登录', 'error');
                    return;
                }
                
                const settings = {
                    data_analytics: document.getElementById('dataAnalytics').checked,
                    save_chat_history: document.getElementById('saveChatHistory').checked
                };
                
                // 保存到本地存储
                localStorage.setItem('privacySettings', JSON.stringify(settings));
                showStatus('privacyStatus', '隐私设置保存成功', 'success');
            }
            
            // 导出用户数据
            function exportData() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('请先登录');
                    return;
                }
                
                if (confirm('确定要导出所有用户数据吗？这可能需要一些时间。')) {
                    showStatus('privacyStatus', '正在导出数据...', 'info');
                    
                    fetch(`${API_BASE_URL}/api/users/export`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `user_data_${new Date().getTime()}.json`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        showStatus('privacyStatus', '数据导出成功', 'success');
                    })
                    .catch(error => {
                        console.error('导出数据失败:', error);
                        showStatus('privacyStatus', '导出失败，请重试', 'error');
                    });
                }
            }
            
            // 清除聊天记录
            function clearHistory() {
                if (confirm('确定要清除所有聊天记录吗？此操作不可恢复！')) {
                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        alert('请先登录');
                        return;
                    }
                    
                    fetch(`${API_BASE_URL}/api/chat/history/clear`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 200) {
                            showStatus('privacyStatus', '聊天记录已清除', 'success');
                            // 清空聊天界面
                            document.getElementById('chatMessages').innerHTML = '';
                        } else {
                            showStatus('privacyStatus', data.message || '清除失败', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('清除聊天记录失败:', error);
                        showStatus('privacyStatus', '清除失败，请重试', 'error');
                    });
                }
            }
            
            // 加载用户AI设置
            async function loadAISettings() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    console.log('用户未登录，不加载AI设置');
                    return; // 用户未登录，不加载设置
                }
                
                try {
                    console.log('开始加载AI设置...');
                    const response = await fetch(`${API_BASE_URL}/api/settings`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('获取AI设置响应状态:', response.status);
                    
                    if (!response.ok) {
                        // 如果没有设置记录(404)，不显示错误
                        if (response.status !== 404) {
                            console.error('获取AI设置失败:', response.status);
                        }
                        return;
                    }
                    
                    // 处理非JSON响应
                    let data;
                    try {
                        data = await response.json();
                        console.log('解析AI设置响应成功:', data);
                        console.log('返回数据的所有字段:', Object.keys(data));
                        console.log('model_params字段:', data.model_params);
                        console.log('model_params类型:', typeof data.model_params);
                    } catch (parseError) {
                        console.error('解析AI设置响应失败:', parseError);
                        return;
                    }
                    
                    // 验证数据格式
                    if (!data || typeof data !== 'object') {
                        console.error('AI设置数据格式无效:', data);
                        return;
                    }
                    
                    // 应用模型参数设置
                    if (data.model_params) {
                        console.log('✓ 找到model_params字段，开始应用设置');
                        try {
                            console.log('解析modelParams:', data.model_params);
                            // 检查 model_params 是否已经是对象，如果是字符串才需要解析
                            let modelParams;
                            if (typeof data.model_params === 'string') {
                                modelParams = JSON.parse(data.model_params);
                            } else {
                                modelParams = data.model_params; // 已经是对象，直接使用
                            }
                            console.log('解析后的modelParams:', modelParams);
                            
                            // 更新滑块值和显示
                            if (modelParams.temperature !== undefined) {
                                const tempSlider = document.getElementById('temperature');
                                const tempValue = document.getElementById('tempValue');
                                if (tempSlider && tempValue) {
                                    tempSlider.value = modelParams.temperature;
                                    tempValue.textContent = modelParams.temperature.toFixed(1);
                                    console.log('已更新temperature:', modelParams.temperature);
                                }
                            }
                            
                            if (modelParams.max_tokens !== undefined) {
                                const tokensSlider = document.getElementById('maxTokens');
                                const tokensValue = document.getElementById('tokensValue');
                                if (tokensSlider && tokensValue) {
                                    tokensSlider.value = modelParams.max_tokens;
                                    tokensValue.textContent = modelParams.max_tokens;
                                    console.log('已更新maxTokens:', modelParams.max_tokens);
                                }
                            }
                            
                            if (modelParams.top_p !== undefined) {
                                const topPSlider = document.getElementById('topP');
                                const topPValue = document.getElementById('topPValue');
                                if (topPSlider && topPValue) {
                                    topPSlider.value = modelParams.top_p;
                                    topPValue.textContent = modelParams.top_p.toFixed(1);
                                    console.log('已更新topP:', modelParams.top_p);
                                }
                            }
                            
                            // 更新隐藏字段
                            const modelParamsInput = document.getElementById('modelParams');
                            if (modelParamsInput) {
                                // 确保存储为 JSON 字符串格式
                                const paramsString = typeof data.model_params === 'string' 
                                    ? data.model_params 
                                    : JSON.stringify(data.model_params);
                                modelParamsInput.value = paramsString;
                                console.log('已更新modelParams隐藏字段:', paramsString);
                            }
                        } catch (parseError) {
                            console.error('解析模型参数失败:', parseError);
                        }
                    } else {
                        console.warn('⚠ 未找到model_params字段，使用默认值');
                        console.log('返回的数据:', data);
                        console.log('可用的字段:', Object.keys(data));
                    }
                    
                    // 应用其他设置（即使值为空也要设置，确保显示正确）
                    const modelNameInput = document.getElementById('modelName');
                    if (modelNameInput) {
                        modelNameInput.value = data.model_name || '';
                        console.log('已更新modelName:', modelNameInput.value);
                    }
                    
                    const apiBaseInput = document.getElementById('apiBase');
                    if (apiBaseInput) {
                        apiBaseInput.value = data.api_base || '';
                        console.log('已更新apiBase:', apiBaseInput.value);
                    }
                    
                    // API密钥以掩码形式显示（如果存在）
                    const apiKeyInput = document.getElementById('apiKey');
                    if (apiKeyInput) {
                        // 如果后端返回了api_key（即使是掩码），说明用户已设置过密钥
                        if (data.api_key) {
                            apiKeyInput.value = '•••••••••••••••';
                            console.log('已更新apiKey为掩码');
                        } else {
                            // 如果没有api_key，清空输入框
                            apiKeyInput.value = '';
                            console.log('清空了apiKey');
                        }
                    }
                    
                    console.log('AI设置加载完成:', {
                        model_name: data.model_name,
                        api_base: data.api_base,
                        has_api_key: !!data.api_key,
                        model_params: data.model_params
                    });
                } catch (error) {
                    console.error('加载AI设置时出错:', error);
                }
            }
            
            // 加载用户偏好设置
            function loadUserPreferences() {
                // 加载通知设置
                const notificationSettings = JSON.parse(localStorage.getItem('notificationSettings') || '{}');
                if (notificationSettings.system_notifications !== undefined) {
                    document.getElementById('systemNotifications').checked = notificationSettings.system_notifications;
                }
                if (notificationSettings.learning_reminders !== undefined) {
                    document.getElementById('learningReminders').checked = notificationSettings.learning_reminders;
                }
                if (notificationSettings.email_notifications !== undefined) {
                    document.getElementById('emailNotifications').checked = notificationSettings.email_notifications;
                }
                
                // 加载隐私设置
                const privacySettings = JSON.parse(localStorage.getItem('privacySettings') || '{}');
                if (privacySettings.data_analytics !== undefined) {
                    document.getElementById('dataAnalytics').checked = privacySettings.data_analytics;
                }
                if (privacySettings.save_chat_history !== undefined) {
                    document.getElementById('saveChatHistory').checked = privacySettings.save_chat_history;
                }
                
                // 加载AI设置
                loadAISettings();
            }
            
            // 显示状态消息
            function showStatus(elementId, message, type) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = message;
                    element.className = `feedback-status ${type}`;
                    // 3秒后清除消息
                    setTimeout(() => {
                        element.textContent = '';
                        element.className = 'feedback-status';
                    }, 3000);
                }
            }
            
            // 初始化标签页
            initSettingsTabs();
            
            // 绑定保存按钮事件
            document.getElementById('saveProfileBtn')?.addEventListener('click', saveProfile);
            document.getElementById('changePasswordBtn')?.addEventListener('click', changePassword);
            // 保存按钮已移除，改为实时自动保存
            // document.getElementById('saveAISettingsBtn')?.addEventListener('click', saveAISettings);
            document.getElementById('saveNotificationsBtn')?.addEventListener('click', saveNotifications);
            document.getElementById('savePrivacyBtn')?.addEventListener('click', savePrivacy);
            document.getElementById('exportDataBtn')?.addEventListener('click', exportData);
            
            // 自定义AI模型相关事件
            document.getElementById('testAPIBtn')?.addEventListener('click', testAPIConnection);
            document.getElementById('addModelBtn')?.addEventListener('click', addCustomModel);
            
            // 模型建议按钮点击事件
            document.querySelectorAll('.model-suggestion').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('modelName').value = this.dataset.model;
                });
            });
            // 页面加载时加载用户的自定义模型
            loadUserCustomModels();
            document.getElementById('clearHistoryBtn')?.addEventListener('click', clearHistory);
            
            // 添加课程资源按钮点击事件
            const showAddResourceBtn = document.getElementById('showAddResourceBtn');
            if (showAddResourceBtn) {
                showAddResourceBtn.addEventListener('click', function() {
                    const addResourceModal = document.getElementById('addResourceModal');
                    if (addResourceModal) {
                        addResourceModal.style.display = 'flex';
                        hideProfileSidebar();
                    }
                });
            }
            
            // 关闭添加资源模态框函数
            function hideAddResourceModal() {
                const addResourceModal = document.getElementById('addResourceModal');
                if (addResourceModal) {
                    addResourceModal.style.display = 'none';
                }
            }
            
            // 点击模态框关闭按钮关闭
            const closeAddResourceBtn = document.querySelector('#addResourceModal .close-feedback-btn');
            if (closeAddResourceBtn) {
                closeAddResourceBtn.addEventListener('click', hideAddResourceModal);
            }
            
            // 点击模态框背景关闭
            const addResourceModal = document.getElementById('addResourceModal');
            if (addResourceModal) {
                addResourceModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideAddResourceModal();
                    }
                });
            }
            
            // 添加资源表单提交
            addResourceForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // 清除之前的错误信息
                document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
                document.getElementById('addResourceFormFeedback').textContent = '';
                
                // 获取表单数据
                const category = document.getElementById('resourceCategory').value.trim();
                const title = document.getElementById('resourceTitle').value.trim();
                const url = document.getElementById('resourceUrl').value.trim();
                const description = document.getElementById('resourceDesc').value.trim();
                
                // 简单验证
                let isValid = true;
                
                if (!category) {
                    document.getElementById('resourceCategoryError').textContent = '请输入资源分类';
                    isValid = false;
                }
                
                if (!title) {
                    document.getElementById('resourceTitleError').textContent = '请输入资源标题';
                    isValid = false;
                }
                
                if (!url) {
                    document.getElementById('resourceUrlError').textContent = '请输入资源链接';
                    isValid = false;
                } else {
                    try {
                        new URL(url);
                    } catch (e) {
                        document.getElementById('resourceUrlError').textContent = '请输入有效的URL';
                        isValid = false;
                    }
                }
                
                if (!isValid) return;
                
                // 获取token
                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('请先登录');
                    return;
                }
                
                try {
                    // 发送API请求
                    const response = await fetch(`${API_BASE_URL}/api/resources`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            category_name: category,
                            title: title,
                            url: url,
                            description: description
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // 显示成功消息
                        document.getElementById('addResourceFormFeedback').textContent = '资源添加成功！';
                        document.getElementById('addResourceFormFeedback').style.color = 'var(--success-color)';
                        
                        // 重置表单
                        addResourceForm.reset();
                        
                        // 延迟关闭模态框
                        setTimeout(hideAddResourceModal, 1500);
                        
                        // 重新加载资源列表
                        await loadResources();
                    } else {
                        // 显示错误消息
                        document.getElementById('addResourceFormFeedback').textContent = data.error || '添加失败，请稍后重试';
                        document.getElementById('addResourceFormFeedback').style.color = 'var(--accent-color)';
                    }
                } catch (error) {
                    console.error('添加资源失败:', error);
                    document.getElementById('addResourceFormFeedback').textContent = '网络错误，请稍后重试';
                    document.getElementById('addResourceFormFeedback').style.color = 'var(--accent-color)';
                }
             });
            // 退出登录按钮点击事件
            document.getElementById('logoutBtn').addEventListener('click', function() {
                //hideProfileSidebar(); // 先关闭个人中心侧边栏
                handleLogout(); // 执行退出登录操作
            });
               // 个人中心按钮点击事件 - 添加存在性检查
            if (document.getElementById('profileBtn')) {
                document.getElementById('profileBtn').addEventListener('click', function() {
                    showProfileSidebar();
                });
            }
            
            // 关闭个人中心侧边栏按钮事件
            if (document.getElementById('closeProfileBtn')) {
                document.getElementById('closeProfileBtn').addEventListener('click', function() {
                    hideProfileSidebar();
                });
            }
            
            if (document.getElementById('profileBtn1')) {
                document.getElementById('profileBtn1').addEventListener('click', function() {
                    alert('个人信息管理功能即将开发');
                    hideProfileSidebar();
                });
            }
            if (document.getElementById('profileBtn2')) {
                document.getElementById('profileBtn2').addEventListener('click', function() {
                    alert('学习记录查看功能即将开发');
                    hideProfileSidebar();
                });
            }
            if (document.getElementById('profileBtn3')) {
                document.getElementById('profileBtn3').addEventListener('click', function() {
                    alert('系统设置功能即将开发');
                    hideProfileSidebar();
                });
            }
            // 提交反馈按钮点击事件 - 添加存在性检查
            if (document.getElementById('profileFeedbackBtn')) {
                document.getElementById('profileFeedbackBtn').addEventListener('click', function() {
                    hideProfileSidebar(); // 先关闭个人中心侧边栏
                    showFeedbackModal(); // 再显示反馈模态框
                });
            }
            
            // 用户设置按钮点击事件
            if (document.getElementById('userSettingsBtn')) {
                document.getElementById('userSettingsBtn').addEventListener('click', function() {
                    hideProfileSidebar(); // 先关闭个人中心侧边栏
                    showUserSettingsModal(); // 先显示模态框
                    loadUserProfile(); // 加载个人信息（包括头像）
                    loadUserCustomModels(); // 加载AI模型设置
                });
            }
            
            // 通用头像上传函数
            async function uploadAvatar(file, options = {}) {
                if (!file) return false;
                
                // 验证文件类型
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    const errorMsg = '不支持的文件类型，请上传 JPG、PNG、GIF 或 WebP 格式的图片';
                    if (options.onError) {
                        options.onError(errorMsg);
                    } else {
                        alert(errorMsg);
                    }
                    return false;
                }
                
                // 验证文件大小（5MB）
                if (file.size > 5 * 1024 * 1024) {
                    const errorMsg = '文件大小超过限制，最大 5MB';
                    if (options.onError) {
                        options.onError(errorMsg);
                    } else {
                        alert(errorMsg);
                    }
                    return false;
                }
                
                const token = localStorage.getItem('access_token');
                if (!token) {
                    const errorMsg = '请先登录';
                    if (options.onError) {
                        options.onError(errorMsg);
                    } else {
                        alert(errorMsg);
                    }
                    return false;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    if (options.onProgress) {
                        options.onProgress(true);
                    }
                    
                    const response = await fetch(`${API_BASE_URL}/api/users/avatar/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok || result.code !== 200) {
                        throw new Error(result.message || '上传失败，请重试');
                    }
                    
                    // 更新所有头像显示
                    if (result.data && result.data.avatar_url) {
                        const avatarUrl = `${API_BASE_URL}${result.data.avatar_url}`;
                        
                        // 更新侧边栏头像
                        const userAvatarImg = document.getElementById('userAvatarImg');
                        if (userAvatarImg) {
                            userAvatarImg.src = avatarUrl;
                        }
                        
                        // 更新设置面板头像
                        const settingsAvatarImg = document.getElementById('settingsAvatarImg');
                        if (settingsAvatarImg) {
                            settingsAvatarImg.src = avatarUrl;
                        }
                        
                        // 显示删除按钮
                        const settingsDeleteAvatarBtn = document.getElementById('settingsDeleteAvatarBtn');
                        if (settingsDeleteAvatarBtn) {
                            settingsDeleteAvatarBtn.style.display = 'flex';
                        }
                    }
                    
                    if (options.onSuccess) {
                        options.onSuccess('头像上传成功');
                    }
                    
                    // 刷新用户信息
                    await refreshCurrentUser();
                    return true;
                } catch (error) {
                    console.error('上传头像失败:', error);
                    const errorMsg = error.message || '上传失败，请重试';
                    if (options.onError) {
                        options.onError(errorMsg);
                    } else {
                        alert(errorMsg);
                    }
                    return false;
                } finally {
                    if (options.onProgress) {
                        options.onProgress(false);
                    }
                }
            }
            
            // 头像上传和删除事件处理
            const settingsUploadAvatarBtn = document.getElementById('settingsUploadAvatarBtn');
            const settingsDeleteAvatarBtn = document.getElementById('settingsDeleteAvatarBtn');
            const settingsAvatarFileInput = document.getElementById('settingsAvatarFileInput');
            const settingsAvatarImg = document.getElementById('settingsAvatarImg');
            
            // 侧边栏头像上传事件处理
            const avatarUploadOverlay = document.getElementById('avatarUploadOverlay');
            const avatarFileInput = document.getElementById('avatarFileInput');
            
            if (avatarUploadOverlay && avatarFileInput) {
                avatarUploadOverlay.style.cursor = 'pointer';
                avatarUploadOverlay.addEventListener('click', function(e) {
                    e.stopPropagation();
                    avatarFileInput.click();
                });
                
                avatarFileInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const overlaySpan = avatarUploadOverlay.querySelector('span');
                    const originalText = overlaySpan ? overlaySpan.textContent : '更换头像';
                    
                    await uploadAvatar(file, {
                        onProgress: (isUploading) => {
                            if (overlaySpan) {
                                overlaySpan.textContent = isUploading ? '上传中...' : originalText;
                            }
                            avatarUploadOverlay.style.pointerEvents = isUploading ? 'none' : 'auto';
                        },
                        onSuccess: (message) => {
                            if (overlaySpan) {
                                overlaySpan.textContent = '上传成功！';
                                setTimeout(() => {
                                    overlaySpan.textContent = originalText;
                                }, 2000);
                            }
                        },
                        onError: (errorMsg) => {
                            alert(errorMsg);
                            if (overlaySpan) {
                                overlaySpan.textContent = originalText;
                            }
                        }
                    });
                    
                    avatarFileInput.value = '';
                });
            }
            
            // 设置面板头像上传事件处理
            if (settingsUploadAvatarBtn && settingsAvatarFileInput) {
                settingsUploadAvatarBtn.addEventListener('click', function() {
                    settingsAvatarFileInput.click();
                });
                
                settingsAvatarFileInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    await uploadAvatar(file, {
                        onProgress: (isUploading) => {
                            settingsUploadAvatarBtn.disabled = isUploading;
                            settingsUploadAvatarBtn.innerHTML = isUploading 
                                ? '<i class="fas fa-spinner fa-spin"></i> 上传中...' 
                                : '<i class="fas fa-upload"></i> 上传头像';
                        },
                        onSuccess: (message) => {
                            showStatus('profileStatus', message, 'success');
                        },
                        onError: (errorMsg) => {
                            showStatus('profileStatus', errorMsg, 'error');
                        }
                    });
                    
                    settingsAvatarFileInput.value = '';
                });
            }
            
            if (settingsDeleteAvatarBtn) {
                settingsDeleteAvatarBtn.addEventListener('click', async function() {
                    if (!confirm('确定要删除头像吗？删除后将恢复默认头像。')) {
                        return;
                    }
                    
                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        showStatus('profileStatus', '请先登录', 'error');
                        return;
                    }
                    
                    try {
                        settingsDeleteAvatarBtn.disabled = true;
                        settingsDeleteAvatarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 删除中...';
                        
                        const response = await fetch(`${API_BASE_URL}/api/users/avatar`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok || result.code !== 200) {
                            throw new Error(result.message || '删除失败，请重试');
                        }
                        
                        // 更新头像显示为默认头像
                        const defaultAvatar = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22100%22%20height%3D%22100%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_18bc6f87a3f%20text%20%7B%20fill%3Argba(153%2C153%2C153%2C.5)%3Bfont-weight%3Anormal%3Bfont-family%3AHelvetica%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_18bc6f87a3f%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2235%22%20y%3D%2254%22%3E%E5%A4%B4%E5%83%8F%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';
                        if (settingsAvatarImg) {
                            settingsAvatarImg.src = defaultAvatar;
                        }
                        // 同时更新侧边栏头像
                        const userAvatarImg = document.getElementById('userAvatarImg');
                        if (userAvatarImg) {
                            userAvatarImg.src = defaultAvatar;
                        }
                        // 隐藏删除按钮
                        settingsDeleteAvatarBtn.style.display = 'none';
                        
                        showStatus('profileStatus', '头像删除成功', 'success');
                        
                        // 刷新用户信息
                        await refreshCurrentUser();
                    } catch (error) {
                        console.error('删除头像失败:', error);
                        showStatus('profileStatus', error.message || '删除失败，请重试', 'error');
                    } finally {
                        settingsDeleteAvatarBtn.disabled = false;
                        settingsDeleteAvatarBtn.innerHTML = '<i class="fas fa-trash"></i> 删除头像';
                    }
                });
            }
            // 事件监听器：关闭反馈模态框
            closeFeedbackBtn.addEventListener('click', hideFeedbackModal);
            cancelFeedbackBtn.addEventListener('click', hideFeedbackModal);
            
            // 事件监听器：关闭用户设置模态框
            if (closeUserSettingsBtn) {
                closeUserSettingsBtn.addEventListener('click', hideUserSettingsModal);
            }
            
            // 点击用户设置模态框外部关闭

            
            // ESC键关闭用户设置模态框
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (userSettingsModal && userSettingsModal.style.display === 'flex') {
                        hideUserSettingsModal();
                    }
                }
            });
            // 点击模态框外部关闭
            feedbackModal.addEventListener('click', function(e) {
                if (e.target === feedbackModal) {
                    hideFeedbackModal();
                }
            });
            // 选择反馈类型
            feedbackTypeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    feedbackTypeInput.value = type;

                    // 更新选中样式
                    feedbackTypeOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            // 提交反馈
            submitFeedbackBtn.addEventListener('click', submitFeedback);

            // 按Enter+Ctrl/Cmd提交
            feedbackContent.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    submitFeedback();
                }
            });

        });
        function loginEvent() {
            // 注销账户按钮点击事件
            document.getElementById('deleteAccountBtn').addEventListener('click', function() {
            //hideProfileSidebar(); // 先关闭个人中心侧边栏
            handleAccountDelete(); // 执行账户注销操作
            });

        };
        // 云盘管理按钮点击事件处理
        document.getElementById('cloudDiskBtn').addEventListener('click', function() {
            const token = localStorage.getItem('access_token');

            // 检查token是否存在
            if (!token) {
                // 显示提示并跳转到登录页
                if (typeof showNotification === 'function') {
                    showNotification('请先登录', 'error');
                } else {
                    alert('请先登录');
                }
                return;
            }

            // 验证token有效性的函数
            function validateTokenBeforeRedirect() {
                const token = localStorage.getItem('access_token');
                // 检查token是否存在
                if (!token) {
                    console.log('未找到令牌，需要登录');
                    window.location.href = 'login.html';
                    return;
                }
                
                fetch(`${API_BASE_URL}/api/auth/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ token: token })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Token验证失败');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.valid || data.user_id) {
                        // Token有效，跳转到云盘页面
                        window.location.href = 'cloud_disk.html';
                    } else {
                        throw new Error('Token无效');
                    }
                })
                .catch(error => {
                    console.error('Token验证失败:', error);
                    if (typeof showNotification === 'function') {
                        showNotification('登录已过期，请重新登录', 'error');
                    } else {
                        alert('登录已过期，请重新登录');
                    }
                    // 添加登录页面重定向，确保用户在验证失败后可以重新登录
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                });
            }

            // 执行token验证后跳转
            validateTokenBeforeRedirect();
        });
    </script>
    <style>
        /* 全屏聊天消息样式 */
        .fullscreen-chat-overlay .message-container {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-start;
            gap: 10px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .fullscreen-chat-overlay .user-message-container {
            flex-direction: row-reverse;
            justify-content: flex-start;
        }
        
        .fullscreen-chat-overlay .ai-message-container {
            flex-direction: row;
            justify-content: flex-start;
        }
        
        .fullscreen-chat-overlay .message-avatar {
            width: 36px;
            height: 36px;
            min-width: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            flex-shrink: 0;
            color: white;
        }
        
        .fullscreen-chat-overlay .message {
            margin: 0;
            padding: 16px 20px;
            border-radius: 12px;
            max-width: calc(100% - 50px);
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            font-size: 1rem;
            line-height: 1.6;
            position: relative;
            transition: transform 0.2s ease;
            box-sizing: border-box;
        }
        
        .fullscreen-chat-overlay .message:hover {
            transform: translateY(-1px);
        }
        
        .fullscreen-chat-overlay .user-message {
            background-color: #2563eb;
            color: white;
            border-bottom-right-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .fullscreen-chat-overlay .ai-message {
            background-color: #475569;
            color: white;
            border-bottom-left-radius: 4px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* 日间模式下的消息样式 */
        body:not(.dark-mode) .fullscreen-chat-overlay .user-message {
            background-color: #3b82f6;
        }
        
        body:not(.dark-mode) .fullscreen-chat-overlay .ai-message {
            background-color: #e2e8f0;
            color: #1e293b;
        }
        
        /* 响应式消息样式 */
        @media (max-width: 768px) {
            .fullscreen-chat-overlay .message-container {
                gap: 8px;
                margin-bottom: 16px;
            }
            
            .fullscreen-chat-overlay .message-avatar {
                width: 32px;
                height: 32px;
                min-width: 32px;
                font-size: 0.75rem;
            }
            
            .fullscreen-chat-overlay .message {
                max-width: calc(100% - 44px);
                padding: 12px 16px;
                font-size: 0.95rem;
            }
        }
        
        @media (max-width: 480px) {
            .fullscreen-chat-overlay .message {
                max-width: calc(100% - 40px);
                padding: 10px 14px;
                font-size: 0.9rem;
            }
            
            .fullscreen-chat-overlay .message-avatar {
                width: 28px;
                height: 28px;
                min-width: 28px;
                font-size: 0.7rem;
            }
        }
        
        /* 复制按钮样式 */
        .fullscreen-chat-overlay .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 6px;
            padding: 5px 10px;
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
            opacity: 0;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
            z-index: 10;
        }
        
        .fullscreen-chat-overlay .message:hover .copy-button {
            opacity: 1;
        }
        
        .fullscreen-chat-overlay .copy-button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }
        
        /* 复制成功提示 */
        .fullscreen-chat-overlay .copy-tooltip {
            position: absolute;
            top: -35px;
            right: 8px;
            background: #10b981;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 11;
        }
        
        .fullscreen-chat-overlay .copy-button.copied + .copy-tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 小屏幕下的复制按钮 */
        @media (max-width: 768px) {
            .fullscreen-chat-overlay .copy-button {
                opacity: 0.7;
                font-size: 0.8rem;
                padding: 4px 8px;
            }
            
            .fullscreen-chat-overlay .copy-tooltip {
                font-size: 0.8rem;
                padding: 5px 10px;
            }
        }
        
        /* 移除旧的全屏输入框样式（已在上方.fullscreen-chat-input textarea中定义） */
        
        .fullscreen-chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .fullscreen-chat-messages::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
        }
        
        .fullscreen-chat-messages::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.5);
            border-radius: 4px;
        }
        
        .fullscreen-chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.7);
        }
        
        .fullscreen-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .fullscreen-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        /* 搜索框样式 */
         .search-container {
             position: relative;
             width: 300px;
             margin: 15px auto 0;
         }
         
         #messageSearchInput {
             width: 100%;
             padding: 10px 40px 10px 15px;
             border: 2px solid #4b5563;
             border-radius: 25px;
             background-color: #1f2937;
             color: white;
             font-size: 1rem;
             transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
         }
         
         /* 日间模式下的搜索框 */
         body:not(.dark-mode) #messageSearchInput {
             background-color: white;
             color: #1e293b;
             border: 2px solid #cbd5e1;
         }
         
         body:not(.dark-mode) #messageSearchInput::placeholder {
             color: #94a3b8;
         }
         
         #messageSearchInput:focus {
             outline: none;
             border-color: #2563eb;
             box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
         }
         
         .search-icon {
             position: absolute;
             right: 15px;
             top: 50%;
             transform: translateY(-50%);
             color: #9ca3af;
             cursor: pointer;
             pointer-events: auto;
             z-index: 10;
             transition: color 0.3s ease;
         }
         
         .search-icon:hover {
             color: white;
         }
         
         /* 日间模式下的搜索图标 */
         body:not(.dark-mode) .search-icon {
             color: #64748b;
         }
         
         body:not(.dark-mode) .search-icon:hover {
             color: #1e293b;
         }
        
        .search-results-info {
            text-align: center;
            color: #9ca3af;
            font-size: 0.9rem;
            margin: 10px 0;
            transition: color 0.3s ease;
        }
        
        /* 日间模式下的搜索结果信息 */
        body:not(.dark-mode) .search-results-info {
            color: #64748b;
        }
        
        .search-highlight {
            background-color: #fef3c7;
            color: #92400e;
            padding: 0 2px;
            border-radius: 2px;
            font-weight: 600;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* 日间模式下的搜索高亮 */
        body:not(.dark-mode) .search-highlight {
            background-color: #fef08a;
            color: #854d0e;
        }
        
        .clear-search-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: none;
            transition: color 0.3s ease;
        }
        
        /* 日间模式下的清除按钮 */
        body:not(.dark-mode) .clear-search-btn {
            color: #64748b;
        }
        
        body:not(.dark-mode) .clear-search-btn:hover {
            color: #1e293b;
        }
        
        .clear-search-btn.visible {
            display: block;
        }
        
        .clear-search-btn:hover {
            color: white;
        }
        
        /* 收藏按钮样式 */
         .favorite-button {
             position: absolute;
             top: 12px;
             right: 100px;
             background: rgba(255, 255, 255, 0.2);
             border: none;
             border-radius: 50%;
             width: 30px;
             height: 30px;
             cursor: pointer;
             font-size: 1rem;
             opacity: 0;
             transition: all 0.3s ease;
             display: flex;
             align-items: center;
             justify-content: center;
             backdrop-filter: blur(4px);
             z-index: 5;
         }
         
         .fullscreen-chat-overlay .message:hover .favorite-button {
             opacity: 1;
         }
         
         .favorite-button:hover {
             background: rgba(255, 255, 255, 0.3);
             transform: scale(1.1);
         }
         
         .favorite-button.favorited {
             color: #f59e0b;
             opacity: 1;
         }
         
         .favorite-button.favorited:hover {
             color: #d97706;
             background: rgba(245, 158, 11, 0.2);
         }
        
        .favorite-tooltip {
            position: absolute;
            top: -35px;
            right: 0;
            background: #10b981;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            transform: translateY(5px);
            transition: all 0.3s ease;
        }
        
        .favorite-button:hover .favorite-tooltip {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
    <!-- 全屏聊天功能JavaScript -->
    <script>
        // 全屏聊天功能
        document.addEventListener('DOMContentLoaded', function() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');
            const fullscreenChatOverlay = document.getElementById('fullscreenChatOverlay');
            const fullscreenChatMessages = document.getElementById('fullscreenChatMessages');
            const chatMessages = document.getElementById('chatMessages');
            const fullscreenQuestionInput = document.getElementById('fullscreenQuestionInput');
            const questionInput = document.getElementById('questionInput');
            const fullscreenAskButton = document.getElementById('fullscreenAskButton');
            const askButton = document.getElementById('askButton');
            
            // 注意：updateFullscreenMessages 函数已在全局作用域定义，这里直接使用
            
            // 全屏模式下的提问按钮事件
            fullscreenAskButton.addEventListener('click', () => {
                // 禁用按钮防止重复点击
                fullscreenAskButton.disabled = true;
                fullscreenAskButton.style.opacity = '0.8';
                fullscreenAskButton.style.transform = 'scale(0.98)';
                fullscreenAskButton.textContent = '发送中...';
                
                // 添加加载动画效果
                const originalText = fullscreenAskButton.textContent;
                let dots = 0;
                const loadingInterval = setInterval(() => {
                    dots = (dots + 1) % 4;
                    fullscreenAskButton.textContent = '发送中' + '.'.repeat(dots);
                }, 300);
                
                // 将全屏输入框的内容同步到主输入框
                questionInput.value = fullscreenQuestionInput.value;
                
                // 触发主提问按钮的点击事件
                setTimeout(() => {
                    askButton.click();
                    // 清空全屏输入框
                    fullscreenQuestionInput.value = '';
                    
                    // 恢复按钮状态
                    clearInterval(loadingInterval);
                    setTimeout(() => {
                        fullscreenAskButton.disabled = false;
                        fullscreenAskButton.style.opacity = '1';
                        fullscreenAskButton.style.transform = 'scale(1)';
                        fullscreenAskButton.textContent = '发送提问';
                    }, 300);
                }, 100);
            });
            
            // 为全屏模式的提问按钮添加悬停效果
            fullscreenAskButton.addEventListener('mouseenter', () => {
                if (!fullscreenAskButton.disabled) {
                    fullscreenAskButton.style.backgroundColor = '#1d4ed8';
                    fullscreenAskButton.style.transform = 'scale(1.02)';
                    fullscreenAskButton.style.boxShadow = '0 6px 12px -1px rgba(37, 99, 235, 0.4)';
                }
            });
            
            fullscreenAskButton.addEventListener('mouseleave', () => {
                if (!fullscreenAskButton.disabled) {
                    fullscreenAskButton.style.backgroundColor = '#2563eb';
                    fullscreenAskButton.style.transform = 'scale(1)';
                    fullscreenAskButton.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)';
                }
            });
            
            // 添加点击效果
            fullscreenAskButton.addEventListener('mousedown', () => {
                if (!fullscreenAskButton.disabled) {
                    fullscreenAskButton.style.transform = 'scale(0.98)';
                }
            });
            
            fullscreenAskButton.addEventListener('mouseup', () => {
                if (!fullscreenAskButton.disabled) {
                    fullscreenAskButton.style.transform = 'scale(1.02)';
                }
            });
            
            // 优化退出全屏按钮样式
            exitFullscreenBtn.style.fontSize = '1.8rem';
            exitFullscreenBtn.style.padding = '8px 16px';
            exitFullscreenBtn.style.borderRadius = '6px';
            exitFullscreenBtn.style.transition = 'all 0.3s ease';
            
            exitFullscreenBtn.addEventListener('mouseenter', () => {
                exitFullscreenBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            });
            
            exitFullscreenBtn.addEventListener('mouseleave', () => {
                exitFullscreenBtn.style.backgroundColor = 'transparent';
            });
            
            // 优化全屏标题样式
            const fullscreenTitle = document.querySelector('.fullscreen-chat-header h2');
            if (fullscreenTitle) {
                fullscreenTitle.style.fontSize = '1.75rem';
                fullscreenTitle.style.fontWeight = 'bold';
            }
            
            // 添加搜索功能
            const searchContainer = document.createElement('div');
            searchContainer.className = 'search-container';
            searchContainer.innerHTML = `
                <input type="text" id="messageSearchInput" placeholder="搜索聊天记录...">
                <span class="search-icon">🔍</span>
                <button id="clearSearchBtn" class="clear-search-btn">✕</button>
            `;
            
            const chatHeader = fullscreenChatOverlay.querySelector('.fullscreen-chat-header');
            chatHeader.parentNode.insertBefore(searchContainer, chatHeader.nextSibling);
            
            const messageSearchInput = document.getElementById('messageSearchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            
            // 搜索结果信息元素
            let searchResultsInfo;
            
            // 搜索功能实现
            function searchMessages(query) {
                if (!query.trim()) {
                    updateFullscreenMessages(true); // 清空搜索时重新加载所有消息，使用强制重建
                    if (searchResultsInfo) {
                        searchResultsInfo.remove();
                        searchResultsInfo = null;
                    }
                    return;
                }
                
                // 创建搜索结果信息
                if (!searchResultsInfo) {
                    searchResultsInfo = document.createElement('div');
                    searchResultsInfo.className = 'search-results-info';
                    searchContainer.parentNode.insertBefore(searchResultsInfo, fullscreenChatMessages);
                }
                
                // 清空当前消息
                fullscreenChatMessages.innerHTML = '';
                
                // 从原始聊天区域获取所有消息
                const allMessages = chatMessages.querySelectorAll('.message');
                let matchedMessages = 0;
                
                allMessages.forEach(message => {
                    const messageText = message.textContent.toLowerCase();
                    const queryLower = query.toLowerCase();
                    
                    if (messageText.includes(queryLower)) {
                        matchedMessages++;
                        const clonedMessage = message.cloneNode(true);
                        
                        // 移除旧的按钮
                        const oldButtons = clonedMessage.querySelectorAll('.copy-button, .favorite-button');
                        oldButtons.forEach(btn => btn.remove());
                        
                        // 高亮搜索关键词
                        const originalText = clonedMessage.textContent;
                        const highlightedText = originalText.replace(
                            new RegExp(`(${query})`, 'gi'),
                            '<span class="search-highlight">$1</span>'
                        );
                        
                        // 保留消息的结构，只替换文本内容
                        const messageContent = clonedMessage.querySelector('.message-content') || clonedMessage;
                        messageContent.innerHTML = highlightedText;
                        
                        // 添加复制和收藏按钮
                        addButtonsToMessage(clonedMessage);
                        
                        fullscreenChatMessages.appendChild(clonedMessage);
                    }
                });
                
                // 更新搜索结果信息
                searchResultsInfo.textContent = matchedMessages > 0 
                    ? `找到 ${matchedMessages} 条包含 "${query}" 的消息`
                    : `未找到包含 "${query}" 的消息`;
            }
            
            // 搜索框事件监听
             messageSearchInput.addEventListener('input', function() {
                 const query = this.value;
                 clearSearchBtn.classList.toggle('visible', query.trim() !== '');
                 searchMessages(query);
             });
             
             // 搜索图标点击事件
             const searchIcon = document.querySelector('.search-icon');
             if (searchIcon) {
                 searchIcon.addEventListener('click', function() {
                     searchMessages(messageSearchInput.value);
                 });
             }
            
            // 清空搜索按钮点击事件
            clearSearchBtn.addEventListener('click', function() {
                messageSearchInput.value = '';
                clearSearchBtn.classList.remove('visible');
                searchMessages('');
            });
            
            // 按Enter键执行搜索
            messageSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchMessages(this.value);
                }
            });
            
            // 获取收藏的消息列表
            function getFavorites() {
                const favorites = localStorage.getItem('messageFavorites');
                return favorites ? JSON.parse(favorites) : [];
            }
            
            // 保存收藏的消息
            function saveFavorites(favorites) {
                localStorage.setItem('messageFavorites', JSON.stringify(favorites));
            }
            // 添加按钮到消息
            function addButtonsToMessage(messageElement) {
                const messageText = messageElement.textContent.trim();
                
                // 添加收藏按钮
                const favoriteButton = document.createElement('button');
                favoriteButton.className = 'favorite-button';
                favoriteButton.innerHTML = '❤️<span class="favorite-tooltip">收藏此消息</span>';
                
                // 检查是否已收藏
                const favorites = getFavorites();
                const isFavorited = favorites.some(fav => fav.content === messageText);
                if (isFavorited) {
                    favoriteButton.classList.add('favorited');
                    favoriteButton.innerHTML = '❤️<span class="favorite-tooltip">取消收藏</span>';
                }
                
                favoriteButton.onclick = function(e) {
                    e.stopPropagation();
                    const favorites = getFavorites();
                    const isCurrentlyFavorited = this.classList.contains('favorited');
                    
                    if (isCurrentlyFavorited) {
                        // 取消收藏
                        const updatedFavorites = favorites.filter(fav => fav.content !== messageText);
                        saveFavorites(updatedFavorites);
                        this.classList.remove('favorited');
                        this.innerHTML = '❤️<span class="favorite-tooltip">收藏此消息</span>';
                        
                        // 显示取消收藏提示
                        this.style.color = '#9ca3af';
                        setTimeout(() => {
                            this.style.color = '';
                        }, 500);
                    } else {
                        // 添加收藏
                        favorites.push({
                            content: messageText,
                            timestamp: new Date().toISOString()
                        });
                        saveFavorites(favorites);
                        this.classList.add('favorited');
                        this.innerHTML = '❤️<span class="favorite-tooltip">取消收藏</span>';
                        
                        // 显示收藏成功提示
                        this.style.color = '#f59e0b';
                        this.style.transform = 'scale(1.3)';
                        setTimeout(() => {
                            this.style.color = '';
                            this.style.transform = '';
                        }, 300);
                    }
                };
                
                // 添加复制按钮
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.innerHTML = '📋 复制';
                copyButton.onclick = function(e) {
                    e.stopPropagation();
                    const textContent = messageElement.textContent;
                    navigator.clipboard.writeText(textContent).then(() => {
                        // 复制成功反馈
                        copyButton.classList.add('copied');
                        copyButton.innerHTML = '✅ 已复制';
                        copyButton.style.backgroundColor = '#10b981';
                        
                        // 添加按钮动画
                        copyButton.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            copyButton.style.transform = 'scale(1)';
                        }, 100);
                        
                        // 2秒后恢复
                        setTimeout(() => {
                            copyButton.classList.remove('copied');
                            copyButton.innerHTML = '📋 复制';
                            copyButton.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                        }, 2000);
                    }).catch(err => {
                        console.error('复制失败:', err);
                        copyButton.innerHTML = '❌ 复制失败';
                        copyButton.style.backgroundColor = '#ef4444';
                        setTimeout(() => {
                            copyButton.innerHTML = '📋 复制';
                            copyButton.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                        }, 2000);
                    });
                };
                
                messageElement.appendChild(favoriteButton);
                messageElement.appendChild(copyButton);
            }
            // 监听消息区域变化，更新全屏模式的消息（不使用节流）
            // 注意：isFullscreenOpen 已在全局作用域定义
            const observer = new MutationObserver((mutations) => {
                // 只在全屏模式打开时才更新消息
                if (!isFullscreenOpen) {
                    return;
                }
                const fullscreenChatOverlay = document.getElementById('fullscreenChatOverlay');
                if (!fullscreenChatOverlay || fullscreenChatOverlay.style.display !== 'block') {
                    return;
                }
                
                // 检查是否有新的消息容器添加（而不是内容修改）
                // 忽略流式输出中的消息容器（带有 streaming 类）
                let hasNewMessage = false;
                for (const mutation of mutations) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        for (const node of mutation.addedNodes) {
                            if (node.classList && (node.classList.contains('message-container') || node.classList.contains('message'))) {
                                // 如果是流式消息容器，不触发更新（流式输出有自己的更新机制）
                                if (node.classList.contains('streaming')) {
                                    continue;
                                }
                                hasNewMessage = true;
                                break;
                            }
                        }
                    }
                    if (hasNewMessage) break;
                }
                
                // 只有在添加新的非流式消息时才更新，避免流式内容更新时的闪烁
                if (hasNewMessage) {
                    updateFullscreenMessages();
                }
            });
            observer.observe(chatMessages, { childList: true, subtree: false }); // 只监听直接子节点的变化
            
            // 全屏按钮点击事件
            if (fullscreenBtn) {
                fullscreenBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('全屏按钮被点击');
                    isFullscreenOpen = true;
                    // 打开全屏时进行一次完整重建，确保所有消息正确显示
                    updateFullscreenMessages(true);
                    if (fullscreenQuestionInput && questionInput) {
                        fullscreenQuestionInput.value = questionInput.value;
                    }
                    if (fullscreenChatOverlay) {
                        fullscreenChatOverlay.style.display = 'block';
                        fullscreenChatOverlay.setAttribute('aria-hidden', 'false');
                        console.log('全屏遮罩已显示');
                    }
                    
                    // 滚动到底部显示最新内容
                    const fullscreenChatMessages = document.getElementById('fullscreenChatMessages');
                    if (fullscreenChatMessages) {
                        setTimeout(() => {
                            fullscreenChatMessages.scrollTop = fullscreenChatMessages.scrollHeight;
                            console.log('已滚动到底部，显示最新消息');
                        }, 50);
                    }
                    
                    if (fullscreenQuestionInput) {
                        setTimeout(() => {
                            fullscreenQuestionInput.focus();
                        }, 100);
                    }
                    document.body.style.overflow = 'hidden';
                };
            }
            
            // 退出全屏按钮点击事件
            if (exitFullscreenBtn) {
                exitFullscreenBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('退出全屏按钮被点击');
                    isFullscreenOpen = false;
                    if (fullscreenChatOverlay) {
                        fullscreenChatOverlay.style.display = 'none';
                        fullscreenChatOverlay.setAttribute('aria-hidden', 'true');
                    }
                    document.body.style.overflow = 'auto';
                };
            }
            
            // 全屏模式下按Enter+Ctrl/Cmd提交
            fullscreenQuestionInput.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    fullscreenAskButton.click();
                }
            });
        });
        
        // 夜间模式切换函数 - 移至全局作用域以便在HTML中直接调用
        function toggleTheme() {
            const body = document.body;
            const themeToggleBtn = document.querySelector('.theme-toggle-btn');
            
            // 切换深色模式类
            body.classList.toggle('dark-mode');
            
            // 更新按钮文本和图标
            if (body.classList.contains('dark-mode')) {
                themeToggleBtn.innerHTML = '☀️ 日间模式';
                themeToggleBtn.dataset.theme = 'dark';
                // 保存到localStorage
                localStorage.setItem('theme', 'dark');
            } else {
                themeToggleBtn.innerHTML = '🌙 夜间模式';
                themeToggleBtn.dataset.theme = 'light';
                // 保存到localStorage
                localStorage.setItem('theme', 'light');
            }
        }
        
        // 页面加载时恢复用户主题偏好
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const themeToggleBtn = document.querySelector('.theme-toggle-btn');
            
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-mode');
                if (themeToggleBtn) {
                    themeToggleBtn.innerHTML = '☀️ 日间模式';
                    themeToggleBtn.dataset.theme = 'dark';
                }
            }
            
            // 跳转按钮点击事件
            const navigateBtn = document.getElementById('navigateBtn');
            if (navigateBtn) {
                navigateBtn.addEventListener('click', function() {
                    // 跳转到语言学习页面
                    window.location.href = 'language_learning.html';
                });
            }

            // 单词记忆按钮点击事件
            const memoryBtn = document.getElementById('memoryBtn');
            if (memoryBtn) {
                memoryBtn.addEventListener('click', function() {
                    window.location.href = 'remenber.html';
                });
            }
        });
    </script>

    <!-- 全屏聊天遮罩层 - 放在 body 最外层以覆盖整个浏览器 -->
    <div id="fullscreenChatOverlay" class="fullscreen-chat-overlay" aria-hidden="true">
        <div class="fullscreen-chat-shell">
            <div class="fullscreen-chat-header">
                <h2>沉浸式对话</h2>
                <button id="exitFullscreenBtn" class="fullscreen-exit-btn" aria-label="退出全屏聊天">×</button>
            </div>
            <div class="fullscreen-chat-messages" id="fullscreenChatMessages">
                <!-- 消息将从主聊天区域复制 -->
            </div>
            <div class="fullscreen-chat-input">
                <textarea
                    id="fullscreenQuestionInput"
                    placeholder="请输入您的学习问题..."
                    autocomplete="off"
                    rows="3"
                ></textarea>
                <div class="chat-input-controls">
                    <button id="fullscreenStopButton" class="stop-answer-btn" type="button">停止回答</button>
                    <button id="fullscreenAskButton" class="fullscreen-ask-btn chat-submit-btn" type="button">提问</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // 全局函数：测试自定义模型
    async function testCustomModel(modelId) {
        // 找到对应的测试按钮并显示加载状态
        const testButtons = document.querySelectorAll(`button[onclick="testCustomModel(${modelId})"]`);
        let testBtn = null;
        
        testButtons.forEach(btn => {
            if (btn.onclick && btn.onclick.toString().includes(`testCustomModel(${modelId})`)) {
                testBtn = btn;
            }
        });
        
        if (testBtn) {
            const originalText = testBtn.innerHTML;
            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
            testBtn.style.opacity = '0.7';
        }
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/custom-models/${modelId}/test`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // 显示成功消息
                showTestResult('success', '✅ API连接测试成功！', '模型可以正常使用，响应时间: ' + (result.response_time || 'N/A'));
            } else {
                // 显示失败消息
                showTestResult('error', '❌ API连接测试失败', result.message || '未知错误');
            }
            
            // 刷新模型列表显示最新状态
            await loadUserCustomModels();
        } catch (error) {
            console.error('测试模型连接失败:', error);
            showTestResult('error', '❌ 测试失败', error.message || '网络连接错误');
        } finally {
            // 恢复按钮状态
            if (testBtn) {
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="fas fa-plug"></i> 测试';
                testBtn.style.opacity = '1';
            }
        }
    }
    
    // 全局函数：显示测试结果
    function showTestResult(type, title, message) {
        const isSuccess = type === 'success';
        const bgColor = isSuccess ? '#f0fdf4' : '#fef2f2';
        const borderColor = isSuccess ? '#10b981' : '#ef4444';
        const textColor = isSuccess ? '#059669' : '#dc2626';
        const icon = isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        // 创建临时通知元素
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${bgColor};
            border: 2px solid ${borderColor};
            border-radius: 8px;
            padding: 16px 20px;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10001;
            animation: slideInRight 0.3s ease-out;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <i class="fas ${icon}" style="color: ${textColor}; font-size: 20px; margin-top: 2px;"></i>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: ${textColor}; margin-bottom: 4px;">${title}</div>
                    <div style="font-size: 0.9rem; color: ${textColor}; opacity: 0.8;">${message}</div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: ${textColor}; font-size: 18px; cursor: pointer; opacity: 0.7; padding: 0; margin-left: 8px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">×</button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 3秒后自动移除
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 3000);
    }
    </script>

</body>
</html>