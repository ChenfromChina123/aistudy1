<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¯­è¨€å­¦ä¹ ä¸­å¿ƒ</title>
    <!-- Chart.js with fallback CDNs -->
    <script>
        // å°è¯•åŠ è½½Chart.jsï¼Œä½¿ç”¨å¤šä¸ªå¤‡ç”¨CDN
        (function() {
            // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ–‡ä»¶
            const localFile = '/html/static/js/chart.umd.min.js';
            const cdnUrls = [
                'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js',
                'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js',
                'https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js',
                'https://fastly.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js'
            ];
            
            // æ‰€æœ‰URLï¼ˆæœ¬åœ°æ–‡ä»¶ä¼˜å…ˆï¼‰
            const allUrls = [localFile, ...cdnUrls];
            
            let currentIndex = -1; // -1 è¡¨ç¤ºå…ˆå°è¯•æœ¬åœ°æ–‡ä»¶
            let loaded = false;
            let loadingStartTime = Date.now();
            const MAX_LOAD_TIME = 10000; // 10ç§’è¶…æ—¶
            
            // å…¨å±€åŠ è½½çŠ¶æ€æ ‡è®°
            window.chartJSLoading = true;
            window.chartJSLoaded = false;
            
            function checkChartLoaded() {
                if (typeof Chart !== 'undefined' && Chart.register) {
                    loaded = true;
                    window.chartJSLoaded = true;
                    window.chartJSLoading = false;
                    const source = currentIndex === -1 ? localFile : (currentIndex >= 0 && currentIndex < cdnUrls.length ? cdnUrls[currentIndex] : 'unknown');
                    console.log('Chart.jsåŠ è½½æˆåŠŸ:', source);
                    // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('chartjsloaded'));
                    return true;
                }
                return false;
            }
            
            function loadChartJS() {
                if (loaded || checkChartLoaded()) {
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
                if (Date.now() - loadingStartTime > MAX_LOAD_TIME) {
                    console.error('Chart.jsåŠ è½½è¶…æ—¶ï¼Œæ‰€æœ‰æºéƒ½å¤±è´¥');
                    window.chartJSLoading = false;
                    // åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„Chartå¯¹è±¡ï¼Œé¿å…è„šæœ¬å´©æºƒ
                    window.Chart = function() {
                        console.warn('Chart.jsæœªåŠ è½½ï¼Œå›¾è¡¨åŠŸèƒ½ä¸å¯ç”¨');
                    };
                    window.Chart.getChart = function() { return null; };
                    window.Chart.register = function() {};
                    return;
                }
                
                // å¦‚æœæœ¬åœ°æ–‡ä»¶è¿˜æ²¡å°è¯•ï¼Œå…ˆå°è¯•æœ¬åœ°æ–‡ä»¶
                if (currentIndex === -1) {
                    const script = document.createElement('script');
                    script.src = localFile;
                    script.async = false;
                    
                    script.onload = function() {
                        setTimeout(() => {
                            if (checkChartLoaded()) {
                                return;
                            }
                            // æœ¬åœ°æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œå°è¯•CDN
                            console.warn('æœ¬åœ°Chart.jsæ–‡ä»¶ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥ï¼Œå°è¯•CDN');
                            currentIndex = 0;
                            loadChartJS();
                        }, 500);
                    };
                    
                    script.onerror = function() {
                        console.warn('æœ¬åœ°Chart.jsæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•CDN');
                        currentIndex = 0;
                        setTimeout(loadChartJS, 100);
                    };
                    
                    document.head.appendChild(script);
                    return;
                }
                
                // å°è¯•CDN
                if (currentIndex >= allUrls.length) {
                    // æ‰€æœ‰CDNéƒ½å°è¯•è¿‡äº†ï¼Œä½†è¿˜æ²¡åŠ è½½æˆåŠŸï¼Œç»§ç»­ç­‰å¾…
                    setTimeout(() => {
                        if (!checkChartLoaded()) {
                            currentIndex = 0; // é‡æ–°å¼€å§‹å°è¯•CDN
                            loadChartJS();
                        }
                    }, 1000);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = allUrls[currentIndex];
                script.async = false;
                script.crossOrigin = 'anonymous';
                
                script.onload = function() {
                    setTimeout(() => {
                        if (checkChartLoaded()) {
                            return;
                        }
                        // å¦‚æœè¿˜æ²¡åŠ è½½æˆåŠŸï¼Œå°è¯•ä¸‹ä¸€ä¸ª
                        const source = currentIndex === 0 ? 'æœ¬åœ°æ–‡ä»¶' : allUrls[currentIndex];
                        console.warn('Chart.jsè„šæœ¬åŠ è½½ä½†å¯¹è±¡æœªå®šä¹‰ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæº:', source);
                        currentIndex++;
                        setTimeout(loadChartJS, 500);
                    }, 500);
                };
                
                script.onerror = function() {
                    const source = currentIndex === 0 ? 'æœ¬åœ°æ–‡ä»¶' : allUrls[currentIndex];
                    console.warn('Chart.jsåŠ è½½å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæº:', source);
                    currentIndex++;
                    setTimeout(loadChartJS, 500);
                };
                
                document.head.appendChild(script);
            }
            
            // å®šæœŸæ£€æŸ¥Chart.jsæ˜¯å¦å·²åŠ è½½
            const checkInterval = setInterval(() => {
                if (checkChartLoaded()) {
                    clearInterval(checkInterval);
                } else if (Date.now() - loadingStartTime > MAX_LOAD_TIME) {
                    clearInterval(checkInterval);
                    console.error('Chart.jsåŠ è½½è¶…æ—¶');
                }
            }, 500);
            
            // é¡µé¢åŠ è½½æ—¶å¼€å§‹åŠ è½½Chart.js
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadChartJS);
            } else {
                loadChartJS();
            }
        })();
    </script>
    <style>
        /* åŸºç¡€æ ·å¼é‡ç½®å’Œå˜é‡å®šä¹‰ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        *::before,
        *::after {
            box-sizing: border-box;
        }
        a {
            color: inherit;
            text-decoration: none;
        }
        input,
        button,
        textarea {
            font-family: inherit;
            outline: none;
        }
        ol,
        ul {
            list-style: none;
        }
        table {
            border-collapse: collapse;
            border-spacing: 0;
        }
        
        /* å…¨å±€å˜é‡å®šä¹‰ */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --gray-color: #95a5a6;
            --light-gray: #f1f2f3;
            --border-color: #eee;
            
            /* æ—¥é—´æ¨¡å¼èƒŒæ™¯å’Œæ–‡æœ¬é¢œè‰² */
            --bg-primary: #f5f7fa;
            --bg-secondary: white;
            --text-primary: #333;
            --text-secondary: #666;
        }
        
        /* å¤œé—´æ¨¡å¼å˜é‡ */
        body.dark-mode {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #333;
            --gray-color: #707070;
            --light-gray: #333;
        }
        
        /* é¡µé¢åŸºç¡€æ ·å¼ */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 28px;
        }
        
        /* å¤´éƒ¨æ ·å¼ï¼ˆä¸é¦–é¡µé£æ ¼åŒæ­¥ï¼‰ */
        header {
            position: relative;
            background: radial-gradient(120% 120% at 0% 0%, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0) 48%), linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 28px 48px;
            text-align: left;
            border-radius: 32px;
            margin-bottom: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        header::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(120% 120% at 100% 0%, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0) 55%);
            pointer-events: none;
        }
        
        header h1 {
            font-size: 2.6rem;
            margin-bottom: 8px;
        }
        
        header p {
            font-size: 1.1rem;
            opacity: 0.92;
        }
        
        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .theme-toggle-btn {
            position: absolute;
            right: 20px;
            top: 20px;
            background-color: rgba(255, 255, 255, 0.22);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.35);
            padding: 10px 20px;
            border-radius: 999px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .theme-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        /* å¯¼èˆªèœå• */
        .nav-menu {
            background-color: var(--bg-secondary);
            border-radius: 24px;
            padding: 0;
            margin-bottom: 24px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            display: flex;
            overflow-x: auto;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }
        
        .nav-item:hover {
            background-color: var(--light-gray);
        }
        
        .nav-item.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        /* å†…å®¹åŒºåŸŸæ ·å¼ */
        .content-section {
            background-color: var(--bg-secondary);
            border-radius: 24px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 26px 60px -30px rgba(15, 23, 42, 0.35);
            border: 1px solid rgba(148, 163, 184, 0.18);
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* å•è¯è¡¨ä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            border: 2px dashed var(--border-color);
            border-radius: 18px;
            padding: 28px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-section:hover {
            border-color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--gray-color);
        }
        
        .upload-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 0.9rem;
            color: var(--gray-color);
        }
        
        .vocabulary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .vocabulary-card {
            border: 1px solid rgba(148, 163, 184, 0.18);
            border-radius: 18px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
            background: var(--bg-secondary);
        }
        
        .vocabulary-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: var(--primary-color);
        }
        
        .vocabulary-card h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .vocabulary-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 15px;
        }
        
        /* å•è¯è¡¨é¢„è§ˆåŒºåŸŸ */
        .vocabulary-preview {
            margin-top: 30px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        .preview-table th {
            background-color: var(--light-gray);
            font-weight: 600;
        }
        
        .system-word-tools,
        .custom-word-editor {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 18px;
        }
        
        .system-word-search {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }
        
        .system-word-results-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.06);
        }
        
        .system-word-pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 14px;
        }
        
        .custom-word-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .custom-word-form .form-control {
            flex: 1;
            min-width: 160px;
        }
        
        .custom-word-tip {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        #generate-word-info-btn {
            position: relative;
            overflow: hidden;
        }
        
        #generate-word-info-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .spinner-border-sm {
            width: 0.875rem;
            height: 0.875rem;
            border-width: 0.125rem;
        }
        
        .word-source-badge {
            display: inline-block;
            margin-left: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(37, 99, 235, 0.12);
            color: var(--secondary-color);
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--dark-color);
        }
        
        .btn-secondary:hover {
            background-color: var(--gray-color);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* AIæ–‡ç« ç”Ÿæˆè®¾ç½® */
        .generation-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        /* æ–‡ç« åˆ—è¡¨æ ·å¼ */
        .article-list {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }
        
        .article-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background-color: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .article-item:hover {
            background-color: var(--light-gray);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .article-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .article-item-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .article-item-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .article-item-preview {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-top: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .article-item-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* åŒè¯­å¯¹ç…§æ–‡ç« å±•ç¤º */
        .bilingual-article {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .article-paragraph {
            margin-bottom: 20px;
            position: relative;
        }
        
        .original-text {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 10px;
        }
        
        .translated-text {
            font-size: 1rem;
            color: var(--text-secondary);
            padding-left: 20px;
            border-left: 3px solid var(--primary-color);
        }
        
        /* å•è¯é«˜äº®å’Œé‡Šä¹‰ */
        .vocab-word {
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
            position: relative;
            display: inline-block;
            padding: 0 2px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        
        .vocab-word:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .word-definition {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 250px;
            max-width: 400px;
            display: none;
        }
        
        .vocab-word:hover .word-definition {
            display: block;
        }
        
        .word-definition::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px;
            border-style: solid;
            border-color: var(--border-color) transparent transparent transparent;
        }
        
        /* å­¦ä¹ è¿›åº¦å›¾è¡¨ */
        .progress-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .chart-container {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            min-height: 350px;
            width: 100%;
            margin-bottom: 30px;
        }
        
        /* å­¦ä¹ è¶‹åŠ¿å›¾è¡¨å®¹å™¨ç‰¹æ®Šå¤„ç†ï¼Œç¡®ä¿å®Œæ•´æ˜¾ç¤º */
        #learning-trend-chart-container {
            min-height: 400px;
            height: auto;
        }
        
        .chart-container canvas {
            max-height: 100% !important;
            max-width: 100% !important;
            height: auto !important;
            width: auto !important;
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* å•è¯å¤ä¹ æ¨¡å— */
        .review-container {
            max-width: 700px;
            margin: 0 auto;
            text-align: center;
        }
        
        .review-settings {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .review-settings .generation-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .review-card {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .review-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .review-word {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .review-definition {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: 20px;
            line-height: 1.8;
            transition: opacity 0.3s ease;
        }
        
        .review-definition.hidden {
            opacity: 0.3;
        }
        
        .review-pronunciation {
            font-size: 1.3rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 15px;
        }
        
        .review-part-of-speech {
            font-size: 1rem;
            color: var(--secondary-color);
            font-weight: 500;
            margin-bottom: 15px;
            padding: 5px 15px;
            background: var(--light-gray);
            border-radius: 20px;
            display: inline-block;
        }
        
        .review-example {
            font-size: 1rem;
            line-height: 1.6;
            border-left: 3px solid var(--primary-color);
            padding-left: 15px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .btn-info {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .btn-info:hover {
            background: var(--light-gray);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary {
            background: var(--bg-secondary);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }
        
        .btn-outline-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .btn-outline-secondary:hover {
            background: var(--light-gray);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }
        
        .completion-chart-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
        }
        
        .completion-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stats-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .review-actions {
            text-align: center;
            margin-top: 10px;
        }
        
        .review-options {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            .content-section {
                padding: 20px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background-color: var(--bg-secondary);
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }
        
        /* éé˜»å¡è¿›åº¦æ¡ */
        .progress-bar-container {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 15px;
            z-index: 10000;
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .progress-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .progress-bar-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .progress-bar-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .progress-bar-close:hover {
            background-color: var(--bg-hover);
        }
        
        .progress-bar-message {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .progress-bar-wrapper {
            width: 100%;
            height: 8px;
            background-color: var(--bg-hover);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #4CAF50);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-bar-stats {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        /* æ¶ˆæ¯æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .toast.success {
            background-color: var(--success-color);
        }
        
        .toast.error {
            background-color: var(--accent-color);
        }
        
        .toast.warning {
            background-color: var(--warning-color);
        }
        
        /* å•è¯é€‰æ‹©å¤é€‰æ¡†æ ·å¼ */
        .vocab-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3498db; /* é»˜è®¤è“è‰² */
        }
        
        /* é€‰ä¸­çŠ¶æ€çš„å¤é€‰æ¡†æ ·å¼ */
        .vocab-checkbox-selected {
            accent-color: #27ae60; /* é€‰ä¸­æ—¶æ”¹ä¸ºç»¿è‰² */
        }
        
        /* é€‰ä¸­å•è¯è¡Œçš„æ ·å¼ */
        .selected-word-row {
            background-color: rgba(39, 174, 96, 0.1); /* æ·¡ç»¿è‰²èƒŒæ™¯ */
        }
        
        .selected-word-row td {
            color: #27ae60; /* æ–‡å­—é¢œè‰²ä¹Ÿç¨å¾®å˜ç»¿ */
            font-weight: 500;
        }
        
        /* å¤œé—´æ¨¡å¼ä¸‹çš„é€‰ä¸­è¡Œæ ·å¼ */
        body.dark-mode .selected-word-row {
            background-color: rgba(39, 174, 96, 0.2);
        }
        
        body.dark-mode .selected-word-row td {
            color: #52d17a; /* å¤œé—´æ¨¡å¼ä½¿ç”¨æ›´äº®çš„ç»¿è‰² */
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .feedback-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }
        
        .feedback-modal-content {
            background-color: var(--bg-secondary);
            width: 100%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-lg {
            max-width: 800px;
        }
        
        .feedback-modal-header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .feedback-modal-header h2 {
            margin: 0;
            font-size: 1.3rem;
        }
        
        .close-feedback-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        .close-feedback-btn:hover {
            transform: scale(1.2);
        }
        
        .feedback-modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }
        
        .feedback-modal-footer {
            padding: 15px 25px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-shrink: 0;
        }
        
        /* ä¸‹è½½æŒ‰é’®ä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown #download-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .dropdown #download-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .download-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            overflow: hidden;
            z-index: 1000;
            animation: dropdownFadeIn 0.2s ease;
        }
        
        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .download-menu a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
        
        .download-menu a:last-child {
            border-bottom: none;
        }
        
        .download-menu a:hover {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(41, 128, 185, 0.1));
            color: var(--primary-color);
            padding-left: 20px;
            font-weight: 500;
        }
        
        .download-menu a:hover::before {
            content: 'â–¶';
            position: absolute;
            left: 8px;
            font-size: 10px;
            color: var(--primary-color);
        }
        
        .download-menu a span {
            font-size: 18px;
        }
        
        /* å¤œé—´æ¨¡å¼ä¸‹çš„ä¸‹æ‹‰èœå•æ ·å¼ */
        body.dark-mode .download-menu {
            background: #2a2a2a;
            border-color: #444;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }
        
        body.dark-mode .download-menu a {
            color: #e0e0e0;
            border-bottom-color: #444;
        }
        
        body.dark-mode .download-menu a:hover {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(41, 128, 185, 0.2));
            color: #5dade2;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="theme-toggle-btn" onclick="toggleTheme()">ğŸŒ™ å¤œé—´æ¨¡å¼</button>
            <h1>AI è¯­è¨€å­¦ä¹ ä¸­å¿ƒ</h1>
            <p>ä¸ªæ€§åŒ–çš„è¯­è¨€å­¦ä¹ ä½“éªŒï¼Œè®©å•è¯è®°å¿†æ›´é«˜æ•ˆ</p>
        </header>
        
        <nav class="nav-menu">
            <div class="nav-item active" onclick="switchSection('vocabulary')">å•è¯è¡¨ç®¡ç†</div>
            <div class="nav-item" onclick="switchSection('article')">AI æ–‡ç« ç”Ÿæˆ</div>
            <div class="nav-item" onclick="switchSection('progress')">å­¦ä¹ è¿›åº¦</div>
            <div class="nav-item" onclick="switchSection('review')">å•è¯å¤ä¹ </div>
            <div class="nav-item" onclick="switchSection('public-words')">ç³»ç»Ÿè¯åº“</div>
        </nav>
        
        <!-- å•è¯è¡¨ç®¡ç†æ¨¡å— -->
        <section id="vocabulary" class="content-section active">
            <h2>å•è¯è¡¨ç®¡ç†</h2>
            
            <!-- ä¸Šä¼ è‡ªå®šä¹‰å•è¯è¡¨ -->
            <div class="upload-section" onclick="document.getElementById('vocab-upload').click()">
                <input type="file" id="vocab-upload" accept=".txt,.csv" style="display: none;" onchange="handleVocabUpload(event)">
                <div class="upload-icon">ğŸ“‚</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å•è¯è¡¨</div>
                <div class="upload-hint">æ”¯æŒ TXTã€CSV æ ¼å¼</div>
            </div>
            
            <!-- ç”¨æˆ·å•è¯è¡¨åˆ—è¡¨ï¼ˆåŠ¨æ€åŠ è½½ï¼‰ -->
            <div id="user-vocabularies" class="user-vocabularies"></div>

            <!-- å•è¯è¡¨é¢„è§ˆ -->
            <div id="vocabulary-preview" class="vocabulary-preview" style="display: none;">
                <h3>å•è¯è¡¨é¢„è§ˆ</h3>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateArticle()">ç”Ÿæˆå­¦ä¹ æ–‡ç« </button>
                    <button class="btn btn-success" onclick="reorganizeVocabulary()" id="reorganize-btn">
                        <span id="reorganize-icon">ğŸ¤–</span> AIæ•´ç†å•è¯
                    </button>
                    <button class="btn btn-secondary" onclick="saveVocabulary()">ä¿å­˜å•è¯è¡¨</button>
                </div>
                <table class="preview-table">
                    <thead>
                        <tr>
                            <th>é€‰æ‹©</th>
                            <th>å•è¯</th>
                            <th>é‡Šä¹‰</th>
                            <th>è¯æ€§</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="vocab-preview-body">
                        <!-- é¢„è§ˆå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- ç³»ç»Ÿè¯åº“ï¼ˆpublic_wordsï¼‰ -->
        <section id="public-words" class="content-section">
            <h2>ç³»ç»Ÿè¯åº“</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap;">
                <input id="public-search" class="form-control" placeholder="æœç´¢å•è¯æˆ–é‡Šä¹‰..." style="flex: 1; min-width: 220px;" onkeypress="if(event.key==='Enter'){loadPublicWords(1)}">
                <select id="public-language" class="form-control" style="width: 140px;">
                    <option value="en" selected>è‹±è¯­</option>
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="ja">æ—¥è¯­</option>
                    <option value="ko">éŸ©è¯­</option>
                </select>
                <button class="btn btn-primary" onclick="loadPublicWords(1)">
                    <span>ğŸ”</span> æœç´¢
                </button>
            </div>
            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px;">
                å…± <span id="public-total">0</span> æ¡è®°å½•
            </div>
            <table class="word-list-table">
                <thead>
                    <tr>
                        <th style="width: 220px;">å•è¯</th>
                        <th>é‡Šä¹‰</th>
                        <th style="width: 120px;">è¯æ€§</th>
                        <th style="width: 120px;">æ ‡ç­¾</th>
                        <th style="width: 90px;">ä½¿ç”¨æ•°</th>
                    </tr>
                </thead>
                <tbody id="public-words-body">
                    <tr><td colspan="5" style="text-align:center; color: var(--text-secondary);">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
            <div id="public-pagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 14px;">
                <button class="btn btn-secondary" onclick="changePublicPage(-1)">ä¸Šä¸€é¡µ</button>
                <div style="display:flex; align-items:center; gap:6px; color: var(--text-secondary);">
                    ç¬¬ <span id="public-page">1</span> / <span id="public-pages">1</span> é¡µ
                </div>
                <button class="btn btn-secondary" onclick="changePublicPage(1)">ä¸‹ä¸€é¡µ</button>
            </div>
        </section>
        
        <!-- AIæ–‡ç« ç”Ÿæˆæ¨¡å— -->
        <section id="article" class="content-section">
            <h2>AI æ–‡ç« ç”Ÿæˆ</h2>
            
            <div class="btn-group" style="margin-bottom: 20px;">
                <button id="generate-article-btn" class="btn btn-primary" onclick="generateArticleFromSettings()">
                    <span id="generate-icon">âœ¨</span> ç”Ÿæˆæ–‡ç« 
                </button>
                <button class="btn btn-outline-secondary" onclick="loadArticleList()">æˆ‘çš„æ–‡ç« </button>
            </div>
            
            <div class="generation-settings">
                <div class="form-group">
                    <label for="vocab-source">å•è¯è¡¨æ¥æº</label>
                    <select id="vocab-source" class="form-control" onchange="handleVocabSourceChange()">
                        <option value="uploaded">å·²ä¸Šä¼ å•è¯è¡¨</option>
                        <option value="system">ç³»ç»Ÿè¯åº“</option>
                        <option value="custom">è‡ªå®šä¹‰å•è¯</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="article-topic">æ–‡ç« ä¸»é¢˜</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="article-topic" class="form-control" placeholder="è¾“å…¥æ–‡ç« ä¸»é¢˜ï¼ˆå¯é€‰ï¼‰" style="flex: 1;">
                        <button id="generate-topics-btn" class="btn btn-outline-primary" onclick="generateTopicSuggestions()" style="
                            padding: 6px 12px;
                            font-size: 13px;
                            white-space: nowrap;
                            min-width: auto;
                            height: 38px;
                            border-radius: 6px;
                            display: flex;
                            align-items: center;
                            gap: 4px;
                        ">
                            <span id="generate-topics-btn-text">ğŸ¤– AIç”Ÿæˆä¸»é¢˜</span>
                        </button>
                    </div>
                    <div id="topic-suggestions" style="margin-top: 10px; display: none;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">AIæ¨èä¸»é¢˜ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰ï¼š</div>
                        <div id="topic-tags" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <!-- AIç”Ÿæˆçš„ä¸»é¢˜æ ‡ç­¾å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="article-length">æ–‡ç« é•¿åº¦</label>
                    <select id="article-length" class="form-control">
                        <option value="short">çŸ­ç¯‡ï¼ˆçº¦200è¯ï¼‰</option>
                        <option value="medium" selected>ä¸­ç¯‡ï¼ˆçº¦400è¯ï¼‰</option>
                        <option value="long">é•¿ç¯‡ï¼ˆçº¦800è¯ï¼‰</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="difficulty-level">éš¾åº¦çº§åˆ«</label>
                    <select id="difficulty-level" class="form-control">
                        <option value="å››çº§">å¤§å­¦è‹±è¯­å››çº§</option>
                        <option value="å…­çº§">å¤§å­¦è‹±è¯­å…­çº§</option>
                        <option value="æ‰˜ç¦">æ‰˜ç¦æ°´å¹³</option>
                        <option value="é›…æ€">é›…æ€æ°´å¹³</option>
                        <option value="å•†åŠ¡è‹±è¯­" selected>å•†åŠ¡è‹±è¯­</option>
                    </select>
                </div>
            </div>
            
            <!-- å•è¯è¡¨é€‰æ‹©åŒºåŸŸ -->
            <div id="article-vocab-list-selection" class="article-vocab-list-selection" style="margin-top: 20px; display: none;">
                <h3>é€‰æ‹©å•è¯è¡¨</h3>
                <div id="article-vocab-list-container" class="vocab-list-container" style="margin-top: 15px;">
                    <!-- å•è¯è¡¨åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- å•è¯é€‰æ‹©åŒºåŸŸ -->
            <div id="article-vocab-selection" class="article-vocab-selection" style="margin-top: 20px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">é€‰æ‹©å•è¯</h3>
                    <button class="btn btn-sm btn-secondary" onclick="showVocabListSelection()">æ›´æ¢å•è¯è¡¨</button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button id="toggle-select-all" class="btn btn-outline-secondary" onclick="toggleSelectAll()">
                        å…¨é€‰/å–æ¶ˆå…¨é€‰
                    </button>
                    <button class="btn btn-outline-primary" onclick="showSelectedWordsModal()" style="display: inline-flex; align-items: center; gap: 5px;">
                        <span>ğŸ“‹</span> æŸ¥çœ‹å·²é€‰å•è¯
                    </button>
                </div>
                <div id="selection-status" style="margin-top: 10px;"></div>
                <div class="vocab-selection-container" style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>é€‰æ‹©</th>
                                <th>å•è¯</th>
                                <th>é‡Šä¹‰</th>
                                <th>è¯æ€§</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="article-vocab-body">
                            <!-- å•è¯åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿè¯åº“æœç´¢ä¸æ·»åŠ  -->
            <div id="system-word-tools" class="system-word-tools" style="display: none; margin-top: 20px;">
                <h3 style="margin-bottom: 12px;">ç³»ç»Ÿè¯åº“</h3>
                <div class="system-word-search">
                    <input id="system-word-query" class="form-control" placeholder="æœç´¢ç³»ç»Ÿè¯åº“å•è¯..." style="flex: 1; min-width: 200px;">
                    <select id="system-word-language" class="form-control" style="width: 140px;">
                        <option value="en" selected>è‹±è¯­</option>
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="ja">æ—¥è¯­</option>
                        <option value="ko">éŸ©è¯­</option>
                    </select>
                    <button class="btn btn-outline-primary" onclick="searchSystemWordsForArticle(1)">
                        <span>ğŸ”</span> æœç´¢
                    </button>
                </div>
                <div class="system-word-results">
                    <table class="preview-table system-word-results-table">
                        <thead>
                            <tr>
                                <th style="width: 180px;">å•è¯</th>
                                <th>é‡Šä¹‰</th>
                                <th style="width: 120px;">è¯æ€§</th>
                                <th style="width: 110px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="system-word-results-body">
                            <tr><td colspan="4" style="text-align: center; color: var(--text-secondary); padding: 18px;">è¯·è¾“å…¥å…³é”®è¯æœç´¢ç³»ç»Ÿè¯åº“</td></tr>
                        </tbody>
                    </table>
                    <div class="system-word-pagination" id="system-word-pagination" style="display: none;">
                        <button class="btn btn-secondary" onclick="changeSystemWordPage(-1)">ä¸Šä¸€é¡µ</button>
                        <span id="system-word-page-info" style="color: var(--text-secondary);">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
                        <button class="btn btn-secondary" onclick="changeSystemWordPage(1)">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰å•è¯æ·»åŠ  -->
            <div id="custom-word-editor" class="custom-word-editor" style="display: none; margin-top: 20px;">
                <h3 style="margin-bottom: 12px;">æ·»åŠ è‡ªå®šä¹‰å•è¯</h3>
                <div class="custom-word-form">
                    <input id="custom-word-text" class="form-control" placeholder="è¾“å…¥å•è¯ï¼ˆæ”¯æŒä¸­æ–‡ï¼Œå°†è‡ªåŠ¨ç¿»è¯‘ï¼‰">
                    <button id="generate-word-info-btn" class="btn btn-secondary" onclick="generateWordInfo()" style="min-width: 120px;">
                        <span id="generate-btn-text">ç”Ÿæˆé‡Šä¹‰</span>
                        <span id="generate-btn-loading" style="display: none;">
                            <span class="spinner-border spinner-border-sm" role="status"></span> ç”Ÿæˆä¸­...
                        </span>
                    </button>
                    <input id="custom-word-definition" class="form-control" placeholder="é‡Šä¹‰ï¼ˆå¯é€‰ï¼‰">
                    <input id="custom-word-pos" class="form-control" placeholder="è¯æ€§ï¼ˆå¯é€‰ï¼‰">
                    <button class="btn btn-primary" onclick="addManualWordForArticle()">æ·»åŠ å•è¯</button>
                </div>
                <div class="custom-word-tip">
                    æç¤ºï¼š
                    <br>â€¢ å¯ä»¥è¾“å…¥ä¸­æ–‡ï¼Œç‚¹å‡»"ç”Ÿæˆé‡Šä¹‰"æŒ‰é’®è‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡å¹¶è·å–é‡Šä¹‰
                    <br>â€¢ ä¹Ÿå¯ä»¥ç›´æ¥è¾“å…¥è‹±æ–‡å•è¯ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä¸­æ–‡é‡Šä¹‰
                    <br>â€¢ æ·»åŠ çš„å•è¯ä¼šè‡ªåŠ¨é€‰ä¸­ï¼Œå¯åœ¨ä¸‹æ–¹åˆ—è¡¨å–æ¶ˆé€‰æ‹©æˆ–ç§»é™¤
                </div>
            </div>
            
            <!-- æ–‡ç« åˆ—è¡¨å¼¹çª— -->
            <div id="article-list-modal" class="feedback-modal" style="display: none;">
                <div class="feedback-modal-content modal-lg">
                    <div class="feedback-modal-header">
                        <h2>æˆ‘çš„æ–‡ç« åˆ—è¡¨</h2>
                        <button class="close-feedback-btn" onclick="closeArticleListModal()">&times;</button>
                    </div>
                    <div class="feedback-modal-body">
                        <div id="article-list" class="article-list">
                            <!-- æ–‡ç« åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="feedback-modal-footer">
                        <button class="btn btn-secondary" onclick="closeArticleListModal()">å…³é—­</button>
                    </div>
                </div>
            </div>
            
            <!-- åŒè¯­å¯¹ç…§æ–‡ç« å±•ç¤º -->
            <div id="bilingual-article" class="bilingual-article" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ç”Ÿæˆçš„æ–‡ç« </h3>
                    <div style="display: flex; gap: 10px;">
                        <div class="dropdown" style="position: relative;">
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleDownloadMenu(event)" id="download-btn">
                                <span>ğŸ’¾</span> ä¸‹è½½æ–‡ç«  <span style="font-size: 0.8em;">â–¼</span>
                            </button>
                            <div id="download-menu" class="download-menu" style="display: none;">
                                <a href="#" onclick="event.preventDefault(); downloadArticle('html'); return false;">ğŸ“„ ä¸‹è½½ä¸º HTML</a>
                                <a href="#" onclick="event.preventDefault(); downloadArticle('pdf'); return false;">ğŸ“‘ ä¸‹è½½ä¸º PDF</a>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadArticleList()">è¿”å›åˆ—è¡¨</button>
                    </div>
                </div>
                <!-- æ–‡ç« å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- æµ‹è¯•ç”¨æŒ‰é’®ï¼Œç”¨äºè°ƒè¯•æ–‡ç« æ˜¾ç¤ºåŠŸèƒ½ -->
            
        </section>
        
        <!-- å­¦ä¹ è¿›åº¦è·Ÿè¸ªæ¨¡å— -->
        <section id="progress" class="content-section">
            <h2>å­¦ä¹ è¿›åº¦</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-words-count">-</div>
                    <div class="stat-label">å·²å­¦ä¹ å•è¯</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="mastery-rate">-</div>
                    <div class="stat-label">å•è¯æŒæ¡ç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="learning-days">-</div>
                    <div class="stat-label">å­¦ä¹ å¤©æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-time">-</div>
                    <div class="stat-label">å­¦ä¹ æ—¶é•¿</div>
                </div>
            </div>
            
            <div class="progress-section">
                <div class="chart-container">
                    <div class="chart-title">æ¯æ—¥å­¦ä¹ å•è¯é‡</div>
                    <canvas id="daily-words-chart" width="400" height="300"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">å•è¯æŒæ¡ç¨‹åº¦</div>
                    <canvas id="mastery-chart" width="400" height="300"></canvas>
                </div>
            </div>
            
            <div class="chart-container" id="learning-trend-chart-container">
                <div class="chart-title">å­¦ä¹ è¶‹åŠ¿</div>
                <canvas id="learning-trend-chart" width="800" height="300"></canvas>
            </div>
        </section>
        
        <!-- å•è¯åˆ—è¡¨å¼¹çª— -->
        <div id="words-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color);">
                    <h3 id="words-modal-title" style="margin: 0; font-size: 1.5rem;">å•è¯åˆ—è¡¨</h3>
                    <button onclick="closeWordsModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-primary);">Ã—</button>
                </div>
                <div id="words-modal-content" style="min-height: 200px;">
                    <div style="text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px; color: var(--text-secondary);">åŠ è½½ä¸­...</p>
                    </div>
                </div>
                <div class="modal-footer" style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                    <div id="words-modal-pagination" style="display: flex; gap: 10px; align-items: center;">
                        <button id="words-modal-prev" class="btn btn-outline-secondary" onclick="loadWordsPage('prev')" disabled>ä¸Šä¸€é¡µ</button>
                        <span id="words-modal-page-info" style="color: var(--text-secondary);">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
                        <button id="words-modal-next" class="btn btn-outline-secondary" onclick="loadWordsPage('next')" disabled>ä¸‹ä¸€é¡µ</button>
                    </div>
                    <button class="btn btn-secondary" onclick="closeWordsModal()">å…³é—­</button>
                </div>
            </div>
        </div>
        
        <!-- æ–‡ç« å±•ç¤ºå¼¹çª— -->
        <div id="article-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color);">
                    <div>
                        <h3 id="article-modal-title" style="margin: 0; font-size: 1.5rem;">ç”Ÿæˆçš„æ–‡ç« </h3>
                        <div id="article-modal-meta" style="margin-top: 8px; font-size: 0.9rem; color: var(--text-secondary);">
                            <span id="article-modal-difficulty">éš¾åº¦: æœªçŸ¥</span> | 
                            <span id="article-modal-length">é•¿åº¦: æœªçŸ¥</span> | 
                            <span id="article-modal-words">ä½¿ç”¨å•è¯: 0 ä¸ª</span>
                        </div>
                    </div>
                    <button onclick="closeArticleModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-primary); padding: 5px 10px; transition: color 0.2s;" onmouseover="this.style.color='var(--accent-color)'" onmouseout="this.style.color='var(--text-primary)'">Ã—</button>
                </div>
                <div id="article-modal-content">
                    <!-- æ–‡ç« å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div id="article-word-list" style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border-color);">
                    <!-- å•è¯è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="modal-footer" style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border-color); display: flex; justify-content: flex-end; align-items: center; gap: 10px; flex-shrink: 0;">
                    <div class="dropdown" style="position: relative;">
                        <button class="btn btn-primary" onclick="toggleDownloadMenu(event)" id="article-modal-download-btn">
                            <span>ğŸ’¾</span> ä¸‹è½½æ–‡ç«  <span style="font-size: 0.8em;">â–¼</span>
                        </button>
                        <div id="article-modal-download-menu" class="download-menu" style="display: none;">
                            <a href="#" onclick="event.preventDefault(); downloadArticle('html'); return false;">ğŸ“„ ä¸‹è½½ä¸º HTML</a>
                            <a href="#" onclick="event.preventDefault(); downloadArticle('pdf'); return false;">ğŸ“‘ ä¸‹è½½ä¸º PDF</a>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="closeArticleModal()">å…³é—­</button>
                </div>
            </div>
        </div>
        
        <style>
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                animation: fadeIn 0.3s;
                align-items: center;
                justify-content: center;
            }
            
            .modal-content {
                background-color: var(--bg-primary);
                margin: 5% auto;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                animation: slideDown 0.3s;
                position: relative;
                max-width: 90%;
                width: 100%;
            }
            
            #article-modal .modal-content {
                max-width: 1400px;
                width: 95vw;
                max-height: 90vh;
                display: flex;
                flex-direction: column;
            }
            
            #article-modal-content {
                flex: 3;
                min-height: 400px;
                overflow-y: auto;
                padding-right: 10px;
                margin-bottom: 15px;
            }
            
            #article-word-list {
                flex: 1;
                max-height: 300px;
                overflow-y: auto;
                padding-right: 10px;
            }
            
            #article-modal-content::-webkit-scrollbar {
                width: 8px;
            }
            
            #article-modal-content::-webkit-scrollbar-track {
                background: var(--bg-secondary);
                border-radius: 4px;
            }
            
            #article-modal-content::-webkit-scrollbar-thumb {
                background: var(--border-color);
                border-radius: 4px;
            }
            
            #article-modal-content::-webkit-scrollbar-thumb:hover {
                background: var(--text-secondary);
            }
            
            #article-word-list::-webkit-scrollbar {
                width: 8px;
            }
            
            #article-word-list::-webkit-scrollbar-track {
                background: var(--bg-secondary);
                border-radius: 4px;
            }
            
            #article-word-list::-webkit-scrollbar-thumb {
                background: var(--border-color);
                border-radius: 4px;
            }
            
            #article-word-list::-webkit-scrollbar-thumb:hover {
                background: var(--text-secondary);
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes slideDown {
                from {
                    transform: translateY(-50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            
            .words-list-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }
            
            .words-list-table th,
            .words-list-table td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid var(--border-color);
            }
            
            .words-list-table th {
                background-color: var(--bg-secondary);
                font-weight: 600;
                color: var(--text-primary);
            }
            
            .words-list-table tr:hover {
                background-color: var(--bg-secondary);
            }
            
            .mastery-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 0.85rem;
                font-weight: 500;
            }
            
            .mastery-badge.mastered {
                background-color: rgba(39, 174, 96, 0.2);
                color: #27ae60;
            }
            
            .mastery-badge.learning {
                background-color: rgba(243, 156, 18, 0.2);
                color: #f39c12;
            }
            
            .mastery-badge.unmastered {
                background-color: rgba(231, 76, 60, 0.2);
                color: #e74c3c;
            }
        </style>
        
        <!-- å•è¯å¤ä¹ æ¨¡å— -->
        <section id="review" class="content-section">
            <h2>å•è¯å¤ä¹ </h2>
            
            <!-- å¤ä¹ è®¾ç½®åŒºåŸŸ -->
            <div id="review-settings" class="review-settings" style="margin-bottom: 30px;">
                <div class="generation-settings">
                    <div class="form-group">
                        <label for="review-vocab-source">é€‰æ‹©å•è¯è¡¨</label>
                        <select id="review-vocab-source" class="form-control">
                            <option value="all">å…¨éƒ¨å•è¯è¡¨</option>
                            <option value="difficult">ä»…ç–‘éš¾å•è¯</option>
                            <option value="custom">è‡ªå®šä¹‰å•è¯è¡¨</option>
                        </select>
                    </div>
                    <div class="form-group" id="review-custom-vocab-group" style="display: none;">
                        <label for="review-custom-vocab">å•è¯è¡¨</label>
                        <select id="review-custom-vocab" class="form-control">
                            <option value="">è¯·å…ˆåŠ è½½å•è¯è¡¨...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="review-count">å¤ä¹ æ•°é‡</label>
                        <select id="review-count" class="form-control">
                            <option value="10">10ä¸ªå•è¯</option>
                            <option value="20" selected>20ä¸ªå•è¯</option>
                            <option value="30">30ä¸ªå•è¯</option>
                            <option value="50">50ä¸ªå•è¯</option>
                            <option value="100">100ä¸ªå•è¯</option>
                            <option value="all">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="review-mode">å¤ä¹ æ¨¡å¼</label>
                        <select id="review-mode" class="form-control">
                            <option value="normal" selected>å¸¸è§„å¤ä¹ </option>
                            <option value="flashcard">é—ªå¡æ¨¡å¼</option>
                            <option value="spell">æ‹¼å†™æ¨¡å¼</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="review-type">å¤ä¹ ç±»å‹</label>
                        <select id="review-type" class="form-control">
                            <option value="all" selected>å…¨éƒ¨å•è¯</option>
                            <option value="reviewed">å·²å¤ä¹ çš„å•è¯</option>
                            <option value="unreviewed">æœªå¤ä¹ çš„å•è¯</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="startReviewSession()">
                        <span>ğŸ“š</span> å¼€å§‹å¤ä¹ 
                    </button>
                    <button class="btn btn-outline-secondary" onclick="reviewDifficultWords()">
                        <span>âš ï¸</span> å¤ä¹ ç–‘éš¾å•è¯
                    </button>
                    <button class="btn btn-outline-secondary" onclick="showReviewedWords()">
                        <span>ğŸ“–</span> æŸ¥çœ‹å·²å¤ä¹ å•è¯
                    </button>
                </div>
            </div>
            
            <!-- å¤ä¹ è¿›åº¦æ¡ -->
            <div id="review-progress-container" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-size: 0.9rem; color: var(--text-secondary);">
                        è¿›åº¦: <span id="review-progress-current">0</span> / <span id="review-progress-total">0</span>
                    </span>
                    <span style="font-size: 0.9rem; color: var(--text-secondary);" id="review-progress-percentage">0%</span>
                </div>
                <div style="width: 100%; height: 8px; background: var(--light-gray); border-radius: 4px; overflow: hidden;">
                    <div id="review-progress-bar" style="height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); width: 0%; transition: width 0.3s ease;"></div>
                </div>
            </div>
            
            <div class="review-container">
                <div id="review-card" class="review-card" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button class="btn btn-sm btn-outline-secondary" onclick="returnToReviewSettings()" title="è¿”å›å•è¯é€‰æ‹©">
                            <span>â†</span> è¿”å›è®¾ç½®
                        </button>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <span id="review-word-info"></span>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleDefinitionVisibility()" id="toggle-definition-btn">
                            <span id="toggle-icon">ğŸ‘ï¸</span> æ˜¾ç¤ºé‡Šä¹‰
                        </button>
                    </div>
                    
                    <div class="review-word" id="current-word">Word</div>
                    <p class="review-pronunciation" id="current-pronunciation"></p>
                    
                    <!-- æ‹¼å†™æ¨¡å¼è¾“å…¥æ¡† -->
                    <div id="spell-input-container" style="display: none; margin: 30px 0;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <label for="spell-input" style="display: block; margin-bottom: 10px; font-size: 1rem; color: var(--text-primary); font-weight: 500;">è¯·è¾“å…¥å•è¯æ‹¼å†™ï¼š</label>
                            <input 
                                type="text" 
                                id="spell-input" 
                                class="form-control" 
                                style="font-size: 1.5rem; text-align: center; padding: 15px; border: 2px solid var(--primary-color); border-radius: 8px; max-width: 400px; margin: 0 auto;"
                                placeholder="è¾“å…¥å•è¯..."
                                autocomplete="off"
                                spellcheck="false"
                            />
                            <div id="spell-feedback" style="margin-top: 15px; font-size: 1.1rem; font-weight: 600;"></div>
                            <div id="spell-buttons-container" style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; align-items: center;">
                                <button id="check-spell-btn" class="btn btn-primary" style="padding: 10px 30px;" onclick="checkSpelling()">
                                    <span>âœ“</span> æ£€æŸ¥æ‹¼å†™
                                </button>
                                <button id="retry-spell-btn" class="btn btn-secondary" style="padding: 10px 30px; display: none;" onclick="retrySpelling()">
                                    <span>ğŸ”„</span> é‡æ–°æ‹¼å†™
                                </button>
                            </div>
                            <div id="spell-hint" style="margin-top: 10px; font-size: 0.85rem; color: var(--text-secondary); text-align: center;"></div>
                        </div>
                    </div>
                    
                    <div class="review-part-of-speech" id="current-part-of-speech" style="display: none;"></div>
                    <div class="review-definition" id="current-definition" style="display: none;">Definition will appear here</div>
                    <div class="review-example" id="current-example" style="display: none; margin-top: 20px; padding: 15px; background: var(--light-gray); border-radius: 6px; font-style: italic; color: var(--text-secondary);"></div>
                    
                    <div class="review-options" style="margin-top: 30px;">
                        <button class="btn btn-success" onclick="markAsRemembered()" id="btn-remembered">
                            <span>âœ…</span> å·²è®°ä½ (1)
                        </button>
                        <button class="btn btn-warning" onclick="markAsDifficult()" id="btn-difficult">
                            <span>âš ï¸</span> æœ‰ç‚¹éš¾ (2)
                        </button>
                        <button class="btn btn-accent" onclick="markAsForgotten()" id="btn-forgotten">
                            <span>âŒ</span> æ²¡è®°ä½ (3)
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center; font-size: 0.85rem; color: var(--text-secondary);">
                        æç¤ºï¼šä½¿ç”¨é”®ç›˜æ•°å­—é”® 1ã€2ã€3 å¿«é€Ÿé€‰æ‹©
                    </div>
                </div>
                
                <div id="review-stats" style="display: none;">
                    <h3>å¤ä¹ å®Œæˆï¼</h3>
                    <div class="stats-container">
                        <div class="completion-chart-container">
                            <canvas id="completion-chart"></canvas>
                            <div class="completion-percentage" id="completion-percentage">0%</div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="remembered-count">0</div>
                                <div class="stat-label">å·²è®°ä½</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="difficult-count">0</div>
                                <div class="stat-label">éœ€è¦å¤ä¹ </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="forgotten-count">0</div>
                                <div class="stat-label">æœªè®°ä½</div>
                            </div>
                        </div>
                    </div>
                    <div class="review-actions" style="margin-top: 30px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="startReviewSession()">ç»§ç»­å¤ä¹ </button>
                        <button class="btn btn-secondary" onclick="resetReviewSession()">é‡æ–°å¼€å§‹</button>
                        <button class="btn btn-outline-secondary" onclick="goToSettings()" style="display: flex; align-items: center; gap: 5px;">
                            <span>âš™ï¸</span> è¿”å›è®¾ç½®
                        </button>
                    </div>
                </div>
                
                <!-- å·²å¤ä¹ å•è¯åˆ—è¡¨ -->
                <div id="reviewed-words-container" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">å·²å¤ä¹ å•è¯</h3>
                        <button class="btn btn-sm btn-outline-secondary" onclick="hideReviewedWords()">
                            <span>â†</span> è¿”å›
                        </button>
                    </div>
                    
                    <!-- æœç´¢å’Œç­›é€‰ -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input 
                            type="text" 
                            id="reviewed-words-search" 
                            class="form-control" 
                            placeholder="æœç´¢å•è¯æˆ–é‡Šä¹‰..." 
                            style="flex: 1; min-width: 200px;"
                            onkeypress="if(event.key === 'Enter') loadReviewedWords()"
                        />
                        <select id="reviewed-words-vocab-filter" class="form-control" style="width: 200px;">
                            <option value="">å…¨éƒ¨å•è¯è¡¨</option>
                        </select>
                        <select id="reviewed-words-sort" class="form-control" style="width: 180px;">
                            <option value="last_reviewed:desc">æœ€è¿‘å¤ä¹ </option>
                            <option value="review_count:desc">å¤ä¹ æ¬¡æ•°æœ€å¤š</option>
                            <option value="mastery_level:desc">æŒæ¡ç¨‹åº¦æœ€é«˜</option>
                            <option value="word:asc">å•è¯A-Z</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadReviewedWords()">
                            <span>ğŸ”</span> æœç´¢
                        </button>
                    </div>
                    
                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div id="reviewed-words-stats" style="margin-bottom: 20px; padding: 15px; background: var(--light-gray); border-radius: 8px;">
                        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                            <div>
                                <span style="color: var(--text-secondary);">æ€»è®¡ï¼š</span>
                                <strong id="reviewed-words-total">0</strong>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">å·²æŒæ¡ï¼š</span>
                                <strong id="reviewed-words-mastered">0</strong>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">å¤ä¹ æ€»æ¬¡æ•°ï¼š</span>
                                <strong id="reviewed-words-total-reviews">0</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å•è¯åˆ—è¡¨ -->
                    <div id="reviewed-words-list" style="min-height: 400px;">
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div class="loader" style="margin: 0 auto;"></div>
                            <p>åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                    
                    <!-- åˆ†é¡µ -->
                    <div id="reviewed-words-pagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <!-- å·²é€‰å•è¯å¼¹çª— -->
    <div id="selected-words-modal" class="feedback-modal" style="display: none;">
        <div class="feedback-modal-content modal-lg">
            <div class="feedback-modal-header">
                <h2>å·²é€‰æ‹©çš„å•è¯</h2>
                <button class="close-feedback-btn" onclick="closeSelectedWordsModal()">&times;</button>
            </div>
            <div class="feedback-modal-body">
                <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="color: var(--text-secondary); font-size: 0.95rem;">
                        å…±é€‰æ‹©äº† <strong id="modal-selected-count" style="color: var(--primary-color); font-size: 1.2rem;">0</strong> ä¸ªå•è¯
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="copySelectedWords()">
                        ğŸ“‹ å¤åˆ¶å•è¯åˆ—è¡¨
                    </button>
                </div>
                <div id="selected-words-list" style="max-height: 400px; overflow-y: auto;">
                    <!-- å·²é€‰å•è¯åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="feedback-modal-footer">
                <button class="btn btn-secondary" onclick="closeSelectedWordsModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½æç¤º -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loader"></div>
            <p id="loading-text">åŠ è½½ä¸­...</p>
        </div>
    </div>
    
    <!-- éé˜»å¡è¿›åº¦æ¡ -->
    <div id="progress-bar-container" class="progress-bar-container">
        <div class="progress-bar-header">
            <span class="progress-bar-title">å•è¯è¡¨å¤„ç†ä¸­</span>
            <button class="progress-bar-close" onclick="hideProgressBar()">Ã—</button>
        </div>
        <div class="progress-bar-message" id="progress-bar-message">æ­£åœ¨å‡†å¤‡...</div>
        <div class="progress-bar-wrapper">
            <div class="progress-bar-fill" id="progress-bar-fill"></div>
        </div>
        <div class="progress-bar-stats">
            <span id="progress-bar-stats">0 / 0 ä¸ªå•è¯</span>
            <span id="progress-bar-percent">0%</span>
        </div>
    </div>
    
    <!-- æ¶ˆæ¯æç¤º -->
    <div id="toast" class="toast"></div>
    
    <script>
        // å…¨å±€å˜é‡
        let currentSection = 'vocabulary';
        let currentVocabulary = [];
        let currentVocabularyId = null;
        let currentVocabSourceForArticle = 'uploaded';
        const selectedWordIdsBySource = {
            uploaded: [],
            system: [],
            custom: []
        };
        let selectedWordIds = selectedWordIdsBySource.uploaded;
        let articleUploadedWords = [];
        let articleUploadedVocabularyId = null;
        let articleSystemWords = [];
        let articleCustomWords = [];
        let tempArticleWordIdCounter = -1;
        const systemWordSearchState = {
            page: 1,
            totalPages: 1,
            query: '',
            language: 'en',
            lastResults: []
        };
        let reviewWords = [];
        let currentReviewIndex = 0;
        let reviewStats = { remembered: 0, difficult: 0, forgotten: 0 };
        let isDefinitionVisible = false;
        let userDefinitionPreference = false; // ä¿å­˜ç”¨æˆ·å¯¹é‡Šä¹‰æ˜¾ç¤ºçš„åå¥½è®¾ç½®
        let reviewMode = 'normal';
        let startTime = null;
        let activityTimer = null;
        let currentArticleData = null; // ä¿å­˜å½“å‰æ–‡ç« æ•°æ®ï¼Œç”¨äºä¸‹è½½
        // åˆ†é¡µç›¸å…³å˜é‡
        let currentPage = 1;
        let pageSize = 20;
        
        // æ‰‹åŠ¨ç”Ÿæˆå•è¯é‡Šä¹‰å’Œè¯æ€§
        async function generateWordInfo() {
            const wordInput = document.getElementById('custom-word-text');
            const definitionInput = document.getElementById('custom-word-definition');
            const posInput = document.getElementById('custom-word-pos');
            const generateBtn = document.getElementById('generate-word-info-btn');
            const generateBtnText = document.getElementById('generate-btn-text');
            const generateBtnLoading = document.getElementById('generate-btn-loading');
            
            if (!wordInput || !definitionInput || !posInput) {
                return;
            }
            
            const inputText = wordInput.value.trim();
            if (!inputText) {
                showToast('è¯·å…ˆè¾“å…¥å•è¯æˆ–ä¸­æ–‡', 'warning');
                return;
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                generateBtn.disabled = true;
                generateBtnText.style.display = 'none';
                generateBtnLoading.style.display = 'inline';
                
                const token = getAuthToken();
                if (!token) {
                    showToast('è¯·å…ˆç™»å½•', 'error');
                    return;
                }
                
                // æ£€æµ‹è¾“å…¥çš„è¯­è¨€ç±»å‹
                const isChinese = /[\u4e00-\u9fff]/.test(inputText);
                
                // è·å–APIåŸºç¡€URL
                const apiBaseUrl = window.API_BASE_URL || '';
                
                let finalWord = inputText;
                let definition = '';
                let partOfSpeech = '';
                
                if (isChinese) {
                    // å¦‚æœæ˜¯ä¸­æ–‡ï¼Œå…ˆç¿»è¯‘ä¸ºè‹±æ–‡
                    const translateResponse = await fetch(`${apiBaseUrl}/api/vocabulary/translate-word`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            text: inputText,
                            from_language: 'zh',
                            to_language: 'en'
                        })
                    });
                    
                    const translateResult = await translateResponse.json();
                    if (translateResult.status === 'success' && translateResult.translated_text) {
                        finalWord = translateResult.translated_text.toLowerCase();
                        wordInput.value = finalWord; // æ›´æ–°è¾“å…¥æ¡†ä¸ºè‹±æ–‡å•è¯
                        showToast(`å·²ç¿»è¯‘: ${inputText} â†’ ${finalWord}`, 'success');
                    } else {
                        showToast('ç¿»è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥', 'error');
                        return;
                    }
                }
                
                // è·å–å•è¯çš„é‡Šä¹‰å’Œè¯æ€§
                const response = await fetch(`${apiBaseUrl}/api/vocabulary/word-info?word=${encodeURIComponent(finalWord)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // å¡«å……é‡Šä¹‰å’Œè¯æ€§
                    if (result.definition) {
                        definitionInput.value = result.definition;
                    }
                    if (result.part_of_speech) {
                        posInput.value = result.part_of_speech;
                    }
                    
                    showToast('é‡Šä¹‰ç”ŸæˆæˆåŠŸï¼', 'success');
                } else {
                    showToast(result.message || 'è·å–é‡Šä¹‰å¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('ç”Ÿæˆå•è¯ä¿¡æ¯å¤±è´¥:', error);
                showToast('ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.disabled = false;
                generateBtnText.style.display = 'inline';
                generateBtnLoading.style.display = 'none';
            }
        }
        
        // éªŒè¯å•è¯æ ¼å¼
        function validateWordFormat(word) {
            if (!word || !word.trim()) {
                return { valid: false, message: 'å•è¯ä¸èƒ½ä¸ºç©º' };
            }
            
            word = word.trim();
            
            // æ£€æŸ¥é•¿åº¦
            if (word.length < 2) {
                return { valid: false, message: 'å•è¯é•¿åº¦è‡³å°‘ä¸º2ä¸ªå­—ç¬¦' };
            }
            if (word.length > 50) {
                return { valid: false, message: 'å•è¯é•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦' };
            }
            
            // æ£€æŸ¥æ ¼å¼ï¼šåªå…è®¸è‹±æ–‡å­—æ¯ã€è¿å­—ç¬¦ã€æ’‡å·
            if (!/^[a-zA-Z]+(?:[-'][a-zA-Z]+)*$/.test(word)) {
                return { valid: false, message: 'å•è¯æ ¼å¼ä¸æ­£ç¡®ï¼Œåªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€è¿å­—ç¬¦(-)å’Œæ’‡å·(\')' };
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•°å­—
            if (/\d/.test(word)) {
                return { valid: false, message: 'å•è¯ä¸èƒ½åŒ…å«æ•°å­—' };
            }
            
            return { valid: true, message: 'å•è¯æ ¼å¼æ­£ç¡®' };
        }
        
        // ä¿å­˜å•è¯åˆ°å…¬å…±è¯åº“
        async function saveWordToPublic(word, definition, partOfSpeech, example = '') {
            try {
                const token = getAuthToken();
                if (!token) {
                    return { success: false, message: 'æœªç™»å½•' };
                }
                
                const apiBaseUrl = window.API_BASE_URL || '';
                const formData = new FormData();
                formData.append('word', word);
                formData.append('definition', definition || '');
                formData.append('part_of_speech', partOfSpeech || '');
                formData.append('example', example || '');
                formData.append('language', 'en');
                
                const response = await fetch(`${apiBaseUrl}/api/vocabulary/save-to-public`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('ä¿å­˜å•è¯åˆ°å…¬å…±è¯åº“å¤±è´¥:', error);
                return { success: false, message: 'ä¿å­˜å¤±è´¥: ' + error.message };
            }
        }
        
        // æ·»åŠ æ‰‹åŠ¨å•è¯åˆ°æ–‡ç« 
        async function addManualWordForArticle() {
            const wordInput = document.getElementById('custom-word-text');
            const definitionInput = document.getElementById('custom-word-definition');
            const posInput = document.getElementById('custom-word-pos');
            
            if (!wordInput) {
                showToast('æ‰¾ä¸åˆ°å•è¯è¾“å…¥æ¡†', 'error');
                return;
            }
            
            const word = wordInput.value.trim();
            if (!word) {
                showToast('è¯·è¾“å…¥å•è¯', 'error');
                return;
            }
            
            // éªŒè¯å•è¯æ ¼å¼
            const validation = validateWordFormat(word);
            if (!validation.valid) {
                showToast(validation.message, 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const exists = articleCustomWords.some(w => w.word.toLowerCase() === word.toLowerCase());
            if (exists) {
                showToast('è¯¥å•è¯å·²åœ¨åˆ—è¡¨ä¸­', 'warning');
                return;
            }
            
            const definition = definitionInput ? definitionInput.value.trim() : '';
            const partOfSpeech = posInput ? posInput.value.trim() : '';
            
            // ä¿å­˜åˆ°å…¬å…±è¯åº“
            const saveResult = await saveWordToPublic(word, definition, partOfSpeech);
            if (saveResult.status === 'error') {
                showToast(`ä¿å­˜åˆ°å…¬å…±è¯åº“å¤±è´¥: ${saveResult.message}`, 'error');
                // å³ä½¿ä¿å­˜å¤±è´¥ï¼Œä¹Ÿå…è®¸æ·»åŠ åˆ°åˆ—è¡¨ä¸­
            } else {
                console.log('å•è¯å·²ä¿å­˜åˆ°å…¬å…±è¯åº“:', saveResult);
            }
            
            // åˆ›å»ºæ–°å•è¯å¯¹è±¡
            const newWord = {
                id: tempArticleWordIdCounter--,
                wordId: null,
                word: word,
                definition: definition,
                partOfSpeech: partOfSpeech,
                example: '',
                source: 'custom'
            };
            
            articleCustomWords.push(newWord);
            currentVocabulary = articleCustomWords;
            
            // è‡ªåŠ¨é€‰ä¸­æ–°æ·»åŠ çš„å•è¯
            const wordIdStr = String(newWord.id);
            if (!selectedWordIds.includes(wordIdStr)) {
                selectedWordIds.push(wordIdStr);
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            wordInput.value = '';
            if (definitionInput) definitionInput.value = '';
            if (posInput) posInput.value = '';
            
            // åˆ·æ–°æ˜¾ç¤º
            displayArticleVocabularySelection();
            updateSelectionStatus();
            
            const successMsg = saveResult.status === 'success' 
                ? `å·²æ·»åŠ å•è¯: ${word}ï¼ˆå·²ä¿å­˜åˆ°å…¬å…±è¯åº“ï¼‰` 
                : `å·²æ·»åŠ å•è¯: ${word}`;
            showToast(successMsg, 'success');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ¢å¤ç”¨æˆ·ä¸»é¢˜åå¥½
            
            // ä¸ºè‡ªå®šä¹‰å•è¯è¾“å…¥æ¡†æ·»åŠ å›è½¦é”®å¿«æ·ç”ŸæˆåŠŸèƒ½
            const wordInput = document.getElementById('custom-word-text');
            if (wordInput) {
                wordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        generateWordInfo();
                    }
                });
            }
            const savedTheme = localStorage.getItem('theme');
            const themeToggleBtn = document.querySelector('.theme-toggle-btn');
            
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-mode');
                if (themeToggleBtn) {
                    themeToggleBtn.innerHTML = 'â˜€ï¸ æ—¥é—´æ¨¡å¼';
                    themeToggleBtn.dataset.theme = 'dark';
                }
            }
            
            // åˆå§‹åŒ–å›¾è¡¨
            initCharts();
            
            // ä¸ºä¸Šä¼ åŒºåŸŸæ·»åŠ æ‹–æ‹½åŠŸèƒ½
            const uploadSection = document.querySelector('.upload-section');
            uploadSection.addEventListener('dragover', handleDragOver);
            uploadSection.addEventListener('drop', handleDrop);
            
            // å¯åŠ¨æ´»åŠ¨è®¡æ—¶
            startTime = new Date();
            activityTimer = setInterval(updateActivityDuration, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
            
            // åŠ è½½ç”¨æˆ·å·²ä¸Šä¼ çš„å•è¯è¡¨
            loadUserVocabularies();
            
            // åˆå§‹åŒ–å•è¯å¤ä¹ æ¨¡å—
            initReviewModule();
        });
        
        // è·å–è®¤è¯ä»¤ç‰Œï¼ˆä»localStorageæˆ–cookieä¸­è·å–ï¼‰
        function getAuthToken() {
            return localStorage.getItem('access_token') || document.cookie.split('; ').find(row => row.startsWith('auth_token='))?.split('=')[1];
        }
        
        // å¤„ç†è®¤è¯è¿‡æœŸï¼Œè‡ªåŠ¨è·³è½¬åˆ°ä¸»é¡µ
        function handleAuthExpired() {
            // æ¸…é™¤token
            localStorage.removeItem('access_token');
            sessionStorage.removeItem('access_token');
            
            // æ¸…é™¤cookieä¸­çš„token
            document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            showToast('ç™»å½•å·²è¿‡æœŸï¼Œæ­£åœ¨è·³è½¬åˆ°ä¸»é¡µ...', 'warning');
            
            // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
            setTimeout(() => {
                // è·³è½¬åˆ°ä¸»é¡µï¼ˆindex.htmlï¼‰
                window.location.href = '/html/index.html';
            }, 1500);
        }
        
        // æ£€æŸ¥å“åº”æ˜¯å¦ä¸º401é”™è¯¯ï¼Œå¦‚æœæ˜¯åˆ™å¤„ç†è®¤è¯è¿‡æœŸ
        function checkAuthAndHandle(response) {
            if (response.status === 401) {
                handleAuthExpired();
                return true; // è¡¨ç¤ºå·²å¤„ç†è®¤è¯è¿‡æœŸ
            }
            return false; // è¡¨ç¤ºæœªå¤„ç†
        }
        
        // ç»Ÿä¸€çš„è®¤è¯fetchåŒ…è£…å‡½æ•°
        function authenticatedFetch(url, options = {}) {
            // æ·»åŠ è®¤è¯token
            const token = getAuthToken();
            if (token) {
                options.headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                };
            }
            
            return fetch(url, options).then(response => {
                // æ£€æŸ¥401é”™è¯¯
                if (checkAuthAndHandle(response)) {
                    // è¿”å›ä¸€ä¸ªè¢«æ‹’ç»çš„Promiseï¼Œé˜»æ­¢åç»­çš„thenæ‰§è¡Œ
                    return Promise.reject(new Error('Authentication expired'));
                }
                return response;
            });
        }
        
        // é‡å†™åŸç”Ÿfetchå‡½æ•°ï¼Œè‡ªåŠ¨å¤„ç†401é”™è¯¯ï¼ˆå…¨å±€æ‹¦æˆªï¼‰
        (function() {
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                return originalFetch.apply(this, args).then(response => {
                    // åªå¯¹APIè¯·æ±‚è¿›è¡Œ401æ£€æŸ¥
                    const url = args[0];
                    if (typeof url === 'string' && url.startsWith('/api/')) {
                        if (checkAuthAndHandle(response)) {
                            // è¿”å›ä¸€ä¸ªç‰¹æ®Šæ ‡è®°çš„å“åº”ï¼Œè®©è°ƒç”¨è€…çŸ¥é“è®¤è¯å·²è¿‡æœŸ
                            return Promise.reject(new Error('Authentication expired'));
                        }
                    }
                    return response;
                });
            };
        })();
        
        // æ›´æ–°æ´»åŠ¨æ—¶é•¿
        function updateActivityDuration() {
            const duration = Math.floor((new Date() - startTime) / 1000);
            // è¿™é‡Œå¯ä»¥å°†æ´»åŠ¨æ—¶é•¿å‘é€åˆ°æœåŠ¡å™¨
        }
        
        // åˆ‡æ¢å†…å®¹åŒºåŸŸ
        function switchSection(sectionId) {
            // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === 'article') {
                    section.style.removeProperty('display');
                }
            });
            
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªé¡¹çš„æ¿€æ´»çŠ¶æ€
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹åŒºåŸŸ
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                selectedSection.style.removeProperty('display');
                selectedSection.classList.add('active');
                
                // å¦‚æœåˆ‡æ¢åˆ°æ–‡ç« ç”ŸæˆåŒºåŸŸï¼Œæ£€æŸ¥å•è¯è¡¨æ¥æºå¹¶æ˜¾ç¤ºç›¸åº”å†…å®¹
                if (sectionId === 'article') {
                    setTimeout(() => {
                        console.log('åˆ‡æ¢åˆ°æ–‡ç« ç”ŸæˆåŒºåŸŸï¼Œæ£€æŸ¥å•è¯è¡¨æ¥æº');
                        const vocabSourceSelect = document.getElementById('vocab-source');
                        const vocabSelectionSection = document.getElementById('article-vocab-selection');
                        
                        if (vocabSourceSelect) {
                            const vocabSource = vocabSourceSelect.value;
                            
                            // å¦‚æœé€‰æ‹©äº†å·²ä¸Šä¼ å•è¯è¡¨ï¼Œè§¦å‘å¤„ç†å‡½æ•°
                            if (vocabSource === 'uploaded') {
                                handleVocabSourceChange();
                            } else if (vocabSource === 'custom') {
                                // å¯¹äºé¢„è®¾å•è¯è¡¨å’Œè‡ªå®šä¹‰å•è¯ï¼Œå¦‚æœå·²ç»æœ‰å•è¯æ•°æ®ï¼Œæ˜¾ç¤ºå•è¯é€‰æ‹©åŒºåŸŸ
                                if (currentVocabulary && currentVocabulary.length > 0) {
                                    if (vocabSelectionSection) {
                                        vocabSelectionSection.style.setProperty('display', 'block', 'important');
                                        vocabSelectionSection.style.setProperty('visibility', 'visible', 'important');
                                        vocabSelectionSection.style.setProperty('opacity', '1', 'important');
                                        vocabSelectionSection.removeAttribute('hidden');
                                        console.log('switchSection: å¼ºåˆ¶æ˜¾ç¤ºå•è¯é€‰æ‹©åŒºåŸŸ');
                                    }
                                    displayArticleVocabularySelection();
                                } else {
                                    // å¦‚æœæ²¡æœ‰å•è¯æ•°æ®ï¼Œéšè—å•è¯é€‰æ‹©åŒºåŸŸ
                                    if (vocabSelectionSection) {
                                        vocabSelectionSection.style.setProperty('display', 'none', 'important');
                                    }
                                }
                            }
                        }
                    }, 100);
                }
                
                // å¦‚æœåˆ‡æ¢åˆ°å­¦ä¹ è¿›åº¦åŒºåŸŸï¼ŒåŠ è½½çœŸå®æ•°æ®
                if (sectionId === 'progress') {
                    loadLearningStats();
                    // ç»§ç»­è¿½è¸ªå­¦ä¹ æ—¶é•¿ï¼ˆå› ä¸ºä»åœ¨å­¦ä¹ é¡µé¢ï¼‰
                }
                
                // æ— è®ºåˆ‡æ¢åˆ°å“ªä¸ªåŒºåŸŸï¼Œéƒ½ç»§ç»­è¿½è¸ªå­¦ä¹ æ—¶é•¿ï¼ˆå› ä¸ºéƒ½åœ¨è¯­è¨€å­¦ä¹ é¡µé¢å†…ï¼‰
                if (!learningDurationInterval && pageStartTime === null) {
                    startLearningDurationTracking();
                }
                
                // å¦‚æœåˆ‡æ¢åˆ°å¤ä¹ åŒºåŸŸï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½å•è¯è¡¨åˆ—è¡¨
                if (sectionId === 'review') {
                    setTimeout(() => {
                        const vocabSource = document.getElementById('review-vocab-source');
                        if (vocabSource && vocabSource.value === 'custom') {
                            const customVocabGroup = document.getElementById('review-custom-vocab-group');
                            if (customVocabGroup) {
                                customVocabGroup.style.display = 'block';
                                loadReviewVocabularies();
                            }
                        }
                    }, 100);
                }
                
                // å¦‚æœåˆ‡æ¢åˆ°ç³»ç»Ÿè¯åº“ï¼Œåˆ™åŠ è½½æ•°æ®
                if (sectionId === 'public-words') {
                    setTimeout(() => loadPublicWords(1), 50);
                }
            }
            
            // æ¿€æ´»å¯¹åº”çš„å¯¼èˆªé¡¹
            const selectedNavItem = document.querySelector(`.nav-item[onclick="switchSection('${sectionId}')"]`);
            if (selectedNavItem) {
                selectedNavItem.classList.add('active');
            }
            
            // æ›´æ–°å½“å‰åŒºåŸŸ
            currentSection = sectionId;
        }
        
        // ä¸»é¢˜åˆ‡æ¢å‡½æ•°
        function toggleTheme() {
            const body = document.body;
            const themeToggleBtn = document.querySelector('.theme-toggle-btn');
            
            // åˆ‡æ¢æ·±è‰²æ¨¡å¼ç±»
            body.classList.toggle('dark-mode');
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬å’Œå›¾æ ‡
            if (body.classList.contains('dark-mode')) {
                themeToggleBtn.innerHTML = 'â˜€ï¸ æ—¥é—´æ¨¡å¼';
                themeToggleBtn.dataset.theme = 'dark';
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('theme', 'dark');
            } else {
                themeToggleBtn.innerHTML = 'ğŸŒ™ å¤œé—´æ¨¡å¼';
                themeToggleBtn.dataset.theme = 'light';
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('theme', 'light');
            }
        }
        
        // æ˜¾ç¤ºåŠ è½½æç¤º
        function showLoading(text = 'åŠ è½½ä¸­...') {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            loadingText.textContent = text;
            loadingOverlay.style.display = 'flex';
        }
        
        // éšè—åŠ è½½æç¤º
        function hideLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'none';
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            
            // æ˜¾ç¤ºæç¤º
            toast.classList.add('show');
            
            // 3ç§’åéšè—
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // ---------------- ç³»ç»Ÿè¯åº“ï¼ˆpublic_wordsï¼‰ ----------------
        let publicCurrentPage = 1;
        let publicPageSize = 20;
        let publicTotalPages = 1;
        
        async function loadPublicWords(page = 1) {
            publicCurrentPage = page;
            const lang = document.getElementById('public-language').value || 'en';
            const q = (document.getElementById('public-search').value || '').trim();
            
            const params = new URLSearchParams({
                language: lang,
                page: String(publicCurrentPage),
                page_size: String(publicPageSize)
            });
            if (q) params.append('search', q);
            
            const tbody = document.getElementById('public-words-body');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--text-secondary);">åŠ è½½ä¸­...</td></tr>';
            }
            
            try {
                const res = await authenticatedFetch(`/api/public-words?${params.toString()}`);
                const data = await res.json();
                
                document.getElementById('public-total').textContent = data.total || 0;
                
                publicTotalPages = Math.max(1, Math.ceil((data.total || 0) / publicPageSize));
                document.getElementById('public-page').textContent = String(publicCurrentPage);
                document.getElementById('public-pages').textContent = String(publicTotalPages);
                
                const items = data.items || [];
                if (!items.length) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--text-secondary);">æš‚æ— æ•°æ®</td></tr>';
                    return;
                }
                
                const rows = items.map(item => {
                    const pos = item.part_of_speech ? `<span class="part-of-speech">${escapeHtml(item.part_of_speech)}</span>` : '';
                    const tag = item.tag ? escapeHtml(item.tag) : '-';
                    return `
                        <tr>
                            <td class="word-cell">${escapeHtml(item.word)}</td>
                            <td>${escapeHtml(item.definition || '')}${item.example ? `<div style="color:var(--text-secondary); font-size:0.9rem; margin-top:4px;">${escapeHtml(item.example)}</div>` : ''}</td>
                            <td>${pos}</td>
                            <td>${tag}</td>
                            <td>${item.usage_count || 0}</td>
                        </tr>
                    `;
                }).join('');
                tbody.innerHTML = rows;
            } catch (e) {
                console.error('åŠ è½½ç³»ç»Ÿè¯åº“å¤±è´¥', e);
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#e74c3c;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</td></tr>';
                }
            }
        }
        
        function changePublicPage(delta) {
            const next = publicCurrentPage + delta;
            if (next < 1 || next > publicTotalPages) return;
            loadPublicWords(next);
        }
        
        // è¿›åº¦æ¡ç®¡ç†å˜é‡
        let currentTaskId = null;
        let progressCheckInterval = null;
        
        // æ˜¾ç¤ºè¿›åº¦æ¡
        function showProgressBar() {
            const container = document.getElementById('progress-bar-container');
            container.style.display = 'block';
        }
        
        // éšè—è¿›åº¦æ¡
        function hideProgressBar() {
            const container = document.getElementById('progress-bar-container');
            container.style.display = 'none';
            if (progressCheckInterval) {
                clearInterval(progressCheckInterval);
                progressCheckInterval = null;
            }
            currentTaskId = null;
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgressBar(progress, message, processedWords, totalWords) {
            const fill = document.getElementById('progress-bar-fill');
            const messageEl = document.getElementById('progress-bar-message');
            const statsEl = document.getElementById('progress-bar-stats');
            const percentEl = document.getElementById('progress-bar-percent');
            
            fill.style.width = `${progress}%`;
            messageEl.textContent = message || 'å¤„ç†ä¸­...';
            statsEl.textContent = `${processedWords || 0} / ${totalWords || 0} ä¸ªå•è¯`;
            percentEl.textContent = `${progress}%`;
        }
        
        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        function pollTaskStatus(taskId, vocabularyListId) {
            if (progressCheckInterval) {
                clearInterval(progressCheckInterval);
            }
            
            progressCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/vocabulary/upload/task/${taskId}`, {
                        headers: {
                            'Authorization': `Bearer ${getAuthToken()}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥');
                    }
                    
                    const taskData = await response.json();
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    updateProgressBar(
                        taskData.progress || 0,
                        taskData.message || 'å¤„ç†ä¸­...',
                        taskData.processed_words || 0,
                        taskData.total_words || 0
                    );
                    
                    // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
                    if (taskData.status === 'completed') {
                        clearInterval(progressCheckInterval);
                        progressCheckInterval = null;
                        
                        // å»¶è¿Ÿéšè—è¿›åº¦æ¡ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®ŒæˆçŠ¶æ€
                        setTimeout(() => {
                            hideProgressBar();
                            showToast('å•è¯è¡¨å¤„ç†å®Œæˆï¼', 'success');
                            
                            // åˆ·æ–°å•è¯è¡¨åˆ—è¡¨
                            loadUserVocabularies();
                            
                            // è‡ªåŠ¨åŠ è½½å•è¯è¡¨ï¼ˆéœ€è¦å…ˆè·å–å•è¯è¡¨åç§°ï¼‰
                            fetch(`/api/vocabulary/lists/${vocabularyListId}`, {
                                headers: {
                                    'Authorization': `Bearer ${getAuthToken()}`
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                loadVocabularyListDetails(vocabularyListId, data.name || 'å•è¯è¡¨');
                            })
                            .catch(error => {
                                console.error('åŠ è½½å•è¯è¡¨å¤±è´¥:', error);
                                // å³ä½¿å¤±è´¥ä¹Ÿåˆ·æ–°åˆ—è¡¨
                                loadUserVocabularies();
                            });
                        }, 2000);
                    } else if (taskData.status === 'failed') {
                        clearInterval(progressCheckInterval);
                        progressCheckInterval = null;
                        hideProgressBar();
                        showToast(`å¤„ç†å¤±è´¥: ${taskData.error_message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    }
                } catch (error) {
                    console.error('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                }
            }, 1000); // æ¯ç§’æŸ¥è¯¢ä¸€æ¬¡
        }
        
        // å¤„ç†å•è¯è¡¨ä¸Šä¼ 
        function handleVocabUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const fileType = file.name.split('.').pop().toLowerCase();
            if (!['txt', 'csv'].includes(fileType)) {
                showToast('è¯·ä¸Šä¼ TXTæˆ–CSVæ ¼å¼çš„æ–‡ä»¶\nTXTæ ¼å¼è¦æ±‚:æ¯è¡Œä¸€ä¸ªå•è¯(å¯é€‰:å•è¯\té‡Šä¹‰\tè¯æ€§\tä¾‹å¥)\nCSVæ ¼å¼è¦æ±‚:å•è¯,é‡Šä¹‰,è¯æ€§,ä¾‹å¥', 'error');
                return;
            }
            
            // è·å–æ–‡ä»¶åï¼ˆä¸åŒ…å«æ‰©å±•åï¼‰ä½œä¸ºå•è¯è¡¨åç§°
            const fileName = file.name.replace(/\.[^/.]+$/, '');
            
            // åˆ›å»ºè¡¨å•æ•°æ®
            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', fileName);
            formData.append('description', `ä¸Šä¼ çš„å•è¯è¡¨: ${fileName}`);
            
            // æ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆéé˜»å¡ï¼‰
            showProgressBar();
            updateProgressBar(0, 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', 0, 0);
            
            // å‘é€åˆ°åç«¯API
            fetch('/api/vocabulary/upload', {
                method: 'POST',
                // æ³¨æ„ï¼šå¯¹äºFormDataï¼Œä¸è¦è®¾ç½®Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨å¤„ç†
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    // è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯å¤„ç†422é”™è¯¯
                    return response.json().then(errorData => {
                        // å¤„ç†FastAPIçš„422éªŒè¯é”™è¯¯æ ¼å¼
                        let errorMessage = 'ä¸Šä¼ å¤±è´¥';
                        if (errorData.detail && Array.isArray(errorData.detail)) {
                            // FastAPIçš„éªŒè¯é”™è¯¯æ ¼å¼
                            errorMessage = errorData.detail.map(err => {
                                if (err.loc && err.msg) {
                                    return `${err.loc.join('.')}: ${err.msg}`;
                                }
                                return err.msg || 'éªŒè¯é”™è¯¯';
                            }).join('\n');
                        } else if (errorData.detail) {
                            errorMessage = errorData.detail;
                        }
                        throw new Error(errorMessage);
                    }).catch(() => {
                        throw new Error(`ä¸Šä¼ å¤±è´¥ (çŠ¶æ€ç : ${response.status})`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // ä¿å­˜ä»»åŠ¡IDå’Œå•è¯è¡¨ID
                currentTaskId = data.task_id;
                const vocabularyListId = data.vocabulary_list_id;
                
                // æ›´æ–°è¿›åº¦æ¡çŠ¶æ€
                updateProgressBar(
                    data.progress || 0,
                    data.message || 'ä»»åŠ¡å·²åˆ›å»ºï¼Œæ­£åœ¨åå°å¤„ç†...',
                    0,
                    0
                );
                
                // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                pollTaskStatus(data.task_id, vocabularyListId);
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showToast('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨åå°å¤„ç†...', 'success');
            })
            .catch(error => {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                hideProgressBar();
                // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                showToast(`ä¸Šä¼ å¤±è´¥:\n${error.message}\n\næ–‡ä»¶æ ¼å¼è¦æ±‚:\n- TXTæ ¼å¼:æ¯è¡Œä¸€ä¸ªå•è¯é¡¹ï¼Œå¯é€‰ä½¿ç”¨Tabåˆ†éš”å•è¯ã€é‡Šä¹‰ã€è¯æ€§å’Œä¾‹å¥\n- CSVæ ¼å¼:ä½¿ç”¨é€—å·åˆ†éš”å•è¯ã€é‡Šä¹‰ã€è¯æ€§å’Œä¾‹å¥`, 'error');
                
                // é™çº§å¤„ç†ï¼šåœ¨å‰ç«¯è§£ææ–‡ä»¶
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        parseVocabularyFile(content, fileType);
                        showToast('ä½¿ç”¨å‰ç«¯è§£æï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™', 'warning');
                    } catch (parseError) {
                        showToast('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                    }
                };
                reader.readAsText(file);
            });
        }
        
        // å¤„ç†æ‹–æ‹½ä¸Šä¼ 
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = 'var(--primary-color)';
        }
        
        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = 'var(--border-color)';
            
            if (event.dataTransfer.files.length > 0) {
                const file = event.dataTransfer.files[0];
                const fileInput = document.getElementById('vocab-upload');
                fileInput.files = event.dataTransfer.files;
                handleVocabUpload({ target: fileInput });
            }
        }
        
        // è§£æå•è¯è¡¨æ–‡ä»¶
        function parseVocabularyFile(content, fileType) {
            let words = [];
            
            if (fileType === 'txt') {
                // TXTæ ¼å¼ï¼šæ¯è¡Œä¸€ä¸ªå•è¯æˆ–å•è¯\té‡Šä¹‰\tè¯æ€§
                const lines = content.split('\n');
                words = lines.map(line => {
                    const parts = line.trim().split('\t');
                    return {
                        word: parts[0] || '',
                        definition: parts[1] || '',
                        partOfSpeech: parts[2] || ''
                    };
                }).filter(item => item.word);
            } else if (fileType === 'csv') {
                // CSVæ ¼å¼ï¼šå•è¯,é‡Šä¹‰,è¯æ€§
                const lines = content.split('\n');
                words = lines.map(line => {
                    const parts = line.trim().split(',');
                    return {
                        word: parts[0] || '',
                        definition: parts[1] || '',
                        partOfSpeech: parts[2] || ''
                    };
                }).filter(item => item.word);
            }
            
            // å­˜å‚¨å½“å‰å•è¯è¡¨
            currentVocabulary = words;
            
            // æ˜¾ç¤ºé¢„è§ˆ
            showVocabularyPreview();
        }
        
        // åŠ è½½ç”¨æˆ·å·²ä¸Šä¼ çš„å•è¯è¡¨
        function loadUserVocabularies() {
            // é˜²æ­¢é‡å¤åŠ è½½
            if (window.isLoadingUserVocabularies) return;
            window.isLoadingUserVocabularies = true;
            
            showLoading('æ­£åœ¨åŠ è½½ç”¨æˆ·å•è¯è¡¨...');
            
            // ç›´æ¥ä½¿ç”¨preset=falseå‚æ•°è·å–ç”¨æˆ·è‡ªå·±çš„å•è¯è¡¨
            fetch('/api/vocabulary/lists?preset=false', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    } else if (response.status === 403) {
                        throw new Error('æ— æƒè®¿é—®ï¼Œè¯·æ£€æŸ¥æƒé™');
                    } else {
                        throw new Error(`è·å–ç”¨æˆ·å•è¯è¡¨å¤±è´¥: ${response.status}`);
                    }
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                console.log('è·å–åˆ°çš„ç”¨æˆ·å•è¯è¡¨æ•°æ®:', data);
                
                // æ•°æ®å·²ç»æ˜¯ç”¨æˆ·è‡ªå·±çš„å•è¯è¡¨ï¼Œæ— éœ€è¿‡æ»¤
                const userVocabularies = Array.isArray(data) ? data : [];
                
                console.log(`æ‰¾åˆ° ${userVocabularies.length} ä¸ªç”¨æˆ·å•è¯è¡¨`);
                
                // æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„å•è¯è¡¨
                const uniqueVocabularies = userVocabularies;
                
                // æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·å•è¯è¡¨åŒºåŸŸ
                let userVocabSection = document.getElementById('user-vocabularies');
                
                if (!userVocabSection) {
                    // åˆ›å»ºæ–°åŒºåŸŸå¹¶æ’å…¥åˆ°å•è¯ç®¡ç†æ¨¡å—ä¸­
                    userVocabSection = document.createElement('div');
                    userVocabSection.id = 'user-vocabularies';
                    userVocabSection.className = 'user-vocabularies';
                    
                    const vocabularySection = document.getElementById('vocabulary');
                    const previewSection = document.getElementById('vocabulary-preview');
                    if (vocabularySection) {
                        if (previewSection) {
                            vocabularySection.insertBefore(userVocabSection, previewSection);
                        } else {
                            vocabularySection.appendChild(userVocabSection);
                        }
                    } else {
                        document.body.appendChild(userVocabSection);
                    }
                }
                
                // æ¸…ç©ºå¹¶é‡æ–°è®¾ç½®å†…å®¹
                userVocabSection.innerHTML = '';
                
                const header = document.createElement('h3');
                header.textContent = 'æˆ‘çš„å•è¯è¡¨';
                userVocabSection.appendChild(header);
                
                const cardsContainer = document.createElement('div');
                cardsContainer.className = 'vocabulary-cards';
                cardsContainer.id = 'user-vocab-cards';
                userVocabSection.appendChild(cardsContainer);
                
                // æ·»åŠ å•è¯è¡¨å¡ç‰‡ - æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„å•è¯è¡¨
                if (uniqueVocabularies.length > 0) {
                    uniqueVocabularies.forEach(vocab => {
                        const card = document.createElement('div');
                        card.className = 'vocabulary-card';
                        card.innerHTML = `
                            <h3>${vocab.name}</h3>
                            <p>${vocab.description || 'ç”¨æˆ·è‡ªå®šä¹‰å•è¯è¡¨'}</p>
                            <div class="vocabulary-info">
                                <span>${vocab.word_count}ä¸ªå•è¯</span>
                                <span>åˆ›å»ºäº${new Date(vocab.created_at).toLocaleDateString()}</span>
                            </div>
                            <div class="vocabulary-actions">
                                <button class="btn btn-danger delete-vocab-btn" style="padding: 5px 10px; font-size: 0.8rem;">åˆ é™¤å•è¯è¡¨</button>
                            </div>
                        `;
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ŒåŠ è½½å•è¯è¡¨è¯¦æƒ…
                        card.querySelector('.delete-vocab-btn').onclick = (e) => {
                            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                            deleteVocabulary(vocab.id, vocab.name);
                        };
                        
                        card.onclick = () => loadVocabularyListDetails(vocab.id, vocab.name);
                        cardsContainer.appendChild(card);
                    });
                } else {
                    cardsContainer.innerHTML = `
                        <div class="no-data" style="text-align: center; padding: 40px; color: #666;">
                            <p style="font-size: 16px; margin-bottom: 10px;">æš‚æ— è‡ªå®šä¹‰å•è¯è¡¨</p>
                            <p style="font-size: 14px; color: #999;">ä¸Šä¼ å•è¯è¡¨å,å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('åŠ è½½ç”¨æˆ·å•è¯è¡¨å¤±è´¥:', error);
                hideLoading();
                
                // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                const errorMessage = error.message || 'åŠ è½½ç”¨æˆ·å•è¯è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                showToast(errorMessage, 'error');
                
                // å³ä½¿å‡ºé”™ä¹Ÿæ˜¾ç¤ºç©ºçŠ¶æ€ï¼Œè€Œä¸æ˜¯ä»€ä¹ˆéƒ½ä¸æ˜¾ç¤º
                let userVocabSection = document.getElementById('user-vocabularies');
                if (!userVocabSection) {
                    userVocabSection = document.createElement('div');
                    userVocabSection.id = 'user-vocabularies';
                    userVocabSection.className = 'user-vocabularies';
                    const vocabularySection = document.getElementById('vocabulary');
                    const previewSection = document.getElementById('vocabulary-preview');
                    if (vocabularySection) {
                        if (previewSection) {
                            vocabularySection.insertBefore(userVocabSection, previewSection);
                        } else {
                            vocabularySection.appendChild(userVocabSection);
                        }
                    }
                }
                
                const header = document.createElement('h3');
                header.textContent = 'æˆ‘çš„å•è¯è¡¨';
                userVocabSection.innerHTML = '';
                userVocabSection.appendChild(header);
                
                const cardsContainer = document.createElement('div');
                cardsContainer.className = 'vocabulary-cards';
                cardsContainer.innerHTML = `
                    <div class="no-data" style="text-align: center; padding: 40px; color: #666;">
                        <p style="font-size: 16px; margin-bottom: 10px;">æš‚æ— è‡ªå®šä¹‰å•è¯è¡¨</p>
                        <p style="font-size: 14px; color: #999;">ä¸Šä¼ å•è¯è¡¨å,å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                `;
                userVocabSection.appendChild(cardsContainer);
            })
            .finally(() => {
                // é‡ç½®åŠ è½½çŠ¶æ€
                window.isLoadingUserVocabularies = false;
            });
        }
        
        // åŠ è½½å•è¯è¡¨è¯¦æƒ…
        function loadVocabularyListDetails(vocabularyId, vocabularyName) {
            showLoading('æ­£åœ¨åŠ è½½å•è¯è¡¨è¯¦æƒ…...');
            
            fetch(`/api/vocabulary/lists/${vocabularyId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–å•è¯è¡¨è¯¦æƒ…å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                
                // æ›´æ–°å½“å‰å•è¯è¡¨ä¿¡æ¯
                currentVocabulary = data.words.map(word => ({
                    word: word.word,
                    definition: word.definition,
                    partOfSpeech: word.part_of_speech,
                    example: word.example,
                    id: word.id
                }));
                currentVocabularyId = data.id;
                
                // æ˜¾ç¤ºå•è¯è¡¨é¢„è§ˆ
                showVocabularyPreview();
                
                // åŒæ—¶æ›´æ–°æ–‡ç« ç”Ÿæˆæ¨¡å—çš„å•è¯é€‰æ‹©åŒºåŸŸ
                console.log('å•è¯è¡¨åŠ è½½å®Œæˆï¼ŒåŒæ—¶æ›´æ–°æ–‡ç« ç”Ÿæˆæ¨¡å—çš„å•è¯é€‰æ‹©');
                const vocabSourceSelect = document.getElementById('vocab-source');
                if (vocabSourceSelect) {
                    vocabSourceSelect.value = 'uploaded';
                    
                    // æ£€æŸ¥æ–‡ç« ç”ŸæˆåŒºåŸŸæ˜¯å¦å¯è§ï¼Œå¦‚æœå¯è§åˆ™ç›´æ¥æ›´æ–°å•è¯é€‰æ‹©
                    const articleSection = document.getElementById('article');
                    if (articleSection && articleSection.style.display !== 'none') {
                        console.log('æ–‡ç« ç”ŸæˆåŒºåŸŸå¯è§ï¼Œæ›´æ–°å•è¯é€‰æ‹©');
                        const vocabSelectionSection = document.getElementById('article-vocab-selection');
                        if (vocabSelectionSection) {
                            vocabSelectionSection.style.display = 'block';
                            displayArticleVocabularySelection();
                            updateSelectionStatus();
                        }
                    }
                }
                
                showToast(`å·²åŠ è½½å•è¯è¡¨: ${vocabularyName}`, 'success');
            })
            .catch(error => {
                console.error('åŠ è½½å•è¯è¡¨è¯¦æƒ…å¤±è´¥:', error);
                hideLoading();
                showToast('åŠ è½½å•è¯è¡¨è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        // å­˜å‚¨é€‰ä¸­çš„å•è¯ID
        // æ˜¾ç¤ºå•è¯è¡¨é¢„è§ˆ
        function showVocabularyPreview() {
            const previewSection = document.getElementById('vocabulary-preview');
            const previewBody = document.getElementById('vocab-preview-body');
            
            // é‡ç½®å½“å‰é¡µç 
            currentPage = 1;
            
            // æ¸…ç©ºé¢„è§ˆå†…å®¹
            previewBody.innerHTML = '';
            
            // è®¡ç®—æ€»é¡µæ•°
            const totalPages = Math.ceil(currentVocabulary.length / pageSize);
            
            // æ˜¾ç¤ºå½“å‰é¡µçš„å•è¯
            displayPage(currentPage);
            
            // åˆ›å»ºæˆ–æ›´æ–°åˆ†é¡µæ§ä»¶
            updatePaginationControls(totalPages);
            
            // æ›´æ–°é€‰æ‹©çŠ¶æ€
            updateSelectionStatus();
            
            // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
            previewSection.style.display = 'block';
            
            // æ·»åŠ æˆ–æ›´æ–°å…¨é€‰æŒ‰é’®
            let selectAllButton = document.getElementById('select-all-button');
            if (!selectAllButton && currentVocabulary.length > 0) {
                selectAllButton = document.createElement('button');
                selectAllButton.id = 'select-all-button';
                selectAllButton.className = 'btn btn-outline-secondary';
                selectAllButton.style.marginTop = '10px';
                selectAllButton.style.marginBottom = '10px';
                selectAllButton.textContent = 'å…¨é€‰/å–æ¶ˆå…¨é€‰';
                selectAllButton.onclick = toggleSelectAll;
                
                // æ’å…¥åˆ°è¡¨æ ¼ä¸Šæ–¹
                const tableContainer = previewBody.parentElement;
                tableContainer.insertBefore(selectAllButton, tableContainer.firstChild);
            }
        }
        
        // å·¥å…·ï¼šåªä¿ç•™å•è¯æœ¬èº«ï¼ˆå»æ‰è§£é‡Š/å¤šä½™ä¿¡æ¯ï¼‰
        function cleanWord(word) {
            if (!word) return '';
            const match = String(word).match(/[A-Za-z\-']+/);
            return match ? match[0] : String(word);
        }
        
        // æ˜¾ç¤ºæŒ‡å®šé¡µç çš„å•è¯
        function displayPage(page) {
            const previewBody = document.getElementById('vocab-preview-body');
            previewBody.innerHTML = '';
            
            // è®¡ç®—èµ·å§‹å’Œç»“æŸç´¢å¼•
            const startIndex = (page - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, currentVocabulary.length);
            
            // è·å–å½“å‰é¡µçš„å•è¯
            const pageWords = currentVocabulary.slice(startIndex, endIndex);
            
            // æ·»åŠ å•è¯åˆ°é¢„è§ˆè¡¨æ ¼
            pageWords.forEach((item, displayIndex) => {
                // è®¡ç®—å®é™…ç´¢å¼•ï¼ˆç”¨äºç¼–è¾‘å’Œåˆ é™¤æ“ä½œï¼‰
                const actualIndex = startIndex + displayIndex;
                
                const row = document.createElement('tr');
                // æ£€æŸ¥å½“å‰å•è¯æ˜¯å¦å·²é€‰ä¸­
                const isChecked = selectedWordIds.includes(item.id) ? 'checked' : '';
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="vocab-checkbox" 
                               data-word-id="${item.id}" ${isChecked} 
                               onchange="toggleWordSelection(${item.id})">
                    </td>
                    <td>${cleanWord(item.word)}</td>
                    <td>${item.definition}</td>
                    <td>${item.partOfSpeech}</td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="editWord(${actualIndex})">ç¼–è¾‘</button>
                        <button class="btn btn-accent" style="padding: 5px 10px; font-size: 0.8rem;" onclick="removeWord(${actualIndex})">åˆ é™¤</button>
                    </td>
                `;
                previewBody.appendChild(row);
            });
        }
        
        // åˆ‡æ¢å•è¯é€‰æ‹©çŠ¶æ€
        function toggleWordSelection(wordId) {
            // æ·»åŠ è¯¦ç»†è°ƒè¯•ä¿¡æ¯
            console.log('åˆ‡æ¢å•è¯é€‰æ‹©:', { 
                originalWordId: wordId, 
                type: typeof wordId,
                currentSelected: selectedWordIds 
            });
            
            // ç¡®ä¿wordIdæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œä»¥ä¾¿æ­£ç¡®æ¯”è¾ƒ
            const stringWordId = String(wordId);
            
            const index = selectedWordIds.indexOf(stringWordId);
            if (index === -1) {
                // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
                selectedWordIds.push(stringWordId);
            } else {
                // ä»é€‰ä¸­åˆ—è¡¨ç§»é™¤
                selectedWordIds.splice(index, 1);
            }
            
            console.log('æ›´æ–°åé€‰ä¸­çš„å•è¯ID:', selectedWordIds);
            
            // æ›´æ–°UIæç¤º
            updateSelectionStatus();
            
            // é‡æ–°æ¸²æŸ“å•è¯åˆ—è¡¨ä»¥æ›´æ–°æ’åºå’Œæ ·å¼
            displayArticleVocabularySelection();
        }
        
        // ç”ŸæˆAIä¸»é¢˜å»ºè®®ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
        async function generateTopicSuggestions() {
            console.log('=== ç”ŸæˆAIä¸»é¢˜å»ºè®® ===');
            console.log('selectedWordIds:', selectedWordIds);
            console.log('currentVocabSourceForArticle:', currentVocabSourceForArticle);
            
            if (!selectedWordIds || selectedWordIds.length === 0) {
                showToast('è¯·å…ˆé€‰æ‹©å•è¯', 'warning');
                return;
            }
            
            // æ„å»ºè¯·æ±‚ä½“ - æ”¯æŒå¤šç§æ¥æºçš„å•è¯
            let requestBody = {};
            
            if (currentVocabSourceForArticle === 'uploaded') {
                // å·²ä¸Šä¼ å•è¯è¡¨ï¼šå‘é€user_word_ids
                const selectedUserWordIds = selectedWordIds
                    .map(id => {
                        const stringId = String(id);
                        const wordObj = currentVocabulary.find(item => String(item.id ?? item.wordId) === stringId);
                        if (wordObj && wordObj.wordId) {
                            const numericId = parseInt(wordObj.wordId, 10);
                            return Number.isNaN(numericId) ? null : numericId;
                        }
                        const numeric = parseInt(stringId, 10);
                        return Number.isNaN(numeric) ? null : numeric;
                    })
                    .filter(id => Number.isInteger(id));
                
                if (!selectedUserWordIds.length) {
                    showToast('æœªæ‰¾åˆ°æœ‰æ•ˆçš„å•è¯ID', 'warning');
                    return;
                }
                requestBody.selected_word_ids = selectedUserWordIds;
                console.log('å‘é€å·²ä¸Šä¼ å•è¯ID:', selectedUserWordIds);
            } else {
                // ç³»ç»Ÿè¯åº“æˆ–è‡ªå®šä¹‰å•è¯ï¼šå‘é€å•è¯æ–‡æœ¬åˆ—è¡¨
                const selectedWords = selectedWordIds
                    .map(id => {
                        const stringId = String(id);
                        const wordObj = currentVocabulary.find(item => String(item.id ?? item.wordId) === stringId);
                        console.log(`æŸ¥æ‰¾å•è¯ ${stringId}:`, wordObj);
                        return wordObj ? wordObj.word : null;
                    })
                    .filter(word => word && word.trim());
                
                console.log('æ‰¾åˆ°çš„å•è¯æ–‡æœ¬:', selectedWords);
                
                if (!selectedWords.length) {
                    showToast('æœªæ‰¾åˆ°æœ‰æ•ˆçš„å•è¯', 'warning');
                    return;
                }
                requestBody.words = selectedWords;
                console.log('å‘é€ç³»ç»Ÿè¯åº“/è‡ªå®šä¹‰å•è¯:', selectedWords);
            }
            
            console.log('è¯·æ±‚ä½“:', requestBody);
            
            // è·å–æŒ‰é’®å…ƒç´ 
            const btn = document.getElementById('generate-topics-btn');
            const btnText = document.getElementById('generate-topics-btn-text');
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (btn) {
                btn.disabled = true;
                btnText.textContent = 'ç”Ÿæˆä¸­...';
            }
            
            try {
                console.log('å‘é€è¯·æ±‚åˆ° /api/articles/generate-topics');
                const response = await fetch('/api/articles/generate-topics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('å“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯:', errorText);
                    throw new Error('ç”Ÿæˆä¸»é¢˜å¤±è´¥');
                }
                
                const data = await response.json();
                console.log('APIå“åº”æ•°æ®:', data);
                const topics = data.topics || [];
                console.log('ç”Ÿæˆçš„ä¸»é¢˜:', topics);
                
                // æ˜¾ç¤ºä¸»é¢˜å»ºè®®
                const suggestionsDiv = document.getElementById('topic-suggestions');
                const tagsDiv = document.getElementById('topic-tags');
                
                console.log('ä¸»é¢˜æ˜¾ç¤ºå®¹å™¨:', { suggestionsDiv, tagsDiv });
                
                if (topics.length > 0 && suggestionsDiv && tagsDiv) {
                    console.log('æ˜¾ç¤ºä¸»é¢˜æ ‡ç­¾');
                    // æ¸…ç©ºç°æœ‰æ ‡ç­¾
                    tagsDiv.innerHTML = '';
                    
                    // åˆ›å»ºä¸»é¢˜æ ‡ç­¾
                    topics.forEach(topic => {
                        const tag = document.createElement('span');
                        tag.className = 'topic-tag';
                        tag.textContent = topic;
                        tag.style.cssText = `
                            display: inline-block;
                            padding: 6px 12px;
                            background-color: #f0f0f0;
                            border: 1px solid #ddd;
                            border-radius: 16px;
                            cursor: pointer;
                            font-size: 13px;
                            color: #333;
                            transition: all 0.2s;
                            user-select: none;
                        `;
                        
                        // æ‚¬åœæ•ˆæœ
                        tag.onmouseenter = function() {
                            this.style.backgroundColor = '#e0e0e0';
                            this.style.borderColor = '#007bff';
                        };
                        tag.onmouseleave = function() {
                            this.style.backgroundColor = '#f0f0f0';
                            this.style.borderColor = '#ddd';
                        };
                        
                        // ç‚¹å‡»é€‰æ‹©ä¸»é¢˜
                        tag.onclick = function() {
                            const topicInput = document.getElementById('article-topic');
                            if (topicInput) {
                                topicInput.value = topic;
                                // æ·»åŠ è§†è§‰åé¦ˆ
                                tag.style.backgroundColor = '#007bff';
                                tag.style.color = '#fff';
                                tag.style.borderColor = '#007bff';
                                
                                // ç§»é™¤å…¶ä»–æ ‡ç­¾çš„é€‰ä¸­çŠ¶æ€
                                tagsDiv.querySelectorAll('.topic-tag').forEach(t => {
                                    if (t !== tag) {
                                        t.style.backgroundColor = '#f0f0f0';
                                        t.style.color = '#333';
                                        t.style.borderColor = '#ddd';
                                    }
                                });
                            }
                        };
                        
                        tagsDiv.appendChild(tag);
                    });
                    
                    suggestionsDiv.style.display = 'block';
                } else if (suggestionsDiv) {
                    suggestionsDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('ç”Ÿæˆä¸»é¢˜å»ºè®®å¤±è´¥:', error);
                // å¤±è´¥æ—¶ä¸æ˜¾ç¤ºä¸»é¢˜å»ºè®®
                const suggestionsDiv = document.getElementById('topic-suggestions');
                if (suggestionsDiv) {
                    suggestionsDiv.style.display = 'none';
                }
                showToast('ç”Ÿæˆä¸»é¢˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (btn) {
                    btn.disabled = false;
                    btnText.textContent = 'ğŸ¤– AIç”Ÿæˆä¸»é¢˜';
                }
            }
        }
        
        // æ›´æ–°é€‰æ‹©çŠ¶æ€æç¤º
        function updateSelectionStatus() {
            // å¤„ç†æ–‡ç« ç”Ÿæˆæ¨¡å—ä¸­çš„çŠ¶æ€æ˜¾ç¤º
            let articleStatusElement = document.getElementById('article-selection-status');
            if (!articleStatusElement) {
                articleStatusElement = document.createElement('div');
                articleStatusElement.id = 'article-selection-status';
                articleStatusElement.style.marginTop = '10px';
                articleStatusElement.style.color = '#666';
                
                // æŸ¥æ‰¾æ–‡ç« ç”Ÿæˆæ¨¡å—ä¸­çš„å®¹å™¨å…ƒç´ 
                const articleVocabSection = document.getElementById('article-vocab-selection');
                if (articleVocabSection) {
                    // æ‰¾åˆ°"å·²é€‰æ‹© X ä¸ªå•è¯"çš„ä½ç½®å¹¶æ›´æ–°
                    const existingStatus = articleVocabSection.querySelector('.selection-count');
                    if (existingStatus) {
                        existingStatus.textContent = `å·²é€‰æ‹© ${selectedWordIds.length} ä¸ªå•è¯`;
                    }
                }
            } else {
                articleStatusElement.textContent = `å·²é€‰æ‹© ${selectedWordIds.length} ä¸ªå•è¯`;
            }
            
            // åŒæ—¶æ›´æ–°å•è¯è¡¨é¢„è§ˆæ¨¡å—çš„çŠ¶æ€
            let previewStatusElement = document.getElementById('selection-status');
            if (previewStatusElement) {
                previewStatusElement.textContent = `å·²é€‰æ‹© ${selectedWordIds.length} ä¸ªå•è¯`;
            }
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            console.log('æ›´æ–°é€‰æ‹©çŠ¶æ€:', { selectedCount: selectedWordIds.length });
            
            // æ›´æ–°ç”Ÿæˆä¸»é¢˜æŒ‰é’®çš„å¯ç”¨çŠ¶æ€ï¼ˆæ‰€æœ‰æ¥æºéƒ½æ”¯æŒï¼‰
            const generateBtn = document.getElementById('generate-topics-btn');
            if (generateBtn) {
                if (selectedWordIds.length > 0) {
                    generateBtn.disabled = false;
                    generateBtn.style.opacity = '1';
                    generateBtn.style.cursor = 'pointer';
                } else {
                    generateBtn.disabled = true;
                    generateBtn.style.opacity = '0.6';
                    generateBtn.style.cursor = 'not-allowed';
                }
            }
            
            // å¦‚æœæ²¡æœ‰é€‰ä¸­å•è¯ï¼Œéšè—ä¸»é¢˜å»ºè®®
            if (selectedWordIds.length === 0) {
                const suggestionsDiv = document.getElementById('topic-suggestions');
                if (suggestionsDiv) {
                    suggestionsDiv.style.display = 'none';
                }
            }
        }
        
        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            const isAllChecked = currentVocabulary.length > 0 && selectedWordIds.length === currentVocabulary.length;
            
            selectedWordIds.length = 0;
            
            if (!isAllChecked) {
                // å…¨é€‰
                currentVocabulary.forEach(item => {
                    const itemId = item.id ?? item.wordId ?? item.word;
                    if (itemId) {
                        selectedWordIds.push(String(itemId));
                    }
                });
            }
            // å¦‚æœisAllCheckedä¸ºtrueï¼Œåˆ™å–æ¶ˆå…¨é€‰ï¼ˆselectedWordIdså·²æ¸…ç©ºï¼‰
            
            // æ›´æ–°UIæç¤º
            updateSelectionStatus();
            
            // é‡æ–°æ¸²æŸ“å•è¯åˆ—è¡¨ä»¥æ›´æ–°æ’åºå’Œæ ·å¼
            displayArticleVocabularySelection();
        }
        
        // æ˜¾ç¤ºå·²é€‰å•è¯å¼¹çª—
        function showSelectedWordsModal() {
            console.log('=== æ˜¾ç¤ºå·²é€‰å•è¯å¼¹çª— ===');
            console.log('selectedWordIds:', selectedWordIds);
            console.log('currentVocabulary:', currentVocabulary);
            
            if (!selectedWordIds || selectedWordIds.length === 0) {
                showToast('è¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•å•è¯', 'warning');
                return;
            }
            
            // è·å–å·²é€‰å•è¯çš„å®Œæ•´ä¿¡æ¯
            const selectedWords = selectedWordIds
                .map(id => {
                    const stringId = String(id);
                    const word = currentVocabulary.find(item => String(item.id ?? item.wordId) === stringId);
                    console.log(`æŸ¥æ‰¾å•è¯ ID ${stringId}:`, word);
                    return word;
                })
                .filter(word => word);
            
            console.log('æ‰¾åˆ°çš„å•è¯:', selectedWords);
            
            if (selectedWords.length === 0) {
                showToast('æœªæ‰¾åˆ°å·²é€‰å•è¯çš„è¯¦ç»†ä¿¡æ¯', 'error');
                return;
            }
            
            // æ›´æ–°å•è¯æ•°é‡
            const countElement = document.getElementById('modal-selected-count');
            if (countElement) {
                countElement.textContent = selectedWords.length;
            }
            
            // ç”Ÿæˆå•è¯åˆ—è¡¨HTML
            const listContainer = document.getElementById('selected-words-list');
            if (!listContainer) {
                console.error('æ‰¾ä¸åˆ° selected-words-list å…ƒç´ ');
                return;
            }
            
            listContainer.innerHTML = `
                <table class="preview-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="width: 50px;">åºå·</th>
                            <th style="width: 150px;">å•è¯</th>
                            <th>é‡Šä¹‰</th>
                            <th style="width: 100px;">è¯æ€§</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${selectedWords.map((word, index) => `
                            <tr>
                                <td style="text-align: center;">${index + 1}</td>
                                <td><strong>${escapeHtml(word.word || '')}</strong></td>
                                <td>${escapeHtml(word.definition || '')}</td>
                                <td>${escapeHtml(word.partOfSpeech || word.part_of_speech || '')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = document.getElementById('selected-words-modal');
            if (!modal) {
                console.error('æ‰¾ä¸åˆ° selected-words-modal å…ƒç´ ');
                return;
            }
            
            console.log('è®¾ç½®æ¨¡æ€æ¡† display ä¸º flex');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // ç¡®è®¤æ¨¡æ€æ¡†æ˜¯å¦å¯è§
            setTimeout(() => {
                const computedStyle = window.getComputedStyle(modal);
                console.log('æ¨¡æ€æ¡†è®¡ç®—æ ·å¼:', {
                    display: computedStyle.display,
                    visibility: computedStyle.visibility,
                    zIndex: computedStyle.zIndex
                });
            }, 100);
        }
        
        // å…³é—­å·²é€‰å•è¯å¼¹çª—
        function closeSelectedWordsModal() {
            const modal = document.getElementById('selected-words-modal');
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
        
        // å¤åˆ¶å·²é€‰å•è¯åˆ—è¡¨
        function copySelectedWords() {
            if (!selectedWordIds || selectedWordIds.length === 0) {
                showToast('æ²¡æœ‰é€‰æ‹©çš„å•è¯', 'warning');
                return;
            }
            
            // è·å–å·²é€‰å•è¯
            const selectedWords = selectedWordIds
                .map(id => {
                    const stringId = String(id);
                    return currentVocabulary.find(item => String(item.id ?? item.wordId) === stringId);
                })
                .filter(word => word);
            
            // ç”Ÿæˆæ–‡æœ¬æ ¼å¼
            const textContent = selectedWords
                .map((word, index) => {
                    const definition = word.definition || '';
                    const pos = word.partOfSpeech || word.part_of_speech || '';
                    return `${index + 1}. ${word.word}${pos ? ' (' + pos + ')' : ''} - ${definition}`;
                })
                .join('\n');
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(textContent).then(() => {
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(e) {
            // å…³é—­å·²é€‰å•è¯å¼¹çª—
            const selectedWordsModal = document.getElementById('selected-words-modal');
            if (selectedWordsModal && e.target === selectedWordsModal) {
                closeSelectedWordsModal();
            }
            
            // å…³é—­æ–‡ç« åˆ—è¡¨å¼¹çª—
            const articleListModal = document.getElementById('article-list-modal');
            if (articleListModal && e.target === articleListModal) {
                closeArticleListModal();
            }
        });
        
        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePaginationControls(totalPages) {
            // æŸ¥æ‰¾æˆ–åˆ›å»ºåˆ†é¡µå®¹å™¨
            let paginationContainer = document.getElementById('vocabulary-pagination');
            if (!paginationContainer) {
                paginationContainer = document.createElement('div');
                paginationContainer.id = 'vocabulary-pagination';
                paginationContainer.className = 'pagination-controls';
                
                // æ·»åŠ æ ·å¼
                paginationContainer.style.display = 'flex';
                paginationContainer.style.justifyContent = 'center';
                paginationContainer.style.marginTop = '20px';
                paginationContainer.style.gap = '10px';
                
                // å°†åˆ†é¡µå®¹å™¨æ·»åŠ åˆ°é¢„è§ˆåŒºåŸŸ
                const previewSection = document.getElementById('vocabulary-preview');
                previewSection.appendChild(paginationContainer);
            }
            
            // æ¸…ç©ºåˆ†é¡µæ§ä»¶
            paginationContainer.innerHTML = '';
            
            // åˆ›å»ºä¸Šä¸€é¡µæŒ‰é’®
            const prevButton = document.createElement('button');
            prevButton.className = 'btn btn-secondary';
            prevButton.textContent = 'ä¸Šä¸€é¡µ';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayPage(currentPage);
                    updatePaginationControls(totalPages);
                }
            };
            paginationContainer.appendChild(prevButton);
            
            // åˆ›å»ºé¡µç æŒ‰é’®
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // è°ƒæ•´èµ·å§‹é¡µï¼Œç¡®ä¿æ˜¾ç¤ºè¶³å¤Ÿçš„é¡µç 
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // æ·»åŠ ç¬¬ä¸€é¡µæŒ‰é’®
            if (startPage > 1) {
                addPageButton(1, paginationContainer, totalPages);
                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.margin = '0 5px';
                    dots.style.lineHeight = '38px';
                    paginationContainer.appendChild(dots);
                }
            }
            
            // æ·»åŠ ä¸­é—´é¡µç æŒ‰é’®
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(i, paginationContainer, totalPages);
            }
            
            // æ·»åŠ æœ€åä¸€é¡µæŒ‰é’®
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.margin = '0 5px';
                    dots.style.lineHeight = '38px';
                    paginationContainer.appendChild(dots);
                }
                addPageButton(totalPages, paginationContainer, totalPages);
            }
            
            // åˆ›å»ºä¸‹ä¸€é¡µæŒ‰é’®
            const nextButton = document.createElement('button');
            nextButton.className = 'btn btn-secondary';
            nextButton.textContent = 'ä¸‹ä¸€é¡µ';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayPage(currentPage);
                    updatePaginationControls(totalPages);
                }
            };
            paginationContainer.appendChild(nextButton);
            
            // æ·»åŠ é¡µç ä¿¡æ¯
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µï¼Œæ€»è®¡ ${currentVocabulary.length} ä¸ªå•è¯`;
            pageInfo.style.marginLeft = '20px';
            pageInfo.style.lineHeight = '38px';
            paginationContainer.appendChild(pageInfo);
        }
        
        // æ·»åŠ é¡µç æŒ‰é’®çš„è¾…åŠ©å‡½æ•°
        function addPageButton(pageNum, container, totalPages) {
            const pageButton = document.createElement('button');
            pageButton.className = pageNum === currentPage ? 'btn btn-primary' : 'btn btn-secondary';
            pageButton.textContent = pageNum;
            pageButton.onclick = () => {
                currentPage = pageNum;
                displayPage(currentPage);
                updatePaginationControls(totalPages);
            };
            container.appendChild(pageButton);
        }
        
        // ç¼–è¾‘å•è¯
        function editWord(index) {
            const word = currentVocabulary[index];
            const newWord = prompt('ç¼–è¾‘å•è¯:', word.word);
            const newDefinition = prompt('ç¼–è¾‘é‡Šä¹‰:', word.definition);
            const newPartOfSpeech = prompt('ç¼–è¾‘è¯æ€§:', word.partOfSpeech);
            
            if (newWord !== null && newWord.trim() !== '') {
                currentVocabulary[index] = {
                    word: newWord.trim(),
                    definition: newDefinition !== null ? newDefinition.trim() : word.definition,
                    partOfSpeech: newPartOfSpeech !== null ? newPartOfSpeech.trim() : word.partOfSpeech
                };
                
                // é‡æ–°æ˜¾ç¤ºå½“å‰é¡µï¼Œè€Œä¸æ˜¯é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                const totalPages = Math.ceil(currentVocabulary.length / pageSize);
                // å¦‚æœå½“å‰é¡µè¶…å‡ºäº†æ€»é¡µæ•°ï¼Œè°ƒæ•´åˆ°æœ€åä¸€é¡µ
                if (currentPage > totalPages) {
                    currentPage = totalPages;
                }
                displayPage(currentPage);
                updatePaginationControls(totalPages);
                
                showToast('å•è¯å·²æ›´æ–°', 'success');
            }
        }
        
        // åˆ é™¤å•è¯è¡¨
        function deleteVocabulary(vocabularyId, vocabularyName) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤å•è¯è¡¨"${vocabularyName}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                showLoading('æ­£åœ¨åˆ é™¤å•è¯è¡¨...');
                
                // ç¡®ä¿ä¼ é€’æ•´æ•°ç±»å‹çš„ID
                const id = parseInt(vocabularyId, 10);
                const token = getAuthToken();
                fetch(`/api/vocabulary/lists/${id}?token=${encodeURIComponent(token)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    console.log('å“åº”çŠ¶æ€ç :', response.status);
                    if (!response.ok) {
                        // å°è¯•è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
                        return response.json().then(errorData => {
                            throw new Error(`åˆ é™¤å•è¯è¡¨å¤±è´¥: ${JSON.stringify(errorData)}`);
                        }).catch(() => {
                            throw new Error(`åˆ é™¤å•è¯è¡¨å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    hideLoading();
                    console.log('åˆ é™¤å“åº”æ•°æ®:', data);
                    
                    // æ£€æŸ¥APIè¿”å›çš„çŠ¶æ€
                    if (data && data.status === 'success') {
                        showToast('å•è¯è¡¨å·²æˆåŠŸåˆ é™¤', 'success');
                        
                        // æ¸…ç©ºå½“å‰å•è¯è¡¨æ•°æ®
                        currentVocabulary = [];
                        currentVocabularyId = null;
                        
                        // éšè—é¢„è§ˆåŒºåŸŸ
                        const previewSection = document.getElementById('vocabulary-preview');
                        if (previewSection) {
                            previewSection.style.display = 'none';
                        }
                        
                        // é‡æ–°åŠ è½½ç”¨æˆ·å•è¯è¡¨
                        loadUserVocabularies();
                    } else {
                        // æ˜¾ç¤ºAPIè¿”å›çš„å…·ä½“é”™è¯¯æ¶ˆæ¯
                        const errorMessage = data && data.message ? data.message : 'åˆ é™¤å¤±è´¥ï¼ŒæœªçŸ¥é”™è¯¯';
                        showToast(errorMessage, 'error');
                        console.warn('åˆ é™¤APIè¿”å›é”™è¯¯çŠ¶æ€:', data);
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤å•è¯è¡¨å¤±è´¥:', error);
                    hideLoading();
                    showToast('åˆ é™¤å•è¯è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                });
            }
        }
        
        // åˆ é™¤å•è¯
        function removeWord(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•è¯å—ï¼Ÿ')) {
                currentVocabulary.splice(index, 1);
                
                // é‡æ–°æ˜¾ç¤ºå½“å‰é¡µï¼Œè€Œä¸æ˜¯é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                const totalPages = Math.ceil(currentVocabulary.length / pageSize);
                // å¦‚æœå½“å‰é¡µè¶…å‡ºäº†æ€»é¡µæ•°ï¼Œè°ƒæ•´åˆ°æœ€åä¸€é¡µ
                if (currentPage > totalPages) {
                    currentPage = totalPages || 1; // ç¡®ä¿è‡³å°‘æœ‰ä¸€é¡µ
                }
                displayPage(currentPage);
                updatePaginationControls(totalPages);
                
                showToast('å•è¯å·²åˆ é™¤', 'success');
            }
        }
        
        // ä¿å­˜å•è¯è¡¨
        function saveVocabulary() {
            showLoading('æ­£åœ¨ä¿å­˜å•è¯è¡¨...');
            
            // å‡†å¤‡å•è¯è¡¨æ•°æ®ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
            const formattedVocabulary = currentVocabulary.map(item => ({
                word: cleanWord(item.word || ''),
                definition: item.definition || '',
                partOfSpeech: item.partOfSpeech || '',
                example: item.example || ''
            }));
            
            const requestData = {
                vocabulary: formattedVocabulary,
                vocabulary_id: currentVocabularyId
            };
            
            console.log('ä¿å­˜çš„å•è¯è¡¨æ•°æ®:', requestData);
            
            // å‘é€è¯·æ±‚åˆ°åç«¯API
            fetch('/api/vocabulary/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                console.log('å“åº”çŠ¶æ€:', response.status);
                return response.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        // éJSONå“åº”
                        if (!response.ok) {
                            throw new Error(text || `HTTPé”™è¯¯: ${response.status}`);
                        }
                        return {};
                    }
                });
            })
            .then(data => {
                hideLoading();
                if (data.message) {
                    showToast(data.message, 'success');
                } else {
                    showToast('å•è¯è¡¨ä¿å­˜æˆåŠŸï¼', 'success');
                }
            })
            .catch(error => {
                console.error('ä¿å­˜å•è¯è¡¨å¤±è´¥:', error.message);
                hideLoading();
                // æå–æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                let errorMsg = error.message;
                if (errorMsg.includes('422')) {
                    errorMsg = 'æ•°æ®éªŒè¯é”™è¯¯ï¼Œè¯·æ£€æŸ¥å•è¯è¡¨å†…å®¹';
                }
                showToast(`å•è¯è¡¨ä¿å­˜å¤±è´¥: ${errorMsg}`, 'error');
            });
        }
        
        // AIæ•´ç†å•è¯è¡¨
        async function reorganizeVocabulary() {
            // æ£€æŸ¥æ˜¯å¦æœ‰å•è¯è¡¨IDï¼ˆå·²ä¿å­˜çš„å•è¯è¡¨ï¼‰
            if (!currentVocabularyId) {
                showToast('è¯·å…ˆä¿å­˜å•è¯è¡¨ï¼Œç„¶åå†è¿›è¡ŒAIæ•´ç†', 'warning');
                return;
            }
            
            // è·å–é€‰ä¸­çš„å•è¯IDï¼ˆå¦‚æœæœ‰é€‰ä¸­çš„ï¼‰
            const selectedIds = selectedWordIds.length > 0 ? selectedWordIds : null;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const reorganizeBtn = document.getElementById('reorganize-btn');
            const reorganizeIcon = document.getElementById('reorganize-icon');
            const originalText = reorganizeBtn.innerHTML;
            reorganizeBtn.disabled = true;
            reorganizeBtn.innerHTML = '<span>â³</span> AIæ•´ç†ä¸­...';
            
            try {
                const requestData = selectedIds ? { word_ids: selectedIds } : {};
                
                const response = await fetch(`/api/vocabulary/${currentVocabularyId}/reorganize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(
                        `AIæ•´ç†å®Œæˆï¼æˆåŠŸæ•´ç† ${data.processed_count} ä¸ªå•è¯${data.failed_count > 0 ? `ï¼Œå¤±è´¥ ${data.failed_count} ä¸ª` : ''}`,
                        'success'
                    );
                    
                    // é‡æ–°åŠ è½½å•è¯è¡¨ä»¥æ˜¾ç¤ºæ›´æ–°åçš„ä¿¡æ¯
                    if (currentVocabularyId) {
                        loadVocabularyListDetails(currentVocabularyId, '');
                    } else {
                        // å¦‚æœæ˜¯ä¸´æ—¶å•è¯è¡¨ï¼Œåˆ·æ–°é¢„è§ˆ
                        showVocabularyPreview();
                    }
                } else {
                    throw new Error(data.detail || 'æ•´ç†å¤±è´¥');
                }
            } catch (error) {
                console.error('AIæ•´ç†å¤±è´¥:', error);
                showToast(`AIæ•´ç†å¤±è´¥: ${error.message}`, 'error');
            } finally {
                reorganizeBtn.disabled = false;
                reorganizeBtn.innerHTML = originalText;
            }
        }
        
        // ç”Ÿæˆå­¦ä¹ æ–‡ç« 
        function generateArticle() {
            if (currentVocabulary.length === 0) {
                showToast('è¯·å…ˆä¸Šä¼ æˆ–é€‰æ‹©å•è¯è¡¨', 'error');
                return;
            }
            
            // åˆ‡æ¢åˆ°æ–‡ç« ç”ŸæˆåŒºåŸŸ
            switchSection('article');
            
            // è‡ªåŠ¨å¡«å……å•è¯è¡¨æ¥æº
            const vocabSourceSelect = document.getElementById('vocab-source');
            
            // å¦‚æœæœ‰å•è¯è¡¨IDï¼Œä½¿ç”¨'uploaded'é€‰é¡¹
            if (currentVocabularyId) {
                vocabSourceSelect.value = 'uploaded';
                // è§¦å‘å•è¯é€‰æ‹©åŒºåŸŸçš„æ˜¾ç¤º
                handleVocabSourceChange();
            } else {
                // è‡ªå®šä¹‰å•è¯è¡¨æƒ…å†µ
                vocabSourceSelect.value = 'custom';
            }
            
            // ç«‹å³è§¦å‘ä¸€æ¬¡å•è¯è¡¨æ¥æºå˜åŒ–å¤„ç†ï¼Œç¡®ä¿å•è¯é€‰æ‹©åŒºåŸŸæ­£ç¡®æ˜¾ç¤º
            setTimeout(handleVocabSourceChange, 100);
            
            // è‡ªåŠ¨è°ƒç”¨ç”Ÿæˆæ–‡ç« å‡½æ•°
            generateArticleFromSettings();
        }
        
        // å¤„ç†å•è¯è¡¨æ¥æºå˜åŒ–
        function handleVocabSourceChange() {
            const vocabSourceSelect = document.getElementById('vocab-source');
            if (!vocabSourceSelect) return;
            
            const vocabSource = vocabSourceSelect.value;
            currentVocabSourceForArticle = vocabSource;
            const vocabSelectionSection = document.getElementById('article-vocab-selection');
            const vocabListSelectionSection = document.getElementById('article-vocab-list-selection');
            const systemTools = document.getElementById('system-word-tools');
            const customEditor = document.getElementById('custom-word-editor');
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            console.log('å¤„ç†å•è¯è¡¨æ¥æºå˜åŒ–:', { 
                vocabSource, 
                currentVocabularyLength: currentVocabulary.length,
                currentVocabularyId: currentVocabularyId 
            });
            
            // æ›´æ–°é€‰ä¸­å•è¯é›†åˆå¼•ç”¨
            if (!Array.isArray(selectedWordIdsBySource[vocabSource])) {
                selectedWordIdsBySource[vocabSource] = [];
            }
            selectedWordIds = selectedWordIdsBySource[vocabSource];
            
            // é»˜è®¤éšè—é™„åŠ å·¥å…·é¢æ¿
            if (systemTools) systemTools.style.display = 'none';
            if (customEditor) customEditor.style.display = 'none';
            
            // åªè¦é€‰æ‹©äº†å·²ä¸Šä¼ å•è¯è¡¨ï¼Œå…ˆæ˜¾ç¤ºå•è¯è¡¨åˆ—è¡¨ä¾›é€‰æ‹©
            if (vocabSource === 'uploaded') {
                currentVocabulary = articleUploadedWords;
                currentVocabularyId = articleUploadedVocabularyId;
                
                // å¦‚æœå·²ç»æœ‰é€‰ä¸­çš„å•è¯è¡¨ï¼Œç›´æ¥æ˜¾ç¤ºå•è¯é€‰æ‹©åŒºåŸŸ
                if (articleUploadedWords.length > 0 && articleUploadedVocabularyId) {
                    vocabListSelectionSection.style.setProperty('display', 'none', 'important');
                    vocabSelectionSection.style.setProperty('display', 'block', 'important');
                    vocabSelectionSection.style.setProperty('visibility', 'visible', 'important');
                    vocabSelectionSection.style.setProperty('opacity', '1', 'important');
                    vocabSelectionSection.removeAttribute('hidden');
                    displayArticleVocabularySelection();
                    updateSelectionStatus();
                } else {
                    // æ˜¾ç¤ºå•è¯è¡¨åˆ—è¡¨ä¾›ç”¨æˆ·é€‰æ‹©
                    vocabSelectionSection.style.setProperty('display', 'none', 'important');
                    vocabListSelectionSection.style.setProperty('display', 'block', 'important');
                    loadArticleVocabularies();
                }
            } else if (vocabSource === 'system') {
                // éšè—ç”¨æˆ·å•è¯è¡¨å®¹å™¨
                if (vocabListSelectionSection) {
                    vocabListSelectionSection.style.setProperty('display', 'none', 'important');
                }
                
                // æ˜¾ç¤ºç³»ç»Ÿè¯åº“å·¥å…·å’Œå•è¯é€‰æ‹©åŒºåŸŸ
                if (systemTools) {
                    systemTools.style.display = 'block';
                }
                if (vocabSelectionSection) {
                    vocabSelectionSection.style.setProperty('display', 'block', 'important');
                    vocabSelectionSection.style.setProperty('visibility', 'visible', 'important');
                    vocabSelectionSection.style.setProperty('opacity', '1', 'important');
                    vocabSelectionSection.removeAttribute('hidden');
                    setArticleVocabTableMessage('æ­£åœ¨åŠ è½½ç³»ç»Ÿè¯åº“...', { color: 'var(--text-secondary)' });
                }
                
                // é‡ç½®ç³»ç»Ÿè¯åº“ç›¸å…³çŠ¶æ€å¹¶åŠ è½½éšæœºå•è¯
                articleSystemWords = [];
                currentVocabulary = articleSystemWords;
                currentVocabularyId = null;
                selectedWordIdsBySource.system = [];
                selectedWordIds = selectedWordIdsBySource.system;
                loadSystemWordsForArticle({ limit: 50 });
            } else if (vocabSource === 'custom') {
                currentVocabulary = articleCustomWords;
                currentVocabularyId = null;
                if (vocabListSelectionSection) {
                    vocabListSelectionSection.style.setProperty('display', 'none', 'important');
                }
                if (vocabSelectionSection) {
                    vocabSelectionSection.style.setProperty('display', 'block', 'important');
                    vocabSelectionSection.style.setProperty('visibility', 'visible', 'important');
                    vocabSelectionSection.style.setProperty('opacity', '1', 'important');
                    vocabSelectionSection.removeAttribute('hidden');
                }
                if (customEditor) {
                    customEditor.style.display = 'block';
                }
                
                // å¯¹äºè‡ªå®šä¹‰å•è¯ï¼Œå¦‚æœå·²ç»æœ‰å•è¯æ•°æ®ï¼Œæ˜¾ç¤ºå•è¯é€‰æ‹©åŒºåŸŸ
                if (articleCustomWords && articleCustomWords.length > 0) {
                    displayArticleVocabularySelection();
                    updateSelectionStatus();
                } else {
                    // å¦‚æœæ²¡æœ‰å•è¯æ•°æ®ï¼Œéšè—å•è¯é€‰æ‹©åŒºåŸŸ
                    if (vocabSelectionSection) {
                        vocabSelectionSection.style.setProperty('display', 'none', 'important');
                    }
                }
            } else {
                // éšè—å•è¯é€‰æ‹©åŒºåŸŸå’Œå•è¯è¡¨åˆ—è¡¨
                vocabSelectionSection.style.setProperty('display', 'none', 'important');
                vocabListSelectionSection.style.setProperty('display', 'none', 'important');
            }
            
            updateSelectionStatus();
        }
        
        function setArticleVocabTableMessage(message, options = {}) {
            const vocabBody = document.getElementById('article-vocab-body');
            if (!vocabBody) {
                return;
            }
            const color = options.color || 'var(--text-secondary)';
            vocabBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px; color: ${color};">${message}</td></tr>`;
        }
        
        function shuffleArray(array) {
            const result = array.slice();
            for (let i = result.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [result[i], result[j]] = [result[j], result[i]];
            }
            return result;
        }
        
        async function loadSystemWordsForArticle({ limit = 50 } = {}) {
            const safeLimit = Math.max(1, limit);
            const pageSize = Math.min(Math.max(safeLimit, 20), 50);
            try {
                let response = await authenticatedFetch(`/api/public-words?page=1&page_size=${pageSize}`);
                if (!response.ok) {
                    throw new Error('åŠ è½½ç³»ç»Ÿè¯åº“å¤±è´¥');
                }
                let data = await response.json();
                const total = data.total || 0;
                const totalPages = Math.max(1, Math.ceil(total / pageSize));
                let randomPage = totalPages > 1 ? Math.floor(Math.random() * totalPages) + 1 : 1;
                let items = Array.isArray(data.items) ? data.items.slice() : [];
                
                if (totalPages > 1 && randomPage !== 1) {
                    const randomResponse = await authenticatedFetch(`/api/public-words?page=${randomPage}&page_size=${pageSize}`);
                    if (randomResponse.ok) {
                        const randomData = await randomResponse.json();
                        items = Array.isArray(randomData.items) ? randomData.items.slice() : items;
                    }
                }
                
                systemWordSearchState.page = randomPage;
                systemWordSearchState.totalPages = totalPages;
                systemWordSearchState.query = '';
                
                if (!items.length) {
                    articleSystemWords = [];
                    currentVocabulary = articleSystemWords;
                    setArticleVocabTableMessage('ç³»ç»Ÿè¯åº“æš‚æ— å¯ç”¨å•è¯ï¼Œè¯·ç¨åå†è¯•ã€‚', { color: 'var(--text-secondary)' });
                    return;
                }
                
                const randomizedItems = shuffleArray(items).slice(0, safeLimit);
                articleSystemWords = randomizedItems.map(item => ({
                    id: item.id,
                    wordId: item.id,
                    word: item.word,
                    definition: item.definition || '',
                    partOfSpeech: item.part_of_speech || '',
                    example: item.example || '',
                    source: 'system'
                }));
                
                currentVocabulary = articleSystemWords;
                currentVocabularyId = null;
                systemWordSearchState.lastResults = articleSystemWords;
                
                displayArticleVocabularySelection();
                
                const systemWordBody = document.getElementById('system-word-results-body');
                if (systemWordBody) {
                    systemWordBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--text-secondary); padding: 14px;">å·²éšæœºæŒ‘é€‰ 50 ä¸ªç³»ç»Ÿè¯åº“å•è¯ï¼Œå¯åœ¨ä¸Šæ–¹ç›´æ¥å‹¾é€‰ã€‚å¦‚éœ€æ›´å¤šè¯·ä½¿ç”¨æœç´¢åŠŸèƒ½ã€‚</td></tr>';
                }
                const systemWordPagination = document.getElementById('system-word-pagination');
                if (systemWordPagination) {
                    systemWordPagination.style.display = 'none';
                }
            } catch (error) {
                console.error('åŠ è½½ç³»ç»Ÿè¯åº“å¤±è´¥:', error);
                articleSystemWords = [];
                currentVocabulary = articleSystemWords;
                setArticleVocabTableMessage(error.message || 'åŠ è½½ç³»ç»Ÿè¯åº“å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', { color: 'var(--accent-color)' });
                showToast(error.message || 'åŠ è½½ç³»ç»Ÿè¯åº“å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
            }
        }
        
        // æœç´¢ç³»ç»Ÿè¯åº“å•è¯ï¼ˆç”¨äºæ–‡ç« ç”Ÿæˆï¼‰
        async function searchSystemWordsForArticle(page = 1) {
            const query = document.getElementById('system-word-query').value.trim();
            const language = document.getElementById('system-word-language').value;
            
            if (!query) {
                showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
                return;
            }
            
            const systemWordBody = document.getElementById('system-word-results-body');
            if (systemWordBody) {
                systemWordBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;"><div class="loader" style="margin: 0 auto;"></div><p style="margin-top: 10px;">æœç´¢ä¸­...</p></td></tr>';
            }
            
            try {
                // ä½¿ç”¨ URLSearchParams æ„å»ºæŸ¥è¯¢å‚æ•°
                const params = new URLSearchParams({
                    language: language,
                    page: String(page),
                    page_size: '20'
                });
                if (query) {
                    params.append('search', query);  // ä½¿ç”¨ search å‚æ•°è€Œä¸æ˜¯ word
                }
                
                const response = await authenticatedFetch(`/api/public-words?${params.toString()}`);
                if (!response.ok) {
                    throw new Error('æœç´¢å¤±è´¥');
                }
                
                const data = await response.json();
                const items = data.items || [];
                const total = data.total || 0;
                const totalPages = Math.ceil(total / 20);
                
                systemWordSearchState.page = page;
                systemWordSearchState.totalPages = totalPages;
                systemWordSearchState.query = query;
                systemWordSearchState.language = language;
                
                if (!items.length) {
                    if (systemWordBody) {
                        systemWordBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary); padding: 20px;">æœªæ‰¾åˆ°åŒ¹é…çš„å•è¯</td></tr>';
                    }
                    const systemWordPagination = document.getElementById('system-word-pagination');
                    if (systemWordPagination) {
                        systemWordPagination.style.display = 'none';
                    }
                    return;
                }
                
                // æ˜¾ç¤ºæœç´¢ç»“æœ
                if (systemWordBody) {
                    systemWordBody.innerHTML = '';
                    items.forEach(item => {
                        const row = document.createElement('tr');
                        const escapedWord = (item.word || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const escapedDefinition = (item.definition || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const escapedPos = (item.part_of_speech || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        
                        row.innerHTML = `
                            <td>${escapeHtml(item.word || '')}</td>
                            <td>${escapeHtml(item.definition || '')}</td>
                            <td>${escapeHtml(item.part_of_speech || '')}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="addSystemWordToArticle(${item.id}, '${escapedWord}', '${escapedDefinition}', '${escapedPos}')">æ·»åŠ </button>
                            </td>
                        `;
                        systemWordBody.appendChild(row);
                    });
                }
                
                // æ›´æ–°åˆ†é¡µ
                const systemWordPagination = document.getElementById('system-word-pagination');
                const systemWordPageInfo = document.getElementById('system-word-page-info');
                if (systemWordPagination && systemWordPageInfo) {
                    systemWordPagination.style.display = totalPages > 1 ? 'flex' : 'none';
                    systemWordPageInfo.textContent = `ç¬¬ ${page} é¡µï¼Œå…± ${totalPages} é¡µ`;
                }
                
            } catch (error) {
                console.error('æœç´¢ç³»ç»Ÿè¯åº“å¤±è´¥:', error);
                if (systemWordBody) {
                    systemWordBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--accent-color); padding: 20px;">æœç´¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•</td></tr>';
                }
                showToast('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
            }
        }
        
        // ç¿»é¡µç³»ç»Ÿè¯åº“æœç´¢ç»“æœ
        function changeSystemWordPage(delta) {
            const newPage = systemWordSearchState.page + delta;
            if (newPage < 1 || newPage > systemWordSearchState.totalPages) {
                return;
            }
            searchSystemWordsForArticle(newPage);
        }
        
        // æ·»åŠ ç³»ç»Ÿè¯åº“å•è¯åˆ°æ–‡ç« ç”Ÿæˆåˆ—è¡¨
        function addSystemWordToArticle(wordId, word, definition, partOfSpeech) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const exists = articleSystemWords.some(w => w.id === wordId);
            if (exists) {
                showToast('è¯¥å•è¯å·²åœ¨åˆ—è¡¨ä¸­', 'warning');
                return;
            }
            
            // æ·»åŠ åˆ°articleSystemWords
            const newWord = {
                id: wordId,
                wordId: wordId,
                word: word,
                definition: definition,
                partOfSpeech: partOfSpeech,
                example: '',
                source: 'system'
            };
            
            articleSystemWords.push(newWord);
            currentVocabulary = articleSystemWords;
            
            // è‡ªåŠ¨é€‰ä¸­æ–°æ·»åŠ çš„å•è¯
            const wordIdStr = String(wordId);
            if (!selectedWordIds.includes(wordIdStr)) {
                selectedWordIds.push(wordIdStr);
            }
            
            // åˆ·æ–°æ˜¾ç¤º
            displayArticleVocabularySelection();
            updateSelectionStatus();
            
            showToast(`å·²æ·»åŠ å•è¯: ${word}`, 'success');
        }
        
        // åœ¨æ–‡ç« ç”Ÿæˆé¡µé¢åŠ è½½ç”¨æˆ·çš„å•è¯è¡¨åˆ—è¡¨
        function loadArticleVocabularies() {
            const vocabListContainer = document.getElementById('article-vocab-list-container');
            vocabListContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">åŠ è½½ä¸­...</div>';
            
            fetch('/api/vocabulary/lists?preset=false', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    } else if (response.status === 403) {
                        throw new Error('æ— æƒè®¿é—®');
                    }
                    throw new Error('åŠ è½½å•è¯è¡¨å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                if (!data || data.length === 0) {
                    vocabListContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <p>æš‚æ— è‡ªå®šä¹‰å•è¯è¡¨</p>
                            <p style="margin-top: 10px; font-size: 0.9rem;">è¯·å…ˆä¸Šä¼ å•è¯è¡¨</p>
                        </div>
                    `;
                    return;
                }
                
                // æ˜¾ç¤ºå•è¯è¡¨åˆ—è¡¨
                vocabListContainer.innerHTML = '';
                data.forEach(vocab => {
                    const vocabCard = document.createElement('div');
                    vocabCard.className = 'vocab-list-card';
                    vocabCard.style.cssText = `
                        padding: 15px;
                        margin-bottom: 10px;
                        background: var(--bg-secondary);
                        border: 1px solid var(--border-color);
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.3s;
                    `;
                    vocabCard.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                    
                    vocabCard.onmouseover = function() {
                        this.style.background = 'var(--light-gray)';
                        this.style.transform = 'translateY(-2px)';
                        this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                    };
                    vocabCard.onmouseout = function() {
                        this.style.background = 'var(--bg-secondary)';
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                    };
                    
                    vocabCard.onclick = function() {
                        loadArticleVocabulary(vocab.id);
                    };
                    
                    vocabCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">${vocab.name}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    ${vocab.description || 'æ— æè¿°'}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                                    å…± ${vocab.word_count || 0} ä¸ªå•è¯
                                </div>
                            </div>
                            <div style="color: var(--primary-color); font-size: 1.2rem;">â†’</div>
                        </div>
                    `;
                    
                    vocabListContainer.appendChild(vocabCard);
                });
            })
            .catch(error => {
                console.error('åŠ è½½å•è¯è¡¨åˆ—è¡¨å¤±è´¥:', error);
                vocabListContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--accent-color);">
                        <p>åŠ è½½å¤±è´¥: ${error.message}</p>
                    </div>
                `;
            });
        }
        
        // åŠ è½½é€‰ä¸­çš„å•è¯è¡¨å¹¶åœ¨æ–‡ç« ç”Ÿæˆé¡µé¢æ˜¾ç¤º
        function loadArticleVocabulary(vocabularyId) {
            showLoading('æ­£åœ¨åŠ è½½å•è¯è¡¨...');
            
            fetch(`/api/vocabulary/lists/${vocabularyId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–å•è¯è¡¨è¯¦æƒ…å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                
                // æ›´æ–°å½“å‰å•è¯è¡¨ä¿¡æ¯
                articleUploadedWords = (data.words || []).map(word => ({
                    word: word.word,
                    definition: word.definition,
                    partOfSpeech: word.part_of_speech,
                    example: word.example,
                    id: word.id,
                    wordId: word.id,
                    source: 'user'
                }));
                articleUploadedVocabularyId = data.id;
                currentVocabulary = articleUploadedWords;
                currentVocabularyId = articleUploadedVocabularyId;
                selectedWordIdsBySource.uploaded = [];
                selectedWordIds = selectedWordIdsBySource.uploaded;
                
                // éšè—å•è¯è¡¨åˆ—è¡¨ï¼Œæ˜¾ç¤ºå•è¯é€‰æ‹©åŒºåŸŸ
                const vocabListSelectionSection = document.getElementById('article-vocab-list-selection');
                const vocabSelectionSection = document.getElementById('article-vocab-selection');
                
                vocabListSelectionSection.style.display = 'none';
                vocabSelectionSection.style.display = 'block';
                
                // æ˜¾ç¤ºå•è¯é€‰æ‹©
                if (currentVocabSourceForArticle === 'uploaded') {
                    displayArticleVocabularySelection();
                    updateSelectionStatus();
                }
                
                showToast(`å·²åŠ è½½å•è¯è¡¨: ${data.name} (${currentVocabulary.length} ä¸ªå•è¯)`, 'success');
            })
            .catch(error => {
                hideLoading();
                console.error('åŠ è½½å•è¯è¡¨å¤±è´¥:', error);
                showToast(`åŠ è½½å•è¯è¡¨å¤±è´¥: ${error.message}`, 'error');
            });
        }
        
        // æ˜¾ç¤ºå•è¯è¡¨é€‰æ‹©åŒºåŸŸ
        function showVocabListSelection() {
            const vocabListSelectionSection = document.getElementById('article-vocab-list-selection');
            const vocabSelectionSection = document.getElementById('article-vocab-selection');
            
            // åˆ‡æ¢å›å·²ä¸Šä¼ å•è¯è¡¨æ¥æº
            currentVocabSourceForArticle = 'uploaded';
            const vocabSourceSelect = document.getElementById('vocab-source');
            if (vocabSourceSelect) {
                vocabSourceSelect.value = 'uploaded';
            }
            
            // é‡ç½®å½“å‰å•è¯è¡¨
            articleUploadedWords = [];
            articleUploadedVocabularyId = null;
            currentVocabulary = articleUploadedWords;
            currentVocabularyId = articleUploadedVocabularyId;
            selectedWordIdsBySource.uploaded = [];
            selectedWordIds = selectedWordIdsBySource.uploaded;
            
            // æ˜¾ç¤ºå•è¯è¡¨åˆ—è¡¨ï¼Œéšè—å•è¯é€‰æ‹©åŒºåŸŸ
            vocabSelectionSection.style.display = 'none';
            vocabListSelectionSection.style.display = 'block';
            loadArticleVocabularies();
            updateSelectionStatus();
        }
        
        // å­¦ä¹ æ—¶é•¿è¿½è¸ªå˜é‡
        let pageStartTime = null;
        let learningDurationInterval = null;
        let accumulatedDuration = 0; // ç´¯è®¡æ—¶é•¿ï¼ˆç§’ï¼‰
        
        // å¼€å§‹è¿½è¸ªå­¦ä¹ æ—¶é•¿
        function startLearningDurationTracking() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (learningDurationInterval) {
                clearInterval(learningDurationInterval);
            }
            
            // è®°å½•é¡µé¢è¿›å…¥æ—¶é—´
            pageStartTime = Date.now();
            
            // æ¯30ç§’å‘é€ä¸€æ¬¡å­¦ä¹ æ—¶é•¿åˆ°åç«¯
            learningDurationInterval = setInterval(async () => {
                if (pageStartTime) {
                    const currentTime = Date.now();
                    const duration = Math.floor((currentTime - pageStartTime) / 1000); // è½¬æ¢ä¸ºç§’
                    
                    if (duration > 0) {
                        accumulatedDuration += duration;
                        
                        try {
                            await fetch('/api/progress/record-duration', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${getAuthToken()}`
                                },
                                body: JSON.stringify({
                                    duration: duration,
                                    activity_type: 'page_view'
                                })
                            });
                            
                            // é‡ç½®èµ·å§‹æ—¶é—´
                            pageStartTime = Date.now();
                        } catch (error) {
                            console.error('è®°å½•å­¦ä¹ æ—¶é•¿å¤±è´¥:', error);
                        }
                    }
                }
            }, 30000); // æ¯30ç§’å‘é€ä¸€æ¬¡
        }
        
        // åœæ­¢è¿½è¸ªå­¦ä¹ æ—¶é•¿
        function stopLearningDurationTracking() {
            if (learningDurationInterval) {
                clearInterval(learningDurationInterval);
                learningDurationInterval = null;
            }
            
            // å‘é€å‰©ä½™çš„å­¦ä¹ æ—¶é•¿
            if (pageStartTime) {
                const currentTime = Date.now();
                const duration = Math.floor((currentTime - pageStartTime) / 1000);
                
                if (duration > 0) {
                    fetch('/api/progress/record-duration', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        },
                        body: JSON.stringify({
                            duration: duration,
                            activity_type: 'page_view'
                        })
                    }).catch(error => {
                        console.error('è®°å½•å­¦ä¹ æ—¶é•¿å¤±è´¥:', error);
                    });
                }
                
                pageStartTime = null;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å¦‚æœå½“å‰åœ¨æ–‡ç« ç”Ÿæˆé¡µé¢ï¼Œæ£€æŸ¥å•è¯è¡¨æ¥æºå¹¶æ˜¾ç¤ºç›¸åº”å†…å®¹
            const articleSection = document.getElementById('article');
            if (articleSection && articleSection.classList.contains('active')) {
                const vocabSourceSelect = document.getElementById('vocab-source');
                if (vocabSourceSelect) {
                    const vocabSource = vocabSourceSelect.value;
                    // å¦‚æœé€‰æ‹©äº†å·²ä¸Šä¼ å•è¯è¡¨ï¼Œè§¦å‘å¤„ç†å‡½æ•°
                    if (vocabSource === 'uploaded') {
                        handleVocabSourceChange();
                    }
                }
            }
            
            // ç›‘å¬ä¸»é¢˜è¾“å…¥æ¡†çš„æ‰‹åŠ¨è¾“å…¥ï¼Œæ¸…é™¤æ ‡ç­¾é€‰ä¸­çŠ¶æ€
            const topicInput = document.getElementById('article-topic');
            if (topicInput) {
                topicInput.addEventListener('input', function() {
                    // æ¸…é™¤æ‰€æœ‰æ ‡ç­¾çš„é€‰ä¸­çŠ¶æ€
                    const tagsDiv = document.getElementById('topic-tags');
                    if (tagsDiv) {
                        tagsDiv.querySelectorAll('.topic-tag').forEach(tag => {
                            tag.style.backgroundColor = '#f0f0f0';
                            tag.style.color = '#333';
                            tag.style.borderColor = '#ddd';
                        });
                    }
                });
            }
            
            // åˆå§‹åŒ–ç”Ÿæˆä¸»é¢˜æŒ‰é’®çŠ¶æ€
            const generateBtn = document.getElementById('generate-topics-btn');
            if (generateBtn && (!selectedWordIds || selectedWordIds.length === 0)) {
                generateBtn.disabled = true;
                generateBtn.style.opacity = '0.6';
            }
            
            // å¼€å§‹è¿½è¸ªå­¦ä¹ æ—¶é•¿ï¼ˆé¡µé¢åŠ è½½æ—¶ï¼‰
            startLearningDurationTracking();
            
            // é¡µé¢å¸è½½æ—¶åœæ­¢è¿½è¸ªå¹¶ä¿å­˜å­¦ä¹ æ—¶é•¿
            window.addEventListener('beforeunload', function() {
                stopLearningDurationTracking();
            });
            
            // é¡µé¢éšè—æ—¶åœæ­¢è¿½è¸ªï¼ˆåˆ‡æ¢æ ‡ç­¾é¡µç­‰ï¼‰
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    stopLearningDurationTracking();
                } else {
                    startLearningDurationTracking();
                }
            });
            
            // æ·»åŠ å•è¯è¡¨æ•°æ®ç›‘å¬
            setInterval(() => {
                const vocabSourceSelect = document.getElementById('vocab-source');
                if (vocabSourceSelect) {
                    const vocabSource = vocabSourceSelect.value;
                    if (vocabSource === 'uploaded') {
                        // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„å•è¯è¡¨ï¼Œæ˜¾ç¤ºå•è¯è¡¨åˆ—è¡¨
                        if (!currentVocabularyId || currentVocabulary.length === 0) {
                            const vocabListSelectionSection = document.getElementById('article-vocab-list-selection');
                            const vocabSelectionSection = document.getElementById('article-vocab-selection');
                            if (vocabListSelectionSection && vocabListSelectionSection.style.display === 'none') {
                                if (vocabSelectionSection && vocabSelectionSection.style.display === 'none') {
                                    vocabListSelectionSection.style.display = 'block';
                                    loadArticleVocabularies();
                                }
                            }
                        }
                    }
                }
            }, 3000);
        });
        
        // æ‰‹åŠ¨æ˜¾ç¤ºå•è¯é€‰æ‹©åŒºåŸŸ - æ˜¾ç¤ºç”¨æˆ·å·²é€‰æ‹©è¦ç”Ÿæˆæ–‡ç« çš„å•è¯
        function showVocabSelection() {
            const vocabSelectionSection = document.getElementById('article-vocab-selection');
            if (!vocabSelectionSection) {
                showToast('æ‰¾ä¸åˆ°å•è¯é€‰æ‹©åŒºåŸŸ', 'error');
                return;
            }
            
            // ç¡®ä¿å•è¯é€‰æ‹©åŒºåŸŸå¯è§ - ä½¿ç”¨!importantå¼ºåˆ¶è¦†ç›–
            vocabSelectionSection.style.setProperty('display', 'block', 'important');
            vocabSelectionSection.style.setProperty('visibility', 'visible', 'important');
            vocabSelectionSection.style.setProperty('opacity', '1', 'important');
            vocabSelectionSection.removeAttribute('hidden');
            displayArticleVocabularySelection();
        }
        
        // åœ¨æ–‡ç« ç”Ÿæˆæ¨¡å—ä¸­æ˜¾ç¤ºå•è¯é€‰æ‹©
        function displayArticleVocabularySelection() {
            console.log('=== å¼€å§‹æ˜¾ç¤ºå•è¯é€‰æ‹© ===');
            
            // ç¡®ä¿å•è¯é€‰æ‹©åŒºåŸŸå¯è§ - ä½¿ç”¨!importantå¼ºåˆ¶è¦†ç›–
            const vocabSelectionSection = document.getElementById('article-vocab-selection');
            if (vocabSelectionSection) {
                vocabSelectionSection.style.setProperty('display', 'block', 'important');
                vocabSelectionSection.style.setProperty('visibility', 'visible', 'important');
                vocabSelectionSection.style.setProperty('opacity', '1', 'important');
                vocabSelectionSection.style.setProperty('height', 'auto', 'important');
                vocabSelectionSection.style.setProperty('overflow', 'visible', 'important');
                vocabSelectionSection.removeAttribute('hidden');
                console.log('å•è¯é€‰æ‹©åŒºåŸŸå·²æ˜¾ç¤ºï¼Œå…ƒç´ :', vocabSelectionSection);
                console.log('è®¡ç®—æ ·å¼:', window.getComputedStyle(vocabSelectionSection).display);
            } else {
                console.error('æ‰¾ä¸åˆ° article-vocab-selection å…ƒç´ ï¼');
                return;
            }
            
            // ç¡®ä¿æ–‡ç« åŒºåŸŸå¯è§
            const articleSection = document.getElementById('article');
            if (articleSection) {
                articleSection.style.removeProperty('display');
                if (currentSection === 'article' && !articleSection.classList.contains('active')) {
                    articleSection.classList.add('active');
                }
            }
            
            const vocabBody = document.getElementById('article-vocab-body');
            if (vocabBody) {
                vocabBody.innerHTML = '';
                console.log('å•è¯é€‰æ‹©è¡¨æ ¼å·²æ¸…ç©º');
            }
            
            // æ·»åŠ è¯¦ç»†è°ƒè¯•ä¿¡æ¯
            console.log('æ˜¾ç¤ºå•è¯é€‰æ‹©:', { 
                words: currentVocabulary, 
                wordsCount: currentVocabulary.length,
                currentVocabularyId: currentVocabularyId,
                selectedWordIds: selectedWordIds
            });
            
            if (!Array.isArray(currentVocabulary) || currentVocabulary.length === 0) {
                if (vocabBody) {
                    vocabBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-primary, #333); padding: 20px; font-size: 14px; font-weight: 500;">æš‚æ— å•è¯æ•°æ®</td></tr>';
                }
                return;
            }
            
            // ä¸å†é‡ç½®é€‰ä¸­çš„å•è¯ï¼Œä¿æŒè·¨æ¨¡å—é€‰æ‹©çŠ¶æ€ä¸€è‡´
            console.log('ä¿æŒå½“å‰é€‰ä¸­çš„å•è¯:', selectedWordIds);
            
            // å¯¹å•è¯è¿›è¡Œæ’åºï¼šæœªé€‰ä¸­çš„æ’åœ¨å‰é¢
            const sortedWords = [...currentVocabulary].sort((a, b) => {
                const aId = String(a.id || '');
                const bId = String(b.id || '');
                const aSelected = selectedWordIds.includes(aId);
                const bSelected = selectedWordIds.includes(bId);
                
                // æœªé€‰ä¸­çš„æ’åœ¨å‰é¢ï¼ˆfalseåœ¨å‰ï¼Œtrueåœ¨åï¼‰
                if (aSelected !== bSelected) {
                    return aSelected ? 1 : -1;
                }
                // å¦‚æœé€‰æ‹©çŠ¶æ€ç›¸åŒï¼Œä¿æŒåŸæœ‰é¡ºåº
                return 0;
            });
            
            // æ·»åŠ å•è¯åˆ°é€‰æ‹©è¡¨æ ¼ï¼ˆé™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼Œé¿å…é¡µé¢è¿‡é•¿ï¼‰
            const maxDisplayWords = 50; // æœ€å¤šæ˜¾ç¤º50ä¸ªå•è¯
            const displayWords = sortedWords.slice(0, maxDisplayWords);
            
            if (vocabBody) {
                displayWords.forEach((item) => {
                    // ç¡®ä¿itemæ˜¯å¯¹è±¡ä¸”æœ‰å¿…è¦çš„å±æ€§
                    if (typeof item !== 'object' || item === null) {
                        console.warn('è·³è¿‡æ— æ•ˆçš„å•è¯é¡¹:', item);
                        return;
                    }
                    
                    // ç¡®ä¿å±æ€§å­˜åœ¨
                    const word = item.word || 'æœªçŸ¥å•è¯';
                    const definition = item.definition || 'æš‚æ— é‡Šä¹‰';
                    const partOfSpeech = item.part_of_speech || item.partOfSpeech || 'æœªçŸ¥è¯æ€§';
                    const wordId = item.id || Math.random().toString(36).substr(2, 9); // ç”Ÿæˆä¸´æ—¶ID
                    
                    // æ£€æŸ¥å½“å‰å•è¯æ˜¯å¦å·²è¢«é€‰ä¸­
                    const stringWordId = String(wordId);
                    const isChecked = selectedWordIds.includes(stringWordId) ? 'checked' : '';
                    const checkboxClass = isChecked ? 'vocab-checkbox vocab-checkbox-selected' : 'vocab-checkbox';
                    
                    const row = document.createElement('tr');
                    // ä¸ºé€‰ä¸­çš„è¡Œæ·»åŠ æ ·å¼ç±»
                    if (isChecked) {
                        row.classList.add('selected-word-row');
                    }
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="${checkboxClass}" 
                                   data-word-id="${wordId}"
                                   onclick="toggleWordSelection('${wordId}')"
                                   ${isChecked}>
                        </td>
                        <td>${word}</td>
                        <td>${definition}</td>
                        <td>${partOfSpeech}</td>
                    `;
                    vocabBody.appendChild(row);
                });
            }
            
            // å¦‚æœå•è¯å¤ªå¤šï¼Œæ˜¾ç¤ºæç¤º
            if (currentVocabulary.length > maxDisplayWords) {
                if (vocabBody) {
                    const moreInfoRow = document.createElement('tr');
                    moreInfoRow.innerHTML = `<td colspan="4" style="text-align: center; color: #999; font-style: italic;">ä»…æ˜¾ç¤ºå‰${maxDisplayWords}ä¸ªå•è¯ï¼Œå…±${currentVocabulary.length}ä¸ª</td>`;
                    vocabBody.appendChild(moreInfoRow);
                }
            }
            
            // æ›´æ–°é€‰æ‹©çŠ¶æ€æ˜¾ç¤º
            updateSelectionStatus();
            
            console.log('å•è¯é€‰æ‹©æ˜¾ç¤ºå®Œæˆ');
        }
        
        // ä»è®¾ç½®ç”Ÿæˆæ–‡ç« 
        function generateArticleFromSettings() {
            // è·å–ç”Ÿæˆè®¾ç½®
            const vocabSource = document.getElementById('vocab-source').value;
            const difficultyLevel = document.getElementById('difficulty-level').value;
            const articleLength = document.getElementById('article-length').value;
            const topic = document.getElementById('article-topic').value;
            
            // æ·»åŠ è¯¦ç»†è°ƒè¯•ä¿¡æ¯
            console.log('ç”Ÿæˆæ–‡ç« è®¾ç½®:', {
                vocabSource,
                difficultyLevel,
                articleLength,
                topic,
                currentVocabularyLength: currentVocabulary.length,
                selectedWordIdsCount: selectedWordIds.length,
                selectedWordIds: selectedWordIds
            });
            
            // æ„å»ºè¯·æ±‚æ•°æ®
            const requestData = {
                difficulty_level: difficultyLevel || "intermediate",
                article_length: articleLength || "medium",
                topic: topic.trim() || null  // ä½¿ç”¨nullè€Œä¸æ˜¯undefinedï¼ŒJSON.stringifyä¼šä¿ç•™null
            };
            
            // ç‰¹æ®Šå¤„ç†å·²ä¸Šä¼ å•è¯è¡¨çš„æƒ…å†µ
            if (vocabSource === 'uploaded') {
                // ç¡®ä¿åŒ…å«vocabulary_list_id
                if (currentVocabularyId && !isNaN(currentVocabularyId)) {
                    requestData.vocabulary_list_id = parseInt(currentVocabularyId);
                    console.log('ä½¿ç”¨å½“å‰å•è¯è¡¨ID:', currentVocabularyId);
                }
                
                // å¤„ç†é€‰ä¸­çš„å•è¯
                if (selectedWordIds.length > 0) {
                    requestData.selected_word_ids = selectedWordIds;
                    console.log('åŒ…å«é€‰ä¸­çš„å•è¯ID:', selectedWordIds);
                } else if (currentVocabulary.length > 0) {
                    // å¦‚æœæ²¡æœ‰æ˜ç¡®é€‰æ‹©å•è¯ä½†æœ‰å•è¯è¡¨ï¼Œä½¿ç”¨æ‰€æœ‰å•è¯ID
                    const allWordIds = currentVocabulary.map(item => item.id).filter(id => id);
                    if (allWordIds.length > 0) {
                        requestData.selected_word_ids = allWordIds;
                        console.log('ä½¿ç”¨å…¨éƒ¨å•è¯ID:', allWordIds);
                    }
                }
            } else if (vocabSource === 'system') {
                // å¤„ç†ç³»ç»Ÿè¯åº“çš„æƒ…å†µ
                if (selectedWordIds.length > 0) {
                    // ä½¿ç”¨é€‰ä¸­çš„å•è¯
                    const publicWordIds = selectedWordIds
                        .map(id => {
                            const stringId = String(id);
                            const wordObj = currentVocabulary.find(item => String(item.id ?? item.wordId) === stringId);
                            return wordObj ? parseInt(wordObj.id) : null;
                        })
                        .filter(id => Number.isInteger(id));
                    
                    if (publicWordIds.length > 0) {
                        requestData.public_word_ids = publicWordIds;
                        console.log('ä½¿ç”¨ç³»ç»Ÿè¯åº“é€‰ä¸­çš„å•è¯ID:', publicWordIds);
                    } else {
                        showToast('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç³»ç»Ÿè¯åº“å•è¯ID', 'warning');
                        return;
                    }
                } else if (currentVocabulary.length > 0) {
                    // å¦‚æœæ²¡æœ‰æ˜ç¡®é€‰æ‹©å•è¯ï¼Œä½¿ç”¨æ‰€æœ‰ç³»ç»Ÿè¯åº“å•è¯
                    const allPublicWordIds = currentVocabulary
                        .map(item => parseInt(item.id))
                        .filter(id => Number.isInteger(id));
                    
                    if (allPublicWordIds.length > 0) {
                        requestData.public_word_ids = allPublicWordIds;
                        console.log('ä½¿ç”¨å…¨éƒ¨ç³»ç»Ÿè¯åº“å•è¯ID:', allPublicWordIds);
                    }
                } else {
                    showToast('è¯·å…ˆé€‰æ‹©ç³»ç»Ÿè¯åº“å•è¯', 'warning');
                    return;
                }
            } else if (vocabSource === 'custom') {
                // å¯¹äºè‡ªå®šä¹‰å•è¯è¡¨ï¼Œæ·»åŠ å•è¯åˆ—è¡¨ä¿¡æ¯
                if (currentVocabulary.length > 0) {
                    requestData.custom_words = currentVocabulary.map(item => item.word);
                    console.log('æ·»åŠ è‡ªå®šä¹‰å•è¯åˆ—è¡¨ï¼Œæ•°é‡:', requestData.custom_words.length);
                } else {
                    showToast('è¯·å…ˆæ·»åŠ è‡ªå®šä¹‰å•è¯', 'warning');
                    return;
                }
            } else if (vocabSource !== '' && vocabSource !== 'custom' && vocabSource !== 'uploaded' && vocabSource !== 'system') {
                // å¤„ç†å…¶ä»–é¢„è®¾å•è¯è¡¨çš„æƒ…å†µ
                const vocabId = parseInt(vocabSource);
                if (!isNaN(vocabId)) {
                    requestData.vocabulary_list_id = vocabId;
                } else {
                    console.warn('æ— æ•ˆçš„å•è¯è¡¨ID:', vocabSource);
                }
                
                // å¦‚æœæœ‰é€‰ä¸­çš„å•è¯IDï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (selectedWordIds.length > 0) {
                    requestData.selected_word_ids = selectedWordIds;
                    console.log('æ·»åŠ é€‰ä¸­çš„å•è¯IDåˆ—è¡¨ï¼Œæ•°é‡:', selectedWordIds.length);
                }
            }
            
            showLoading('æ­£åœ¨ç”Ÿæˆæ–‡ç« ...');
            
            // ç¦ç”¨ç”ŸæˆæŒ‰é’®
            const generateBtn = document.getElementById('generate-article-btn');
            generateBtn.disabled = true;
            document.getElementById('generate-icon').className = 'loader';
            
            // å‘é€è¯·æ±‚åˆ°åç«¯API
            fetch('/api/articles/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                if (!response.ok) {
                    // å°è¯•è·å–é”™è¯¯è¯¦æƒ…
                    return response.json().then(data => {
                        const errorMsg = data.detail || data.message || `HTTPé”™è¯¯: ${response.status}`;
                        throw new Error(errorMsg);
                    }).catch(() => {
                        // å¦‚æœå“åº”ä¸æ˜¯JSONï¼Œè¿”å›çŠ¶æ€ç 
                    throw new Error(`ç”Ÿæˆæ–‡ç« å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : ${response.status}`);
                    });
                }
                return response.json().catch(() => {
                    // å¦‚æœå“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSON
                    throw new Error('APIè¿”å›éJSONæ•°æ®');
                });
            })
            .then(data => {
                console.log('APIè¿”å›æ•°æ®:', data);
                
                // æ£€æŸ¥æ•°æ®ç»“æ„
                const paragraphs = data?.paragraphs || [];
                
                if (!Array.isArray(paragraphs) || paragraphs.length === 0) {
                    throw new Error('APIè¿”å›çš„æ–‡ç« æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                }
                
                // ä¿å­˜æ–‡ç« æ•°æ®ä¾›ä¸‹è½½ä½¿ç”¨ï¼ˆåœ¨æ˜¾ç¤ºä¹‹å‰ï¼‰
                // é‡è¦ï¼šä¿å­˜æ–‡ç« IDï¼Œç”¨äºåç»­ä¸‹è½½
                currentArticleData = {
                    id: data?.id || null,  // ä¿å­˜æ–‡ç« IDï¼Œç”¨äºä¸‹è½½PDF
                    paragraphs: paragraphs,
                    used_words: data?.used_words || [],
                    topic: data?.topic || 'ç”Ÿæˆçš„æ–‡ç« ',
                    difficulty_level: data?.difficulty_level || 'æœªçŸ¥',
                    article_length: data?.article_length || 'æœªçŸ¥',
                    created_at: data?.created_at || new Date().toISOString(),
                    used_words_count: data?.used_words_count || 0
                };
                
                // è®°å½•æ–‡ç« IDç”¨äºè°ƒè¯•
                console.log('æ–‡ç« ç”ŸæˆæˆåŠŸï¼Œä¿å­˜æ–‡ç« ID:', currentArticleData.id);
                console.log('åç«¯è¿”å›çš„used_words:', data?.used_words);
                console.log('used_wordsæ•°é‡:', data?.used_words?.length || 0);
                
                // åœ¨å¼¹çª—ä¸­æ˜¾ç¤ºæ–‡ç« 
                showArticleModal(currentArticleData);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€ - ç¡®ä¿ç§»é™¤loaderç±»å¹¶æ¢å¤å›¾æ ‡
                generateBtn.disabled = false;
                const generateIcon = document.getElementById('generate-icon');
                generateIcon.className = ''; // ç§»é™¤loaderç±»ä»¥åœæ­¢åŠ¨ç”»
                generateIcon.textContent = 'âœ¨';
                
                hideLoading();
                showToast('æ–‡ç« ç”ŸæˆæˆåŠŸï¼', 'success');
            })
            .catch(error => {
                console.error('ç”Ÿæˆæ–‡ç« å¤±è´¥:', error);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€ - ç¡®ä¿ç§»é™¤loaderç±»å¹¶æ¢å¤å›¾æ ‡
                generateBtn.disabled = false;
                const generateIcon = document.getElementById('generate-icon');
                generateIcon.className = ''; // ç§»é™¤loaderç±»ä»¥åœæ­¢åŠ¨ç”»
                generateIcon.textContent = 'âœ¨';
                
                hideLoading();
                
                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
                let errorMessage = 'æ–‡ç« ç”Ÿæˆå¤±è´¥';
                if (error.message.includes('401') || error.message.includes('403')) {
                    errorMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
                } else if (error.message.includes('404')) {
                    errorMessage = 'æœåŠ¡å™¨æ¥å£æœªæ‰¾åˆ°';
                } else if (error.message.includes('500')) {
                    errorMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                } else {
                    errorMessage = error.message || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•';
                }
                
                showToast(errorMessage, 'error');
            });
        }
        
        // åŠ è½½æ–‡ç« åˆ—è¡¨ï¼ˆå¼¹çª—å½¢å¼ï¼‰
        async function loadArticleList() {
            const modal = document.getElementById('article-list-modal');
            const articleList = document.getElementById('article-list');
            
            // æ˜¾ç¤ºå¼¹çª—
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            articleList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">åŠ è½½ä¸­...</div>';
            
            try {
                const token = getAuthToken();
                const response = await fetch('/api/articles?page=1&page_size=20', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥');
                }
                
                const data = await response.json();
                const articles = data.articles || [];
                
                if (articles.length === 0) {
                    articleList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">æš‚æ— ç”Ÿæˆçš„æ–‡ç« ï¼Œå¿«å»ç”Ÿæˆä¸€ç¯‡å§ï¼</div>';
                    return;
                }
                
                // æ¸…ç©ºåˆ—è¡¨
                articleList.innerHTML = '';
                
                // æ¸²æŸ“æ–‡ç« åˆ—è¡¨
                articles.forEach(article => {
                    const articleItem = document.createElement('div');
                    articleItem.className = 'article-item';
                    
                    const createdDate = article.created_at ? new Date(article.created_at).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }) : 'æœªçŸ¥æ—¶é—´';
                    
                    articleItem.innerHTML = `
                        <div class="article-item-header">
                            <div class="article-item-title" onclick="viewArticle(${article.id})" style="cursor: pointer; flex: 1;">${article.topic || 'æœªå‘½åæ–‡ç« '}</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div class="dropdown" style="position: relative;">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); toggleDownloadMenu(event)" title="ä¸‹è½½æ–‡ç« ">
                                        <span>ğŸ’¾</span> ä¸‹è½½ <span style="font-size: 0.8em;">â–¼</span>
                                    </button>
                                    <div class="download-menu" style="display: none;">
                                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); downloadArticleById(${article.id}, 'html'); return false;">ğŸ“„ HTML</a>
                                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); downloadArticleById(${article.id}, 'pdf'); return false;">ğŸ“‘ PDF</a>
                                    </div>
                                </div>
                                <div class="article-item-meta">${createdDate}</div>
                            </div>
                        </div>
                        <div class="article-item-preview" onclick="viewArticle(${article.id})" style="cursor: pointer;">${article.original_text_preview || ''}</div>
                        <div class="article-item-stats">
                            <span>éš¾åº¦: ${article.difficulty_level || 'æœªçŸ¥'}</span>
                            <span>é•¿åº¦: ${article.article_length || 'æœªçŸ¥'}</span>
                            <span>ä½¿ç”¨å•è¯: ${article.used_words_count || 0} ä¸ª</span>
                        </div>
                    `;
                    
                    articleList.appendChild(articleItem);
                });
                
            } catch (error) {
                console.error('åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥:', error);
                articleList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--accent-color);">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                showToast('åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥', 'error');
            }
        }
        
        // ä¸‹è½½æŒ‡å®šIDçš„æ–‡ç« ï¼ˆä»å†å²æ–‡ç« åˆ—è¡¨ï¼‰
        async function downloadArticleById(articleId, format = 'html') {
            try {
                // å…³é—­æ‰€æœ‰ä¸‹è½½èœå•
                document.querySelectorAll('.download-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
                
                if (format === 'pdf') {
                    // ç›´æ¥è°ƒç”¨åç«¯APIä¸‹è½½PDF
                    await downloadArticlePDFById(articleId);
                } else {
                    // å¯¹äºHTMLï¼Œå…ˆè·å–æ–‡ç« æ•°æ®ï¼Œç„¶åä¸‹è½½
                    showLoading('æ­£åœ¨åŠ è½½æ–‡ç« æ•°æ®...');
                    
                    const token = getAuthToken();
                    const response = await authenticatedFetch(`/api/articles/${articleId}`, {
                        method: 'GET'
                    });
                    
                    if (!response.ok) {
                        throw new Error('åŠ è½½æ–‡ç« è¯¦æƒ…å¤±è´¥');
                    }
                    
                    const articleData = await response.json();
                    
                    // è®¾ç½®å½“å‰æ–‡ç« æ•°æ®ï¼Œç¡®ä¿åŒ…å«ID
                    currentArticleData = {
                        id: articleData.id || null,
                        paragraphs: articleData.paragraphs || [],
                        used_words: articleData.used_words || [],
                        topic: articleData.topic || 'ç”Ÿæˆçš„æ–‡ç« ',
                        difficulty_level: articleData.difficulty_level || 'æœªçŸ¥',
                        article_length: articleData.article_length || 'æœªçŸ¥',
                        created_at: articleData.created_at || new Date().toISOString(),
                        used_words_count: articleData.used_words_count || 0
                    };
                    console.log('ä¸‹è½½HTMLæ—¶ï¼Œä¿å­˜æ–‡ç« ID:', currentArticleData.id);
                    
                    // è°ƒç”¨ä¸‹è½½å‡½æ•°
                    downloadArticle('html');
                    
                    hideLoading();
                }
            } catch (error) {
                console.error('ä¸‹è½½æ–‡ç« å¤±è´¥:', error);
                hideLoading();
                showToast('ä¸‹è½½æ–‡ç« å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        // ä»åç«¯ä¸‹è½½PDF
        async function downloadArticlePDFById(articleId) {
            try {
                showLoading('æ­£åœ¨ç”ŸæˆPDFï¼Œè¯·ç¨å€™...');
                const token = getAuthToken();
                const response = await fetch(`/api/articles/${articleId}/download/pdf`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'ä¸‹è½½PDFå¤±è´¥' }));
                    throw new Error(errorData.detail || 'ä¸‹è½½PDFå¤±è´¥');
                }
                
                // è·å–PDF blob
                const blob = await response.blob();
                
                // ä»å“åº”å¤´è·å–æ–‡ä»¶åï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”Ÿæˆé»˜è®¤æ–‡ä»¶å
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'article.pdf';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                hideLoading();
                showToast('PDFä¸‹è½½æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('ä¸‹è½½PDFå¤±è´¥:', error);
                hideLoading();
                showToast(error.message || 'ä¸‹è½½PDFå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        // æŸ¥çœ‹æ–‡ç« è¯¦æƒ…
        async function viewArticle(articleId) {
            // å…³é—­æ–‡ç« åˆ—è¡¨å¼¹çª—
            closeArticleListModal();
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading('æ­£åœ¨åŠ è½½æ–‡ç« ...');
            
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/articles/${articleId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('åŠ è½½æ–‡ç« è¯¦æƒ…å¤±è´¥');
                }
                
                const articleData = await response.json();
                
                console.log('åŠ è½½çš„æ–‡ç« æ•°æ®:', articleData);
                console.log('æ–‡ç« çš„used_words:', articleData?.used_words);
                
                // åœ¨å¼¹çª—ä¸­æ˜¾ç¤ºæ–‡ç« å†…å®¹
                showArticleModal(articleData);
                
                hideLoading();
                
            } catch (error) {
                console.error('åŠ è½½æ–‡ç« è¯¦æƒ…å¤±è´¥:', error);
                hideLoading();
                showToast('åŠ è½½æ–‡ç« è¯¦æƒ…å¤±è´¥', 'error');
            }
        }
        
        // å…³é—­æ–‡ç« åˆ—è¡¨å¼¹çª—
        function closeArticleListModal() {
            const modal = document.getElementById('article-list-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        // ä»APIæ•°æ®å±•ç¤ºæ–‡ç« ï¼ˆå·²åºŸå¼ƒï¼Œç°åœ¨ä½¿ç”¨ showArticleModalï¼‰
        function displayArticleFromData(articleData) {
            // ç›´æ¥è°ƒç”¨å¼¹çª—æ˜¾ç¤ºå‡½æ•°
            showArticleModal(articleData);
        }
        
        // æ˜¾ç¤ºæ–‡ç« 
        function displayArticle(article) {
            const articleContainer = document.getElementById('bilingual-article');
            articleContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ç”Ÿæˆçš„æ–‡ç« </h3>
                    <div style="display: flex; gap: 10px;">
                        <div class="dropdown" style="position: relative;">
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleDownloadMenu(event)" id="download-btn-3">
                                <span>ğŸ’¾</span> ä¸‹è½½æ–‡ç«  <span style="font-size: 0.8em;">â–¼</span>
                            </button>
                            <div id="download-menu-3" class="download-menu" style="display: none;">
                                <a href="#" onclick="event.preventDefault(); downloadArticle('html'); return false;">ğŸ“„ ä¸‹è½½ä¸º HTML</a>
                                <a href="#" onclick="event.preventDefault(); downloadArticle('pdf'); return false;">ğŸ“‘ ä¸‹è½½ä¸º PDF</a>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadArticleList()">è¿”å›åˆ—è¡¨</button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯åˆ°æ§åˆ¶å°
            console.log('æ˜¾ç¤ºæ–‡ç« æ•°æ®:', article);
            
            // è·å–å½“å‰å•è¯è¡¨ä¸­çš„å•è¯ç”¨äºé«˜äº®
            const vocabWords = new Map();
            currentVocabulary.forEach(item => {
                vocabWords.set(item.word.toLowerCase(), item);
            });
            
            // ç¡®ä¿articleæ˜¯æ•°ç»„æ ¼å¼
            const paragraphsArray = Array.isArray(article) ? article : [];
            
            // ä¿å­˜æ–‡ç« æ•°æ®ä¾›ä¸‹è½½ä½¿ç”¨ï¼Œä¿ç•™å·²æœ‰çš„IDï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingId = currentArticleData?.id || null;
            currentArticleData = {
                id: existingId,  // ä¿ç•™å·²æœ‰çš„æ–‡ç« IDï¼Œç”¨äºä¸‹è½½PDF
                paragraphs: paragraphsArray,
                used_words: currentVocabulary.filter(v => vocabWords.has(v.word.toLowerCase())),
                topic: currentArticleData?.topic || 'ç”Ÿæˆçš„æ–‡ç« ',
                difficulty_level: currentArticleData?.difficulty_level || 'æœªçŸ¥',
                article_length: currentArticleData?.article_length || 'æœªçŸ¥',
                created_at: currentArticleData?.created_at || new Date().toISOString(),
                used_words_count: currentArticleData?.used_words_count || 0
            };
            
            if (paragraphsArray.length === 0) {
                // å¤„ç†ç©ºå“åº”æˆ–æ ¼å¼é”™è¯¯çš„æƒ…å†µ
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'article-paragraph';
                emptyDiv.innerHTML = '<p class="original-text">æš‚æ— æ–‡ç« å†…å®¹</p><p class="translated-text">è¯·å°è¯•é‡æ–°ç”Ÿæˆæ–‡ç« </p>';
                articleContainer.appendChild(emptyDiv);
            } else {
                // è§£ææ–‡ç« æ®µè½
                paragraphsArray.forEach(paragraph => {
                    const paragraphDiv = document.createElement('div');
                    paragraphDiv.className = 'article-paragraph';
                    
                    // æ·»åŠ åŸæ–‡ - æ”¯æŒå•è¯é«˜äº®
                    const originalDiv = document.createElement('div');
                    originalDiv.className = 'original-text';
                    
                    // è·å–åŸæ–‡å†…å®¹
                    const textContent = paragraph.original || paragraph.text || paragraph || '';
                    
                    if (typeof textContent === 'string') {
                        // æ‹†åˆ†æ–‡æœ¬ä¸ºå•è¯å¹¶æ·»åŠ é«˜äº®
                        const words = textContent.split(/(\s+|[,.!?;:"'()\[\]{}])/);
                        
                        words.forEach(wordPart => {
                            // æ£€æŸ¥æ˜¯å¦ä¸ºå•è¯
                            const cleanWord = wordPart.replace(/[^\w']/g, '').toLowerCase();
                            
                            if (cleanWord && vocabWords.has(cleanWord)) {
                                // è·å–å•è¯ä¿¡æ¯
                                const wordInfo = vocabWords.get(cleanWord);
                                // åˆ›å»ºå¯ç‚¹å‡»çš„å•è¯
                                const wordSpan = document.createElement('span');
                                wordSpan.className = 'vocab-word';
                                wordSpan.textContent = wordPart;
                                wordSpan.dataset.word = cleanWord;
                                wordSpan.dataset.wordId = wordInfo.id;
                                wordSpan.style.backgroundColor = '#fff3cd'; // é«˜äº®èƒŒæ™¯è‰²
                                wordSpan.style.padding = '2px 4px';
                                wordSpan.style.borderRadius = '4px';
                                wordSpan.style.cursor = 'pointer';
                                wordSpan.style.transition = 'all 0.2s ease';
                                
                                // æ·»åŠ æ‚¬åœæ•ˆæœ
                                wordSpan.onmouseover = function() {
                                    this.style.backgroundColor = '#ffeaa7';
                                    this.style.textDecoration = 'underline';
                                };
                                wordSpan.onmouseout = function() {
                                    this.style.backgroundColor = '#fff3cd';
                                    this.style.textDecoration = 'none';
                                };
                                
                                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                                wordSpan.onclick = function() {
                                    showWordDefinition(cleanWord);
                                };
                                
                                originalDiv.appendChild(wordSpan);
                            } else {
                                // æ™®é€šæ–‡æœ¬
                                originalDiv.appendChild(document.createTextNode(wordPart));
                            }
                        });
                    } else {
                        // å¦‚æœæ–‡æœ¬å†…å®¹ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•æå–å­—ç¬¦ä¸²å†…å®¹æˆ–è·³è¿‡
                        if (textContent && typeof textContent === 'object') {
                            // å¦‚æœæ˜¯å¯¹è±¡ï¼Œå°è¯•æå–originalæˆ–textå±æ€§
                            const objText = textContent.original || textContent.text || '';
                            if (objText) {
                                originalDiv.textContent = objText;
                            } else {
                                // å¦‚æœæ— æ³•æå–ï¼Œè·³è¿‡è¿™ä¸ªæ®µè½
                                return;
                            }
                        } else {
                            originalDiv.textContent = String(textContent || '');
                        }
                    }
                    
                    // å…ˆæ·»åŠ åŸæ–‡
                    paragraphDiv.appendChild(originalDiv);
                    
                    // å†æ·»åŠ è¯‘æ–‡ - å¦‚æœæ²¡æœ‰ç¿»è¯‘å°±ä¸æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯æ˜¾ç¤º"æš‚æ— ç¿»è¯‘"
                    const translatedText = paragraph.translated || paragraph.translation || '';
                    if (translatedText) {
                        const translatedDiv = document.createElement('div');
                        translatedDiv.className = 'translated-text';
                        translatedDiv.textContent = translatedText;
                        paragraphDiv.appendChild(translatedDiv);
                    }
                    
                    articleContainer.appendChild(paragraphDiv);
                });
            }
            
            // æ˜¾ç¤ºæ–‡ç« å®¹å™¨
            articleContainer.style.display = 'block';
        }
        
        // æ˜¾ç¤ºæ–‡ç« å¼¹çª—
        function showArticleModal(articleData) {
            const modal = document.getElementById('article-modal');
            if (!modal) {
                console.error('æ–‡ç« å¼¹çª—å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            // ä¿å­˜æ–‡ç« æ•°æ®ä¾›ä¸‹è½½ä½¿ç”¨ï¼Œç¡®ä¿åŒ…å«ID
            currentArticleData = {
                id: articleData.id || null,
                paragraphs: articleData.paragraphs || [],
                used_words: articleData.used_words || [],
                topic: articleData.topic || 'ç”Ÿæˆçš„æ–‡ç« ',
                difficulty_level: articleData.difficulty_level || 'æœªçŸ¥',
                article_length: articleData.article_length || 'æœªçŸ¥',
                created_at: articleData.created_at || new Date().toISOString(),
                used_words_count: articleData.used_words_count || 0
            };
            console.log('æ˜¾ç¤ºæ–‡ç« å¼¹çª—ï¼Œä¿å­˜æ–‡ç« ID:', currentArticleData.id);
            
            // æ›´æ–°å¼¹çª—æ ‡é¢˜å’Œå…ƒä¿¡æ¯
            const titleEl = document.getElementById('article-modal-title');
            const difficultyEl = document.getElementById('article-modal-difficulty');
            const lengthEl = document.getElementById('article-modal-length');
            const wordsEl = document.getElementById('article-modal-words');
            const contentEl = document.getElementById('article-modal-content');
            
            if (titleEl) titleEl.textContent = articleData.topic || 'ç”Ÿæˆçš„æ–‡ç« ';
            if (difficultyEl) difficultyEl.textContent = `éš¾åº¦: ${articleData.difficulty_level || 'æœªçŸ¥'}`;
            if (lengthEl) lengthEl.textContent = `é•¿åº¦: ${articleData.article_length || 'æœªçŸ¥'}`;
            if (wordsEl) wordsEl.textContent = `ä½¿ç”¨å•è¯: ${articleData.used_words_count || 0} ä¸ª`;
            
            // è·å–ä½¿ç”¨çš„å•è¯ç”¨äºé«˜äº®å’Œå•è¯è¡¨æ˜¾ç¤ºï¼ˆåœ¨æ‰€æœ‰å—ä¹‹å‰å®šä¹‰ï¼‰
            const vocabWords = new Map();
            if (articleData.used_words && Array.isArray(articleData.used_words) && articleData.used_words.length > 0) {
                console.log('ä½¿ç”¨articleData.used_words:', articleData.used_words);
                articleData.used_words.forEach(word => {
                    const wordText = (word.word || '').trim().toLowerCase();
                    if (wordText) {
                        vocabWords.set(wordText, word);
                    }
                });
            }
            
            // å¦‚æœæ²¡æœ‰used_wordsæˆ–used_wordsä¸ºç©ºï¼Œå°è¯•ä½¿ç”¨currentVocabularyä½œä¸ºå¤‡ç”¨
            if (vocabWords.size === 0 && currentVocabulary && currentVocabulary.length > 0) {
                console.log('used_wordsä¸ºç©ºï¼Œä½¿ç”¨currentVocabularyä½œä¸ºå¤‡ç”¨:', currentVocabulary);
                currentVocabulary.forEach(item => {
                    const wordText = (item.word || '').trim().toLowerCase();
                    if (wordText) {
                        // åªæœ‰å½“Mapä¸­è¿˜æ²¡æœ‰è¿™ä¸ªå•è¯æ—¶æ‰æ·»åŠ ï¼ˆé¿å…è¦†ç›–used_wordsä¸­çš„æ•°æ®ï¼‰
                        if (!vocabWords.has(wordText)) {
                            vocabWords.set(wordText, item);
                        }
                    }
                });
            }
            
            console.log('vocabWords Mapå¤§å°:', vocabWords.size);
            if (vocabWords.size === 0) {
                console.warn('è­¦å‘Šï¼šæ²¡æœ‰å¯ç”¨çš„å•è¯æ•°æ®ç”¨äºæ ‡è®°å’Œæ˜¾ç¤º');
            } else {
                console.log('vocabWordsç¤ºä¾‹:', Array.from(vocabWords.entries()).slice(0, 3));
            }
            
            // æ¸…ç©ºå†…å®¹åŒºåŸŸ
            if (contentEl) {
                contentEl.innerHTML = '';
                
                // æ˜¾ç¤ºæ–‡ç« æ®µè½
                const paragraphs = articleData.paragraphs || [];
                if (paragraphs.length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'article-paragraph';
                    emptyDiv.innerHTML = '<p class="original-text">æš‚æ— æ–‡ç« å†…å®¹</p><p class="translated-text">è¯·å°è¯•é‡æ–°ç”Ÿæˆæ–‡ç« </p>';
                    contentEl.appendChild(emptyDiv);
                } else {
                    paragraphs.forEach(paragraph => {
                        // è·³è¿‡ç©ºæ®µè½æˆ–æ— æ•ˆæ®µè½
                        if (!paragraph || typeof paragraph !== 'object') {
                            return;
                        }
                        
                        const paragraphDiv = document.createElement('div');
                        paragraphDiv.className = 'article-paragraph';
                        
                        // æ·»åŠ åŸæ–‡ - æ”¯æŒå•è¯é«˜äº®
                        const originalDiv = document.createElement('div');
                        originalDiv.className = 'original-text';
                        
                        // å®‰å…¨è·å–æ–‡æœ¬å†…å®¹ï¼Œé¿å…æ˜¾ç¤º [object Object]
                        let textContent = '';
                        if (paragraph && typeof paragraph === 'object') {
                            textContent = paragraph.original || paragraph.text || '';
                        } else if (typeof paragraph === 'string') {
                            textContent = paragraph;
                        }
                        
                        // ç¡®ä¿ textContent æ˜¯å­—ç¬¦ä¸²
                        textContent = String(textContent || '').trim();
                        
                        if (textContent) {
                            // æ‹†åˆ†æ–‡æœ¬ä¸ºå•è¯å¹¶æ·»åŠ é«˜äº®
                            const words = textContent.split(/(\s+|[,.!?;:"'()\[\]{}])/);
                            
                            words.forEach(wordPart => {
                                const cleanWord = wordPart.replace(/[^\w']/g, '').toLowerCase();
                                
                                if (cleanWord && vocabWords.has(cleanWord)) {
                                    const wordInfo = vocabWords.get(cleanWord);
                                    const wordSpan = document.createElement('span');
                                    wordSpan.className = 'vocab-word';
                                    wordSpan.textContent = wordPart;
                                    wordSpan.dataset.word = cleanWord;
                                    // å®‰å…¨è·å– wordId
                                    if (wordInfo && (wordInfo.id || wordInfo.wordId)) {
                                        wordSpan.dataset.wordId = String(wordInfo.id || wordInfo.wordId);
                                    }
                                    wordSpan.style.backgroundColor = '#fff3cd';
                                    wordSpan.style.padding = '2px 4px';
                                    wordSpan.style.borderRadius = '4px';
                                    wordSpan.style.cursor = 'pointer';
                                    wordSpan.style.transition = 'all 0.2s ease';
                                    
                                    wordSpan.onmouseover = function() {
                                        this.style.backgroundColor = '#ffeaa7';
                                        this.style.textDecoration = 'underline';
                                    };
                                    wordSpan.onmouseout = function() {
                                        this.style.backgroundColor = '#fff3cd';
                                        this.style.textDecoration = 'none';
                                    };
                                    
                                    wordSpan.onclick = function() {
                                        showWordDefinition(cleanWord);
                                    };
                                    
                                    originalDiv.appendChild(wordSpan);
                                } else {
                                    originalDiv.appendChild(document.createTextNode(wordPart));
                                }
                            });
                        }
                        
                        paragraphDiv.appendChild(originalDiv);
                        
                        // æ·»åŠ è¯‘æ–‡
                        const translatedText = (paragraph && typeof paragraph === 'object') 
                            ? (paragraph.translated || paragraph.translation || '') 
                            : '';
                        if (translatedText) {
                            const translatedDiv = document.createElement('div');
                            translatedDiv.className = 'translated-text';
                            translatedDiv.textContent = String(translatedText);
                            paragraphDiv.appendChild(translatedDiv);
                        }
                        
                        contentEl.appendChild(paragraphDiv);
                    });
                }
            }
            
            // æ˜¾ç¤ºå•è¯è¡¨
            const wordListEl = document.getElementById('article-word-list');
            if (wordListEl) {
                wordListEl.innerHTML = '';
                
                if (vocabWords.size > 0) {
                    const wordListTitle = document.createElement('h3');
                    wordListTitle.textContent = 'ä½¿ç”¨çš„å•è¯';
                    wordListTitle.style.cssText = 'margin-bottom: 15px; color: var(--text-primary); font-size: 1.2rem;';
                    wordListEl.appendChild(wordListTitle);
                    
                    const wordTable = document.createElement('table');
                    wordTable.style.cssText = 'width: 100%; border-collapse: collapse;';
                    
                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr style="background: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">
                            <th style="padding: 10px; text-align: left; font-weight: 600;">å•è¯</th>
                            <th style="padding: 10px; text-align: left; font-weight: 600;">è¯æ€§</th>
                            <th style="padding: 10px; text-align: left; font-weight: 600;">é‡Šä¹‰</th>
                        </tr>
                    `;
                    wordTable.appendChild(thead);
                    
                    const tbody = document.createElement('tbody');
                    Array.from(vocabWords.values()).forEach((wordInfo, index) => {
                        const row = document.createElement('tr');
                        row.style.cssText = `border-bottom: 1px solid var(--border-color); ${index % 2 === 0 ? 'background: var(--bg-primary);' : 'background: var(--bg-secondary);'}`;
                        
                        const wordCell = document.createElement('td');
                        wordCell.textContent = wordInfo.word || '';
                        wordCell.style.cssText = 'padding: 10px; font-weight: 500;';
                        row.appendChild(wordCell);
                        
                        const posCell = document.createElement('td');
                        posCell.textContent = wordInfo.part_of_speech || wordInfo.pos || '-';
                        posCell.style.cssText = 'padding: 10px; color: var(--text-secondary);';
                        row.appendChild(posCell);
                        
                        const defCell = document.createElement('td');
                        defCell.textContent = wordInfo.definition || wordInfo.meaning || '-';
                        defCell.style.cssText = 'padding: 10px;';
                        row.appendChild(defCell);
                        
                        tbody.appendChild(row);
                    });
                    wordTable.appendChild(tbody);
                    
                    wordListEl.appendChild(wordTable);
                } else {
                    wordListEl.style.display = 'none';
                }
            }
            
            // æ˜¾ç¤ºå¼¹çª—
            modal.style.display = 'flex';
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­ï¼ˆä½†æ’é™¤å¼¹çª—å†…å®¹åŒºåŸŸï¼‰
            modal.onclick = function(event) {
                // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¼¹çª—èƒŒæ™¯ï¼ˆè€Œä¸æ˜¯å†…å®¹åŒºåŸŸï¼‰æ—¶æ‰å…³é—­
                if (event.target === modal) {
                    closeArticleModal();
                }
            };
            
            // é˜»æ­¢å¼¹çª—å†…å®¹åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.onclick = function(event) {
                    event.stopPropagation();
                };
            }
        }
        
        // å…³é—­æ–‡ç« å¼¹çª—
        function closeArticleModal() {
            const modal = document.getElementById('article-modal');
            if (modal) {
                modal.style.display = 'none';
            }
            // å…³é—­æ‰€æœ‰ä¸‹è½½èœå•
            document.querySelectorAll('.download-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }
        
        // æŒ‰ESCé”®å…³é—­å¼¹çª—
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('article-modal');
                if (modal && modal.style.display === 'flex') {
                    closeArticleModal();
                }
            }
        });
        
        // æµ‹è¯•æ–‡ç« æ˜¾ç¤ºåŠŸèƒ½çš„è¾…åŠ©å‡½æ•°
        function testDisplayArticle() {
            // åˆ›å»ºæ¨¡æ‹Ÿæ–‡ç« æ•°æ®
            const mockArticle = [
                {
                    original: "Learning a new language can be challenging but rewarding. It helps expand your horizons and connect with people from different cultures.",
                    translated: "å­¦ä¹ ä¸€é—¨æ–°è¯­è¨€å¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œä½†å¾ˆæœ‰å›æŠ¥ã€‚å®ƒæœ‰åŠ©äºæ‹“å®½è§†é‡å¹¶ä¸æ¥è‡ªä¸åŒæ–‡åŒ–çš„äººå»ºç«‹è”ç³»ã€‚"
                },
                {
                    original: "Regular practice is essential for improving language skills. Try to read, write, listen and speak every day to make consistent progress.",
                    translated: "å®šæœŸç»ƒä¹ å¯¹äºæé«˜è¯­è¨€æŠ€èƒ½è‡³å…³é‡è¦ã€‚è¯•ç€æ¯å¤©é˜…è¯»ã€å†™ä½œã€å€¾å¬å’Œè¯´è¯ï¼Œä»¥å–å¾—æŒç»­çš„è¿›æ­¥ã€‚"
                }
            ];
            
            // å¦‚æœå½“å‰æ²¡æœ‰å•è¯è¡¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå•è¯è¡¨æ•°æ®
            if (currentVocabulary.length === 0) {
                currentVocabulary = [
                    { word: "language", definition: "è¯­è¨€", part_of_speech: "noun" },
                    { word: "learning", definition: "å­¦ä¹ ", part_of_speech: "noun/verb" },
                    { word: "practice", definition: "ç»ƒä¹ ", part_of_speech: "noun/verb" }
                ];
            }
            
            console.log('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•æ–‡ç« æ˜¾ç¤º:', mockArticle);
            console.log('ä½¿ç”¨çš„å•è¯è¡¨æ•°æ®:', currentVocabulary);
            
            // åˆ›å»ºæ¨¡æ‹Ÿæ–‡ç« æ•°æ®å¯¹è±¡
            const mockArticleData = {
                id: null,
                paragraphs: mockArticle,
                used_words: currentVocabulary,
                topic: 'æµ‹è¯•æ–‡ç« ',
                difficulty_level: 'ä¸­çº§',
                article_length: 'ä¸­ç­‰',
                created_at: new Date().toISOString(),
                used_words_count: currentVocabulary.length
            };
            
            // åœ¨å¼¹çª—ä¸­æ˜¾ç¤º
            showArticleModal(mockArticleData);
            showToast('æµ‹è¯•æ–‡ç« æ˜¾ç¤ºæˆåŠŸï¼', 'info');
        }
        
        // åˆ‡æ¢ä¸‹è½½èœå•æ˜¾ç¤º
        function toggleDownloadMenu(event) {
            event.stopPropagation();
            const button = event.target.closest('.dropdown');
            if (!button) return;
            
            const menu = button.querySelector('.download-menu');
            if (!menu) return;
            
            // å…³é—­æ‰€æœ‰å…¶ä»–èœå•
            document.querySelectorAll('.download-menu').forEach(m => {
                if (m !== menu) m.style.display = 'none';
            });
            
            // åˆ‡æ¢å½“å‰èœå•
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown')) {
                document.querySelectorAll('.download-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
            }
        });
        
        // ä¸‹è½½æ–‡ç« ï¼ˆä¿ç•™é«˜äº®å’Œå•è¯åˆ—è¡¨ï¼‰
        async function downloadArticle(format = 'html') {
            if (!currentArticleData) {
                showToast('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ç« ', 'warning');
                return;
            }
            
            // å…³é—­æ‰€æœ‰ä¸‹è½½èœå•
            document.querySelectorAll('.download-menu').forEach(menu => {
                menu.style.display = 'none';
            });
            
            if (format === 'pdf') {
                // è°ƒç”¨åç«¯APIä¸‹è½½PDF
                if (!currentArticleData.id) {
                    console.error('ä¸‹è½½PDFå¤±è´¥ï¼šæ–‡ç« IDä¸å­˜åœ¨', currentArticleData);
                    showToast('æ— æ³•ä¸‹è½½ï¼šæ–‡ç« IDä¸å­˜åœ¨ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•', 'error');
                    return;
                }
                console.log('ä½¿ç”¨æ–‡ç« IDä¸‹è½½PDF:', currentArticleData.id);
                await downloadArticlePDFById(currentArticleData.id);
            } else {
                downloadArticleAsHTML();
            }
        }
        
        // ä¸‹è½½ä¸ºHTMLæ ¼å¼
        function downloadArticleAsHTML() {
            try {
                // è·å–æ–‡ç« æ®µè½å’Œä½¿ç”¨çš„å•è¯
                const paragraphs = currentArticleData.paragraphs || [];
                const usedWords = currentArticleData.used_words || [];
                
                // æ„å»ºå•è¯Mapç”¨äºé«˜äº®
                const vocabWords = new Map();
                usedWords.forEach(word => {
                    vocabWords.set((word.word || '').toLowerCase(), word);
                });
                
                // ç”ŸæˆHTMLå†…å®¹
                let htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${escapeHtml(currentArticleData.topic || 'ç”Ÿæˆçš„æ–‡ç« ')}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.8;
            color: #333;
            background-color: #f5f7fa;
            padding: 40px 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #3498db;
            margin-bottom: 20px;
            font-size: 2rem;
        }
        .article-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .article-meta span {
            margin-right: 15px;
        }
        .article-paragraph {
            margin-bottom: 30px;
        }
        .original-text {
            font-size: 1.1rem;
            line-height: 2;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .translated-text {
            font-size: 1rem;
            line-height: 1.8;
            color: #666;
            padding-left: 20px;
            border-left: 3px solid #3498db;
            margin-top: 10px;
        }
        .vocab-word {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-weight: 500;
        }
        .word-list-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #3498db;
        }
        .word-list-title {
            font-size: 1.5rem;
            color: #3498db;
            margin-bottom: 20px;
        }
        .word-list-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .word-list-table th,
        .word-list-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .word-list-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        .word-list-table tr:hover {
            background-color: #f8f9fa;
        }
        .word-cell {
            font-weight: 600;
            color: #3498db;
        }
        .part-of-speech {
            color: #666;
            font-size: 0.9rem;
        }
        @media print {
            body {
                background: white;
                padding: 20px;
            }
            .container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>${escapeHtml(currentArticleData.topic || 'ç”Ÿæˆçš„æ–‡ç« ')}</h1>
        <div class="article-meta">
            <span>éš¾åº¦: ${escapeHtml(currentArticleData.difficulty_level || 'æœªçŸ¥')}</span>
            <span>é•¿åº¦: ${escapeHtml(currentArticleData.article_length || 'æœªçŸ¥')}</span>
            <span>ä½¿ç”¨å•è¯: ${usedWords.length} ä¸ª</span>
            <span>ç”Ÿæˆæ—¶é—´: ${currentArticleData.created_at ? new Date(currentArticleData.created_at).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }) : 'æœªçŸ¥'}</span>
        </div>
`;
                
                // æ·»åŠ æ–‡ç« æ®µè½
                paragraphs.forEach(paragraph => {
                    const originalText = paragraph.original || paragraph.text || '';
                    const translatedText = paragraph.translated || paragraph.translation || '';
                    
                    if (!originalText) return;
                    
                    htmlContent += '<div class="article-paragraph">\n';
                    
                    // æ·»åŠ åŸæ–‡ï¼ˆå¸¦é«˜äº®ï¼‰
                    htmlContent += '<div class="original-text">';
                    const words = originalText.split(/(\s+|[,.!?;:"'()\[\]{}])/);
                    
                    words.forEach(wordPart => {
                        const cleanWord = wordPart.replace(/[^\w']/g, '').toLowerCase();
                        if (cleanWord && vocabWords.has(cleanWord)) {
                            htmlContent += `<span class="vocab-word">${escapeHtml(wordPart)}</span>`;
                        } else {
                            htmlContent += escapeHtml(wordPart);
                        }
                    });
                    htmlContent += '</div>\n';
                    
                    // æ·»åŠ è¯‘æ–‡
                    if (translatedText) {
                        htmlContent += `<div class="translated-text">${escapeHtml(translatedText)}</div>\n`;
                    }
                    
                    htmlContent += '</div>\n';
                });
                
                // æ·»åŠ å•è¯åˆ—è¡¨
                if (usedWords.length > 0) {
                    htmlContent += `
        <div class="word-list-section">
            <h2 class="word-list-title">ä½¿ç”¨çš„å•è¯åˆ—è¡¨</h2>
            <table class="word-list-table">
                <thead>
                    <tr>
                        <th>å•è¯</th>
                        <th>è¯æ€§</th>
                        <th>é‡Šä¹‰</th>
                        <th>ä¾‹å¥</th>
                    </tr>
                </thead>
                <tbody>
`;
                    
                    usedWords.forEach(word => {
                        htmlContent += `
                    <tr>
                        <td class="word-cell">${escapeHtml(word.word || '')}</td>
                        <td class="part-of-speech">${escapeHtml(word.part_of_speech || '')}</td>
                        <td>${escapeHtml(word.definition || '')}</td>
                        <td style="font-style: italic; color: #666;">${escapeHtml(word.example || '')}</td>
                    </tr>
`;
                    });
                    
                    htmlContent += `
                </tbody>
            </table>
        </div>
`;
                }
                
                htmlContent += `
    </div>
</body>
</html>`;
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                // ç”Ÿæˆæ–‡ä»¶å
                const fileName = `${(currentArticleData.topic || 'article').replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_')}_${new Date().toISOString().split('T')[0]}.html`;
                link.download = fileName;
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('æ–‡ç« ä¸‹è½½æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('ä¸‹è½½æ–‡ç« å¤±è´¥:', error);
                showToast('ä¸‹è½½æ–‡ç« å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        // æ˜¾ç¤ºå•è¯è¯¦ç»†é‡Šä¹‰
        function showWordDefinition(word) {
            console.log('æ˜¾ç¤ºå•è¯å®šä¹‰:', word);
            
            // æŸ¥æ‰¾å•è¯ä¿¡æ¯ - ä¼˜å…ˆä»æ–‡ç« çš„used_wordsä¸­æŸ¥æ‰¾ï¼Œå…¶æ¬¡ä»currentVocabularyæŸ¥æ‰¾
            let wordInfo = null;
            
            // 1. é¦–å…ˆå°è¯•ä»å½“å‰æ–‡ç« çš„used_wordsä¸­æŸ¥æ‰¾
            if (currentArticleData && currentArticleData.used_words && Array.isArray(currentArticleData.used_words)) {
                wordInfo = currentArticleData.used_words.find(item => 
                    item.word && item.word.toLowerCase() === word.toLowerCase()
                );
                console.log('ä»æ–‡ç« used_wordsæŸ¥æ‰¾:', wordInfo);
            }
            
            // 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä»currentVocabularyä¸­æŸ¥æ‰¾
            if (!wordInfo && currentVocabulary && Array.isArray(currentVocabulary)) {
                wordInfo = currentVocabulary.find(item => 
                    item.word && item.word.toLowerCase() === word.toLowerCase()
                );
                console.log('ä»currentVocabularyæŸ¥æ‰¾:', wordInfo);
            }
            
            if (!wordInfo) {
                console.warn('æœªæ‰¾åˆ°å•è¯ä¿¡æ¯:', word);
                showToast('æœªæ‰¾åˆ°å•è¯ä¿¡æ¯', 'warning');
                return;
            }
            
            // ç¡®ä¿å¼¹çª—å…ƒç´ å­˜åœ¨
            let modal = document.getElementById('word-definition-modal');
            if (!modal) {
                // åˆ›å»ºå¼¹çª—å…ƒç´ 
                createWordDefinitionModal();
                modal = document.getElementById('word-definition-modal');
            }
            
            const modalTitle = document.getElementById('modal-word-title');
            const modalDefinition = document.getElementById('modal-word-definition');
            const modalExample = document.getElementById('modal-word-example');
            const modalPronunciation = document.getElementById('modal-word-pronunciation');
            
            if (!modalTitle || !modalDefinition) {
                console.error('å¼¹çª—å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            // æ›´æ–°å¼¹çª—å†…å®¹
            modalTitle.textContent = wordInfo.word || word;
            modalDefinition.textContent = wordInfo.definition || 'æš‚æ— é‡Šä¹‰';
            
            // å¤„ç†ä¾‹å¥
            if (modalExample) {
                modalExample.textContent = wordInfo.example || 'æ— ä¾‹å¥';
            }
            
            // å¤„ç†å‘éŸ³
            if (modalPronunciation) {
                modalPronunciation.textContent = wordInfo.pronunciation ? `å‘éŸ³: ${wordInfo.pronunciation}` : '';
            }
            
            // æ˜¾ç¤ºå¼¹çª—
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
            
            // æ ‡è®°å•è¯çŠ¶æ€æŒ‰é’®
            const markKnownBtn = document.getElementById('mark-known-btn');
            const markUnknownBtn = document.getElementById('mark-unknown-btn');
            
            if (markKnownBtn) {
                markKnownBtn.onclick = () => {
                    markWordAsKnown(wordInfo.word || word);
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                };
            }
            
            if (markUnknownBtn) {
                markUnknownBtn.onclick = () => {
                    markWordAsUnknown(wordInfo.word || word);
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                };
            }
            
            // å…³é—­æŒ‰é’®
            const closeBtn = document.getElementById('close-modal-btn');
            if (closeBtn) {
                closeBtn.onclick = () => {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                };
            }
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            };
        }
        
        // åˆ›å»ºå•è¯å®šä¹‰å¼¹çª—
        function createWordDefinitionModal() {
            const modalHTML = `
                <div id="word-definition-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="modal-word-title"></h3>
                            <span id="close-modal-btn" class="close">&times;</span>
                        </div>
                        <div class="modal-body">
                            <p id="modal-word-pronunciation" class="pronunciation"></p>
                            <p id="modal-word-definition" class="definition"></p>
                            <p id="modal-word-example" class="example"></p>
                        </div>
                        <div class="modal-footer">
                            <button id="mark-known-btn" class="btn btn-success">å·²æŒæ¡</button>
                            <button id="mark-unknown-btn" class="btn btn-warning">æœªè®°ä½</button>
                        </div>
                    </div>
                </div>
                <style>
                    #word-definition-modal {
                        display: none;
                        position: fixed;
                        z-index: 10002;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        overflow: auto;
                        background-color: rgba(0,0,0,0.6);
                        justify-content: center;
                        align-items: center;
                    }
                    #word-definition-modal.modal {
                        z-index: 10002;
                    }
                    #word-definition-modal .modal-content {
                        background-color: var(--bg-secondary, #fefefe);
                        margin: auto;
                        padding: 20px;
                        border: 1px solid #888;
                        border-radius: 12px;
                        width: 80%;
                        max-width: 500px;
                        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                    }
                    #word-definition-modal .modal-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 15px;
                        border-bottom: 2px solid var(--border-color, #e0e0e0);
                        padding-bottom: 10px;
                    }
                    #word-definition-modal .modal-header h3 {
                        margin: 0;
                        font-size: 1.5rem;
                        color: var(--primary-color);
                    }
                    #word-definition-modal .close {
                        color: #aaa;
                        font-size: 28px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: color 0.2s;
                    }
                    #word-definition-modal .close:hover {
                        color: #000;
                    }
                    #word-definition-modal .pronunciation {
                        color: #666;
                        font-style: italic;
                        font-size: 0.9rem;
                        margin-bottom: 10px;
                    }
                    #word-definition-modal .definition {
                        font-size: 16px;
                        margin: 15px 0;
                        color: var(--text-primary, #333);
                        line-height: 1.6;
                    }
                    #word-definition-modal .example {
                        color: #555;
                        font-style: italic;
                        background-color: #f9f9f9;
                        padding: 10px;
                        border-radius: 4px;
                        border-left: 3px solid var(--primary-color);
                        margin-top: 10px;
                    }
                    #word-definition-modal .modal-footer {
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                        margin-top: 20px;
                    }
                    body.dark-mode #word-definition-modal .modal-content {
                        background-color: var(--bg-secondary);
                        color: var(--text-primary);
                        border-color: var(--border-color);
                    }
                    body.dark-mode #word-definition-modal .example {
                        background-color: rgba(255, 255, 255, 0.05);
                        color: var(--text-secondary);
                    }
                    .vocab-word {
                        background-color: #e3f2fd;
                        border-bottom: 2px dotted #2196f3;
                        cursor: pointer;
                        padding: 0 2px;
                    }
                    .vocab-word:hover {
                        background-color: #bbdefb;
                    }
                    .dark-mode .modal-content {
                        background-color: #333;
                        color: #eee;
                    }
                    .dark-mode .example {
                        background-color: #444;
                        color: #ddd;
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // æ ‡è®°å•è¯ä¸ºå·²æŒæ¡
        function markWordAsKnown(word) {
            // å‘é€æ›´æ–°è¿›åº¦è¯·æ±‚åˆ°åç«¯
            fetch(`/api/progress/words`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    word: word,
                    is_remembered: true
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('æ›´æ–°å•è¯çŠ¶æ€å¤±è´¥');
                }
                return response.json();
            })
            .then(() => {
                showToast(`${word} å·²æ ‡è®°ä¸ºå·²æŒæ¡`, 'success');
            })
            .catch(error => {
                console.error('æ›´æ–°å•è¯çŠ¶æ€å¤±è´¥:', error);
                showToast(`${word} å·²æ ‡è®°ä¸ºå·²æŒæ¡ï¼ˆæœ¬åœ°ï¼‰`, 'info');
            });
        }
        
        // æ ‡è®°å•è¯ä¸ºæœªè®°ä½
        function markWordAsUnknown(word) {
            // å‘é€æ›´æ–°è¿›åº¦è¯·æ±‚åˆ°åç«¯
            fetch(`/api/progress/words`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    word: word,
                    is_remembered: false
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('æ›´æ–°å•è¯çŠ¶æ€å¤±è´¥');
                }
                return response.json();
            })
            .then(() => {
                showToast(`${word} å·²æ·»åŠ åˆ°å¤ä¹ åˆ—è¡¨`, 'info');
            })
            .catch(error => {
                console.error('æ›´æ–°å•è¯çŠ¶æ€å¤±è´¥:', error);
                showToast(`${word} å·²æ ‡è®°ä¸ºæœªè®°ä½ï¼ˆæœ¬åœ°ï¼‰`, 'info');
            });
        }
        
        // åˆå§‹åŒ–å•è¯å¤ä¹ æ¨¡å—
        function initReviewModule() {
            // ç›‘å¬å•è¯è¡¨æ¥æºå˜åŒ–
            const vocabSourceSelect = document.getElementById('review-vocab-source');
            if (vocabSourceSelect) {
                vocabSourceSelect.addEventListener('change', function() {
                    const source = this.value;
                    const customVocabGroup = document.getElementById('review-custom-vocab-group');
                    if (source === 'custom') {
                        customVocabGroup.style.display = 'block';
                        loadReviewVocabularies();
                    } else {
                        customVocabGroup.style.display = 'none';
                    }
                });
            }
            
            // æ·»åŠ é”®ç›˜å¿«æ·é”®ç›‘å¬
            document.addEventListener('keydown', function(e) {
                const reviewCard = document.getElementById('review-card');
                if (reviewCard && reviewCard.style.display !== 'none') {
                    // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†ä¸­ï¼Œä¸è§¦å‘å¿«æ·é”®
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                        return;
                    }
                    
                    if (e.key === '1') {
                        e.preventDefault();
                        markAsRemembered();
                    } else if (e.key === '2') {
                        e.preventDefault();
                        markAsDifficult();
                    } else if (e.key === '3') {
                        e.preventDefault();
                        markAsForgotten();
                    } else if (e.key === ' ' || e.key === 'Enter') {
                        e.preventDefault();
                        toggleDefinitionVisibility();
                    }
                }
            });
            
            // å¦‚æœåˆ‡æ¢åˆ°å¤ä¹ åŒºåŸŸï¼ŒåŠ è½½å•è¯è¡¨åˆ—è¡¨
            const reviewSection = document.getElementById('review');
            if (reviewSection) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            if (reviewSection.classList.contains('active')) {
                                const vocabSource = document.getElementById('review-vocab-source');
                                if (vocabSource && vocabSource.value === 'custom') {
                                    loadReviewVocabularies();
                                }
                            }
                        }
                    });
                });
                observer.observe(reviewSection, { attributes: true });
            }
        }
        
        // åŠ è½½å¤ä¹ ç”¨çš„å•è¯è¡¨åˆ—è¡¨
        function loadReviewVocabularies() {
            const select = document.getElementById('review-custom-vocab');
            if (!select) return;
            
            select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            
            fetch('/api/vocabulary/lists?preset=false', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–å•è¯è¡¨å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                select.innerHTML = '<option value="">è¯·é€‰æ‹©å•è¯è¡¨...</option>';
                // åç«¯è¿”å›çš„æ˜¯æ•°ç»„ï¼Œä¸æ˜¯åŒ…å«listså­—æ®µçš„å¯¹è±¡
                const vocabLists = Array.isArray(data) ? data : (data.lists || []);
                if (vocabLists.length > 0) {
                    vocabLists.forEach(list => {
                        const option = document.createElement('option');
                        option.value = list.id;
                        option.textContent = `${list.name} (${list.word_count || 0}ä¸ªå•è¯)`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">æš‚æ— å•è¯è¡¨</option>';
                }
            })
            .catch(error => {
                console.error('åŠ è½½å•è¯è¡¨å¤±è´¥:', error);
                select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            });
        }
        
        // åˆ‡æ¢é‡Šä¹‰æ˜¾ç¤º/éšè—
        function toggleDefinitionVisibility() {
            isDefinitionVisible = !isDefinitionVisible;
            // æ›´æ–°ç”¨æˆ·åå¥½è®¾ç½®
            userDefinitionPreference = isDefinitionVisible;
            const definitionEl = document.getElementById('current-definition');
            const partOfSpeechEl = document.getElementById('current-part-of-speech');
            const exampleEl = document.getElementById('current-example');
            const toggleBtn = document.getElementById('toggle-definition-btn');
            const toggleIcon = document.getElementById('toggle-icon');
            
            if (isDefinitionVisible) {
                if (definitionEl) definitionEl.style.display = 'block';
                if (partOfSpeechEl) partOfSpeechEl.style.display = 'block';
                if (exampleEl) exampleEl.style.display = 'block';
                if (toggleBtn) toggleBtn.innerHTML = '<span id="toggle-icon">ğŸ™ˆ</span> éšè—é‡Šä¹‰';
            } else {
                if (definitionEl) definitionEl.style.display = 'none';
                if (partOfSpeechEl) partOfSpeechEl.style.display = 'none';
                if (exampleEl) exampleEl.style.display = 'none';
                if (toggleBtn) toggleBtn.innerHTML = '<span id="toggle-icon">ğŸ‘ï¸</span> æ˜¾ç¤ºé‡Šä¹‰';
            }
        }
        
        // å¼€å§‹å¤ä¹ ä¼šè¯
        function startReviewSession() {
            const vocabSource = document.getElementById('review-vocab-source')?.value || 'all';
            const reviewCount = document.getElementById('review-count')?.value || '20';
            const reviewType = document.getElementById('review-type')?.value || 'all';
            reviewMode = document.getElementById('review-mode')?.value || 'normal';
            
            let apiUrl = '/api/review/next-session';
            let params = new URLSearchParams();
            
            if (vocabSource === 'difficult') {
                apiUrl = '/api/review/difficult-words';
            } else if (vocabSource === 'custom') {
                const customVocabId = document.getElementById('review-custom-vocab')?.value;
                if (!customVocabId) {
                    showToast('è¯·å…ˆé€‰æ‹©å•è¯è¡¨', 'warning');
                    return;
                }
                params.append('vocabulary_id', customVocabId);
                apiUrl = '/api/review/next-session';
            }
            
            // æ·»åŠ å¤ä¹ ç±»å‹å‚æ•°
            if (reviewType !== 'all') {
                params.append('review_type', reviewType);
            }
            
            if (reviewCount !== 'all') {
                params.append('limit', reviewCount);
            }
            
            if (params.toString()) {
                apiUrl += '?' + params.toString();
            }
            
            showLoading('æ­£åœ¨å‡†å¤‡å¤ä¹ å†…å®¹...');
            
            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–å¤ä¹ å•è¯å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                
                let words = [];
                if (data.words && Array.isArray(data.words)) {
                    words = data.words;
                } else if (data.data && Array.isArray(data.data)) {
                    words = data.data;
                }
                
                if (words.length > 0) {
                    // å¦‚æœæŒ‡å®šäº†æ•°é‡ï¼Œé™åˆ¶å•è¯æ•°é‡
                    if (reviewCount !== 'all' && parseInt(reviewCount) < words.length) {
                        words = words.slice(0, parseInt(reviewCount));
                    }
                    
                    reviewWords = words;
                    currentReviewIndex = 0;
                    // æ ¹æ®å¤ä¹ æ¨¡å¼è®¾ç½®åˆå§‹æ˜¾ç¤ºçŠ¶æ€ï¼Œä½†åç»­ä¼šä¿æŒç”¨æˆ·çš„é€‰æ‹©
                    isDefinitionVisible = reviewMode === 'flashcard' ? false : true;
                    // åˆå§‹åŒ–ç”¨æˆ·åå¥½è®¾ç½®
                    userDefinitionPreference = isDefinitionVisible;
                    reviewStats = { 
                        total: words.length,
                        remembered: 0, 
                        difficult: 0, 
                        forgotten: 0,
                        completed_at: null
                    };
                    
                    // éšè—è®¾ç½®ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡å’Œå¤ä¹ å¡ç‰‡
                    document.getElementById('review-settings').style.display = 'none';
                    document.getElementById('review-progress-container').style.display = 'block';
                    updateReviewProgress();
                    
                    // æ˜¾ç¤ºç¬¬ä¸€ä¸ªå•è¯
                    showNextReviewWord();
                } else {
                    showToast('å½“å‰æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯', 'info');
                }
            })
            .catch(error => {
                console.error('è·å–å¤ä¹ å•è¯å¤±è´¥:', error);
                hideLoading();
                showToast('è·å–å¤ä¹ å•è¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        // æ›´æ–°å¤ä¹ è¿›åº¦
        function updateReviewProgress() {
            const progressContainer = document.getElementById('review-progress-container');
            if (!progressContainer || progressContainer.style.display === 'none') return;
            
            // åªè®¡ç®—å·²è®°ä½å’Œæœ‰ç‚¹éš¾çš„å•è¯ä½œä¸ºè¿›åº¦ï¼Œæœªè®°ä½çš„ä¸è®¡å…¥è¿›åº¦
            const completed = reviewStats.remembered + reviewStats.difficult;
            const total = reviewStats.total;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            document.getElementById('review-progress-current').textContent = completed;
            document.getElementById('review-progress-total').textContent = total;
            document.getElementById('review-progress-percentage').textContent = percentage + '%';
            
            const progressBar = document.getElementById('review-progress-bar');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
        }
        
        // å¤ä¹ ç–‘éš¾å•è¯
        function reviewDifficultWords() {
            // è®¾ç½®å•è¯è¡¨æ¥æºä¸ºç–‘éš¾å•è¯
            const vocabSourceSelect = document.getElementById('review-vocab-source');
            if (vocabSourceSelect) {
                vocabSourceSelect.value = 'difficult';
            }
            // è°ƒç”¨å¼€å§‹å¤ä¹ å‡½æ•°
            startReviewSession();
        }
        
        // è¿”å›å¤ä¹ è®¾ç½®ç•Œé¢
        function returnToReviewSettings() {
            // ç¡®è®¤æ˜¯å¦è¦é€€å‡ºå½“å‰å¤ä¹ 
            if (currentReviewIndex > 0 && currentReviewIndex < reviewWords.length) {
                const confirmed = confirm(`å½“å‰å·²å¤ä¹  ${currentReviewIndex} ä¸ªå•è¯ï¼Œç¡®å®šè¦è¿”å›è®¾ç½®ç•Œé¢å—ï¼Ÿæœªå®Œæˆçš„å•è¯å°†ä¸ä¼šä¿å­˜ã€‚`);
                if (!confirmed) {
                    return;
                }
            }
            
            // é‡ç½®çŠ¶æ€
            currentReviewIndex = 0;
            reviewWords = [];
            reviewStats = { remembered: 0, difficult: 0, forgotten: 0 };
            isDefinitionVisible = false;
            
            // æ˜¾ç¤ºè®¾ç½®ç•Œé¢ï¼Œéšè—å¤ä¹ ç›¸å…³å…ƒç´ 
            document.getElementById('review-settings').style.display = 'block';
            document.getElementById('review-card').style.display = 'none';
            document.getElementById('review-stats').style.display = 'none';
            document.getElementById('review-progress-container').style.display = 'none';
            
            showToast('å·²è¿”å›è®¾ç½®ç•Œé¢', 'info');
        }
        
        // è¿”å›è®¾ç½®é¡µé¢ï¼ˆè¿”å›åˆ°å•è¯å¤ä¹ çš„è®¾ç½®ç•Œé¢ï¼‰
        function goToSettings() {
            // éšè—å¤ä¹ å®Œæˆç»Ÿè®¡é¡µé¢
            document.getElementById('review-stats').style.display = 'none';
            // æ˜¾ç¤ºå•è¯å¤ä¹ è®¾ç½®ç•Œé¢
            document.getElementById('review-settings').style.display = 'block';
            // éšè—å¤ä¹ å¡ç‰‡
            document.getElementById('review-card').style.display = 'none';
            // éšè—è¿›åº¦æ¡
            document.getElementById('review-progress-container').style.display = 'none';
            // é‡ç½®å¤ä¹ çŠ¶æ€
            currentReviewIndex = 0;
            reviewStats = { remembered: 0, difficult: 0, forgotten: 0 };
            reviewWords = [];
            showToast('å·²è¿”å›å•è¯é€‰æ‹©è®¾ç½®', 'info');
        }
        
        // é‡ç½®å¤ä¹ ä¼šè¯
        function resetReviewSession() {
            currentReviewIndex = 0;
            reviewStats = { remembered: 0, difficult: 0, forgotten: 0 };
            document.getElementById('review-settings').style.display = 'block';
            document.getElementById('review-card').style.display = 'none';
            document.getElementById('review-stats').style.display = 'none';
            document.getElementById('review-progress-container').style.display = 'none';
        }
        
        // æ˜¾ç¤ºä¸‹ä¸€ä¸ªå¤ä¹ å•è¯
        function showNextReviewWord() {
            const reviewCard = document.getElementById('review-card');
            const reviewStatsSection = document.getElementById('review-stats');
            
            updateReviewProgress();
            
            if (currentReviewIndex < reviewWords.length) {
                // æ˜¾ç¤ºå¤ä¹ å¡ç‰‡
                reviewCard.style.display = 'block';
                reviewStatsSection.style.display = 'none';
                
                const currentWord = reviewWords[currentReviewIndex];
                
                // æ›´æ–°å•è¯ä¿¡æ¯
                document.getElementById('current-word').textContent = currentWord.word;
                document.getElementById('current-definition').textContent = currentWord.definition || 'æš‚æ— å®šä¹‰';
                document.getElementById('review-word-info').textContent = `ç¬¬ ${currentReviewIndex + 1} / ${reviewWords.length} ä¸ªå•è¯`;
                
                // è·å–å„ä¸ªå…ƒç´ 
                const wordEl = document.getElementById('current-word');
                const pronunciationEl = document.getElementById('current-pronunciation');
                const partOfSpeechEl = document.getElementById('current-part-of-speech');
                const definitionEl = document.getElementById('current-definition');
                const exampleEl = document.getElementById('current-example');
                const toggleBtn = document.getElementById('toggle-definition-btn');
                const spellInputContainer = document.getElementById('spell-input-container');
                const spellInput = document.getElementById('spell-input');
                const spellFeedback = document.getElementById('spell-feedback');
                const checkSpellBtn = document.getElementById('check-spell-btn');
                
                // é‡ç½®æ‹¼å†™è¾“å…¥æ¡†å’Œåé¦ˆ
                if (spellInput) {
                    spellInput.value = '';
                    spellInput.disabled = false;
                }
                if (spellFeedback) {
                    spellFeedback.textContent = '';
                    spellFeedback.style.color = '';
                }
                if (checkSpellBtn) {
                    checkSpellBtn.style.display = 'inline-block';
                }
                const retrySpellBtn = document.getElementById('retry-spell-btn');
                if (retrySpellBtn) {
                    retrySpellBtn.style.display = 'none';
                }
                const spellHint = document.getElementById('spell-hint');
                if (spellHint) {
                    spellHint.textContent = 'ğŸ’¡ æç¤ºï¼šå¯ä»¥å‚è€ƒä¸‹æ–¹çš„é‡Šä¹‰ã€è¯æ€§å’Œä¾‹å¥æ¥å¸®åŠ©æ‹¼å†™';
                }
                
                // æ˜¾ç¤ºå‘éŸ³
                if (pronunciationEl) {
                    pronunciationEl.textContent = currentWord.pronunciation || '';
                    pronunciationEl.style.display = currentWord.pronunciation ? 'block' : 'none';
                }
                
                // æ˜¾ç¤ºè¯æ€§
                if (partOfSpeechEl) {
                    partOfSpeechEl.textContent = currentWord.part_of_speech || '';
                    partOfSpeechEl.style.display = currentWord.part_of_speech ? 'block' : 'none';
                }
                
                // æ˜¾ç¤ºä¾‹å¥
                if (exampleEl) {
                    exampleEl.textContent = currentWord.example || '';
                    exampleEl.style.display = currentWord.example ? 'block' : 'none';
                }
                
                // æ ¹æ®å¤ä¹ æ¨¡å¼è®¾ç½®æ˜¾ç¤ºçŠ¶æ€
                if (reviewMode === 'spell') {
                    // æ‹¼å†™æ¨¡å¼ï¼šéšè—å•è¯ï¼Œæ˜¾ç¤ºé‡Šä¹‰ç­‰æç¤ºä¿¡æ¯ï¼Œæ˜¾ç¤ºæ‹¼å†™è¾“å…¥æ¡†
                    if (wordEl) wordEl.style.display = 'none';
                    if (spellInputContainer) spellInputContainer.style.display = 'block';
                    if (toggleBtn) toggleBtn.style.display = 'none';
                    
                    // æ˜¾ç¤ºé‡Šä¹‰ã€è¯æ€§ã€ä¾‹å¥ä½œä¸ºæç¤º
                    if (definitionEl) definitionEl.style.display = 'block';
                    if (partOfSpeechEl && currentWord.part_of_speech) partOfSpeechEl.style.display = 'block';
                    if (exampleEl && currentWord.example) exampleEl.style.display = 'block';
                    
                    // éšè—æ“ä½œæŒ‰é’®ï¼Œç›´åˆ°æ£€æŸ¥æ‹¼å†™åæ‰æ˜¾ç¤º
                    const reviewOptions = document.querySelector('.review-options');
                    if (reviewOptions) {
                        reviewOptions.style.display = 'none';
                    }
                    
                    // èšç„¦åˆ°è¾“å…¥æ¡†
                    setTimeout(() => {
                        if (spellInput) spellInput.focus();
                    }, 100);
                    
                    // æ·»åŠ å›è½¦é”®ç›‘å¬
                    if (spellInput) {
                        spellInput.onkeypress = function(e) {
                            if (e.key === 'Enter' && !spellInput.disabled) {
                                checkSpelling();
                            }
                        };
                    }
                } else if (reviewMode === 'flashcard') {
                    // é—ªå¡æ¨¡å¼ï¼šéšè—æ‹¼å†™è¾“å…¥æ¡†ï¼Œæ˜¾ç¤ºå•è¯ï¼Œé»˜è®¤éšè—é‡Šä¹‰
                    if (wordEl) wordEl.style.display = 'block';
                    if (spellInputContainer) spellInputContainer.style.display = 'none';
                    if (toggleBtn) toggleBtn.style.display = 'block';
                    
                    // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                    const reviewOptions = document.querySelector('.review-options');
                    if (reviewOptions) {
                        reviewOptions.style.display = 'flex';
                    }
                    
                    // æ¢å¤ç”¨æˆ·å¯¹é‡Šä¹‰æ˜¾ç¤ºçš„åå¥½è®¾ç½®
                    isDefinitionVisible = userDefinitionPreference;
                    if (!isDefinitionVisible) {
                        // å¦‚æœç”¨æˆ·åå¥½æ˜¯éšè—çŠ¶æ€ï¼Œä¿æŒéšè—
                        if (definitionEl) definitionEl.style.display = 'none';
                        if (partOfSpeechEl) partOfSpeechEl.style.display = 'none';
                        if (exampleEl) exampleEl.style.display = 'none';
                        if (toggleBtn) toggleBtn.innerHTML = '<span id="toggle-icon">ğŸ‘ï¸</span> æ˜¾ç¤ºé‡Šä¹‰';
                    } else {
                        // å¦‚æœç”¨æˆ·åå¥½æ˜¯æ˜¾ç¤ºçŠ¶æ€ï¼Œä¿æŒæ˜¾ç¤º
                        if (definitionEl) definitionEl.style.display = 'block';
                        if (partOfSpeechEl && currentWord.part_of_speech) partOfSpeechEl.style.display = 'block';
                        if (exampleEl && currentWord.example) exampleEl.style.display = 'block';
                        if (toggleBtn) toggleBtn.innerHTML = '<span id="toggle-icon">ğŸ™ˆ</span> éšè—é‡Šä¹‰';
                    }
                } else {
                    // å¸¸è§„æ¨¡å¼ï¼šéšè—æ‹¼å†™è¾“å…¥æ¡†ï¼Œæ˜¾ç¤ºå•è¯ï¼Œä¿æŒç”¨æˆ·ä¹‹å‰çš„é€‰æ‹©çŠ¶æ€
                    if (wordEl) wordEl.style.display = 'block';
                    if (spellInputContainer) spellInputContainer.style.display = 'none';
                    if (toggleBtn) toggleBtn.style.display = 'block';
                    
                    // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                    const reviewOptions = document.querySelector('.review-options');
                    if (reviewOptions) {
                        reviewOptions.style.display = 'flex';
                    }
                    
                    // æ¢å¤ç”¨æˆ·å¯¹é‡Šä¹‰æ˜¾ç¤ºçš„åå¥½è®¾ç½®
                    isDefinitionVisible = userDefinitionPreference;
                    if (isDefinitionVisible) {
                        // å¦‚æœç”¨æˆ·åå¥½æ˜¯æ˜¾ç¤ºçŠ¶æ€ï¼Œä¿æŒæ˜¾ç¤º
                        if (definitionEl) definitionEl.style.display = 'block';
                        if (partOfSpeechEl && currentWord.part_of_speech) partOfSpeechEl.style.display = 'block';
                        if (exampleEl && currentWord.example) exampleEl.style.display = 'block';
                        if (toggleBtn) toggleBtn.innerHTML = '<span id="toggle-icon">ğŸ™ˆ</span> éšè—é‡Šä¹‰';
                    } else {
                        // å¦‚æœç”¨æˆ·åå¥½æ˜¯éšè—çŠ¶æ€ï¼Œä¿æŒéšè—
                        if (definitionEl) definitionEl.style.display = 'none';
                        if (partOfSpeechEl) partOfSpeechEl.style.display = 'none';
                        if (exampleEl) exampleEl.style.display = 'none';
                        if (toggleBtn) toggleBtn.innerHTML = '<span id="toggle-icon">ğŸ‘ï¸</span> æ˜¾ç¤ºé‡Šä¹‰';
                    }
                }
            } else {
                // å¤ä¹ å®Œæˆ
                reviewCard.style.display = 'none';
                reviewStatsSection.style.display = 'block';
                
                document.getElementById('remembered-count').textContent = reviewStats.remembered;
                document.getElementById('difficult-count').textContent = reviewStats.difficult;
                document.getElementById('forgotten-count').textContent = reviewStats.forgotten;
                
                // è®¡ç®—å®Œæˆç‡
                const totalReviewed = reviewStats.remembered + reviewStats.difficult + reviewStats.forgotten;
                const completionRate = totalReviewed > 0 ? Math.round((reviewStats.remembered / totalReviewed) * 100) : 0;
                
                // æ˜¾ç¤ºå®Œæˆç‡
                if (document.getElementById('completion-percentage')) {
                    document.getElementById('completion-percentage').textContent = `${completionRate}%`;
                }
                
                // åˆ›å»ºå®Œæˆç‡ç¯å½¢å›¾
                if (document.getElementById('completion-chart')) {
                    const ctx = document.getElementById('completion-chart').getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['å·²è®°ä½', 'æœªæŒæ¡'],
                            datasets: [{
                                data: [reviewStats.remembered, totalReviewed - reviewStats.remembered],
                                backgroundColor: [
                                    getComputedStyle(document.documentElement).getPropertyValue('--success-color'),
                                    getComputedStyle(document.documentElement).getPropertyValue('--light-gray')
                                ],
                                borderWidth: 0,
                                cutout: '70%'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false }
                            }
                        }
                    });
                }
                
                showToast('å¤ä¹ å®Œæˆï¼', 'success');
                
                // å®Œæˆå¤ä¹ ä¼šè¯
                completeReviewSession();
            }
        }
        
        // æ ‡è®°ä¸ºå·²è®°ä½
        function markAsRemembered() {
            if (currentReviewIndex < reviewWords.length) {
                const currentWord = reviewWords[currentReviewIndex];
                updateWordProgress(currentWord.id || currentWord.word, 'remembered');
            }
            
            // ä¿å­˜ç”¨æˆ·å½“å‰çš„é‡Šä¹‰æ˜¾ç¤ºåå¥½
            userDefinitionPreference = isDefinitionVisible;
            
            reviewStats.remembered++;
            currentReviewIndex++;
            showNextReviewWord();
        }
        
        // æ ‡è®°ä¸ºæœ‰ç‚¹éš¾
        function markAsDifficult() {
            if (currentReviewIndex < reviewWords.length) {
                const currentWord = reviewWords[currentReviewIndex];
                updateWordProgress(currentWord.id || currentWord.word, 'difficult');
            }
            
            // ä¿å­˜ç”¨æˆ·å½“å‰çš„é‡Šä¹‰æ˜¾ç¤ºåå¥½
            userDefinitionPreference = isDefinitionVisible;
            
            reviewStats.difficult++;
            currentReviewIndex++;
            showNextReviewWord();
        }
        
        // æ ‡è®°ä¸ºæ²¡è®°ä½
        function markAsForgotten() {
            if (currentReviewIndex < reviewWords.length) {
                const currentWord = reviewWords[currentReviewIndex];
                updateWordProgress(currentWord.id || currentWord.word, 'forgotten');
            }
            
            // å¦‚æœç”¨æˆ·æœªæ˜¾ç¤ºé‡Šä¹‰ï¼Œåˆ™ä¸´æ—¶æ˜¾ç¤ºé‡Šä¹‰ï¼Œå¸®åŠ©ç”¨æˆ·å­¦ä¹ 
            if (!isDefinitionVisible) {
                // ä¿å­˜ç”¨æˆ·ä¹‹å‰çš„è®¾ç½®
                userDefinitionPreference = false;
                // ä¸´æ—¶æ˜¾ç¤ºé‡Šä¹‰
                const definitionEl = document.getElementById('current-definition');
                const partOfSpeechEl = document.getElementById('current-part-of-speech');
                const exampleEl = document.getElementById('current-example');
                const toggleBtn = document.getElementById('toggle-definition-btn');
                
                if (definitionEl) definitionEl.style.display = 'block';
                if (partOfSpeechEl && partOfSpeechEl.textContent) partOfSpeechEl.style.display = 'block';
                if (exampleEl && exampleEl.textContent) exampleEl.style.display = 'block';
                if (toggleBtn) toggleBtn.innerHTML = '<span id="toggle-icon">ğŸ™ˆ</span> éšè—é‡Šä¹‰';
                
                // ä¸´æ—¶è®¾ç½®æ ‡å¿—ï¼Œä½†è®°ä½ç”¨æˆ·åå¥½æ˜¯éšè—çš„
                // æ³¨æ„ï¼šä¸æ”¹å˜ isDefinitionVisibleï¼Œè¿™æ ·åœ¨ä¸‹ä¸€ä¸ªå•è¯æ—¶ä¼šæ¢å¤ç”¨æˆ·è®¾ç½®
            } else {
                // å¦‚æœç”¨æˆ·å·²ç»æ˜¾ç¤ºäº†é‡Šä¹‰ï¼Œä¿å­˜è¿™ä¸ªåå¥½
                userDefinitionPreference = true;
            }
            
            reviewStats.forgotten++;
            // å°†æœªè®°ä½çš„å•è¯æ·»åŠ åˆ°å¤ä¹ åˆ—è¡¨æœ«å°¾ï¼Œéœ€è¦å†æ¬¡å¤ä¹ 
            if (currentReviewIndex < reviewWords.length) {
                reviewWords.push(reviewWords[currentReviewIndex]);
            }
            // æœªè®°ä½çš„å•è¯ä¸è®¡å…¥è¿›åº¦ï¼Œæ‰€ä»¥ä¸å¢åŠ  currentReviewIndex
            // ä½†éœ€è¦ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå•è¯ç»§ç»­å¤ä¹ 
            currentReviewIndex++;
            showNextReviewWord();
            // æ³¨æ„ï¼šè¿›åº¦æ›´æ–°ä¼šåœ¨ showNextReviewWord() ä¸­è°ƒç”¨ updateReviewProgress()
            // ç”±äºæˆ‘ä»¬ä¿®æ”¹äº† updateReviewProgress() åªè®¡ç®—å·²è®°ä½å’Œæœ‰ç‚¹éš¾çš„å•è¯
            // æ‰€ä»¥æœªè®°ä½çš„å•è¯ä¸ä¼šå½±å“è¿›åº¦æ˜¾ç¤º
        }
        
        // æ£€æŸ¥æ‹¼å†™ï¼ˆæ‹¼å†™æ¨¡å¼ä¸“ç”¨ï¼‰
        function checkSpelling() {
            if (reviewMode !== 'spell') return;
            
            const spellInput = document.getElementById('spell-input');
            const spellFeedback = document.getElementById('spell-feedback');
            const checkSpellBtn = document.getElementById('check-spell-btn');
            const retrySpellBtn = document.getElementById('retry-spell-btn');
            const spellHint = document.getElementById('spell-hint');
            const wordEl = document.getElementById('current-word');
            
            if (!spellInput || !spellFeedback || currentReviewIndex >= reviewWords.length) return;
            
            const userInput = spellInput.value.trim().toLowerCase();
            const correctWord = reviewWords[currentReviewIndex].word.toLowerCase();
            
            if (!userInput) {
                spellFeedback.textContent = 'è¯·è¾“å…¥å•è¯';
                spellFeedback.style.color = 'var(--warning-color, #ff9800)';
                if (spellHint) spellHint.textContent = 'ğŸ’¡ æç¤ºï¼šå¯ä»¥å‚è€ƒä¸‹æ–¹çš„é‡Šä¹‰ã€è¯æ€§å’Œä¾‹å¥æ¥å¸®åŠ©æ‹¼å†™';
                return;
            }
            
            // ç¦ç”¨è¾“å…¥æ¡†å’Œæ£€æŸ¥æŒ‰é’®
            spellInput.disabled = true;
            if (checkSpellBtn) checkSpellBtn.style.display = 'none';
            
            // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
            if (wordEl) wordEl.style.display = 'block';
            
            // æ£€æŸ¥æ‹¼å†™æ˜¯å¦æ­£ç¡®ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
            if (userInput === correctWord) {
                spellFeedback.textContent = 'âœ“ æ‹¼å†™æ­£ç¡®ï¼';
                spellFeedback.style.color = 'var(--success-color, #4caf50)';
                if (retrySpellBtn) retrySpellBtn.style.display = 'none';
                if (spellHint) spellHint.textContent = 'ğŸ‰ å¤ªæ£’äº†ï¼å³å°†è¿›å…¥ä¸‹ä¸€ä¸ªå•è¯...';
                
                // è‡ªåŠ¨æ ‡è®°ä¸ºå·²è®°ä½ï¼Œå»¶è¿Ÿåè¿›å…¥ä¸‹ä¸€ä¸ªå•è¯
                setTimeout(() => {
                    markAsRemembered();
                }, 1500);
            } else {
                spellFeedback.textContent = `âœ— æ‹¼å†™é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${reviewWords[currentReviewIndex].word}`;
                spellFeedback.style.color = 'var(--accent-color, #f44336)';
                
                // æ˜¾ç¤ºé‡æ–°æ‹¼å†™æŒ‰é’®
                if (retrySpellBtn) retrySpellBtn.style.display = 'inline-block';
                if (spellHint) spellHint.innerHTML = 'ğŸ’¡ æç¤ºï¼šå¯ä»¥ç‚¹å‡»"é‡æ–°æ‹¼å†™"æŒ‰é’®å†æ¬¡å°è¯•ï¼Œæˆ–ç›´æ¥é€‰æ‹©ä¸‹æ–¹æŒ‰é’®æ ‡è®°å­¦ä¹ çŠ¶æ€';
                
                // æ˜¾ç¤ºä¸‰ä¸ªæ“ä½œæŒ‰é’®ï¼Œè®©ç”¨æˆ·é€‰æ‹©
                const reviewOptions = document.querySelector('.review-options');
                if (reviewOptions) {
                    reviewOptions.style.display = 'flex';
                }
            }
        }
        
        // é‡æ–°æ‹¼å†™ï¼ˆæ‹¼å†™æ¨¡å¼ä¸“ç”¨ï¼‰
        function retrySpelling() {
            if (reviewMode !== 'spell') return;
            
            const spellInput = document.getElementById('spell-input');
            const spellFeedback = document.getElementById('spell-feedback');
            const checkSpellBtn = document.getElementById('check-spell-btn');
            const retrySpellBtn = document.getElementById('retry-spell-btn');
            const spellHint = document.getElementById('spell-hint');
            const wordEl = document.getElementById('current-word');
            const reviewOptions = document.querySelector('.review-options');
            
            if (!spellInput) return;
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            spellInput.value = '';
            spellInput.disabled = false;
            
            // é‡ç½®åé¦ˆä¿¡æ¯
            if (spellFeedback) {
                spellFeedback.textContent = '';
                spellFeedback.style.color = '';
            }
            
            // æ˜¾ç¤ºæ£€æŸ¥æŒ‰é’®ï¼Œéšè—é‡æ–°æ‹¼å†™æŒ‰é’®
            if (checkSpellBtn) checkSpellBtn.style.display = 'inline-block';
            if (retrySpellBtn) retrySpellBtn.style.display = 'none';
            
            // éšè—æ­£ç¡®ç­”æ¡ˆ
            if (wordEl) wordEl.style.display = 'none';
            
            // éšè—æ“ä½œæŒ‰é’®
            if (reviewOptions) {
                reviewOptions.style.display = 'none';
            }
            
            // æ›´æ–°æç¤º
            if (spellHint) spellHint.textContent = 'ğŸ’¡ æç¤ºï¼šå¯ä»¥å‚è€ƒä¸‹æ–¹çš„é‡Šä¹‰ã€è¯æ€§å’Œä¾‹å¥æ¥å¸®åŠ©æ‹¼å†™';
            
            // èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                if (spellInput) spellInput.focus();
            }, 100);
        }
        
        // æ›´æ–°å•è¯è¿›åº¦
        function updateWordProgress(wordId, status) {
            // å‘é€åˆ°åç«¯æ›´æ–°å•è¯å­¦ä¹ çŠ¶æ€
            fetch('/api/progress/words', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    word_id: wordId,
                    status: status,
                    vocabulary_id: currentVocabularyId || 'custom',
                    timestamp: new Date().toISOString()
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('æ›´æ–°å•è¯çŠ¶æ€å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('æ›´æ–°å•è¯çŠ¶æ€å¤±è´¥:', error);
                // æœ¬åœ°é™çº§å¤„ç†ï¼šå­˜å‚¨åˆ°localStorage
                const learningProgress = JSON.parse(localStorage.getItem('learningProgress') || '{}');
                learningProgress[wordId] = {
                    status: status,
                    lastReviewed: new Date().toISOString(),
                    reviewCount: (learningProgress[wordId]?.reviewCount || 0) + 1
                };
                localStorage.setItem('learningProgress', JSON.stringify(learningProgress));
            });
        }
        
        // å®Œæˆå¤ä¹ ä¼šè¯
        // æ˜¾ç¤ºå·²å¤ä¹ å•è¯åˆ—è¡¨
        let reviewedWordsPage = 1;
        let reviewedWordsPageSize = 20;
        let currentReviewedWordsList = [];
        let currentReviewedWordIndex = 0;
        
        function showReviewedWords() {
            // éšè—å¤ä¹ è®¾ç½®å’Œå¡ç‰‡
            document.getElementById('review-settings').style.display = 'none';
            document.getElementById('review-card').style.display = 'none';
            document.getElementById('review-stats').style.display = 'none';
            document.getElementById('review-progress-container').style.display = 'none';
            
            // æ˜¾ç¤ºå·²å¤ä¹ å•è¯åˆ—è¡¨
            document.getElementById('reviewed-words-container').style.display = 'block';
            
            // åŠ è½½å•è¯è¡¨åˆ—è¡¨åˆ°ç­›é€‰å™¨
            loadReviewedWordsVocabFilter();
            
            // åŠ è½½å·²å¤ä¹ å•è¯
            reviewedWordsPage = 1;
            loadReviewedWords();
            
            // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
            setupReviewedWordsKeyboard();
        }
        
        function setupReviewedWordsKeyboard() {
            // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (window.reviewedWordsKeyHandler) {
                document.removeEventListener('keydown', window.reviewedWordsKeyHandler);
            }
            
            // åˆ›å»ºæ–°çš„é”®ç›˜äº‹ä»¶å¤„ç†å™¨
            window.reviewedWordsKeyHandler = function(e) {
                const container = document.getElementById('reviewed-words-container');
                if (!container || container.style.display === 'none') {
                    return;
                }
                
                // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†æˆ–é€‰æ‹©æ¡†ä¸­ï¼Œä¸å¤„ç†é”®ç›˜äº‹ä»¶
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    return;
                }
                
                // å·¦ç®­å¤´æˆ–ä¸Šç®­å¤´ï¼šä¸Šä¸€ä¸ªå•è¯
                if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    showPreviousReviewedWord();
                }
                // å³ç®­å¤´æˆ–ä¸‹ç®­å¤´ï¼šä¸‹ä¸€ä¸ªå•è¯
                else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    showNextReviewedWord();
                }
                // ç©ºæ ¼é”®ï¼šä¸‹ä¸€ä¸ªå•è¯
                else if (e.key === ' ' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    showNextReviewedWord();
                }
            };
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬
            document.addEventListener('keydown', window.reviewedWordsKeyHandler);
        }
        
        function hideReviewedWords() {
            document.getElementById('reviewed-words-container').style.display = 'none';
            document.getElementById('review-settings').style.display = 'block';
            
            // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬
            if (window.reviewedWordsKeyHandler) {
                document.removeEventListener('keydown', window.reviewedWordsKeyHandler);
                window.reviewedWordsKeyHandler = null;
            }
        }
        
        function loadReviewedWordsVocabFilter() {
            fetch('/api/vocabulary/lists?preset=false', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('reviewed-words-vocab-filter');
                if (!select) return;
                
                // ä¿ç•™"å…¨éƒ¨å•è¯è¡¨"é€‰é¡¹
                select.innerHTML = '<option value="">å…¨éƒ¨å•è¯è¡¨</option>';
                
                // æ·»åŠ ç”¨æˆ·å•è¯è¡¨
                const vocabLists = Array.isArray(data) ? data : (data.lists || []);
                vocabLists.forEach(list => {
                    const option = document.createElement('option');
                    option.value = list.id;
                    option.textContent = list.name;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('åŠ è½½å•è¯è¡¨åˆ—è¡¨å¤±è´¥:', error);
            });
        }
        
        function loadReviewedWords() {
            const searchInput = document.getElementById('reviewed-words-search');
            const vocabFilter = document.getElementById('reviewed-words-vocab-filter');
            const sortSelect = document.getElementById('reviewed-words-sort');
            const listContainer = document.getElementById('reviewed-words-list');
            const paginationContainer = document.getElementById('reviewed-words-pagination');
            
            if (!listContainer) return;
            
            listContainer.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loader" style="margin: 0 auto;"></div><p>åŠ è½½ä¸­...</p></div>';
            
            const search = searchInput ? searchInput.value.trim() : '';
            const vocabularyId = vocabFilter && vocabFilter.value ? parseInt(vocabFilter.value) : null;
            const sortValue = sortSelect ? sortSelect.value : 'last_reviewed:desc';
            const [sortBy, order] = sortValue.split(':');
            
            const params = new URLSearchParams({
                page: reviewedWordsPage.toString(),
                page_size: reviewedWordsPageSize.toString(),
                sort_by: sortBy,
                order: order || 'desc'
            });
            
            if (search) {
                params.append('search', search);
            }
            if (vocabularyId) {
                params.append('vocabulary_id', vocabularyId.toString());
            }
            
            fetch(`/api/review/reviewed-words?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–å·²å¤ä¹ å•è¯å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                // ä¿å­˜å½“å‰é¡µçš„å•è¯åˆ—è¡¨
                currentReviewedWordsList = data.words || [];
                currentReviewedWordIndex = 0;
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateReviewedWordsStats(data);
                
                // æ¸²æŸ“å•è¯åˆ—è¡¨ï¼ˆæ”¹ä¸ºå•å¡ç‰‡æ˜¾ç¤ºï¼‰
                renderReviewedWordsList(currentReviewedWordsList);
                
                // æ¸²æŸ“åˆ†é¡µ
                renderReviewedWordsPagination(data.page || 1, data.total_pages || 1, data.total || 0);
            })
            .catch(error => {
                console.error('åŠ è½½å·²å¤ä¹ å•è¯å¤±è´¥:', error);
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--accent-color);">
                        <p>åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
                        <button class="btn btn-primary" onclick="loadReviewedWords()">é‡è¯•</button>
                    </div>
                `;
            });
        }
        
        function updateReviewedWordsStats(data) {
            const words = data.words || [];
            const total = data.total || 0;
            
            // è®¡ç®—ç»Ÿè®¡
            const mastered = words.filter(w => w.mastery_level >= 3).length;
            const totalReviews = words.reduce((sum, w) => sum + (w.review_count || 0), 0);
            
            // æ›´æ–°æ˜¾ç¤ºï¼ˆå¦‚æœå½“å‰é¡µæœ‰æ•°æ®ï¼Œæ˜¾ç¤ºå½“å‰é¡µç»Ÿè®¡ï¼›å¦åˆ™æ˜¾ç¤ºæ€»æ•°ï¼‰
            document.getElementById('reviewed-words-total').textContent = total;
            document.getElementById('reviewed-words-mastered').textContent = mastered;
            document.getElementById('reviewed-words-total-reviews').textContent = totalReviews;
        }
        
        function renderReviewedWordsList(words) {
            const listContainer = document.getElementById('reviewed-words-list');
            if (!listContainer) return;
            
            if (words.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">æš‚æ— å·²å¤ä¹ çš„å•è¯</p>
                        <p>å¼€å§‹å¤ä¹ å•è¯åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºæ‚¨å·²å¤ä¹ çš„å•è¯åˆ—è¡¨</p>
                    </div>
                `;
                return;
            }
            
            // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
            if (currentReviewedWordIndex >= words.length) {
                currentReviewedWordIndex = 0;
            }
            if (currentReviewedWordIndex < 0) {
                currentReviewedWordIndex = words.length - 1;
            }
            
            const word = words[currentReviewedWordIndex];
            const masteryLevel = word.mastery_level || 0;
            const masteryColor = masteryLevel >= 3 ? 'var(--success-color)' : masteryLevel >= 1 ? 'var(--warning-color)' : 'var(--text-secondary)';
            const masteryText = masteryLevel >= 3 ? 'å·²æŒæ¡' : masteryLevel >= 1 ? 'å­¦ä¹ ä¸­' : 'æœªæŒæ¡';
            
            const lastReviewed = word.last_reviewed ? new Date(word.last_reviewed).toLocaleString('zh-CN') : 'ä»æœª';
            const reviewCount = word.review_count || 0;
            
            // å•å¡ç‰‡æ˜¾ç¤ºï¼Œå¸¦å¯¼èˆªæŒ‰é’®
            const html = `
                <div style="display: flex; align-items: center; gap: 20px; justify-content: center; max-width: 1200px; margin: 0 auto;">
                    <!-- ä¸Šä¸€ä¸ªæŒ‰é’® -->
                    <button 
                        class="btn btn-outline-primary" 
                        style="padding: 15px 20px; font-size: 1.5rem; min-width: 60px; ${currentReviewedWordIndex === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
                        onclick="showPreviousReviewedWord()"
                        ${currentReviewedWordIndex === 0 ? 'disabled' : ''}
                    >
                        â†
                    </button>
                    
                    <!-- å•è¯å¡ç‰‡ -->
                    <div class="review-card" style="flex: 1; max-width: 600px; padding: 15px; min-height: 300px; text-align: center;">
                        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 8px; position: relative;">
                            <div style="flex: 1;"></div>
                            <div style="flex: 2; text-align: center;">
                                <h4 style="margin: 0 0 3px 0; color: var(--primary-color); font-size: 1.5rem; text-align: center;">${escapeHtml(word.word)}</h4>
                                ${word.pronunciation ? `<p style="margin: 0; color: var(--text-secondary); font-size: 0.85rem; text-align: center;">${escapeHtml(word.pronunciation)}</p>` : ''}
                            </div>
                            <div style="flex: 1; text-align: right; position: absolute; right: 0; top: 0;">
                                <span style="display: inline-block; padding: 3px 8px; background: ${masteryColor}; color: white; border-radius: 4px; font-size: 0.8rem;">${masteryText}</span>
                            </div>
                        </div>
                        <div style="margin: 8px 0; text-align: center;">
                            <p style="margin: 0; color: var(--text-primary); font-size: 0.95rem; text-align: center;">${escapeHtml(word.definition || 'æš‚æ— å®šä¹‰')}</p>
                            ${word.part_of_speech ? `<span style="display: inline-block; margin-top: 5px; padding: 2px 6px; background: var(--light-gray); border-radius: 4px; font-size: 0.75rem; color: var(--text-secondary);">${escapeHtml(word.part_of_speech)}</span>` : ''}
                        </div>
                        ${word.example ? `<div style="margin-top: 8px; padding: 8px; background: var(--light-gray); border-radius: 6px; font-style: italic; color: var(--text-secondary); font-size: 0.85rem; text-align: center;">${escapeHtml(word.example)}</div>` : ''}
                        <div style="margin-top: 12px; display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.8rem; color: var(--text-secondary); justify-content: center;">
                            <span>å¤ä¹ æ¬¡æ•°: <strong>${reviewCount}</strong></span>
                            <span>æœ€åå¤ä¹ : <strong>${lastReviewed}</strong></span>
                            ${word.vocabulary_list_name ? `<span>å•è¯è¡¨: <strong>${escapeHtml(word.vocabulary_list_name)}</strong></span>` : ''}
                        </div>
                        <div style="margin-top: 15px; text-align: center; font-size: 0.85rem; color: var(--text-secondary);">
                            ç¬¬ ${currentReviewedWordIndex + 1} / ${words.length} ä¸ªå•è¯
                            <br>
                            <span style="font-size: 0.75rem; opacity: 0.7;">æç¤ºï¼šä½¿ç”¨ â† â†’ æ–¹å‘é”®æˆ–ç©ºæ ¼é”®åˆ‡æ¢å•è¯</span>
                        </div>
                    </div>
                    
                    <!-- ä¸‹ä¸€ä¸ªæŒ‰é’® -->
                    <button 
                        class="btn btn-outline-primary" 
                        style="padding: 15px 20px; font-size: 1.5rem; min-width: 60px; ${currentReviewedWordIndex >= words.length - 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
                        onclick="showNextReviewedWord()"
                        ${currentReviewedWordIndex >= words.length - 1 ? 'disabled' : ''}
                    >
                        â†’
                    </button>
                </div>
            `;
            
            listContainer.innerHTML = html;
        }
        
        function showPreviousReviewedWord() {
            if (currentReviewedWordsList.length === 0) return;
            currentReviewedWordIndex--;
            if (currentReviewedWordIndex < 0) {
                // å¦‚æœå½“å‰é¡µæ˜¯ç¬¬ä¸€é¡µï¼Œå°è¯•åŠ è½½ä¸Šä¸€é¡µ
                if (reviewedWordsPage > 1) {
                    reviewedWordsPage--;
                    loadReviewedWords();
                    return;
                }
                currentReviewedWordIndex = 0;
            }
            renderReviewedWordsList(currentReviewedWordsList);
        }
        
        function showNextReviewedWord() {
            if (currentReviewedWordsList.length === 0) return;
            currentReviewedWordIndex++;
            if (currentReviewedWordIndex >= currentReviewedWordsList.length) {
                // å¦‚æœå½“å‰é¡µæ˜¯æœ€åä¸€é¡µï¼Œå°è¯•åŠ è½½ä¸‹ä¸€é¡µ
                const paginationInfo = document.querySelector('#reviewed-words-pagination');
                if (paginationInfo && reviewedWordsPage < parseInt(paginationInfo.dataset.totalPages || '1')) {
                    reviewedWordsPage++;
                    loadReviewedWords();
                    return;
                }
                currentReviewedWordIndex = currentReviewedWordsList.length - 1;
            }
            renderReviewedWordsList(currentReviewedWordsList);
        }
        
        function renderReviewedWordsPagination(currentPage, totalPages, total) {
            const paginationContainer = document.getElementById('reviewed-words-pagination');
            if (!paginationContainer) return;
            
            // ä¿å­˜æ€»é¡µæ•°åˆ°datasetï¼Œä¾›showNextReviewedWordä½¿ç”¨
            paginationContainer.dataset.totalPages = totalPages.toString();
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            html += `<button class="btn btn-sm btn-secondary" ${currentPage <= 1 ? 'disabled' : ''} onclick="reviewedWordsPage = ${currentPage - 1}; currentReviewedWordIndex = 0; loadReviewedWords();">
                <span>â†</span> ä¸Šä¸€é¡µ
            </button>`;
            
            // é¡µç ä¿¡æ¯
            html += `<span style="padding: 0 15px; color: var(--text-secondary);">
                ç¬¬ ${currentPage} / ${totalPages} é¡µï¼ˆå…± ${total} ä¸ªå•è¯ï¼‰
            </span>`;
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            html += `<button class="btn btn-sm btn-secondary" ${currentPage >= totalPages ? 'disabled' : ''} onclick="reviewedWordsPage = ${currentPage + 1}; currentReviewedWordIndex = 0; loadReviewedWords();">
                ä¸‹ä¸€é¡µ <span>â†’</span>
            </button>`;
            
            paginationContainer.innerHTML = html;
        }
        
        function viewReviewedWordDetail(wordId) {
            // å¯ä»¥åœ¨è¿™é‡Œå®ç°æŸ¥çœ‹å•è¯è¯¦æƒ…çš„åŠŸèƒ½
            // ä¾‹å¦‚ï¼šæ˜¾ç¤ºä¸€ä¸ªæ¨¡æ€æ¡†æˆ–è·³è½¬åˆ°å•è¯è¯¦æƒ…é¡µ
            showToast('æŸ¥çœ‹å•è¯è¯¦æƒ…åŠŸèƒ½å¾…å®ç°', 'info');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function completeReviewSession() {
            reviewStats.completed_at = new Date().toISOString();
            
            // å‘é€å¤ä¹ ä¼šè¯å®ŒæˆæŠ¥å‘Šåˆ°åç«¯
            fetch('/api/review/complete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    session_stats: reviewStats
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ä¿å­˜å¤ä¹ ä¼šè¯å¤±è´¥');
                }
                // åˆ·æ–°å­¦ä¹ ç»Ÿè®¡
                loadLearningStats();
            })
            .catch(error => {
                console.error('ä¿å­˜å¤ä¹ ä¼šè¯å¤±è´¥:', error);
                // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
            });
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // ä¸ºcanvaså…ƒç´ è®¾ç½®å›ºå®šå¤§å°
            const canvasElements = [
                { id: 'daily-words-chart', width: 400, height: 300 },
                { id: 'mastery-chart', width: 400, height: 300 },
                { id: 'learning-trend-chart', width: 800, height: 300 }
            ];
            
            canvasElements.forEach(canvasInfo => {
                const canvas = document.getElementById(canvasInfo.id);
                if (canvas) {
                    canvas.width = canvasInfo.width;
                    canvas.height = canvasInfo.height;
                }
            });
            
            // ä»åç«¯åŠ è½½å­¦ä¹ ç»Ÿè®¡æ•°æ®
            loadLearningStats();
        }
        
        // åŠ è½½å­¦ä¹ ç»Ÿè®¡æ•°æ®
        function loadLearningStats() {
            showLoading('åŠ è½½å­¦ä¹ æ•°æ®ä¸­...');
            
            // å‘é€è¯·æ±‚è·å–å­¦ä¹ ç»Ÿè®¡
            fetch('/api/progress/stats', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–å­¦ä¹ æ•°æ®å¤±è´¥');
                }
                return response.json();
            })
            .then(stats => {
                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                updateStatsCards(stats);
                
                // ç­‰å¾…Chart.jsåŠ è½½å®Œæˆåå†åˆ›å»ºå›¾è¡¨
                function waitForChartAndCreate() {
                    if (typeof Chart !== 'undefined' && Chart.register) {
                        createProgressCharts(stats);
                        hideLoading();
                        return;
                    }
                    
                    // å¦‚æœChart.jsè¿˜åœ¨åŠ è½½ï¼Œç­‰å¾…åŠ è½½å®Œæˆ
                    if (window.chartJSLoading) {
                        const maxWaitTime = 8000; // æœ€å¤šç­‰å¾…8ç§’
                        const startTime = Date.now();
                        
                        function checkAndCreate() {
                            if (typeof Chart !== 'undefined' && Chart.register) {
                                createProgressCharts(stats);
                                hideLoading();
                            } else if (Date.now() - startTime < maxWaitTime) {
                                // ç»§ç»­ç­‰å¾…
                                setTimeout(checkAndCreate, 500);
                            } else {
                                console.warn('Chart.jsåŠ è½½è¶…æ—¶ï¼Œè·³è¿‡å›¾è¡¨åˆ›å»º');
                                hideLoading();
                            }
                        }
                        
                        // ç›‘å¬Chart.jsåŠ è½½å®Œæˆäº‹ä»¶
                        window.addEventListener('chartjsloaded', function() {
                            createProgressCharts(stats);
                            hideLoading();
                        }, { once: true });
                        
                        // å¼€å§‹è½®è¯¢æ£€æŸ¥
                        checkAndCreate();
                    } else {
                        // Chart.jsåŠ è½½å¤±è´¥ï¼Œç›´æ¥è·³è¿‡
                        console.warn('Chart.jsåŠ è½½å¤±è´¥ï¼Œè·³è¿‡å›¾è¡¨åˆ›å»º');
                        hideLoading();
                    }
                }
                
                waitForChartAndCreate();
            })
            .catch(error => {
                console.error('åŠ è½½å­¦ä¹ æ•°æ®å¤±è´¥:', error);
                hideLoading();
                showToast('åŠ è½½å­¦ä¹ æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        function updateStatsCards(stats) {
            // æ·»åŠ DOMå…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥ï¼Œé¿å…TypeError
            const elements = {
                'total-words-count': stats.total_words || 0,
                'mastery-rate': `${stats.mastery_rate || 0}%`,
                'learning-days': stats.learning_days || 0,
                'total-time': formatDuration(stats.total_time_minutes || 0),
                'difficult-words': stats.difficult_words_count || 0
            };
            
            // éå†æ‰€æœ‰éœ€è¦æ›´æ–°çš„å…ƒç´ 
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        }
        
        // å­˜å‚¨å›¾è¡¨å®ä¾‹çš„å…¨å±€å˜é‡
        let chartInstances = {
            dailyWords: null,
            mastery: null,
            trend: null
        };
        
        // åˆ›å»ºå­¦ä¹ è¿›åº¦å›¾è¡¨
        function createProgressCharts(stats) {
            // æ£€æŸ¥Chart.jsæ˜¯å¦å·²åŠ è½½
            if (typeof Chart === 'undefined') {
                console.error('Chart.jsæœªåŠ è½½ï¼Œæ— æ³•åˆ›å»ºå›¾è¡¨');
                // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
                const chartContainers = ['daily-words-chart', 'mastery-chart', 'learning-trend-chart'];
                chartContainers.forEach(id => {
                    const container = document.getElementById(id);
                    if (container && container.parentElement) {
                        container.parentElement.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">å›¾è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
                    }
                });
                return;
            }
            
            // æ¯æ—¥å­¦ä¹ å•è¯é‡å›¾è¡¨ - æ·»åŠ DOMå…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥
            const dailyWordsChart = document.getElementById('daily-words-chart');
            if (dailyWordsChart) {
                // é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨å®ä¾‹
                if (chartInstances.dailyWords) {
                    chartInstances.dailyWords.destroy();
                    chartInstances.dailyWords = null;
                }
                // æˆ–è€…ä½¿ç”¨ Chart.getChart è·å–å¹¶é”€æ¯
                const existingChart = Chart.getChart(dailyWordsChart);
                if (existingChart) {
                    existingChart.destroy();
                }
                
                // ç¡®ä¿canvaså¤§å°æ­£ç¡®è®¾ç½®
                dailyWordsChart.width = 400;
                dailyWordsChart.height = 300;
                
                const dailyWordsCtx = dailyWordsChart.getContext('2d');
                chartInstances.dailyWords = new Chart(dailyWordsCtx, {
                    type: 'bar',
                    data: {
                        labels: stats.daily_words?.labels || ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'],
                        datasets: [{
                            label: 'å­¦ä¹ å•è¯æ•°',
                            data: stats.daily_words?.data || [45, 63, 78, 52, 91, 105, 68],
                            backgroundColor: 'rgba(52, 152, 219, 0.6)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 1.3,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // å•è¯æŒæ¡ç¨‹åº¦å›¾è¡¨ - æ·»åŠ DOMå…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥
            const masteryChart = document.getElementById('mastery-chart');
            if (masteryChart) {
                // é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨å®ä¾‹
                if (chartInstances.mastery) {
                    chartInstances.mastery.destroy();
                    chartInstances.mastery = null;
                }
                const existingChart = Chart.getChart(masteryChart);
                if (existingChart) {
                    existingChart.destroy();
                }
                
                // ç¡®ä¿canvaså¤§å°æ­£ç¡®è®¾ç½®
                masteryChart.width = 400;
                masteryChart.height = 300;
                
                const masteryCtx = masteryChart.getContext('2d');
                chartInstances.mastery = new Chart(masteryCtx, {
                    type: 'pie',
                    data: {
                        labels: ['å·²æŒæ¡', 'å­¦ä¹ ä¸­', 'æœªæŒæ¡'],
                        datasets: [{
                            data: [
                                stats.mastered_words || 87,
                                stats.learning_words || 10,
                                stats.unmastered_words || 3
                            ],
                            backgroundColor: [
                                'rgba(39, 174, 96, 0.7)',
                                'rgba(243, 156, 18, 0.7)',
                                'rgba(231, 76, 60, 0.7)'
                            ],
                            borderColor: [
                                'rgba(39, 174, 96, 1)',
                                'rgba(243, 156, 18, 1)',
                                'rgba(231, 76, 60, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 1.3,
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const element = elements[0];
                                const index = element.index;
                                const labels = ['å·²æŒæ¡', 'å­¦ä¹ ä¸­', 'æœªæŒæ¡'];
                                const masteryTypes = ['mastered', 'learning', 'unmastered'];
                                const label = labels[index];
                                const masteryType = masteryTypes[index];
                                
                                // æ˜¾ç¤ºå¼¹çª—
                                showWordsModal(label, masteryType);
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        return `${label}: ${value} ä¸ªå•è¯`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // å­¦ä¹ è¶‹åŠ¿å›¾è¡¨ - æ·»åŠ DOMå…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥
            const trendChart = document.getElementById('learning-trend-chart');
            if (trendChart) {
                // é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨å®ä¾‹
                if (chartInstances.trend) {
                    chartInstances.trend.destroy();
                    chartInstances.trend = null;
                }
                const existingChart = Chart.getChart(trendChart);
                if (existingChart) {
                    existingChart.destroy();
                }
                
                // ç¡®ä¿canvaså¤§å°æ­£ç¡®è®¾ç½®
                trendChart.width = 800;
                trendChart.height = 300;
                
                const trendCtx = trendChart.getContext('2d');
                chartInstances.trend = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: stats.weekly_trend?.labels || ['ç¬¬1å‘¨', 'ç¬¬2å‘¨', 'ç¬¬3å‘¨', 'ç¬¬4å‘¨', 'ç¬¬5å‘¨', 'ç¬¬6å‘¨'],
                        datasets: [{
                            label: 'ç´¯è®¡å­¦ä¹ å•è¯',
                            data: stats.weekly_trend?.data || [250, 480, 690, 850, 1020, 1254],
                            borderColor: 'rgba(52, 152, 219, 1)',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.7,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(minutes) {
            // å•è¯åˆ—è¡¨å¼¹çª—ç›¸å…³å˜é‡
            let currentWordsModalType = '';
            let currentWordsPage = 1;
            let currentWordsTotalPages = 1;

            // æ˜¾ç¤ºå•è¯åˆ—è¡¨å¼¹çª—
            function showWordsModal(title, masteryType) {
                currentWordsModalType = masteryType;
                currentWordsPage = 1;
                const modal = document.getElementById('words-modal');
                const modalTitle = document.getElementById('words-modal-title');
                modalTitle.textContent = title;
                modal.style.display = 'block';
                loadWordsList(masteryType, 1);
            }

            // å…³é—­å•è¯åˆ—è¡¨å¼¹çª—
            function closeWordsModal() {
                const modal = document.getElementById('words-modal');
                modal.style.display = 'none';
                currentWordsModalType = '';
                currentWordsPage = 1;
            }

            // åŠ è½½å•è¯åˆ—è¡¨
            function loadWordsList(masteryType, page) {
                const content = document.getElementById('words-modal-content');
                content.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p style="margin-top: 15px; color: var(--text-secondary);">åŠ è½½ä¸­...</p></div>';
                
                fetch(`/api/progress/words-by-mastery?mastery_type=${masteryType}&page=${page}&page_size=50`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('åŠ è½½å•è¯åˆ—è¡¨å¤±è´¥');
                    }
                    return response.json();
                })
                .then(data => {
                    currentWordsPage = data.page;
                    currentWordsTotalPages = data.total_pages;
                    renderWordsList(data.words, data.total);
                    updateWordsPagination();
                })
                .catch(error => {
                    console.error('åŠ è½½å•è¯åˆ—è¡¨å¤±è´¥:', error);
                    content.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--error-color);">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>`;
                });
            }

            // æ¸²æŸ“å•è¯åˆ—è¡¨
            function renderWordsList(words, total) {
                const content = document.getElementById('words-modal-content');
                
                if (words.length === 0) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">æš‚æ— å•è¯</div>';
                    return;
                }
                
                let html = `
                    <div style="margin-bottom: 15px; color: var(--text-secondary);">
                        å…± ${total} ä¸ªå•è¯ï¼Œå½“å‰æ˜¾ç¤ºç¬¬ ${(currentWordsPage - 1) * 50 + 1} - ${Math.min(currentWordsPage * 50, total)} ä¸ª
                    </div>
                    <table class="words-list-table">
                        <thead>
                            <tr>
                                <th>å•è¯</th>
                                <th>é‡Šä¹‰</th>
                                <th>è¯æ€§</th>
                                <th>æŒæ¡ç¨‹åº¦</th>
                                <th>å¤ä¹ æ¬¡æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                words.forEach(word => {
                    const masteryBadgeClass = word.mastery_level >= 3 ? 'mastered' : 
                                            word.mastery_level >= 1 ? 'learning' : 'unmastered';
                    const masteryText = word.mastery_level >= 3 ? 'å·²æŒæ¡' : 
                                    word.mastery_level >= 1 ? 'å­¦ä¹ ä¸­' : 'æœªæŒæ¡';
                    
                    html += `
                        <tr>
                            <td><strong>${word.word || '-'}</strong></td>
                            <td>${word.definition || '-'}</td>
                            <td>${word.part_of_speech || '-'}</td>
                            <td><span class="mastery-badge ${masteryBadgeClass}">${masteryText}</span></td>
                            <td>${word.review_count || 0}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                content.innerHTML = html;
            }

            // æ›´æ–°åˆ†é¡µæŒ‰é’®
            function updateWordsPagination() {
                const prevBtn = document.getElementById('words-modal-prev');
                const nextBtn = document.getElementById('words-modal-next');
                const pageInfo = document.getElementById('words-modal-page-info');
                
                prevBtn.disabled = currentWordsPage <= 1;
                nextBtn.disabled = currentWordsPage >= currentWordsTotalPages;
                pageInfo.textContent = `ç¬¬ ${currentWordsPage} é¡µï¼Œå…± ${currentWordsTotalPages} é¡µ`;
            }

            // åŠ è½½å•è¯åˆ—è¡¨é¡µé¢
            function loadWordsPage(direction) {
                if (direction === 'prev' && currentWordsPage > 1) {
                    loadWordsList(currentWordsModalType, currentWordsPage - 1);
                } else if (direction === 'next' && currentWordsPage < currentWordsTotalPages) {
                    loadWordsList(currentWordsModalType, currentWordsPage + 1);
                }
            }

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            window.onclick = function(event) {
                const modal = document.getElementById('words-modal');
                if (event.target === modal) {
                    closeWordsModal();
                }
            }
            if (minutes < 60) {
                return `${minutes} åˆ†é’Ÿ`;
            }
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours} å°æ—¶ ${mins} åˆ†é’Ÿ`;
        }
        
        // ä½¿ç”¨çœŸå®APIæ•°æ®
    </script>
</body>
</html>