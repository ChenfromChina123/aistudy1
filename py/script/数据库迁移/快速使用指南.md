# 数据库迁移脚本 - 快速使用指南

## 🎯 最简单的方式（推荐）

### 方式一：直接运行（最简单）

1. **确保 `.env` 文件中有 `DATABASE_URL` 配置**
   ```
   DATABASE_URL=mysql+pymysql://root:123456@localhost:3306/ipv6_education
   ```

2. **Windows用户：双击运行 `运行迁移.bat`**
   
   **Linux/Mac用户：运行 `./运行迁移.sh`**
   
   **或者直接运行：**
   ```bash
   python py/script/数据库迁移/简单迁移.py
   ```

3. **按提示选择操作：**
   - 输入 `1` - 导出数据到文件
   - 输入 `2` - 从文件导入数据
   - 输入 `3` - 退出

就这么简单！脚本会自动从 `.env` 文件读取数据库配置。

---

## 📋 使用前准备

1. **确保目标数据库已创建**
2. **确保目标数据库表结构已存在**（与源数据库一致）
3. **备份目标数据库**（重要！）

## 🚀 高级用法（命令行模式）

### 第一步：导出数据到文件

```powershell
# Windows PowerShell（使用反引号 ` 作为行继续符）
python py/script/数据库迁移/migrate_all_data.py export `
    --source-db "mysql+pymysql://root:123456@localhost:3306/old_database" `
    --output-dir "./migration_data" `
    --generate-script `
    --target-db "mysql+pymysql://root:123456@localhost:3306/new_database"

# 或者单行命令（推荐，避免转义问题）
python py/script/数据库迁移/migrate_all_data.py export --source-db "mysql+pymysql://root:123456@localhost:3306/old_database" --output-dir "./migration_data" --generate-script --target-db "mysql+pymysql://root:123456@localhost:3306/new_database"

# Linux/Mac（使用反斜杠 \ 作为行继续符）
python py/script/数据库迁移/migrate_all_data.py export \
    --source-db "mysql+pymysql://root:123456@localhost:3306/old_database" \
    --output-dir "./migration_data" \
    --generate-script \
    --target-db "mysql+pymysql://root:123456@localhost:3306/new_database"
```

### 第二步：从文件导入数据

**方式1：使用命令行导入（推荐，最简单）**

```powershell
# Windows PowerShell（单行命令，推荐）
python py/script/数据库迁移/migrate_all_data.py import --target-db "mysql+pymysql://root:123456@localhost:3306/new_database" --data-dir "./migration_data"

# 或者多行命令
python py/script/数据库迁移/migrate_all_data.py import `
    --target-db "mysql+pymysql://root:123456@localhost:3306/new_database" `
    --data-dir "./migration_data"
```

**方式2：生成并使用导入脚本**

如果导出时没有生成导入脚本，可以手动生成：

```powershell
# 生成导入脚本
python py/script/数据库迁移/generate_import_script.py --data-dir "./migration_data" --target-db "mysql+pymysql://root:123456@localhost:3306/new_database"

# 然后运行生成的脚本
python ./migration_data/import_data.py
```

**方式3：导出时自动生成导入脚本**

在导出时添加 `--generate-script` 和 `--target-db` 参数：

```powershell
python py/script/数据库迁移/migrate_all_data.py export --source-db "mysql+pymysql://root:123456@localhost:3306/ipv6_education" --output-dir "./migration_data" --generate-script --target-db "mysql+pymysql://root:123456@localhost:3306/new_database"
```

这样导出完成后会自动生成 `./migration_data/import_data.py` 文件。

## 📝 参数说明

### 导出模式（export）

| 参数 | 说明 | 是否必需 | 示例 |
|------|------|---------|------|
| `--source-db` | 源数据库连接URL | ✅ 必需 | `mysql+pymysql://root:123456@localhost:3306/old_db` |
| `--output-dir` | 输出目录 | ❌ 可选 | `./migration_data`（默认） |
| `--tables` | 要导出的表（可选） | ❌ 可选 | `users admins user_files` |
| `--generate-script` | 生成导入脚本 | ❌ 可选 | 需要配合 `--target-db` 使用 |
| `--target-db` | 目标数据库URL（用于生成脚本） | ❌ 可选 | 与 `--generate-script` 一起使用 |

### 导入模式（import）

| 参数 | 说明 | 是否必需 | 示例 |
|------|------|---------|------|
| `--target-db` | 目标数据库连接URL | ✅ 必需 | `mysql+pymysql://root:123456@localhost:3306/new_db` |
| `--data-dir` | 数据文件目录 | ✅ 必需 | `./migration_data` |
| `--tables` | 要导入的表（可选） | ❌ 可选 | `users admins user_files` |

## 💡 常用场景

### 场景1：完整迁移流程（推荐）

```powershell
# 第一步：导出数据
python py/script/数据库迁移/migrate_all_data.py export --source-db "mysql+pymysql://root:123456@localhost:3306/ipv6_education" --output-dir "./migration_data"

# 第二步：导入数据（直接使用命令行，最简单）
python py/script/数据库迁移/migrate_all_data.py import --target-db "mysql+pymysql://root:123456@localhost:3306/new_database" --data-dir "./migration_data"
```

**或者使用导入脚本方式：**

```powershell
# 第一步：导出数据（自动生成导入脚本）
python py/script/数据库迁移/migrate_all_data.py export --source-db "mysql+pymysql://root:123456@localhost:3306/ipv6_education" --output-dir "./migration_data" --generate-script --target-db "mysql+pymysql://root:123456@localhost:3306/new_database"

# 第二步：使用生成的脚本导入
python ./migration_data/import_data.py
```

**如果导出时没有生成脚本，可以手动生成：**

```powershell
# 生成导入脚本
python py/script/数据库迁移/generate_import_script.py --data-dir "./migration_data" --target-db "mysql+pymysql://root:123456@localhost:3306/new_database"

# 运行导入脚本
python ./migration_data/import_data.py
```

### 场景2：只导出特定表

```powershell
# 导出（单行命令）
python py/script/数据库迁移/migrate_all_data.py export --source-db "mysql+pymysql://root:123456@localhost:3306/ipv6_education" --output-dir "./migration_data" --tables users admins user_files

# 导入（单行命令）
python py/script/数据库迁移/migrate_all_data.py import --target-db "mysql+pymysql://root:123456@localhost:3306/new_database" --data-dir "./migration_data"
```

### 场景3：跨服务器迁移

```powershell
# 在源服务器上导出
python py/script/数据库迁移/migrate_all_data.py export --source-db "mysql+pymysql://root:123456@localhost:3306/ipv6_education" --output-dir "./migration_data"

# 将 migration_data 目录传输到目标服务器（使用 scp、ftp 等）

# 在目标服务器上导入
python py/script/数据库迁移/migrate_all_data.py import --target-db "mysql+pymysql://admin:password@192.168.1.100:3306/production_db" --data-dir "./migration_data"
```

## 📊 执行过程

### 导出阶段

```
✓ 源数据库连接成功
将导出 23 个表
导出顺序: users, admins, verification_codes, ...

[1/23] 导出表: users
开始导出表 users，记录数: 150
✓ 表 users 导出完成: 150 条记录 -> users.sql

...

导出摘要
总表数: 23
成功导出: 23
总记录数: 15234
成功导出记录数: 15234
输出目录: ./migration_data
元数据文件: ./migration_data/migration_metadata.json
✓ 导入脚本已生成: ./migration_data/import_data.py
```

### 导入阶段

```
✓ 目标数据库连接成功
将导入 23 个表
导入顺序: users, admins, verification_codes, ...

[1/23] 导入表: users
开始导入表 users，文件: users.sql
✓ 表 users 导入完成: 150 条记录

...

导入摘要
总表数: 23
成功导入: 23
总记录数: 15234
成功导入记录数: 15234
```

## 📁 生成的文件

### 导出后生成的文件结构

```
migration_data/
├── migration_metadata.json    # 元数据文件（包含导出信息）
├── users.sql                 # 用户表数据
├── admins.sql                # 管理员表数据
├── user_files.sql            # 用户文件表数据
├── ...                       # 其他表的SQL文件
└── import_data.py            # 自动生成的导入脚本（如果使用了--generate-script）
```

### 日志文件

迁移日志保存在：`log/migrate_all_data_YYYYMMDD_HHMMSS.log`

## ⚠️ 重要提示

1. **执行前备份目标数据库**
   ```bash
   mysqldump -u root -p target_database > backup.sql
   ```

2. **确保目标数据库表结构已创建**
   - 目标数据库必须已经存在
   - 表结构必须与源数据库一致

3. **检查数据库连接**
   - 确保能连接到源数据库和目标数据库
   - 检查用户名、密码、主机、端口是否正确

4. **字符编码**
   - 确保数据库使用 `utf8mb4` 字符集

## 🔍 验证迁移结果

迁移完成后，可以执行SQL验证：

```sql
-- 比较记录数
SELECT 
    'users' as table_name,
    (SELECT COUNT(*) FROM source_db.users) as source_count,
    (SELECT COUNT(*) FROM target_db.users) as target_count;

-- 检查数据
SELECT * FROM target_db.users LIMIT 10;
```

## ❓ 常见问题

### Q1: 连接失败怎么办？
**A**: 检查数据库URL格式、用户名、密码、主机和端口

### Q2: 表不存在怎么办？
**A**: 这是正常的，如果表不存在会跳过并继续

### Q3: 外键约束错误？
**A**: 确保依赖的表已经迁移完成，脚本会自动处理顺序

### Q4: 如何查看详细日志？
**A**: 查看 `log/` 目录下的日志文件

## 📞 需要帮助？

查看完整文档：`README_MIGRATE_ALL_DATA.md`

