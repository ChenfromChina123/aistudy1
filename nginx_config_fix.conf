# ä¿®å¤åçš„ Nginx é…ç½®
# åœ¨ server å—ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®

server {
    listen 80;
    listen [::]:80;
    listen 443 ssl;
    http2 on;
    listen 443 quic; # å¯ç”¨ HTTP/3
    server_name aistudy.icu;
    index index.php index.html index.htm;
    root /www/wwwroot/aistudy.icu;

    # =============================
    # ğŸš€ å…³é”®ä¿®å¤ï¼šæ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
    # =============================
    client_max_body_size 1G;  # å…è®¸ä¸Šä¼ æœ€å¤§ 1GB æ–‡ä»¶
    client_body_timeout 300s;  # å®¢æˆ·ç«¯è¯·æ±‚ä½“è¶…æ—¶æ—¶é—´
    client_body_buffer_size 128k;  # å®¢æˆ·ç«¯è¯·æ±‚ä½“ç¼“å†²åŒºå¤§å°

    # è¯ä¹¦é…ç½®ï¼ˆä¿æŒåŸæ ·ï¼‰
    ssl_certificate /www/server/panel/vhost/cert/aistudy.icu/fullchain.pem;
    ssl_certificate_key /www/server/panel/vhost/cert/aistudy.icu/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers EECDH+CHACHA20:EECDH+AES128:EECDH+AES256:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    add_header Strict-Transport-Security "max-age=31536000";
    error_page 497 https://$host$request_uri;

    include /www/server/panel/vhost/nginx/extension/aistudy.icu/*.conf;
    include /www/server/panel/vhost/nginx/well-known/aistudy.icu.conf;

    # =============================
    # ğŸ”’ åå‘ä»£ç†åˆ° Python åç«¯ï¼ˆå·²å…³é—­ç¼“å­˜å’Œç¼“å†²ï¼‰
    # =============================
    location / {
        proxy_set_header X-Real-Port $remote_port;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header Remote-Host $remote_addr;
        proxy_pass http://localhost:5000; # ä¿æŒä¸å˜

        # ä¼ é€’å¿…è¦çš„è¯·æ±‚å¤´ï¼ˆä¿æŒä¸å˜ï¼‰
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # =============================
        # ğŸš€ å¤§æ–‡ä»¶ä¸Šä¼ ä¼˜åŒ–é…ç½®
        # =============================
        # è¶…æ—¶è®¾ç½®ï¼ˆå¤§æ–‡ä»¶ä¸Šä¼ éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
        proxy_connect_timeout 60s;
        proxy_send_timeout 600s;    # å¢åŠ åˆ°10åˆ†é’Ÿ
        proxy_read_timeout 600s;    # å¢åŠ åˆ°10åˆ†é’Ÿ
        
        # è¯·æ±‚ä½“å¤§å°é™åˆ¶ï¼ˆä¸ client_max_body_size ä¿æŒä¸€è‡´ï¼‰
        proxy_request_buffering off;  # ç¦ç”¨è¯·æ±‚ç¼“å†²ï¼Œæ”¯æŒæµå¼ä¸Šä¼ 
        proxy_max_temp_file_size 0;   # ç¦ç”¨ä¸´æ—¶æ–‡ä»¶ï¼Œç›´æ¥è½¬å‘

        # =============================
        # âš¡ å…³é—­ç¼“å†²ï¼ˆæ ¸å¿ƒé…ç½®ï¼‰
        # =============================
        proxy_buffering off; # ç¦ç”¨åå‘ä»£ç†ç¼“å†²ï¼ˆå…³é”®ï¼ç¡®ä¿æ•°æ®å®æ—¶è½¬å‘ï¼‰
        proxy_cache off; # å†æ¬¡ç¡®è®¤å…³é—­ç¼“å­˜ï¼ˆåŒé‡ä¿éšœï¼‰
        chunked_transfer_encoding on; # å¯ç”¨åˆ†å—ä¼ è¾“ç¼–ç ï¼ˆé€‚é…æµå¼ä¸å®šé•¿æ•°æ®ï¼‰
        tcp_nopush off; # ç¦ç”¨Nagleç®—æ³•ï¼ˆé¿å…å°æ•°æ®å—åˆå¹¶å»¶è¿Ÿï¼‰
        tcp_nodelay on; # å¯ç”¨TCPæ— å»¶è¿Ÿï¼ˆç¡®ä¿å³æ—¶å‘é€å°æ•°æ®åŒ…ï¼‰
    }

    # ç¦æ­¢è®¿é—®æ•æ„Ÿæ–‡ä»¶ï¼ˆä¿æŒä¸å˜ï¼‰
    location ~ ^/(\.user.ini|\.htaccess|\.git|\.env|\.svn|LICENSE|README.md) {
        return 404;
    }

    # SSL è¯ä¹¦éªŒè¯ç›®å½•ï¼ˆä¿æŒä¸å˜ï¼‰
    location /.well-known {
        allow all;
    }

    # é˜²æ­¢ä¸Šä¼ æ•æ„Ÿæ–‡ä»¶ï¼ˆä¿æŒä¸å˜ï¼‰
    if ($uri ~ "^/\.well-known/.*\.(php|jsp|py|js|css|lua|ts|go|zip|tar\.gz|rar|7z|sql|bak)$" ) {
        return 403;
    }

    # æ—¥å¿—ï¼ˆä¿æŒä¸å˜ï¼‰
    access_log /www/wwwlogs/aistudy.icu.log;
    error_log /www/wwwlogs/aistudy.icu.error.log;
}



